<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel de Gerenciamento de Usu치rios</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css?v=20240826" />
  </head>
  <body class="bg-gray-100">
    <div class="app-container">
      <div id="sidebar-container"></div>
      <div id="navbar-container"></div>
      <div class="main-content p-6">
        <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
          <h1 class="text-2xl font-bold mb-4">游논 Gerenciamento de Usu치rios</h1>

          <form id="userForm" class="space-y-4">
            <input
              type="text"
              id="uid"
              placeholder="UID do Usu치rio"
              class="w-full p-2 border rounded"
            />
            <input
              type="text"
              id="nome"
              placeholder="Nome do Usu치rio"
              class="w-full p-2 border rounded"
            />
            <input
              type="email"
              id="email"
              placeholder="E-mail do Usu치rio"
              class="w-full p-2 border rounded"
            />
            <input
              type="text"
              id="emailExpedicao"
              placeholder="E-mails Respons치vel Expedi칞칚o (at칠 2, separados por v칤rgula)"
              class="w-full p-2 border rounded"
            />
            <select id="perfil" class="w-full p-2 border rounded">
              <option value="Usuario Completo">Usu치rio Completo</option>
              <option value="Usuario Basico">Usu치rio B치sico</option>
              <option value="Expedicao">Expedi칞칚o</option>
              <option value="Responsavel Financeiro">
                Respons치vel Financeiro
              </option>
              <option value="ADM">ADM</option>
            </select>
            <button
              type="submit"
              class="bg-blue-600 text-white px-4 py-2 rounded"
            >
              Salvar Usu치rio
            </button>
          </form>

          <hr class="my-6" />

          <h2 class="text-xl font-semibold mb-2">游늶 Lista de Usu치rios</h2>
          <ul id="listaUsuarios" class="space-y-2"></ul>
        </div>
      </div>
    </div>
    <script src="shared.js"></script>

    <script type="module">
      import { firebaseConfig, getPassphrase } from './firebase-config.js';

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();

      firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = 'index.html?login=1';
          return;
        }

        try {
          let perfil = '';
          const snap = await db.collection('uid').doc(user.uid).get();
          const enc = snap.data()?.encrypted;
          if (enc) {
            const { decryptString } = await import('./crypto.js');
            const pass = getPassphrase() || `chave-${user.uid}`;
            const data = JSON.parse(await decryptString(enc, pass));
            perfil = data.perfil || '';
          } else {
            const userSnap = await db.collection('usuarios').doc(user.uid).get();
            perfil = userSnap.data()?.perfil || '';
          }
          perfil = String(perfil).toLowerCase().trim();
          if (!['adm', 'admin', 'administrador'].includes(perfil)) {
            alert('Acesso permitido apenas para administradores.');
            window.location.href = 'index.html';
          }
        } catch (err) {
          console.error('Erro ao verificar perfil do usu치rio:', err);
          window.location.href = 'index.html';
        }
      });
      const form = document.getElementById('userForm');
      const lista = document.getElementById('listaUsuarios');
      const perfilSelect = document.getElementById('perfil');

      const normalizarPerfilValor = (valor) =>
        (valor || '')
          .toString()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .trim();

      const obterValorSelectPerfil = (valor) => {
        const normalizado = normalizarPerfilValor(valor);
        if (!normalizado) return 'Usuario Completo';
        const mapa = {
          adm: 'ADM',
          admin: 'ADM',
          administrador: 'ADM',
          'usuario completo': 'Usuario Completo',
          usuario: 'Usuario Completo',
          'usuario basico': 'Usuario Basico',
          cliente: 'Usuario Basico',
          'responsavel financeiro': 'Responsavel Financeiro',
          responsavel: 'Responsavel Financeiro',
          expedicao: 'Expedicao',
          'gestor expedicao': 'Expedicao',
          'gestor de expedicao': 'Expedicao',
        };
        return (
          mapa[normalizado] ||
          Array.from(perfilSelect.options).find(
            (opt) => normalizarPerfilValor(opt.value) === normalizado,
          )?.value ||
          valor ||
          'Usuario Completo'
        );
      };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const uid = document.getElementById('uid').value.trim();
        const nome = document.getElementById('nome').value.trim();
        const email = document.getElementById('email').value.trim();
        const emailExpedicaoRaw = document
          .getElementById('emailExpedicao')
          .value.trim();
        const gestoresEmails = emailExpedicaoRaw
          .split(',')
          .map((e) => e.trim())
          .filter((e) => e);
        if (gestoresEmails.length > 2) {
          alert('Informe no m치ximo 2 e-mails de gestores de expedi칞칚o.');
          return;
        }
        const perfil = perfilSelect.value;

        if (uid && nome && email) {
          const { encryptString } = await import('./crypto.js');
          const pass = getPassphrase() || `chave-${uid}`;
          await db
            .collection('uid')
            .doc(uid)
            .set({
              uid,
              email,
              responsavelExpedicaoEmail: gestoresEmails[0] || null,
              gestoresExpedicaoEmails: gestoresEmails,
              encrypted: await encryptString(
                JSON.stringify({ nome, perfil }),
                pass,
              ),
            });
          await db
            .collection('usuarios')
            .doc(uid)
            .set({ perfil, email }, { merge: true });
          alert('Usu치rio salvo com sucesso!');
          carregarUsuarios();
        }
      });

      async function carregarUsuarios() {
        lista.innerHTML = '';
        const { decryptString } = await import('./crypto.js');
        const snapshot = await db.collection('usuarios').get();
        for (const userDoc of snapshot.docs) {
          const userInfo = userDoc.data();
          const uidSnap = await db.collection('uid').doc(userDoc.id).get();
          let nome = 'N/A';
          let perfil = userInfo.perfil || 'N/A';
          let respArr = userInfo.gestoresExpedicaoEmails || [];
          let resp = respArr.length
            ? respArr.join(', ')
            : userInfo.responsavelExpedicaoEmail || 'N/A';
          if (uidSnap.exists) {
            const uidData = uidSnap.data();
            const enc = uidData.encrypted;
            if (enc) {
              const pass = getPassphrase() || `chave-${userDoc.id}`;
              const dec = JSON.parse(await decryptString(enc, pass));
              nome = dec.nome || nome;
              perfil = perfil || dec.perfil || perfil;
            }
            if (!respArr.length) {
              respArr = uidData.gestoresExpedicaoEmails || [];
              resp = respArr.length
                ? respArr.join(', ')
                : uidData.responsavelExpedicaoEmail || resp;
            }
          }
          const emailRaw = userInfo.email || '';
          const email = emailRaw || 'N/A';
          const item = document.createElement('li');
          item.className =
            'p-2 bg-gray-50 border rounded flex justify-between items-center';
          const infoSpan = document.createElement('span');
          infoSpan.innerText = `UID: ${userDoc.id} | Email: ${email} | Resp Exp: ${resp} | Nome: ${nome} | Perfil: ${perfil}`;
          const btnContainer = document.createElement('div');
          btnContainer.className = 'flex space-x-2';
          const editBtn = document.createElement('button');
          editBtn.className = 'bg-yellow-500 text-white px-2 py-1 rounded';
          editBtn.innerText = 'Editar';
          editBtn.addEventListener('click', () => {
            document.getElementById('uid').value = userDoc.id;
            document.getElementById('nome').value = nome === 'N/A' ? '' : nome;
            document.getElementById('email').value = emailRaw;
            document.getElementById('emailExpedicao').value = respArr.join(', ');
            perfilSelect.value = obterValorSelectPerfil(perfil);
          });
          const delBtn = document.createElement('button');
          delBtn.className = 'bg-red-500 text-white px-2 py-1 rounded';
          delBtn.innerText = 'Excluir';
          delBtn.addEventListener('click', async () => {
            if (confirm('Deseja excluir este usu치rio?')) {
              await db.collection('usuarios').doc(userDoc.id).delete();
              await db.collection('uid').doc(userDoc.id).delete().catch(() => {});
              alert('Usu치rio exclu칤do com sucesso!');
              carregarUsuarios();
            }
          });
          btnContainer.appendChild(editBtn);
          btnContainer.appendChild(delBtn);
          item.appendChild(infoSpan);
          item.appendChild(btnContainer);
          lista.appendChild(item);
        }
      }

      carregarUsuarios();
    </script>
  </body>
</html>
