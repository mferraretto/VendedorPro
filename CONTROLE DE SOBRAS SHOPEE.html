<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Sobras - Shopee Premium</title>
  <!-- Meta tag para CSP (Content Security Policy) -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' 
  https://*.firebaseio.com 
  https://*.googleapis.com 
  https://*.google.com 
  https://*.gstatic.com 
  https://cdnjs.cloudflare.com 
  https://cdn.jsdelivr.net 
  'unsafe-eval' 
  'unsafe-inline'
">  
  <!-- Bibliotecas CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Bibliotecas JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    :root {
      --primary: #4a6bff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background: #f4f4f4;
      color: #333;
      margin: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    h2, h3, h4 {
      color: var(--primary);
      margin-top: 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    
    th, td {
      border: 1px solid #dee2e6;
      padding: 12px;
      text-align: center;
    }
    
    th {
      background: var(--primary);
      color: white;
      position: sticky;
      top: 0;
    }
    
    .aba {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .ativa { display: block; }
    
    .aba-btn {
      margin: 5px 10px 5px 0;
      padding: 10px 20px;
      cursor: pointer;
      background: white;
      border: 2px solid var(--primary);
      color: var(--primary);
      border-radius: 5px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .aba-btn:hover, .aba-btn.active {
      background: var(--primary);
      color: white;
    }
    
    .aba-btn.active {
      box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.3);
    }
    
    .editInput {
      display: none;
      width: 100px;
      padding: 5px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    
    .info-box {
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid var(--primary);
    }
    
    .alert {
      padding: 10px 15px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid var(--success);
    }
    
    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid var(--danger);
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #3a56d4;
      transform: translateY(-1px);
    }
    
    .btn-outline-primary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    .btn-outline-primary:hover {
      background: #f0f4ff;
    }
    
    .form-control {
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      margin-right: 10px;
      width: 200px;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    .badge {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-success {
      background: var(--success);
      color: white;
    }
    
    .badge-warning {
      background: var(--warning);
      color: white;
    }
    
    .badge-danger {
      background: var(--danger);
      color: white;
    }
    
    .badge-info {
      background: #17a2b8;
      color: white;
    }
    
    .badge-secondary {
      background: var(--gray);
      color: white;
    }
    
    .chart-container {
      margin: 30px 0;
      height: 300px;
    }
    
    .history-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    
    .history-item:last-child {
      border-bottom: none;
    }
    
    .history-date {
      color: var(--gray);
      font-size: 12px;
    }
    
    .connection-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
    }
    
    .online { 
      background: var(--success);
      color: white;
    }
    
    .offline { 
      background: var(--danger);
      color: white;
    }
    
    .error-box {
      background: #ffebee;
      border-left: 4px solid #f44336;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      th, td {
        padding: 8px;
        font-size: 14px;
      }
      
      .form-control {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .aba-btn {
        display: block;
        width: 100%;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <nav class="bg-gray-800 text-white p-4 flex flex-wrap justify-center space-x-4 mb-4 rounded">
    <a href="index.html" class="hover:underline">Início</a>
    <a href="Gerenciamento%20de%20ANUNCIOS%20E%20DESEMPENHO.html" class="hover:underline">Anúncios</a>
    <a href="CONTROLE%20DE%20SOBRAS%20SHOPEE.html" class="hover:underline">Sobras</a>
    <a href="SISTEMA%20DE%20CUSTEIO%20DE%20PRODUÇÃO%20E%20PRODUTOS.html" class="hover:underline">Custeio</a>
  </nav>
<div class="container">
  <!-- Alertas e status de conexão -->
  <div id="alertSuccess" class="alert alert-success"></div>
  <div id="alertError" class="alert alert-danger"></div>
  <div id="firebase-error" class="error-box">
    <h3><i class="fas fa-exclamation-triangle"></i> Erro de Conexão com o Firebase</h3>
    <p id="error-message"></p>
    <button onclick="verificarConexao()" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Tentar Reconectar</button>
  </div>
  
  <h2><i class="fas fa-check-circle"></i> Mentoria Ferraretto - Conferência de Sobras</h2>
  
  <!-- Barra de navegação por abas -->
  <button class="aba-btn active" onclick="trocarAba('importar')"><i class="fas fa-box-open"></i> Conferir Pedidos</button>
  <button class="aba-btn" onclick="trocarAba('metas')"><i class="fas fa-bullseye"></i> Metas por SKU</button>
  <button class="aba-btn" onclick="trocarAba('graficos')"><i class="fas fa-chart-bar"></i> Gráficos</button>
  <button class="aba-btn" onclick="trocarAba('produtos')"><i class="fas fa-box"></i> Produtos</button>
  <button class="aba-btn" onclick="trocarAba('historico')"><i class="fas fa-history"></i> Histórico</button>
  

  <!-- Aba de Importação/Conferência -->
  <div id="importar" class="aba ativa">
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> Importe o relatório de pedidos da Shopee para calcular automaticamente as sobras e comparar com suas metas cadastradas.</p>
    </div>
    
    <div style="margin: 15px 0;">
      <input type="file" id="inputExcel" accept=".xlsx, .xls" class="form-control" />
      <button onclick="processarPlanilha()" class="btn btn-primary" id="btnProcessar">
        <span id="btnProcessarText"><i class="fas fa-cogs"></i> Processar Planilha</span>
      </button>
    </div>
    
    <div style="margin: 15px 0;">
      <label><strong><i class="fas fa-filter"></i> Filtrar por SKU:</strong></label>
      <select id="tipoFiltro" onchange="filtrarPorSKU()" class="form-control" style="width: auto; display: inline-block;">
        <option value="exata">Correspondência Exata</option>
        <option value="comeca">Começa com</option>
        <option value="contem">Contém</option>
      </select>
      <input type="text" id="filtroSKU" oninput="filtrarPorSKU()" placeholder="Digite o SKU..." class="form-control" style="width: 250px; display: inline-block;" />
      <button onclick="limparFiltros()" class="btn btn-outline-primary"><i class="fas fa-times"></i> Limpar</button>
    </div>
    
    <div style="overflow-x: auto;">
      <table id="resultado">
        <thead>
          <tr>
            <th>ID do Pedido</th>
            <th>SKU</th>
            <th>Subtotal</th>
            <th>Reembolso</th>
            <th>Cupom</th>
            <th>Comissão</th>
            <th>Serviço</th>
            <th>Sobra</th>
            <th>% vs Meta</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="totalSobra" style="margin-top: 20px;"></div>
    
    <div style="margin-top: 20px;">
      <button onclick="exportarCSV()" class="btn btn-primary"><i class="fas fa-file-export"></i> Exportar CSV</button>
      <button onclick="exportarJSON()" class="btn btn-outline-primary"><i class="fas fa-file-code"></i> Exportar JSON</button>
    </div>
  </div>

  <!-- Aba de Metas -->
  <div id="metas" class="aba">
    <h3><i class="fas fa-bullseye"></i> Metas de Sobra por SKU</h3>
    
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> Cadastre metas de sobra para cada SKU. O sistema irá comparar automaticamente o desempenho real com a meta estabelecida.</p>
    </div>
    
    <div style="margin: 15px 0;">
       <input type="text" id="metaSku" list="listaSkus" placeholder="SKU do Produto" class="form-control" />
      <datalist id="listaSkus"></datalist>
      <span id="precoMinimoInfo" style="margin-left:10px;color:#28a745;"></span>
      <input type="number" id="metaValor" placeholder="Sobra Esperada (R$)" step="0.01" class="form-control" />
      <button onclick="adicionarMeta()" class="btn btn-primary" id="btnAdicionarMeta">
        <i class="fas fa-plus"></i> Adicionar Meta
      </button>
    </div>
    
    <div style="overflow-x: auto;">
      <table id="tabelaMetas">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Preço Mínimo</th>
            <th>Meta R$</th>
            <th>Última Atualização</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Aba de Gráficos -->
  <div id="graficos" class="aba">
    <h3><i class="fas fa-chart-bar"></i> Gráficos de Desempenho</h3>
    
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> Visualize gráficos comparativos entre o desempenho real e as metas estabelecidas.</p>
    </div>
    
    <div style="margin: 15px 0;">
      <select id="filtroGrafico" class="form-control" style="width: 300px;">
        <option value="top10">Top 10 SKUs com maior diferença</option>
        <option value="bottom10">Top 10 SKUs com menor diferença</option>
        <option value="all">Todos os SKUs</option>
      </select>
      <button onclick="atualizarGraficos()" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>
    
    <div class="chart-container">
      <canvas id="graficoBarras"></canvas>
    </div>
    
    <div class="chart-container">
      <canvas id="graficoPizza"></canvas>
    </div>
  </div>
 <div id="produtos" class="tab-content p-4">
      <div class="bg-white rounded-xl p-6 shadow mb-6">
        <h2 class="text-2xl font-bold mb-6"><i class="fas fa-boxes"></i> Produtos Salvos</h2>
        
        <div class="import-export-section">
          <h3 class="text-xl font-bold mb-4"><i class="fas fa-file-import"></i> Importar/Exportar Promoções Shopee</h3>
          
          <div class="flex flex-wrap gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Importar Planilha Shopee:</label>
              <input type="file" id="shopeeFileInput" accept=".xlsx,.xls" class="border p-2 rounded-lg">
            </div>
            <button onclick="importShopeeFile()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-medium h-10 mt-auto">
              <i class="fas fa-upload"></i> Importar
            </button>
          </div>
          
          <div id="importedShopeeProducts" class="mt-4" style="display: none;">
            <h4 class="font-semibold mb-2">Produtos importados:</h4>
            <div class="overflow-x-auto">
              <table class="imported-products-table">
                <thead>
                  <tr>
                    <th>ID Produto</th>
                    <th>Nome</th>
                    <th>Parent SKU</th>
                    <th>ID Variação</th>
                    <th>Variação</th>
                    <th>SKU</th>
                    <th>Preço Original</th>
                    <th>Preço Desconto</th>
                  </tr>
                </thead>
                <tbody id="importedProductsTableBody"></tbody>
              </table>
            </div>
            
            <div class="price-update-options">
              <button onclick="applyPriceUpdate('promo')" class="btn-apply-promo">
                <i class="fas fa-tag"></i> Aplicar Sem Lucro (0%)
              </button>
              <button onclick="applyPriceUpdate('medium')" class="btn-apply-medium">
                <i class="fas fa-chart-line"></i> Aplicar Lucro 5%
              </button>
              <button onclick="applyPriceUpdate('ideal')" class="btn-apply-ideal">
                <i class="fas fa-star"></i> Aplicar Lucro 10%
              </button>
              <button onclick="exportShopeeFile()" class="btn-export-shopee ml-auto">
                <i class="fas fa-file-export"></i> Exportar Planilha
              </button>
            </div>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-4 mb-6">
          <button onclick="exportarExcel()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-lg font-medium">
            <i class="fas fa-file-excel"></i> Exportar Excel
          </button>
          <button onclick="exportarPDF()" class="bg-red-600 hover:bg-red-700 text-white px-5 py-3 rounded-lg font-medium">
            <i class="fas fa-file-pdf"></i> Exportar PDF
          </button>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Filtrar por Plataforma:</label>
          <select id="filtroPlataforma" class="border p-3 rounded-lg w-full md:w-1/3">
            <option value="Todas">Todas as Plataformas</option>
            <option value="SHOPEE">Shopee</option>
            <option value="MAGALU">Magalu</option>
            <option value="ML">Mercado Livre</option>
            <option value="SHEIN">SHEIN</option>
          </select>
        </div>
        
        <div id="listaProdutos" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      </div>
    </div>

  <!-- Aba de Histórico -->
  <div id="historico" class="aba">
    <h3><i class="fas fa-history"></i> Histórico de Alterações</h3>
    
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> Registro de todas as alterações nas metas de sobra.</p>
    </div>
    
    <div style="margin: 15px 0;">
      <input type="text" id="filtroHistorico" placeholder="Filtrar por SKU..." class="form-control" style="width: 300px;" oninput="filtrarHistorico()" />
    </div>
    
    <div id="listaHistorico" style="border: 1px solid #eee; border-radius: 5px; max-height: 500px; overflow-y: auto;"></div>
  </div>
</div>

<!-- Status de conexão -->
<div id="connectionStatus" class="connection-status offline">Offline - Trabalhando localmente</div>

<script>
  // =============================================
  // CONFIGURAÇÃO INICIAL E VARIÁVEIS GLOBAIS
  // =============================================
  
  const firebaseConfig = {
  apiKey: "AIzaSyC78l9b2DTNj64y_0fbRKofNupO6NHDmeo",
  authDomain: "matheus-35023.firebaseapp.com",
  projectId: "matheus-35023",
  storageBucket: "matheus-35023.appspot.com",  // Note que mudei de .firebasestorage.app para .appspot.com
  messagingSenderId: "1011113149395",
  appId: "1:1011113149395:web:c1f449e0e974ca8ecb2526",
  databaseURL: "https://matheus-35023.firebaseio.com"
};
  // Variáveis globais
  let db;
  let metas = {};
  let historico = [];
  let produtos = {};
  let pedidosProcessados = [];
  let graficoBarras, graficoPizza;
  let app;

  // =============================================
  // INICIALIZAÇÃO DO FIREBASE E CONFIGURAÇÕES
  // =============================================
  
// Inicialização mais robusta do Firebase
try {
  const app = firebase.initializeApp(firebaseConfig);
  db = firebase.firestore(app);
  const auth = firebase.auth();

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = 'index.html?login=1';
    }
  });
  // Configurações importantes para a conexão
  db.settings({
  experimentalForceLongPolling: true
});
  
  // Habilita persistência offline
  firebase.firestore().enablePersistence()
    .catch((err) => {
      if (err.code == 'failed-precondition') {
        console.warn("Persistência offline não suportada em múltiplas abas");
      } else if (err.code == 'unimplemented') {
        console.warn("Persistência offline não disponível no navegador");
      }
    });
  
  // Verifica conexão
  verificarConexao();
  
} catch (error) {
  console.error("Erro ao inicializar Firebase:", error);
  mostrarErroFirebase(error);
}

  // Carrega dados iniciais
 document.addEventListener('DOMContentLoaded', async function() {
    await carregarProdutos();
    await carregarMetas();
    carregarHistorico();
  });

  // =============================================
  // FUNÇÕES DE GERENCIAMENTO DE CONEXÃO
  // =============================================
  
  function verificarConexao() {
  firebase.firestore().enableNetwork()
    .then(() => {
      console.log("Conectado ao Firestore");
      document.getElementById('connectionStatus').className = 'connection-status online';
      document.getElementById('connectionStatus').textContent = 'Online';
    })
    .catch((error) => {
      console.error("Erro de conexão:", error);
      document.getElementById('connectionStatus').className = 'connection-status offline';
      document.getElementById('connectionStatus').textContent = 'Offline';
    });
}

  function mostrarErroFirebase(error) {
    const errorBox = document.getElementById('firebase-error');
    const errorMessage = document.getElementById('error-message');
    
    errorMessage.innerHTML = `<strong>${error.message}</strong><br>(Código: ${error.code})`;
    errorBox.style.display = 'block';
    
    console.error("Erro Firebase:", error);
  }

  function updateConnectionStatus(online) {
    const statusElement = document.getElementById('connectionStatus');
    
    if (online) {
      statusElement.textContent = 'Online';
      statusElement.className = 'connection-status online';
    } else {
      statusElement.textContent = 'Offline - Trabalhando localmente';
      statusElement.className = 'connection-status offline';
    }
  }

  // =============================================
  // FUNÇÕES UTILITÁRIAS
  // =============================================
  
  function mostrarSucesso(mensagem) {
    const alerta = document.getElementById('alertSuccess');
    alerta.innerHTML = `<i class="fas fa-check-circle"></i> ${mensagem}`;
    alerta.style.display = 'block';
    
    setTimeout(() => {
      alerta.style.display = 'none';
    }, 5000);
  }

  function mostrarErro(mensagem) {
    const alerta = document.getElementById('alertError');
    alerta.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${mensagem}`;
    alerta.style.display = 'block';
    
    setTimeout(() => {
      alerta.style.display = 'none';
    }, 5000);
  }

  function toggleLoading(botao, texto) {
    const btnText = botao.querySelector('span') || botao;
    if (botao.classList.contains('loading')) {
      botao.classList.remove('loading');
      btnText.innerHTML = texto;
    } else {
      botao.classList.add('loading');
      btnText.innerHTML = '<div class="loading"></div> Carregando...';
    }
  }

  async function executarComRetry(operacao, maxTentativas = 3, delay = 1000) {
    let tentativas = 0;
    
    while (tentativas < maxTentativas) {
      try {
        return await operacao();
      } catch (error) {
        tentativas++;
        if (tentativas >= maxTentativas) throw error;
        
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2; // Aumenta o delay exponencialmente
      }
    }
  }
 function atualizarPrecoMinimo() {
    const sku = document.getElementById('metaSku').value.trim();
    const preco = produtos[sku];
    const info = document.getElementById('precoMinimoInfo');
    if (!info) return;
    if (preco) {
      info.textContent = `Preço Mínimo: R$ ${parseFloat(preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
    } else {
      info.textContent = '';
    }
  }

  // =============================================
  // FUNÇÕES DE NAVEGAÇÃO E INTERFACE
  // =============================================
  
  function trocarAba(id) {
    document.querySelectorAll('.aba').forEach(aba => aba.classList.remove('ativa'));
    document.querySelectorAll('.aba-btn').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(id).classList.add('ativa');
    document.querySelector(`.aba-btn[onclick="trocarAba('${id}')"]`).classList.add('active');
    
    if (id === 'graficos') {
      setTimeout(atualizarGraficos, 100);
    }
  }

  // =============================================
  // FUNÇÕES DE GERENCIAMENTO DE METAS
  // =============================================
   async function carregarProdutos() {
    try {
      const snapshot = await db.collection("products").get();
      produtos = {};
      const datalist = document.getElementById('listaSkus');
      if (datalist) datalist.innerHTML = '';

      snapshot.forEach(doc => {
        const data = doc.data();
        if (!data.sku) return;
        produtos[data.sku] = data.precoMinimo;
        if (datalist) {
          const opt = document.createElement('option');
          const preco = data.precoMinimo ? parseFloat(data.precoMinimo).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '0.00';
          opt.value = data.sku;
          opt.label = `${data.sku} - R$ ${preco}`;
          datalist.appendChild(opt);
        }
      });
    } catch (error) {
      console.error('Erro ao carregar produtos:', error);
    }
  }

  async function carregarMetas() {
    try {
      toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
      
      return await executarComRetry(async () => {
        metas = {};
        // Carrega SKUs e preço mínimo da coleção de produtos
        const produtosSnap = await db.collection("products").get();
        produtosSnap.forEach((doc) => {
          const data = doc.data();
          if (data.sku && data.precoMinimo !== undefined) {
            metas[data.sku] = {
              valor: parseFloat(data.precoMinimo),
              atualizadoEm: new Date()
            };
          }
        });

        // Sobrepõe com metas salvas manualmente se existirem
        const metasSnap = await db.collection("metasSKU").get();
        metasSnap.forEach((doc) => {
          const originalSku = doc.id.replaceAll('__', '/');
          metas[originalSku] = {
            valor: doc.data().valor,
            atualizadoEm: doc.data().atualizadoEm?.toDate() || new Date()
          };
        });
        
        renderizarMetas();
        return true;
      });
    } catch (error) {
      mostrarErroFirebase(`Erro ao carregar metas: ${error.message}`);
      console.error("Erro ao carregar metas:", error);
      return false;
    } finally {
      toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
    }
  }

  async function carregarHistorico() {
    try {
      return await executarComRetry(async () => {
        historico = [];
        const snapshot = await db.collection("historicoMetas").orderBy("data", "desc").limit(50).get();
        
        snapshot.forEach((doc) => {
          historico.push({
            sku: doc.data().sku,
            acao: doc.data().acao,
            valorAnterior: doc.data().valorAnterior,
            valorNovo: doc.data().valorNovo,
            data: doc.data().data.toDate(),
            usuario: doc.data().usuario || 'Sistema'
          });
        });
        
        renderizarHistorico();
        return true;
      });
    } catch (error) {
      mostrarErroFirebase(`Erro ao carregar histórico: ${error.message}`);
      console.error("Erro ao carregar histórico:", error);
      return false;
    }
  }

  async function registrarHistorico(sku, acao, valorAnterior, valorNovo) {
    try {
      await executarComRetry(async () => {
        await db.collection("historicoMetas").add({
          sku: sku,
          acao: acao,
          valorAnterior: valorAnterior,
          valorNovo: valorNovo,
          data: new Date(),
          usuario: "Usuário" // Em um sistema real, pegaria do auth
        });
        
        // Recarregar histórico após adicionar novo registro
        await carregarHistorico();
        return true;
      });
    } catch (error) {
      console.error("Erro ao registrar histórico:", error);
      throw error;
    }
  }

  function renderizarMetas() {
    const tbody = document.querySelector('#tabelaMetas tbody');
    tbody.innerHTML = '';
    
    if (Object.keys(metas).length === 0) {
     tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma meta cadastrada</td></tr>';
      return;
    }
    
   for (let sku in metas) {
        const meta = metas[sku];
        const precoProduto = produtos[sku];
        const dataFormatada = meta.atualizadoEm ? meta.atualizadoEm.toLocaleDateString('pt-BR') : 'N/A';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${sku}</td>
        <td>${precoProduto ? 'R$ ' + parseFloat(precoProduto).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '-'}</td>
        <td>
          <span class="valorMeta">R$ ${meta.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
          <input class="editInput" type="number" value="${meta.valor}" step="0.01" />
        </td>
        <td>${dataFormatada}</td>
        <td>
          <button onclick="editarMeta(this, '${sku}')" class="btn" style="padding: 5px 8px;"><i class="fas fa-edit"></i></button>
          <button onclick="excluirMeta('${sku}', this)" class="btn" style="padding: 5px 8px;"><i class="fas fa-trash-alt"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderizarHistorico() {
    const lista = document.getElementById('listaHistorico');
    lista.innerHTML = '';
    
    if (historico.length === 0) {
      lista.innerHTML = '<div class="history-item" style="text-align: center;">Nenhum registro histórico encontrado</div>';
      return;
    }
    
    historico.forEach(item => {
      const div = document.createElement('div');
      div.className = 'history-item';
      
      let acaoTexto = '';
      let valorTexto = '';
      
      if (item.acao === 'adicionar') {
        acaoTexto = `<span class="badge badge-success">Adicionado</span>`;
        valorTexto = `Novo valor: R$ ${item.valorNovo?.toFixed(2) || '0.00'}`;
      } else if (item.acao === 'editar') {
        acaoTexto = `<span class="badge badge-warning">Editado</span>`;
        valorTexto = `De R$ ${item.valorAnterior?.toFixed(2) || '0.00'} para R$ ${item.valorNovo?.toFixed(2) || '0.00'}`;
      } else if (item.acao === 'remover') {
        acaoTexto = `<span class="badge badge-danger">Removido</span>`;
        valorTexto = `Valor anterior: R$ ${item.valorAnterior?.toFixed(2) || '0.00'}`;
      }
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${item.sku}</strong> - ${acaoTexto}
            <div>${valorTexto}</div>
          </div>
          <div class="history-date">
            ${item.data.toLocaleDateString('pt-BR')} ${item.data.toLocaleTimeString('pt-BR')}
            <div>Por: ${item.usuario}</div>
          </div>
        </div>
      `;
      
      lista.appendChild(div);
    });
  }

  function filtrarHistorico() {
    const filtro = document.getElementById('filtroHistorico').value.toLowerCase();
    const itens = document.querySelectorAll('.history-item');
    
    itens.forEach(item => {
      const sku = item.querySelector('strong')?.textContent.toLowerCase() || '';
      item.style.display = sku.includes(filtro) ? '' : 'none';
    });
  }

  async function adicionarMeta() {
    const skuInput = document.getElementById('metaSku');
    const valorInput = document.getElementById('metaValor');
    
    const sku = skuInput.value.trim();
    const valor = parseFloat(valorInput.value);
    
    if (!sku) {
      mostrarErro('Por favor, informe o SKU do produto.');
      skuInput.focus();
      return;
    }
    
    if (isNaN(valor) || valor <= 0) {
      mostrarErro('Por favor, informe um valor válido para a meta (maior que zero).');
      valorInput.focus();
      return;
    }
    
    try {
      toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
      
      const safeSku = sku.replaceAll('/', '__');
      const metaData = {
        valor: valor,
        atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      await executarComRetry(async () => {
        await db.collection("metasSKU").doc(safeSku).set(metaData);
        return true;
      });
      
      // Atualizar localmente
      metas[sku] = {
        valor: valor,
        atualizadoEm: new Date()
      };
      
      // Registrar no histórico
      await registrarHistorico(sku, 'adicionar', null, valor);
      
      renderizarMetas();
      
      skuInput.value = '';
      valorInput.value = '';
      
      mostrarSucesso(`Meta para o SKU ${sku} adicionada com sucesso!`);
      
      // Atualizar gráficos se estiver na aba
      if (document.getElementById('graficos').classList.contains('ativa')) {
        atualizarGraficos();
      }
    } catch (error) {
      mostrarErro(`Erro ao adicionar meta: ${error.message}`);
      console.error("Erro ao adicionar meta:", error);
    } finally {
      toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
    }
  }

  async function editarMeta(botao, sku) {
    const tr = botao.closest('tr');
    const span = tr.querySelector('.valorMeta');
    const input = tr.querySelector('.editInput');
    const icon = botao.querySelector('i');
    
    if (input.style.display === 'none') {
      // Iniciar edição
      input.style.display = 'inline-block';
      span.style.display = 'none';
      icon.className = 'fas fa-save';
      input.focus();
    } else {
      // Salvar edição
      const novoValor = parseFloat(input.value);
      
      if (isNaN(novoValor) || novoValor <= 0) {
        mostrarErro('Por favor, informe um valor válido para a meta (maior que zero).');
        input.focus();
        return;
      }
      
      try {
        icon.className = 'fas fa-spinner fa-spin';
        
        const valorAnterior = metas[sku].valor;
        const safeSku = sku.replaceAll('/', '__');
        const metaData = {
          valor: novoValor,
          atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await executarComRetry(async () => {
          await db.collection("metasSKU").doc(safeSku).set(metaData);
          return true;
        });
        
        // Atualizar localmente
        metas[sku] = {
          valor: novoValor,
          atualizadoEm: new Date()
        };
        
        // Registrar no histórico
        await registrarHistorico(sku, 'editar', valorAnterior, novoValor);
        
        renderizarMetas();
        mostrarSucesso(`Meta para o SKU ${sku} atualizada com sucesso!`);
        
        // Atualizar gráficos se estiver na aba
        if (document.getElementById('graficos').classList.contains('ativa')) {
          atualizarGraficos();
        }
      } catch (error) {
        mostrarErro(`Erro ao editar meta: ${error.message}`);
        console.error("Erro ao editar meta:", error);
        // Reverter visualmente
        input.value = metas[sku].valor;
      } finally {
        input.style.display = 'none';
        span.style.display = 'inline-block';
        icon.className = 'fas fa-edit';
      }
    }
  }

  async function excluirMeta(sku, botao) {
    if (!confirm(`Tem certeza que deseja excluir a meta do SKU ${sku}?`)) {
      return;
    }
    
    try {
      const icon = botao.querySelector('i');
      icon.className = 'fas fa-spinner fa-spin';
      
      const valorAnterior = metas[sku].valor;
      const safeSku = sku.replaceAll('/', '__');
      
      await executarComRetry(async () => {
        await db.collection("metasSKU").doc(safeSku).delete();
        return true;
      });
      
      // Remover localmente
      delete metas[sku];
      
      // Registrar no histórico
      await registrarHistorico(sku, 'remover', valorAnterior, null);
      
      renderizarMetas();
      mostrarSucesso(`Meta para o SKU ${sku} removida com sucesso!`);
      
      // Atualizar gráficos se estiver na aba
      if (document.getElementById('graficos').classList.contains('ativa')) {
        atualizarGraficos();
      }
    } catch (error) {
      mostrarErro(`Erro ao excluir meta: ${error.message}`);
      console.error("Erro ao excluir meta:", error);
    }
  }

  // =============================================
  // FUNÇÕES DE PROCESSAMENTO DE PEDIDOS
  // =============================================
  
  function processarPlanilha() {
    const fileInput = document.getElementById('inputExcel');
    const file = fileInput.files[0];
    
    if (!file) {
      mostrarErro('Por favor, selecione um arquivo antes de processar.');
      return;
    }
    
    try {
      toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const pedidos = XLSX.utils.sheet_to_json(sheet);
          
          processarPedidos(pedidos);
        } catch (error) {
          mostrarErro(`Erro ao ler o arquivo: ${error.message}`);
          console.error("Erro ao ler arquivo:", error);
        } finally {
          toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
        }
      };
      
      reader.onerror = function() {
        mostrarErro('Erro ao ler o arquivo. Por favor, tente novamente.');
        toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
      };
      
      reader.readAsArrayBuffer(file);
    } catch (error) {
      mostrarErro(`Erro ao processar o arquivo: ${error.message}`);
      console.error("Erro ao processar arquivo:", error);
      toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
    }
  }

  function processarPedidos(pedidos) {
    const contagem = {};
    pedidos.forEach(p => {
      const id = p['ID do pedido'];
      if (id) contagem[id] = (contagem[id] || 0) + 1;
    });

    const tbody = document.querySelector('#resultado tbody');
    tbody.innerHTML = '';
    let totalSobra = 0, totalPercentual = 0, totalPedidos = 0;
    
    pedidosProcessados = [];

    pedidos.forEach(p => {
      const id = p['ID do pedido'];
      if (!id || contagem[id] > 1) return;

      const sku = p['Número de referência SKU'] || '';
      const status = (p['Status do pedido'] || '').toLowerCase();
      if (!sku || status.includes('cancelado') || status.includes('não pago')) return;

      const subtotal = parseFloat(p['Subtotal do produto']) || 0;
      const reembolso = parseFloat(p['Reembolso Shopee']) || 0;
      const cupom = parseFloat(p['Cupom do vendedor']) || 0;
      const comissao = parseFloat(p['Taxa de comissão']) || 0;
      const servico = parseFloat(p['Taxa de serviço']) || 0;
      const sobra = subtotal + reembolso - cupom - comissao - servico;
      const meta = metas[sku]?.valor || 0;
      const percentual = meta ? ((sobra - meta) / meta) * 100 : 0;
      
      const pedidoData = {
        id, sku, subtotal, reembolso, cupom, comissao, servico, sobra, meta, percentual, status
      };
      
      pedidosProcessados.push(pedidoData);

      const tr = document.createElement('tr');
      
      // Determinar classe CSS baseada no desempenho
      let statusClass = '';
      let statusText = '';
      
      if (meta) {
        if (percentual <= -10) {
          statusClass = 'danger';
          statusText = 'Crítico';
        } else if (percentual <= -5) {
          statusClass = 'warning';
          statusText = 'Atenção';
        } else if (percentual >= 5) {
          statusClass = 'success';
          statusText = 'Bom';
        } else {
          statusClass = 'info';
          statusText = 'Normal';
        }
      } else {
        statusClass = 'secondary';
        statusText = 'Sem meta';
      }

      tr.innerHTML = `
        <td>${id}</td>
        <td>${sku}</td>
        <td>R$ ${subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td>R$ ${reembolso.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td>R$ ${cupom.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td>R$ ${comissao.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td>R$ ${servico.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td><strong>R$ ${sobra.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong><br><small>Meta: R$ ${meta.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</small></td>
        <td>${percentual.toFixed(2)}%</td>
        <td><span class="badge badge-${statusClass}">${statusText}</span></td>
      `;
      
      tbody.appendChild(tr);

      totalSobra += sobra;
      totalPercentual += percentual;
      totalPedidos++;
    });

    // Calcular total esperado com base na quantidade de pedidos por SKU
    const linhas = document.querySelectorAll("#resultado tbody tr");
    let esperadoTotal = 0;
    linhas.forEach(l => {
      const sku = l.children[1].textContent.trim();
      if (metas[sku]) esperadoTotal += metas[sku].valor;
    });
  
    const media = totalPedidos ? (totalPercentual / totalPedidos).toFixed(2) : '0.00';
    const diferencaTotal = totalSobra - esperadoTotal;
    const diferencaPercentual = esperadoTotal ? (diferencaTotal / esperadoTotal) * 100 : 0;

    let diferencaHTML = '';
    if (esperadoTotal > 0) {
      const diferencaClass = diferencaTotal >= 0 ? 'success' : 'danger';
      diferencaHTML = `
        <h4>
          <span class="badge badge-${diferencaClass}">
            Diferença Total: R$ ${Math.abs(diferencaTotal).toLocaleString('pt-BR', { minimumFractionDigits: 2 })} 
            (${diferencaPercentual.toFixed(2)}%)
            ${diferencaTotal >= 0 ? 'acima' : 'abaixo'} da meta
          </span>
        </h4>
      `;
    }

    document.getElementById('totalSobra').innerHTML = `
      <div class="info-box">
        <h3><i class="fas fa-coins"></i> Sobra Total: R$ ${totalSobra.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h3>
        <h3><i class="fas fa-bullseye"></i> Sobra Total Esperada: R$ ${esperadoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h3>
        ${diferencaHTML}
        <h4><i class="fas fa-chart-line"></i> Média de Desempenho vs Meta: ${media}%</h4>
      </div>
    `;
    
    // Atualizar gráficos se estiver na aba
    if (document.getElementById('graficos').classList.contains('ativa')) {
      atualizarGraficos();
    }
  }

  function filtrarPorSKU() {
    const filtro = document.getElementById("filtroSKU").value.toLowerCase();
    const tipo = document.getElementById("tipoFiltro").value;
    const linhas = document.querySelectorAll("#resultado tbody tr");
    
    linhas.forEach(linha => {
      const sku = linha.children[1].textContent.toLowerCase();

      if (!filtro) {
        linha.style.display = "";
        return;
      }

      if (tipo === "exata") {
        linha.style.display = sku === filtro ? "" : "none";
      } else if (tipo === "comeca") {
        linha.style.display = sku.startsWith(filtro) ? "" : "none";
      } else if (tipo === "contem") {
        linha.style.display = sku.includes(filtro) ? "" : "none";
      }
    });
  }

  function limparFiltros() {
    document.getElementById("filtroSKU").value = "";
    filtrarPorSKU();
  }

  // =============================================
  // FUNÇÕES DE GRÁFICOS
  // =============================================
  
  function atualizarGraficos() {
    if (pedidosProcessados.length === 0) {
      document.querySelectorAll('.chart-container').forEach(container => {
        container.innerHTML = '<p style="text-align: center; color: var(--gray);">Nenhum dado disponível para exibir gráficos. Processe um arquivo primeiro.</p>';
      });
      return;
    }
    
    const tipoFiltro = document.getElementById('filtroGrafico').value;
    let dados = agruparPorSKU(pedidosProcessados);
    
    // Aplicar filtro
    if (tipoFiltro === 'top10') {
      dados.sort((a, b) => b.diferencaPercentual - a.diferencaPercentual);
      dados = dados.slice(0, 10);
    } else if (tipoFiltro === 'bottom10') {
      dados.sort((a, b) => a.diferencaPercentual - b.diferencaPercentual);
      dados = dados.slice(0, 10);
    }
    
    criarGraficoBarras(dados);
    criarGraficoPizza(dados);
  }

  function agruparPorSKU(pedidos) {
    const agrupados = {};
    
    pedidos.forEach(pedido => {
      if (!agrupados[pedido.sku]) {
        agrupados[pedido.sku] = {
          sku: pedido.sku,
          totalSobra: 0,
          totalMeta: 0,
          quantidade: 0
        };
      }
      
      agrupados[pedido.sku].totalSobra += pedido.sobra;
      agrupados[pedido.sku].totalMeta += pedido.meta || 0;
      agrupados[pedido.sku].quantidade += 1;
    });
    
    // Converter para array e calcular diferenças
    return Object.values(agrupados).map(item => {
      const diferenca = item.totalSobra - item.totalMeta;
      const diferencaPercentual = item.totalMeta ? (diferenca / item.totalMeta) * 100 : 0;
      
      return {
        ...item,
        diferenca,
        diferencaPercentual
      };
    });
  }

  function criarGraficoBarras(dados) {
    const ctx = document.getElementById('graficoBarras').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (graficoBarras) {
      graficoBarras.destroy();
    }
    
    // Preparar dados
    const labels = dados.map(item => item.sku);
    const sobras = dados.map(item => item.totalSobra);
    const metas = dados.map(item => item.totalMeta);
    
    graficoBarras = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Sobra Real (R$)',
            data: sobras,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Meta Esperada (R$)',
            data: metas,
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Valor (R$)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'SKU'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Comparação entre Sobra Real e Meta por SKU'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                label += 'R$ ' + context.raw.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                return label;
              }
            }
          }
        }
      }
    });
  }

  function criarGraficoPizza(dados) {
    const ctx = document.getElementById('graficoPizza').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (graficoPizza) {
      graficoPizza.destroy();
    }
    
    // Preparar dados - vamos mostrar a diferença percentual
    const labels = dados.map(item => item.sku);
    const diferencas = dados.map(item => item.diferencaPercentual);
    
    // Criar cores baseadas no desempenho
    const backgroundColors = diferencas.map(val => {
      if (val >= 5) return 'rgba(75, 192, 192, 0.7)'; // Verde - acima
      if (val <= -5) return 'rgba(255, 99, 132, 0.7)'; // Vermelho - abaixo
      return 'rgba(255, 206, 86, 0.7)'; // Amarelo - dentro do esperado
    });
    
    graficoPizza = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: diferencas,
          backgroundColor: backgroundColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Desempenho vs Meta por SKU (%)'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                return `${label}: ${value.toFixed(2)}%`;
              }
            }
          }
        }
      }
    });
  }

  // =============================================
  // FUNÇÕES DE EXPORTAÇÃO
  // =============================================
  
  function exportarCSV() {
    if (pedidosProcessados.length === 0) {
      mostrarErro('Nenhum dado disponível para exportar. Processe um arquivo primeiro.');
      return;
    }
    
    try {
      // Cabeçalhos
      let csv = 'ID do Pedido;SKU;Subtotal;Reembolso;Cupom;Comissão;Serviço;Sobra;Meta;% vs Meta;Status\n';
      
      // Dados
      pedidosProcessados.forEach(pedido => {
        const status = pedido.meta ? 
          (pedido.percentual <= -10 ? 'Crítico' : 
           pedido.percentual <= -5 ? 'Atenção' : 
           pedido.percentual >= 5 ? 'Bom' : 'Normal') : 'Sem meta';
        
        csv += `"${pedido.id}";"${pedido.sku}";"${pedido.subtotal.toFixed(2)}";"${pedido.reembolso.toFixed(2)}";"${pedido.cupom.toFixed(2)}";"${pedido.comissao.toFixed(2)}";"${pedido.servico.toFixed(2)}";"${pedido.sobra.toFixed(2)}";"${pedido.meta.toFixed(2)}";"${pedido.percentual.toFixed(2)}";"${status}"\n`;
      });
      
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, `relatorio_sobras_${new Date().toISOString().slice(0,10)}.csv`);
      
      mostrarSucesso('Arquivo CSV exportado com sucesso!');
    } catch (error) {
      mostrarErro(`Erro ao exportar CSV: ${error.message}`);
      console.error("Erro ao exportar CSV:", error);
    }
  }

  function exportarJSON() {
    if (pedidosProcessados.length === 0) {
      mostrarErro('Nenhum dado disponível para exportar. Processe um arquivo primeiro.');
      return;
    }
    
    try {
      const data = {
        geradoEm: new Date().toISOString(),
        pedidos: pedidosProcessados,
        resumo: {
          totalSobra: pedidosProcessados.reduce((sum, p) => sum + p.sobra, 0),
          totalMeta: pedidosProcessados.reduce((sum, p) => sum + (p.meta || 0), 0)
        }
      };
      
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
      saveAs(blob, `relatorio_sobras_${new Date().toISOString().slice(0,10)}.json`);
      
      mostrarSucesso('Arquivo JSON exportado com sucesso!');
    } catch (error) {
      mostrarErro(`Erro ao exportar JSON: ${error.message}`);
      console.error("Erro ao exportar JSON:", error);
    }
  }
  
    function atualizarLista() {
      const filtro = document.getElementById("filtroPlataforma").value;
      const container = document.getElementById("listaProdutos");
      
      container.innerHTML = "";
      
      const listaFiltrada = filtro === "Todas" ? 
          sistema.produtos : 
          sistema.produtos.filter(item => item.plataforma === filtro);
      
      if (listaFiltrada.length === 0) {
        container.innerHTML = `
          <div class="col-span-2 text-center py-10">
            <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-medium text-gray-500">Nenhum produto encontrado</h3>
            <p class="text-gray-400">Adicione produtos na aba de Precificação</p>
          </div>
        `;
        return;
      }
      
      listaFiltrada.forEach(item => {
        const div = document.createElement("div");
        div.className = "product-card";
        
        // Determinar classe de cor para a plataforma
        let platformClass = "";
        let platformName = "";
        switch(item.plataforma) {
          case "ML":
            platformClass = "platform-ml";
            platformName = "Mercado Livre";
            break;
          case "SHOPEE":
            platformClass = "platform-shopee";
            platformName = "Shopee";
            break;
          case "MAGALU":
            platformClass = "platform-magalu";
            platformName = "Magalu";
            break;
          case "SHEIN":
            platformClass = "platform-shein";
            platformName = "SHEIN";
            break;
        }
        
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-bold text-lg">${item.produto}</h3>
              ${item.sku ? `<div class="text-sm text-gray-500">SKU: ${item.sku}</div>` : ''}
              <div class="mt-1">
                <span class="${platformClass} platform-tag">${platformName}</span>
              </div>
            </div>
            <div class="text-right">
              <div class="text-gray-500 text-sm">Preço mínimo</div>
              <div class="product-price text-green-600">R$ ${parseFloat(item.precoMinimo).toFixed(2)}</div>
            </div>
          </div>
          
          <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between">
            <div class="text-sm text-gray-500">
              <i class="far fa-calendar-alt"></i> ${new Date(item.createdAt).toLocaleDateString('pt-BR')}
            </div>
            <div class="flex space-x-2">
              <button onclick="verDetalhes('${item.id}')" class="btn-action btn-view">
                <i class="fas fa-eye"></i> Ver
              </button>
              <button onclick="editarProduto('${item.id}')" class="btn-action btn-edit">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button onclick="excluirProduto('${item.id}')" class="btn-action btn-delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      
      // Atualiza KPIs
      updateKPIs();
    }

    async function verDetalhes(id) {
      const produto = sistema.produtos.find(item => item.id === id);
      
      if (!produto) return;
      
      let html = `
        <h3 class="text-2xl font-bold mb-2">${produto.produto}</h3>
        ${produto.sku ? `<div class="text-gray-600 mb-2">SKU: ${produto.sku}</div>` : ''}
        <div class="flex items-center mb-6">
          <span class="${getPlatformClass(produto.plataforma)} platform-tag mr-3">${getPlatformName(produto.plataforma)}</span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="scenario-card scenario-promo">
            <div class="scenario-title">Sem Lucro (0%)</div>
            <div class="scenario-value">R$ ${produto.precoPromo}</div>
          </div>
          
          <div class="scenario-card scenario-medium">
              <div class="scenario-title">Lucro 5%</div>
            <div class="scenario-value">R$ ${produto.precoMedio}</div>
          </div>
          
          <div class="scenario-card scenario-ideal">
            <div class="scenario-title">Lucro 10%</div>
            <div class="scenario-value">R$ ${produto.precoIdeal}</div>
          </div>
          
          <div class="bg-gray-100 p-4 rounded-lg">
            <div class="font-semibold">Preço Mínimo</div>
            <div class="text-xl font-bold text-green-600">R$ ${produto.precoMinimo}</div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-gray-50 p-5 rounded-xl">
            <h4 class="font-semibold text-lg mb-4 pb-2 border-b">Informações Básicas</h4>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Custo do produto:</span>
                <span class="font-medium">R$ ${produto.custo}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Data de cadastro:</span>
                <span class="font-medium">${new Date(produto.createdAt).toLocaleDateString('pt-BR')}</span>
              </div>
            </div>
          </div>
          
          <div class="bg-gray-50 p-5 rounded-xl">
            <h4 class="font-semibold text-lg mb-4 pb-2 border-b">Detalhes das Taxas</h4>
            <div class="space-y-3">
      `;
      
      for (const [campo, valor] of Object.entries(produto.taxas)) {
        const unidade = campo.includes('%') ? '%' : 'R$';
        html += `
          <div class="flex justify-between">
            <span class="text-gray-600">${campo}:</span>
            <span class="font-medium">${valor} ${unidade}</span>
          </div>
        `;
      }
      
      html += `
            </div>
          </div>
        </div>
        
        <div class="mt-8 text-right">
          <button onclick="fecharModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-lg font-medium">
            Fechar
          </button>
        </div>
      `;
      
      document.getElementById("modalContent").innerHTML = html;
      document.getElementById("detalhesModal").style.display = "block";
    }

    function getPlatformClass(plataforma) {
      switch(plataforma) {
        case "ML": return "platform-ml";
        case "SHOPEE": return "platform-shopee";
        case "MAGALU": return "platform-magalu";
        case "SHEIN": return "platform-shein";
        default: return "";
      }
    }

    function getPlatformName(plataforma) {
      switch(plataforma) {
        case "ML": return "Mercado Livre";
        case "SHOPEE": return "Shopee";
        case "MAGALU": return "Magalu";
        case "SHEIN": return "SHEIN";
        default: return plataforma;
      }
    }

    function editarProduto(id) {
      const produto = sistema.produtos.find(item => item.id === id);
      
      if (!produto) return;
      
      // Preencher campos básicos
      document.getElementById("produto").value = produto.produto;
      document.getElementById("sku").value = produto.sku || '';
      document.getElementById("custo").value = produto.custo;
      
      // Preencher campos específicos da plataforma
      const plataforma = produto.plataforma.toLowerCase();
      
      // Taxa
      document.getElementById(`${plataforma}_taxa_custom`).value = produto.taxas['Taxas da Plataforma (%)'];
      document.getElementById(`${plataforma}_taxa_select`).selectedIndex = -1;
      
      // Fixo
      document.getElementById(`${plataforma}_fixo_custom`).value = produto.taxas['Custo Fixo Plataforma (R$)'];
      document.getElementById(`${plataforma}_fixo_select`).selectedIndex = -1;
      
      // Preencher outros campos
      const container = document.getElementById(`${plataforma}Campos`);
      const inputs = container.querySelectorAll('input[data-campo]');
      inputs.forEach(input => {
        const campo = input.getAttribute('data-campo');
        input.value = produto.taxas[campo] || '';
      });
      
      // Ativar aba de precificação
      document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      document.querySelector(`.tab-button[data-tab="precificacao"]`).classList.add("active");
      document.getElementById('precificacao').classList.add("active");
      
      // Salvar referência do produto que está sendo editado
      sistema.produtoEditando = produto;
      
      // Rolar para o topo
      window.scrollTo(0, 0);
    }

    async function excluirProduto(id) {
      if (!confirm('Tem certeza que deseja excluir este produto permanentemente?')) {
        return;
      }
      
      try {
        await db.collection("products").doc(id).delete();
        
        // Atualizar lista local
        sistema.produtos = sistema.produtos.filter(item => item.id !== id);
        atualizarLista();
        
        // Mostrar feedback visual
        const feedback = document.createElement('div');
        feedback.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
        feedback.innerHTML = `<i class="fas fa-trash-alt mr-2"></i> Produto excluído com sucesso!`;
        document.body.appendChild(feedback);
        
        setTimeout(() => {
          feedback.remove();
        }, 3000);
        
        // Registrar no histórico
        addHistoryEntry('product_delete', `Produto excluído`);
      } catch (error) {
        console.error("Erro ao excluir produto:", error);
        alert("Erro ao excluir produto!");
      }
    }

    function fecharModal() {
      document.getElementById("detalhesModal").style.display = "none";
    }

    function exportarExcel() {
      if (sistema.produtos.length === 0) {
        alert("Nenhum produto para exportar!");
        return;
      }
      
      // Definir cabeçalhos
      const headers = [
        "Produto", 
        "SKU",
        "Plataforma", 
        "Custo (R$)", 
        "Preço Mínimo (R$)", 
        "Preço Ideal (R$)",
        "Preço Médio (R$)",
        "Preço Promo (R$)",
        "Data",
        "Taxas da Plataforma (%)",
        "Custo Fixo Plataforma (R$)",
        "Frete (R$)",
        "Taxa de Transação (%)",
        "Taxa de Transferência (%)",
        "Taxa de Antecipação (%)",
        "Custos Variáveis (R$)",
        "Imposto (%)",
        "Comissão do Vendedor (%)"
      ];
      
      // Criar conteúdo CSV
      let csvContent = headers.join(";") + "\n";
      
      // Adicionar dados
      sistema.produtos.forEach(item => {
        const row = [
          `"${item.produto}"`,
          `"${item.sku || ''}"`,
          getPlatformName(item.plataforma),
          item.custo,
          item.precoMinimo,
          item.precoIdeal,
          item.precoMedio,
          item.precoPromo,
          `"${new Date(item.createdAt).toLocaleDateString('pt-BR')}"`,
          item.taxas['Taxas da Plataforma (%)'] || '0',
          item.taxas['Custo Fixo Plataforma (R$)'] || '0',
          item.taxas['Frete (R$)'] || '0',
          item.taxas['Taxa de Transação (%)'] || '0',
          item.taxas['Taxa de Transferência (%)'] || '0',
          item.taxas['Taxa de Antecipação (%)'] || '0',
          item.taxas['Custos Variáveis (R$)'] || '0',
          item.taxas['Imposto (%)'] || '0',
          item.taxas['Comissão do Vendedor (%)'] || '0'
        ];
        
        csvContent += row.join(";") + "\n";
      });
      
      // Criar e baixar arquivo
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "precificacao_produtos.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      addHistoryEntry('export', 'Exportação para Excel realizada');
    }

    function exportarPDF() {
      if (sistema.produtos.length === 0) {
        alert("Nenhum produto para exportar!");
        return;
      }
      
      // Criar novo documento PDF
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });
      
      // Título do documento
      doc.setFontSize(18);
      doc.text("Relatório de Precificação de Produtos", 105, 15, { align: 'center' });
      doc.setFontSize(12);
      doc.setTextColor(100);
      doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
      
      // Preparar dados da tabela
      const headers = [
        "Produto", 
        "SKU",
        "Plataforma", 
        "Custo (R$)", 
        "Preço Mínimo (R$)", 
        "Preço Ideal (R$)",
        "Preço Médio (R$)",
        "Preço Promo (R$)",
        "Data"
      ];
      
      const data = sistema.produtos.map(item => [
        item.produto,
        item.sku || '-',
        getPlatformName(item.plataforma),
        parseFloat(item.custo).toFixed(2),
        parseFloat(item.precoMinimo).toFixed(2),
        parseFloat(item.precoIdeal).toFixed(2),
        parseFloat(item.precoMedio).toFixed(2),
        parseFloat(item.precoPromo).toFixed(2),
        new Date(item.createdAt).toLocaleDateString('pt-BR')
      ]);
      
      // Criar tabela
      doc.autoTable({
        head: [headers],
        body: data,
        startY: 30,
        theme: 'grid',
        styles: { 
          fontSize: 8,
          cellPadding: 2,
          valign: 'middle'
        },
        headStyles: {
          fillColor: [76, 175, 80],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240]
        },
        margin: { top: 30 }
      });
      
      // Salvar PDF
      doc.save(`precificacao_produtos_${new Date().toISOString().slice(0, 10)}.pdf`);
      
      addHistoryEntry('export', 'Exportação para PDF realizada');
    }
  function importShopeeFile() {
      const fileInput = document.getElementById('shopeeFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Selecione um arquivo primeiro!');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Assume que os dados estão na primeira planilha
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        
        // Converter para JSON
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        if (jsonData.length < 2) {
          alert('Planilha vazia ou formato inválido!');
          return;
        }
        
        // Extrair cabeçalhos
        const headers = jsonData[0];
        
        // Processar linhas de dados
        const products = [];
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (row.length === 0) continue;
          
          const product = {};
          for (let j = 0; j < headers.length; j++) {
            product[headers[j]] = row[j];
          }
          products.push(product);
        }
        
        // Armazenar dados importados
        sistema.importedShopeeData = products;
        sistema.originalShopeeData = JSON.parse(JSON.stringify(products)); // Cópia profunda para backup
        
        // Exibir dados na tabela
        displayImportedProducts(products);
        
        // Mostrar seção de produtos importados
        document.getElementById('importedShopeeProducts').style.display = 'block';
        
        addHistoryEntry('import', `${products.length} produtos importados da Shopee`);
      };
      
      reader.readAsArrayBuffer(file);
    }

    function displayImportedProducts(products) {
      const tableBody = document.getElementById('importedProductsTableBody');
      tableBody.innerHTML = '';
      
      products.forEach(product => {
        const row = document.createElement('tr');
        
        // Mapear campos importantes para exibição
        row.innerHTML = `
          <td>${product['ID do produto'] || ''}</td>
          <td>${product['Nome do Produto. (Opcional)'] || ''}</td>
          <td>${product['Nº de Ref. Parent SKU. (Opcional)'] || ''}</td>
          <td>${product['ID de variação'] || ''}</td>
          <td>${product['Variação de nome. (Opcional)'] || ''}</td>
          <td>${product['Nº de Ref. SKU. (Opcional)'] || ''}</td>
          <td>${product['Preço original (opcional)'] || ''}</td>
          <td class="font-bold">${product['Preço de desconto'] || ''}</td>
        `;
        
        tableBody.appendChild(row);
      });
    }

    function applyPriceUpdate(type) {
      if (!sistema.importedShopeeData) {
        alert('Importe os dados da Shopee primeiro!');
        return;
      }
      
      // Obter todos os produtos do sistema
      const systemProducts = sistema.produtos;
      let productsWithNoSku = 0;
      let productsNotFound = 0;
      let productsUpdated = 0;
      
      // Percorrer produtos importados
      for (const importedProduct of sistema.importedShopeeData) {
        // Determinar o SKU a ser buscado (primeiro tenta SKU, depois Parent SKU)
        const sku = importedProduct['Nº de Ref. SKU. (Opcional)'] ? 
                   String(importedProduct['Nº de Ref. SKU. (Opcional)']).trim() : null;
        
        const parentSku = importedProduct['Nº de Ref. Parent SKU. (Opcional)'] ? 
                         String(importedProduct['Nº de Ref. Parent SKU. (Opcional)']).trim() : null;
        
        const searchSku = sku || parentSku;
        
        if (!searchSku) {
          console.log('Produto sem SKU identificável:', importedProduct['Nome do Produto. (Opcional)'] || 'Sem nome');
          productsWithNoSku++;
          continue;
        }
        
        // Buscar produto correspondente no sistema (comparação exata de strings)
        const systemProduct = systemProducts.find(p => {
          const systemSku = p.sku ? String(p.sku).trim() : '';
          return systemSku === searchSku;
        });
        
        if (!systemProduct) {
          console.log('Produto não encontrado no sistema:', searchSku, importedProduct['Nome do Produto. (Opcional)'] || 'Sem nome');
          productsNotFound++;
          continue;
        }
        
        // Aplicar preço conforme o tipo selecionado, formatando com 2 casas decimais
        let priceToApply = 0;
        switch(type) {
          case 'promo':
            priceToApply = parseFloat(systemProduct.precoPromo).toFixed(2);
            break;
          case 'medium':
            priceToApply = parseFloat(systemProduct.precoMedio).toFixed(2);
            break;
          case 'ideal':
            priceToApply = parseFloat(systemProduct.precoIdeal).toFixed(2);
            break;
        }
        
        importedProduct['Preço de desconto'] = priceToApply;
        productsUpdated++;
      }
      
      // Atualizar exibição
      displayImportedProducts(sistema.importedShopeeData);
      
      // Feedback visual detalhado
      const feedback = document.createElement('div');
      feedback.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg';
      feedback.innerHTML = `
        <i class="fas fa-check-circle mr-2"></i> 
        Operação concluída!<br>
        Produtos atualizados: ${productsUpdated}<br>
        Produtos não encontrados: ${productsNotFound}<br>
        Produtos sem SKU: ${productsWithNoSku}
      `;
      document.body.appendChild(feedback);
      
      setTimeout(() => {
        feedback.remove();
      }, 5000);
      
      // Registrar no histórico
      addHistoryEntry('price_update', `${productsUpdated} preços atualizados na planilha Shopee`);
    }

    function exportShopeeFile() {
      if (!sistema.importedShopeeData) {
        alert('Nenhum dado para exportar!');
        return;
      }
      
      // Recriar estrutura original com cabeçalhos
      const headers = Object.keys(sistema.originalShopeeData[0]);
      const dataToExport = [headers];
      
      // Adicionar dados modificados mantendo a estrutura original
      sistema.importedShopeeData.forEach(product => {
        const row = headers.map(header => product[header]);
        dataToExport.push(row);
      });
      
      // Criar planilha
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Promoções");
      
      // Exportar
      XLSX.writeFile(wb, `promocoes_shopee_${new Date().toISOString().slice(0, 10)}.xlsx`);
      
      addHistoryEntry('export', 'Planilha Shopee exportada');
    }

    // Funções auxiliares
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
    }

    function openRecoverModal() {
      closeModal('loginModal');
      openModal('recoverModal');
    }

    function sendRecovery() {
      const email = document.getElementById('recoverEmail').value;
      if (!email.includes('@')) {
        alert('E-mail inválido!');
        return;
      }
      
      // Simulação de envio
      alert(`Link de recuperação enviado para ${email}`);
      closeModal('recoverModal');
      addHistoryEntry('recovery', `Solicitação de recuperação de senha para ${email}`);
    }

    function setupEventListeners() {
      // Login/logout
      document.getElementById('loginBtn').addEventListener('click', () => openModal('loginModal'));
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // Tabs
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
        });
      });
      
      // Filtros
      document.getElementById('filterHistoryType').addEventListener('change', loadHistory);
      document.getElementById('filterHistoryUser').addEventListener('change', loadHistory);
      document.getElementById('filterHistoryDate').addEventListener('change', loadHistory);
      document.getElementById('filtroPlataforma').addEventListener('change', atualizarLista);
      
      // Configurações
      document.getElementById('autoBackup').addEventListener('change', function() {
        sistema.config.backupAuto = this.checked;
        saveSystem();
      });
      
      document.getElementById('backupFrequency').addEventListener('change', function() {
        sistema.config.backupFrequency = this.value;
        saveSystem();
      });
    }

    function updateUI() {
      // Atualiza checkbox de backup automático
      document.getElementById('autoBackup').checked = sistema.config.backupAuto;
      document.getElementById('backupFrequency').value = sistema.config.backupFrequency || 'daily';
      
      // Atualiza status de conexão
      updateApiStatusUI();
      
      // Atualiza histórico recente
      updateRecentUpdates();
    }

    function updateKPIs() {
      const totalProducts = sistema.produtos.length;
      
      // Calcula margem média
      let avgMargin = 0;
      if (sistema.produtos.length > 0) {
        const totalMargin = sistema.produtos.reduce((sum, produto) => {
          const custo = parseFloat(produto.custo);
          const precoMinimo = parseFloat(produto.precoMinimo);
          return sum + ((precoMinimo - custo) / precoMinimo * 100);
        }, 0);
        avgMargin = (totalMargin / sistema.produtos.length).toFixed(2);
      }
      
      // Conta conexões ativas
      const activeConnections = Object.values(sistema.config.apiConfig)
        .filter(api => api.connected).length;
      
      document.getElementById('totalProducts').textContent = totalProducts;
      document.getElementById('avgMargin').textContent = `${avgMargin}%`;
      document.getElementById('activeConnections').textContent = `${activeConnections}/3`;
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    // Verificações periódicas
    setInterval(() => {
      checkApiConnections();
      updateKPIs();
      
      // Backup automático
      if (sistema.config.backupAuto) {
        const now = new Date();
        const lastBackup = localStorage.getItem("lastBackupTime");
        const lastBackupTime = lastBackup ? new Date(lastBackup) : null;
        
        let needsBackup = false;
        if (!lastBackupTime) {
          needsBackup = true;
        } else {
          const diffHours = (now - lastBackupTime) / (1000 * 60 * 60);
          
          if (sistema.config.backupFrequency === 'daily' && diffHours >= 24) {
            needsBackup = true;
          } else if (sistema.config.backupFrequency === 'weekly' && diffHours >= 168) {
            needsBackup = true;
          } else if (sistema.config.backupFrequency === 'monthly' && diffHours >= 720) {
            needsBackup = true;
          }
        }
        
        if (needsBackup) {
          createBackup();
          localStorage.setItem("lastBackupTime", now.toISOString());
        }
      }
    }, 300000); // 5 minutos
</script>
  <!-- Modal de detalhes -->
<div id="detalhesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div id="modalContent" class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-lg"></div>
</div>

</body>
</html>
