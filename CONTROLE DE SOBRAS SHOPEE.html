<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Sobras - Shopee Premium</title>
  <!-- Meta tag para CSP (Content Security Policy) -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' 
  https://*.firebaseio.com 
  https://*.googleapis.com 
  https://*.google.com 
  https://*.gstatic.com 
  https://cdnjs.cloudflare.com 
  https://cdn.jsdelivr.net 
  'unsafe-eval' 
  'unsafe-inline'
">  
  <!-- Bibliotecas CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Bibliotecas JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script type="module" src="firebase-init.js"></script>

  <style>
    :root {
      --primary: #4a6bff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background: #f4f4f4;
      color: #333;
      margin: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    h2, h3, h4 {
      color: var(--primary);
      margin-top: 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    
    th, td {
      border: 1px solid #dee2e6;
      padding: 12px;
      text-align: center;
    }
    
    th {
      background: var(--primary);
      color: white;
      position: sticky;
      top: 0;
    }
    
    .aba {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .ativa { display: block; }
    
     .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-button {
      margin: 5px 10px 5px 0;
      padding: 10px 20px;
      cursor: pointer;
      background: white;
      border: 2px solid var(--primary);
      color: var(--primary);
      border-radius: 5px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .tab-button:hover, .tab-button.active {
      background: var(--primary);
      color: white;
    }
    
    .tab-button.active {
      box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.3);
    }
    
    .editInput {
      display: none;
      width: 100px;
      padding: 5px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    
    .info-box {
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid var(--primary);
    }
    
    .alert {
      padding: 10px 15px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid var(--success);
    }
    
    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid var(--danger);
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #3a56d4;
      transform: translateY(-1px);
    }
    
    .btn-outline-primary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    .btn-outline-primary:hover {
      background: #f0f4ff;
    }
    
    .form-control {
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      margin-right: 10px;
      width: 200px;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    .badge {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-success {
      background: var(--success);
      color: white;
    }
    
    .badge-warning {
      background: var(--warning);
      color: white;
    }
    
    .badge-danger {
      background: var(--danger);
      color: white;
    }
    
    .badge-info {
      background: #17a2b8;
      color: white;
    }
    
    .badge-secondary {
      background: var(--gray);
      color: white;
    }
    
    .chart-container {
      margin: 30px 0;
      height: 300px;
    }
    
    .history-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    
    .history-item:last-child {
      border-bottom: none;
    }
    
    .history-date {
      color: var(--gray);
      font-size: 12px;
    }
    
    .connection-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
    }
    
    .online { 
      background: var(--success);
      color: white;
    }
    
    .offline { 
      background: var(--danger);
      color: white;
    }
    
    .error-box {
      background: #ffebee;
      border-left: 4px solid #f44336;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      th, td {
        padding: 8px;
        font-size: 14px;
      }
      
      .form-control {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .tab-button {
        display: block;
        width: 100%;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <nav class="bg-gray-800 text-white p-4 flex flex-wrap items-center space-x-4 mb-8 rounded">
    <a href="index.html" class="hover:underline">Início</a>
    <a href="Gerenciamento%20de%20ANUNCIOS%20E%20DESEMPENHO.html" class="hover:underline">Anúncios</a>
    <a href="CONTROLE%20DE%20SOBRAS%20SHOPEE.html" class="hover:underline">Sobras</a>
    <a href="SISTEMA%20DE%20CUSTEIO%20DE%20PRODUÇÃO%20E%20PRODUTOS.html" class="hover:underline">Custeio</a>
  </nav>
<div class="container">
  <!-- Alertas e status de conexão -->
  <div id="alertSuccess" class="alert alert-success"></div>
  <div id="alertError" class="alert alert-danger"></div>
  <div id="firebase-error" class="error-box">
    <h3><i class="fas fa-exclamation-triangle"></i> Erro de Conexão com o Firebase</h3>
    <p id="error-message"></p>
    <button onclick="verificarConexao()" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Tentar Reconectar</button>
  </div>
  
  <h2><i class="fas fa-check-circle"></i> Mentoria Ferraretto - Conferência de Sobras</h2>
  
  <!-- Barra de navegação por abas -->
<div class="tabs">
    <button class="tab-button active" onclick="trocarAba('importar')"><i class="fas fa-box-open"></i> Conferir Pedidos</button>
    <button class="tab-button" onclick="trocarAba('metas')"><i class="fas fa-bullseye"></i> Metas por SKU</button>
    <button class="tab-button" onclick="trocarAba('graficos')"><i class="fas fa-chart-bar"></i> Gráficos</button>
    <button class="tab-button" onclick="trocarAba('historico')"><i class="fas fa-history"></i> Histórico</button>
   <button class="tab-button" onclick="trocarAba('produtosSalvos')"><i class="fas fa-history"></i> Produtos Salvos</button>
  </div>

  <!-- Aba de Importação/Conferência -->
  <div id="importar" class="aba ativa">
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> Importe o relatório de pedidos da Shopee para calcular automaticamente as sobras e comparar com suas metas cadastradas.</p>
    </div>
    
    <div style="margin: 15px 0;">
      <input type="file" id="inputExcel" accept=".xlsx, .xls" class="form-control" />
      <button onclick="processarPlanilha()" class="btn btn-primary" id="btnProcessar">
        <span id="btnProcessarText"><i class="fas fa-cogs"></i> Processar Planilha</span>
      </button>
    </div>
    
    <div style="margin: 15px 0;">
      <label><strong><i class="fas fa-filter"></i> Filtrar por SKU:</strong></label>
      <select id="tipoFiltro" onchange="filtrarPorSKU()" class="form-control" style="width: auto; display: inline-block;">
        <option value="exata">Correspondência Exata</option>
        <option value="comeca">Começa com</option>
        <option value="contem">Contém</option>
      </select>
      <input type="text" id="filtroSKU" oninput="filtrarPorSKU()" placeholder="Digite o SKU..." class="form-control" style="width: 250px; display: inline-block;" />
      <button onclick="limparFiltros()" class="btn btn-outline-primary"><i class="fas fa-times"></i> Limpar</button>
    </div>
    
    <div style="overflow-x: auto;">
      <table id="resultado">
        <thead>
          <tr>
            <th>ID do Pedido</th>
            <th>SKU</th>
            <th>Subtotal</th>
            <th>Reembolso</th>
            <th>Cupom</th>
            <th>Comissão</th>
            <th>Serviço</th>
            <th>Sobra</th>
            <th>% vs Meta</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="totalSobra" style="margin-top: 20px;"></div>
    
    <div style="margin-top: 20px;">
      <button onclick="exportarCSV()" class="btn btn-primary"><i class="fas fa-file-export"></i> Exportar CSV</button>
      <button onclick="exportarJSON()" class="btn btn-outline-primary"><i class="fas fa-file-code"></i> Exportar JSON</button>
    </div>
  </div>

  <!-- Aba de Metas -->
  <div id="metas" class="aba">
    <h3><i class="fas fa-bullseye"></i> Metas de Sobra por SKU</h3>
    
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> Cadastre metas de sobra para cada SKU. O sistema irá comparar automaticamente o desempenho real com a meta estabelecida.</p>
    </div>
    
    <div style="margin: 15px 0;">
       <input type="text" id="metaSku" list="listaSkus" placeholder="SKU do Produto" class="form-control" />
      <datalist id="listaSkus"></datalist>
      <span id="precoMinimoInfo" style="margin-left:10px;color:#28a745;"></span>
      <input type="number" id="metaValor" placeholder="Sobra Esperada (R$)" step="0.01" class="form-control" />
      <button onclick="adicionarMeta()" class="btn btn-primary" id="btnAdicionarMeta">
        <i class="fas fa-plus"></i> Adicionar Meta
      </button>
    </div>
    
    <div style="overflow-x: auto;">
      <table id="tabelaMetas">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Preço Mínimo</th>
            <th>Meta R$</th>
            <th>Última Atualização</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Aba de Gráficos -->
  <div id="graficos" class="aba">
    <h3><i class="fas fa-chart-bar"></i> Gráficos de Desempenho</h3>
    
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> Visualize gráficos comparativos entre o desempenho real e as metas estabelecidas.</p>
    </div>
    
    <div style="margin: 15px 0;">
      <select id="filtroGrafico" class="form-control" style="width: 300px;">
        <option value="top10">Top 10 SKUs com maior diferença</option>
        <option value="bottom10">Top 10 SKUs com menor diferença</option>
        <option value="all">Todos os SKUs</option>
      </select>
      <button onclick="atualizarGraficos()" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>
    
    <div class="chart-container">
      <canvas id="graficoBarras"></canvas>
    </div>
    
    <div class="chart-container">
      <canvas id="graficoPizza"></canvas>
    </div>
  </div>

  <!-- Aba de Histórico -->
  <div id="historico" class="aba">
    <h3><i class="fas fa-history"></i> Histórico de Alterações</h3>
    
    <div class="info-box">
      <p><i class="fas fa-info-circle"></i> Registro de todas as alterações nas metas de sobra.</p>
    </div>
    
    <div style="margin: 15px 0;">
      <input type="text" id="filtroHistorico" placeholder="Filtrar por SKU..." class="form-control" style="width: 300px;" oninput="filtrarHistorico()" />
    </div>
    
   <div id="listaHistorico" style="border: 1px solid #eee; border-radius: 5px; max-height: 500px; overflow-y: auto;"></div>
  </div>

  <!-- Aba de Produtos Salvos -->
  <div id="produtosSalvos" class="aba">
    <div style="height:90vh;">
      <iframe src="Sistema de Precificação COM IMPORTAÇÃO DE PLANILHA DE PROMOÇÕES SHOPEE.html?tab=produtos" style="width:100%;height:100%;border:none;"></iframe>
    </div>
  </div>
</div>

<!-- Status de conexão -->
<div id="connectionStatus" class="connection-status offline">Offline - Trabalhando localmente</div>

<script type="module">
  import { db, auth } from './firebase-init.js';
  // =============================================
  // CONFIGURAÇÃO INICIAL E VARIÁVEIS GLOBAIS
  // =============================================
  
  
  // Variáveis globais
  let metas = {};
  let historico = [];
  let produtos = {};
  let pedidosProcessados = [];
  let graficoBarras, graficoPizza;

  // =============================================
  // INICIALIZAÇÃO DO FIREBASE E CONFIGURAÇÕES
  // =============================================
  
// Inicialização mais robusta do Firebase
try {
  

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = 'index.html?login=1';
    }
  });
  // Configurações importantes para a conexão
  db.settings({
  experimentalForceLongPolling: true
  });
  
  // Habilita persistência offline
  firebase.firestore().enablePersistence()
    .catch((err) => {
      if (err.code == 'failed-precondition') {
        console.warn("Persistência offline não suportada em múltiplas abas");
      } else if (err.code == 'unimplemented') {
        console.warn("Persistência offline não disponível no navegador");
      }
    });
  
  // Verifica conexão
  verificarConexao();
  
} catch (error) {
  console.error("Erro ao inicializar Firebase:", error);
  mostrarErroFirebase(error);
}

  // Carrega dados iniciais
 document.addEventListener('DOMContentLoaded', async function() {
    await carregarProdutos();
    await carregarMetas();
    carregarHistorico();
  });

  // =============================================
  // FUNÇÕES DE GERENCIAMENTO DE CONEXÃO
  // =============================================
  
  function verificarConexao() {
  firebase.firestore().enableNetwork()
    .then(() => {
      console.log("Conectado ao Firestore");
      document.getElementById('connectionStatus').className = 'connection-status online';
      document.getElementById('connectionStatus').textContent = 'Online';
    })
    .catch((error) => {
      console.error("Erro de conexão:", error);
      document.getElementById('connectionStatus').className = 'connection-status offline';
      document.getElementById('connectionStatus').textContent = 'Offline';
    });
}

  function mostrarErroFirebase(error) {
    const errorBox = document.getElementById('firebase-error');
    const errorMessage = document.getElementById('error-message');
    
    errorMessage.innerHTML = `<strong>${error.message}</strong><br>(Código: ${error.code})`;
    errorBox.style.display = 'block';
    
    console.error("Erro Firebase:", error);
  }

  function updateConnectionStatus(online) {
    const statusElement = document.getElementById('connectionStatus');
    
    if (online) {
      statusElement.textContent = 'Online';
      statusElement.className = 'connection-status online';
    } else {
      statusElement.textContent = 'Offline - Trabalhando localmente';
      statusElement.className = 'connection-status offline';
    }
  }

  // =============================================
  // FUNÇÕES UTILITÁRIAS
  // =============================================
  
  function mostrarSucesso(mensagem) {
    const alerta = document.getElementById('alertSuccess');
    alerta.innerHTML = `<i class="fas fa-check-circle"></i> ${mensagem}`;
    alerta.style.display = 'block';
    
    setTimeout(() => {
      alerta.style.display = 'none';
    }, 5000);
  }

  function mostrarErro(mensagem) {
    const alerta = document.getElementById('alertError');
    alerta.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${mensagem}`;
    alerta.style.display = 'block';
    
    setTimeout(() => {
      alerta.style.display = 'none';
    }, 5000);
  }

  function toggleLoading(botao, texto) {
    const btnText = botao.querySelector('span') || botao;
    if (botao.classList.contains('loading')) {
      botao.classList.remove('loading');
      btnText.innerHTML = texto;
    } else {
      botao.classList.add('loading');
      btnText.innerHTML = '<div class="loading"></div> Carregando...';
    }
  }

  async function executarComRetry(operacao, maxTentativas = 3, delay = 1000) {
    let tentativas = 0;
    
    while (tentativas < maxTentativas) {
      try {
        return await operacao();
      } catch (error) {
        tentativas++;
        if (tentativas >= maxTentativas) throw error;
        
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2; // Aumenta o delay exponencialmente
      }
    }
  }
 function atualizarPrecoMinimo() {
    const sku = document.getElementById('metaSku').value.trim();
    const preco = produtos[sku];
    const info = document.getElementById('precoMinimoInfo');
    if (!info) return;
    if (preco) {
      info.textContent = `Preço Mínimo: R$ ${parseFloat(preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
    } else {
      info.textContent = '';
    }
  }

  // =============================================
  // FUNÇÕES DE NAVEGAÇÃO E INTERFACE
  // =============================================
  
  function trocarAba(id) {
    document.querySelectorAll('.aba').forEach(aba => aba.classList.remove('ativa'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(id).classList.add('ativa');
    document.querySelector(`.tab-button[onclick="trocarAba('${id}')"]`).classList.add('active');
    
    if (id === 'graficos') {
      setTimeout(atualizarGraficos, 100);
    }
  }

  // =============================================
  // FUNÇÕES DE GERENCIAMENTO DE METAS
  // =============================================
   async function carregarProdutos() {
    try {
      const snapshot = await db.collection("products").get();
      produtos = {};
      const datalist = document.getElementById('listaSkus');
      if (datalist) datalist.innerHTML = '';

      snapshot.forEach(doc => {
        const data = doc.data();
        if (!data.sku) return;
        produtos[data.sku] = data.precoMinimo;
        if (datalist) {
          const opt = document.createElement('option');
          const preco = data.precoMinimo ? parseFloat(data.precoMinimo).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '0.00';
          opt.value = data.sku;
          opt.label = `${data.sku} - R$ ${preco}`;
          datalist.appendChild(opt);
        }
      });
    } catch (error) {
      console.error('Erro ao carregar produtos:', error);
    }
  }

  async function carregarMetas() {
    try {
      toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
      
      return await executarComRetry(async () => {
        metas = {};
        // Carrega SKUs e preço mínimo da coleção de produtos
        const produtosSnap = await db.collection("products").get();
        produtosSnap.forEach((doc) => {
          const data = doc.data();
          if (data.sku && data.precoMinimo !== undefined) {
            metas[data.sku] = {
              valor: parseFloat(data.precoMinimo),
              atualizadoEm: new Date()
            };
          }
        });

        // Sobrepõe com metas salvas manualmente se existirem
        const metasSnap = await db.collection("metasSKU").get();
        metasSnap.forEach((doc) => {
          const originalSku = doc.id.replaceAll('__', '/');
          metas[originalSku] = {
            valor: doc.data().valor,
            atualizadoEm: doc.data().atualizadoEm?.toDate() || new Date()
          };
        });
        
        renderizarMetas();
        return true;
      });
    } catch (error) {
      mostrarErroFirebase(`Erro ao carregar metas: ${error.message}`);
      console.error("Erro ao carregar metas:", error);
      return false;
    } finally {
      toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
    }
  }

  async function carregarHistorico() {
    try {
      return await executarComRetry(async () => {
        historico = [];
        const snapshot = await db.collection("historicoMetas").orderBy("data", "desc").limit(50).get();
        
        snapshot.forEach((doc) => {
          historico.push({
            sku: doc.data().sku,
            acao: doc.data().acao,
            valorAnterior: doc.data().valorAnterior,
            valorNovo: doc.data().valorNovo,
            data: doc.data().data.toDate(),
            usuario: doc.data().usuario || 'Sistema'
          });
        });
        
        renderizarHistorico();
        return true;
      });
    } catch (error) {
      mostrarErroFirebase(`Erro ao carregar histórico: ${error.message}`);
      console.error("Erro ao carregar histórico:", error);
      return false;
    }
  }

  async function registrarHistorico(sku, acao, valorAnterior, valorNovo) {
    try {
      await executarComRetry(async () => {
        await db.collection("historicoMetas").add({
          sku: sku,
          acao: acao,
          valorAnterior: valorAnterior,
          valorNovo: valorNovo,
          data: new Date(),
          usuario: "Usuário" // Em um sistema real, pegaria do auth
        });
        
        // Recarregar histórico após adicionar novo registro
        await carregarHistorico();
        return true;
      });
    } catch (error) {
      console.error("Erro ao registrar histórico:", error);
      throw error;
    }
  }

  function renderizarMetas() {
    const tbody = document.querySelector('#tabelaMetas tbody');
    tbody.innerHTML = '';
    
    if (Object.keys(metas).length === 0) {
     tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma meta cadastrada</td></tr>';
      return;
    }
    
   for (let sku in metas) {
        const meta = metas[sku];
        const precoProduto = produtos[sku];
        const dataFormatada = meta.atualizadoEm ? meta.atualizadoEm.toLocaleDateString('pt-BR') : 'N/A';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${sku}</td>
        <td>${precoProduto ? 'R$ ' + parseFloat(precoProduto).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '-'}</td>
        <td>
          <span class="valorMeta">R$ ${meta.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
          <input class="editInput" type="number" value="${meta.valor}" step="0.01" />
        </td>
        <td>${dataFormatada}</td>
        <td>
          <button onclick="editarMeta(this, '${sku}')" class="btn" style="padding: 5px 8px;"><i class="fas fa-edit"></i></button>
          <button onclick="excluirMeta('${sku}', this)" class="btn" style="padding: 5px 8px;"><i class="fas fa-trash-alt"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderizarHistorico() {
    const lista = document.getElementById('listaHistorico');
    lista.innerHTML = '';
    
    if (historico.length === 0) {
      lista.innerHTML = '<div class="history-item" style="text-align: center;">Nenhum registro histórico encontrado</div>';
      return;
    }
    
    historico.forEach(item => {
      const div = document.createElement('div');
      div.className = 'history-item';
      
      let acaoTexto = '';
      let valorTexto = '';
      
      if (item.acao === 'adicionar') {
        acaoTexto = `<span class="badge badge-success">Adicionado</span>`;
        valorTexto = `Novo valor: R$ ${item.valorNovo?.toFixed(2) || '0.00'}`;
      } else if (item.acao === 'editar') {
        acaoTexto = `<span class="badge badge-warning">Editado</span>`;
        valorTexto = `De R$ ${item.valorAnterior?.toFixed(2) || '0.00'} para R$ ${item.valorNovo?.toFixed(2) || '0.00'}`;
      } else if (item.acao === 'remover') {
        acaoTexto = `<span class="badge badge-danger">Removido</span>`;
        valorTexto = `Valor anterior: R$ ${item.valorAnterior?.toFixed(2) || '0.00'}`;
      }
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${item.sku}</strong> - ${acaoTexto}
            <div>${valorTexto}</div>
          </div>
          <div class="history-date">
            ${item.data.toLocaleDateString('pt-BR')} ${item.data.toLocaleTimeString('pt-BR')}
            <div>Por: ${item.usuario}</div>
          </div>
        </div>
      `;
      
      lista.appendChild(div);
    });
  }

  function filtrarHistorico() {
    const filtro = document.getElementById('filtroHistorico').value.toLowerCase();
    const itens = document.querySelectorAll('.history-item');
    
    itens.forEach(item => {
      const sku = item.querySelector('strong')?.textContent.toLowerCase() || '';
      item.style.display = sku.includes(filtro) ? '' : 'none';
    });
  }

  async function adicionarMeta() {
    const skuInput = document.getElementById('metaSku');
    const valorInput = document.getElementById('metaValor');
    
    const sku = skuInput.value.trim();
    const valor = parseFloat(valorInput.value);
    
    if (!sku) {
      mostrarErro('Por favor, informe o SKU do produto.');
      skuInput.focus();
      return;
    }
    
    if (isNaN(valor) || valor <= 0) {
      mostrarErro('Por favor, informe um valor válido para a meta (maior que zero).');
      valorInput.focus();
      return;
    }
    
    try {
      toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
      
      const safeSku = sku.replaceAll('/', '__');
      const metaData = {
        valor: valor,
        atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      await executarComRetry(async () => {
        await db.collection("metasSKU").doc(safeSku).set(metaData);
        return true;
      });
      
      // Atualizar localmente
      metas[sku] = {
        valor: valor,
        atualizadoEm: new Date()
      };
      
      // Registrar no histórico
      await registrarHistorico(sku, 'adicionar', null, valor);
      
      renderizarMetas();
      
      skuInput.value = '';
      valorInput.value = '';
      
      mostrarSucesso(`Meta para o SKU ${sku} adicionada com sucesso!`);
      
      // Atualizar gráficos se estiver na aba
      if (document.getElementById('graficos').classList.contains('ativa')) {
        atualizarGraficos();
      }
    } catch (error) {
      mostrarErro(`Erro ao adicionar meta: ${error.message}`);
      console.error("Erro ao adicionar meta:", error);
    } finally {
      toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
    }
  }

  async function editarMeta(botao, sku) {
    const tr = botao.closest('tr');
    const span = tr.querySelector('.valorMeta');
    const input = tr.querySelector('.editInput');
    const icon = botao.querySelector('i');
    
    if (input.style.display === 'none') {
      // Iniciar edição
      input.style.display = 'inline-block';
      span.style.display = 'none';
      icon.className = 'fas fa-save';
      input.focus();
    } else {
      // Salvar edição
      const novoValor = parseFloat(input.value);
      
      if (isNaN(novoValor) || novoValor <= 0) {
        mostrarErro('Por favor, informe um valor válido para a meta (maior que zero).');
        input.focus();
        return;
      }
      
      try {
        icon.className = 'fas fa-spinner fa-spin';
        
        const valorAnterior = metas[sku].valor;
        const safeSku = sku.replaceAll('/', '__');
        const metaData = {
          valor: novoValor,
          atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await executarComRetry(async () => {
          await db.collection("metasSKU").doc(safeSku).set(metaData);
          return true;
        });
        
        // Atualizar localmente
        metas[sku] = {
          valor: novoValor,
          atualizadoEm: new Date()
        };
        
        // Registrar no histórico
        await registrarHistorico(sku, 'editar', valorAnterior, novoValor);
        
        renderizarMetas();
        mostrarSucesso(`Meta para o SKU ${sku} atualizada com sucesso!`);
        
        // Atualizar gráficos se estiver na aba
        if (document.getElementById('graficos').classList.contains('ativa')) {
          atualizarGraficos();
        }
      } catch (error) {
        mostrarErro(`Erro ao editar meta: ${error.message}`);
        console.error("Erro ao editar meta:", error);
        // Reverter visualmente
        input.value = metas[sku].valor;
      } finally {
        input.style.display = 'none';
        span.style.display = 'inline-block';
        icon.className = 'fas fa-edit';
      }
    }
  }

  async function excluirMeta(sku, botao) {
    if (!confirm(`Tem certeza que deseja excluir a meta do SKU ${sku}?`)) {
      return;
    }
    
    try {
      const icon = botao.querySelector('i');
      icon.className = 'fas fa-spinner fa-spin';
      
      const valorAnterior = metas[sku].valor;
      const safeSku = sku.replaceAll('/', '__');
      
      await executarComRetry(async () => {
        await db.collection("metasSKU").doc(safeSku).delete();
        return true;
      });
      
      // Remover localmente
      delete metas[sku];
      
      // Registrar no histórico
      await registrarHistorico(sku, 'remover', valorAnterior, null);
      
      renderizarMetas();
      mostrarSucesso(`Meta para o SKU ${sku} removida com sucesso!`);
      
      // Atualizar gráficos se estiver na aba
      if (document.getElementById('graficos').classList.contains('ativa')) {
        atualizarGraficos();
      }
    } catch (error) {
      mostrarErro(`Erro ao excluir meta: ${error.message}`);
      console.error("Erro ao excluir meta:", error);
    }
  }

  // =============================================
  // FUNÇÕES DE PROCESSAMENTO DE PEDIDOS
  // =============================================
  
  function processarPlanilha() {
    const fileInput = document.getElementById('inputExcel');
    const file = fileInput.files[0];
    
    if (!file) {
      mostrarErro('Por favor, selecione um arquivo antes de processar.');
      return;
    }
    
    try {
      toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const pedidos = XLSX.utils.sheet_to_json(sheet);
          
          processarPedidos(pedidos);
        } catch (error) {
          mostrarErro(`Erro ao ler o arquivo: ${error.message}`);
          console.error("Erro ao ler arquivo:", error);
        } finally {
          toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
        }
      };
      
      reader.onerror = function() {
        mostrarErro('Erro ao ler o arquivo. Por favor, tente novamente.');
        toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
      };
      
      reader.readAsArrayBuffer(file);
    } catch (error) {
      mostrarErro(`Erro ao processar o arquivo: ${error.message}`);
      console.error("Erro ao processar arquivo:", error);
      toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
    }
  }

  function processarPedidos(pedidos) {
    const contagem = {};
    pedidos.forEach(p => {
      const id = p['ID do pedido'];
      if (id) contagem[id] = (contagem[id] || 0) + 1;
    });

    const tbody = document.querySelector('#resultado tbody');
    tbody.innerHTML = '';
    let totalSobra = 0, totalPercentual = 0, totalPedidos = 0;
    
    pedidosProcessados = [];

    pedidos.forEach(p => {
      const id = p['ID do pedido'];
      if (!id || contagem[id] > 1) return;

      const sku = p['Número de referência SKU'] || '';
      const status = (p['Status do pedido'] || '').toLowerCase();
      if (!sku || status.includes('cancelado') || status.includes('não pago')) return;

      const subtotal = parseFloat(p['Subtotal do produto']) || 0;
      const reembolso = parseFloat(p['Reembolso Shopee']) || 0;
      const cupom = parseFloat(p['Cupom do vendedor']) || 0;
      const comissao = parseFloat(p['Taxa de comissão']) || 0;
      const servico = parseFloat(p['Taxa de serviço']) || 0;
      const sobra = subtotal + reembolso - cupom - comissao - servico;
      const meta = metas[sku]?.valor || 0;
      const percentual = meta ? ((sobra - meta) / meta) * 100 : 0;
      
      const pedidoData = {
        id, sku, subtotal, reembolso, cupom, comissao, servico, sobra, meta, percentual, status
      };
      
      pedidosProcessados.push(pedidoData);

      const tr = document.createElement('tr');
      
      // Determinar classe CSS baseada no desempenho
      let statusClass = '';
      let statusText = '';
      
      if (meta) {
        if (percentual <= -10) {
          statusClass = 'danger';
          statusText = 'Crítico';
        } else if (percentual <= -5) {
          statusClass = 'warning';
          statusText = 'Atenção';
        } else if (percentual >= 5) {
          statusClass = 'success';
          statusText = 'Bom';
        } else {
          statusClass = 'info';
          statusText = 'Normal';
        }
      } else {
        statusClass = 'secondary';
        statusText = 'Sem meta';
      }

      tr.innerHTML = `
        <td>${id}</td>
        <td>${sku}</td>
        <td>R$ ${subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td>R$ ${reembolso.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td>R$ ${cupom.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td>R$ ${comissao.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td>R$ ${servico.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td><strong>R$ ${sobra.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong><br><small>Meta: R$ ${meta.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</small></td>
        <td>${percentual.toFixed(2)}%</td>
        <td><span class="badge badge-${statusClass}">${statusText}</span></td>
      `;
      
      tbody.appendChild(tr);

      totalSobra += sobra;
      totalPercentual += percentual;
      totalPedidos++;
    });

    // Calcular total esperado com base na quantidade de pedidos por SKU
    const linhas = document.querySelectorAll("#resultado tbody tr");
    let esperadoTotal = 0;
    linhas.forEach(l => {
      const sku = l.children[1].textContent.trim();
      if (metas[sku]) esperadoTotal += metas[sku].valor;
    });
  
    const media = totalPedidos ? (totalPercentual / totalPedidos).toFixed(2) : '0.00';
    const diferencaTotal = totalSobra - esperadoTotal;
    const diferencaPercentual = esperadoTotal ? (diferencaTotal / esperadoTotal) * 100 : 0;

    let diferencaHTML = '';
    if (esperadoTotal > 0) {
      const diferencaClass = diferencaTotal >= 0 ? 'success' : 'danger';
      diferencaHTML = `
        <h4>
          <span class="badge badge-${diferencaClass}">
            Diferença Total: R$ ${Math.abs(diferencaTotal).toLocaleString('pt-BR', { minimumFractionDigits: 2 })} 
            (${diferencaPercentual.toFixed(2)}%)
            ${diferencaTotal >= 0 ? 'acima' : 'abaixo'} da meta
          </span>
        </h4>
      `;
    }

    document.getElementById('totalSobra').innerHTML = `
      <div class="info-box">
        <h3><i class="fas fa-coins"></i> Sobra Total: R$ ${totalSobra.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h3>
        <h3><i class="fas fa-bullseye"></i> Sobra Total Esperada: R$ ${esperadoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h3>
        ${diferencaHTML}
        <h4><i class="fas fa-chart-line"></i> Média de Desempenho vs Meta: ${media}%</h4>
      </div>
    `;
    
    // Atualizar gráficos se estiver na aba
    if (document.getElementById('graficos').classList.contains('ativa')) {
      atualizarGraficos();
    }
  }

  function filtrarPorSKU() {
    const filtro = document.getElementById("filtroSKU").value.toLowerCase();
    const tipo = document.getElementById("tipoFiltro").value;
    const linhas = document.querySelectorAll("#resultado tbody tr");
    
    linhas.forEach(linha => {
      const sku = linha.children[1].textContent.toLowerCase();

      if (!filtro) {
        linha.style.display = "";
        return;
      }

      if (tipo === "exata") {
        linha.style.display = sku === filtro ? "" : "none";
      } else if (tipo === "comeca") {
        linha.style.display = sku.startsWith(filtro) ? "" : "none";
      } else if (tipo === "contem") {
        linha.style.display = sku.includes(filtro) ? "" : "none";
      }
    });
  }

  function limparFiltros() {
    document.getElementById("filtroSKU").value = "";
    filtrarPorSKU();
  }

  // =============================================
  // FUNÇÕES DE GRÁFICOS
  // =============================================
  
  function atualizarGraficos() {
    if (pedidosProcessados.length === 0) {
      document.querySelectorAll('.chart-container').forEach(container => {
        container.innerHTML = '<p style="text-align: center; color: var(--gray);">Nenhum dado disponível para exibir gráficos. Processe um arquivo primeiro.</p>';
      });
      return;
    }
    
    const tipoFiltro = document.getElementById('filtroGrafico').value;
    let dados = agruparPorSKU(pedidosProcessados);
    
    // Aplicar filtro
    if (tipoFiltro === 'top10') {
      dados.sort((a, b) => b.diferencaPercentual - a.diferencaPercentual);
      dados = dados.slice(0, 10);
    } else if (tipoFiltro === 'bottom10') {
      dados.sort((a, b) => a.diferencaPercentual - b.diferencaPercentual);
      dados = dados.slice(0, 10);
    }
    
    criarGraficoBarras(dados);
    criarGraficoPizza(dados);
  }

  function agruparPorSKU(pedidos) {
    const agrupados = {};
    
    pedidos.forEach(pedido => {
      if (!agrupados[pedido.sku]) {
        agrupados[pedido.sku] = {
          sku: pedido.sku,
          totalSobra: 0,
          totalMeta: 0,
          quantidade: 0
        };
      }
      
      agrupados[pedido.sku].totalSobra += pedido.sobra;
      agrupados[pedido.sku].totalMeta += pedido.meta || 0;
      agrupados[pedido.sku].quantidade += 1;
    });
    
    // Converter para array e calcular diferenças
    return Object.values(agrupados).map(item => {
      const diferenca = item.totalSobra - item.totalMeta;
      const diferencaPercentual = item.totalMeta ? (diferenca / item.totalMeta) * 100 : 0;
      
      return {
        ...item,
        diferenca,
        diferencaPercentual
      };
    });
  }

  function criarGraficoBarras(dados) {
    const ctx = document.getElementById('graficoBarras').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (graficoBarras) {
      graficoBarras.destroy();
    }
    
    // Preparar dados
    const labels = dados.map(item => item.sku);
    const sobras = dados.map(item => item.totalSobra);
    const metas = dados.map(item => item.totalMeta);
    
    graficoBarras = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Sobra Real (R$)',
            data: sobras,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Meta Esperada (R$)',
            data: metas,
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Valor (R$)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'SKU'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Comparação entre Sobra Real e Meta por SKU'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                label += 'R$ ' + context.raw.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                return label;
              }
            }
          }
        }
      }
    });
  }

  function criarGraficoPizza(dados) {
    const ctx = document.getElementById('graficoPizza').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (graficoPizza) {
      graficoPizza.destroy();
    }
    
    // Preparar dados - vamos mostrar a diferença percentual
    const labels = dados.map(item => item.sku);
    const diferencas = dados.map(item => item.diferencaPercentual);
    
    // Criar cores baseadas no desempenho
    const backgroundColors = diferencas.map(val => {
      if (val >= 5) return 'rgba(75, 192, 192, 0.7)'; // Verde - acima
      if (val <= -5) return 'rgba(255, 99, 132, 0.7)'; // Vermelho - abaixo
      return 'rgba(255, 206, 86, 0.7)'; // Amarelo - dentro do esperado
    });
    
    graficoPizza = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: diferencas,
          backgroundColor: backgroundColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Desempenho vs Meta por SKU (%)'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                return `${label}: ${value.toFixed(2)}%`;
              }
            }
          }
        }
      }
    });
  }

  // =============================================
  // FUNÇÕES DE EXPORTAÇÃO
  // =============================================
  
  function exportarCSV() {
    if (pedidosProcessados.length === 0) {
      mostrarErro('Nenhum dado disponível para exportar. Processe um arquivo primeiro.');
      return;
    }
    
    try {
      // Cabeçalhos
      let csv = 'ID do Pedido;SKU;Subtotal;Reembolso;Cupom;Comissão;Serviço;Sobra;Meta;% vs Meta;Status\n';
      
      // Dados
      pedidosProcessados.forEach(pedido => {
        const status = pedido.meta ? 
          (pedido.percentual <= -10 ? 'Crítico' : 
           pedido.percentual <= -5 ? 'Atenção' : 
           pedido.percentual >= 5 ? 'Bom' : 'Normal') : 'Sem meta';
        
        csv += `"${pedido.id}";"${pedido.sku}";"${pedido.subtotal.toFixed(2)}";"${pedido.reembolso.toFixed(2)}";"${pedido.cupom.toFixed(2)}";"${pedido.comissao.toFixed(2)}";"${pedido.servico.toFixed(2)}";"${pedido.sobra.toFixed(2)}";"${pedido.meta.toFixed(2)}";"${pedido.percentual.toFixed(2)}";"${status}"\n`;
      });
      
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, `relatorio_sobras_${new Date().toISOString().slice(0,10)}.csv`);
      
      mostrarSucesso('Arquivo CSV exportado com sucesso!');
    } catch (error) {
      mostrarErro(`Erro ao exportar CSV: ${error.message}`);
      console.error("Erro ao exportar CSV:", error);
    }
  }

  function exportarJSON() {
    if (pedidosProcessados.length === 0) {
      mostrarErro('Nenhum dado disponível para exportar. Processe um arquivo primeiro.');
      return;
    }
    
    try {
      const data = {
        geradoEm: new Date().toISOString(),
        pedidos: pedidosProcessados,
        resumo: {
          totalSobra: pedidosProcessados.reduce((sum, p) => sum + p.sobra, 0),
          totalMeta: pedidosProcessados.reduce((sum, p) => sum + (p.meta || 0), 0)
        }
      };
      
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
      saveAs(blob, `relatorio_sobras_${new Date().toISOString().slice(0,10)}.json`);
      
      mostrarSucesso('Arquivo JSON exportado com sucesso!');
    } catch (error) {
      mostrarErro(`Erro ao exportar JSON: ${error.message}`);
      console.error("Erro ao exportar JSON:", error);
    }
  }
   // Exponha funções para uso em manipuladores inline
  window.trocarAba = trocarAba;
  window.verificarConexao = verificarConexao;
  window.processarPlanilha = processarPlanilha;
  window.limparFiltros = limparFiltros;
  window.exportarCSV = exportarCSV;
  window.exportarJSON = exportarJSON;
  window.adicionarMeta = adicionarMeta;
  window.atualizarGraficos = atualizarGraficos;
  window.editarMeta = editarMeta;
  window.excluirMeta = excluirMeta;
  window.filtrarPorSKU = filtrarPorSKU;
  window.filtrarHistorico = filtrarHistorico;
  
</script>
</body>
</html>
