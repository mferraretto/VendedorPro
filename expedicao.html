<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expedição</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css?v=20240826">
    <link rel="stylesheet" href="css/components.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  </head>
  <body class="bg-gray-100">
  <div id="sidebar-container"></div>
  <div id="navbar-container"></div>
  <div id="gestorUsersCard" class="hidden fixed top-24 right-4 w-72 bg-white rounded shadow-lg p-4">
    <h2 class="text-lg font-semibold mb-2">Equipe de Expedição</h2>
    <ul id="gestorUsersList" class="space-y-1 text-sm"></ul>
  </div>
  <div class="main-content p-4">
    <h1 class="text-2xl font-bold mb-4">Expedição</h1>
    <div id="actionBar" class="sticky top-0 z-10 bg-white border-b shadow-sm mb-4 flex flex-wrap items-center gap-2 p-2">
      <button id="startDayBtn" class="btn flex items-center gap-2 px-4 py-2 rounded-lg bg-green-600 text-white"><i class="fas fa-play"></i><span>Iniciar Dia</span></button>
      <button id="closeDayBtn" class="btn flex items-center gap-2 px-4 py-2 rounded-lg bg-green-600 text-white hidden"><i class="fas fa-check"></i><span>Concluir</span></button>
      <label for="manualPdfInput" class="btn flex items-center gap-2 px-4 py-2 rounded-lg bg-purple-600 text-white cursor-pointer"><i class="fas fa-file-upload"></i><span>Escolher Arquivo</span></label>
      <input type="file" id="manualPdfInput" accept="application/pdf" class="hidden" />
      <button id="uploadManualBtn" class="btn flex items-center gap-2 px-4 py-2 rounded-lg bg-purple-600 text-white"><i class="fas fa-plus"></i><span>Adicionar Etiqueta</span></button>
      <button id="gestorUsersBtn" class="btn flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white"><i class="fas fa-users"></i><span>Equipe</span></button>
    </div>
    <div id="sobrasFields" class="mb-4 hidden flex flex-wrap items-center gap-2">
      <input type="number" id="sobrasQuantidade" class="form-control w-40" placeholder="Qtd não expedida" />
      <input type="text" id="sobrasMotivo" class="form-control w-64" placeholder="Motivo" />
      <select id="sobrasResponsavel" class="form-control w-48">
        <option value="">Selecione responsável</option>
      </select>
      <button id="enviarSobrasBtn" class="btn btn-primary">Enviar</button>
    </div>
    <div id="statusFilters" class="flex flex-wrap gap-2 mb-4">
      <button class="filter-btn px-4 py-2 rounded-full bg-indigo-600 text-white text-sm font-medium" data-status="all">Todas</button>
      <button class="filter-btn px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition" data-status="nao_impresso">Não impresso</button>
      <button class="filter-btn px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition" data-status="impresso">Impresso</button>
      <button class="filter-btn px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition" data-status="concluido">Concluído</button>
    </div>
    <div id="viewToggle" class="flex gap-2 mb-4">
      <button class="view-btn px-4 py-2 rounded-full bg-indigo-600 text-white text-sm font-medium" data-view="cards" title="Exibição em cartões"><i class="fas fa-th"></i></button>
      <button class="view-btn px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition" data-view="list" title="Exibição em lista"><i class="fas fa-list"></i></button>
    </div>
    <div id="searchBar" class="flex flex-wrap gap-2 mb-4">
      <input id="searchInput" type="text" class="form-control w-64" placeholder="Buscar por nome, ID, e-mail, data" />
      <select id="sortSelect" class="form-control">
        <option value="createdAt">Ordenar por data</option>
        <option value="owner">Ordenar por responsável</option>
        <option value="status">Ordenar por status</option>
      </select>
      <button id="advancedToggle" class="btn px-3 py-2 bg-gray-200 text-gray-700 rounded">Filtros avançados</button>
    </div>
    <div id="advancedFilters" class="flex flex-wrap gap-2 mb-4 hidden">
      <input type="date" id="startDate" class="form-control" />
      <input type="date" id="endDate" class="form-control" />
      <input type="text" id="responsavelFilter" class="form-control w-48" placeholder="Responsável" />
      <label class="flex items-center gap-1 text-sm">
        <input type="checkbox" id="attentionOnly" class="mr-1" />
        <span>Somente Atenção</span>
      </label>
    </div>
    <div id="labelsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
  </div>

  <div id="pdfModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white w-11/12 md:w-3/4 h-5/6 rounded shadow-lg relative">
      <button id="closeModal" class="absolute top-2 right-2 text-gray-600"><i class="fas fa-times"></i></button>
      <iframe id="pdfFrame" src="" class="w-full h-full rounded-b"></iframe>
    </div>
  </div>

 <script type="module">
    import { firebaseConfig, getPassphrase } from './firebase-config.js';
    import { decryptString } from './crypto.js';

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const storage = firebase.storage();
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    let currentUser = null;
    let currentFilter = 'all';
    let viewMode = 'cards';
    let diaDocRef = null;
    let isResponsavel = false;
    const userNameCache = {};
    let gestoresEmails = [];
    let currentUserName = '';
    let responsavelExpedicaoUid = null;
    let searchTerm = '';
    let sortOption = 'createdAt';
    let startDateFilter = '';
    let endDateFilter = '';
    let responsavelFiltro = '';
    let attentionOnly = false;

    const startBtn = document.getElementById('startDayBtn');
    const closeBtn = document.getElementById('closeDayBtn');
    startBtn.addEventListener('click', iniciarDia);
    closeBtn.addEventListener('click', fecharDia);
    const sobrasDiv = document.getElementById('sobrasFields');
    const sobrasQtdInput = document.getElementById('sobrasQuantidade');
    const sobrasMotivoInput = document.getElementById('sobrasMotivo');
    const sobrasResponsavelSelect = document.getElementById('sobrasResponsavel');
    const manualPdfInput = document.getElementById('manualPdfInput');
    const uploadManualBtn = document.getElementById('uploadManualBtn');
    uploadManualBtn.addEventListener('click', uploadManualLabel);
    const gestorUsersBtn = document.getElementById('gestorUsersBtn');
    if (gestorUsersBtn) {
      gestorUsersBtn.addEventListener('click', () => {
        const card = document.getElementById('gestorUsersCard');
        if (card.classList.contains('hidden')) {
          carregarEquipeGestor();
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      });
    }
    const enviarSobrasBtn = document.getElementById('enviarSobrasBtn');
    if (enviarSobrasBtn) enviarSobrasBtn.addEventListener('click', enviarSobras);

    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.addEventListener('input', () => {
      searchTerm = searchInput.value.toLowerCase();
      carregarEtiquetas();
    });
    const sortSelect = document.getElementById('sortSelect');
    if (sortSelect) sortSelect.addEventListener('change', () => {
      sortOption = sortSelect.value;
      carregarEtiquetas();
    });
    const advancedToggle = document.getElementById('advancedToggle');
    const advancedFiltersDiv = document.getElementById('advancedFilters');
    if (advancedToggle && advancedFiltersDiv) {
      advancedToggle.addEventListener('click', () => {
        advancedFiltersDiv.classList.toggle('hidden');
      });
    }
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const responsavelInput = document.getElementById('responsavelFilter');
    const attentionOnlyInput = document.getElementById('attentionOnly');
    if (startDateInput) startDateInput.addEventListener('change', () => {
      startDateFilter = startDateInput.value;
      carregarEtiquetas();
    });
    if (endDateInput) endDateInput.addEventListener('change', () => {
      endDateFilter = endDateInput.value;
      carregarEtiquetas();
    });
    if (responsavelInput) responsavelInput.addEventListener('input', () => {
      responsavelFiltro = responsavelInput.value.toLowerCase();
      carregarEtiquetas();
    });
    if (attentionOnlyInput) attentionOnlyInput.addEventListener('change', () => {
      attentionOnly = attentionOnlyInput.checked;
      carregarEtiquetas();
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => {
          b.classList.remove('bg-indigo-600','text-white');
          b.classList.add('bg-gray-100','text-gray-700');
        });
        btn.classList.remove('bg-gray-100','text-gray-700');
        btn.classList.add('bg-indigo-600','text-white');
        currentFilter = btn.dataset.status;
        carregarEtiquetas();
      });
    });

    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-btn').forEach(b => {
          b.classList.remove('bg-indigo-600','text-white');
          b.classList.add('bg-gray-100','text-gray-700');
        });
        btn.classList.remove('bg-gray-100','text-gray-700');
        btn.classList.add('bg-indigo-600','text-white');
        viewMode = btn.dataset.view;
        carregarEtiquetas();
      });
    });

    firebase.auth().onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        await carregarDadosUsuario();
        await verificarResponsavel();
        carregarEtiquetas();
        if (isResponsavel) {
          verificarDia();
          carregarEquipeGestor();
        } else {
          startBtn.classList.add('hidden');
          closeBtn.classList.add('hidden');
        }
      }
    });

    async function verificarResponsavel() {
      try {
        const q1 = await db.collection('uid').where('responsavelExpedicaoEmail', '==', currentUser.email).limit(1).get();
        const q2 = await db.collection('uid').where('gestoresExpedicaoEmails', 'array-contains', currentUser.email).limit(1).get();
        isResponsavel = !q1.empty || !q2.empty;
      } catch (e) {
        console.error('Erro ao verificar responsável:', e);
        isResponsavel = false;
      }
    }

    async function getOwnerName(uid, email) {
      if (uid && userNameCache[uid]) return userNameCache[uid];
      try {
        if (uid) {
          const snap = await db.collection('uid').doc(uid).get();
          if (snap.exists) {
            const data = snap.data();
            let nome = data.nome;
            if (!nome && data.encrypted) {
              try {
                const pass = getPassphrase() || `chave-${uid}`;
                const dec = await decryptString(data.encrypted, pass);
                nome = JSON.parse(dec).nome;
              } catch (_) {}
            }
            if (nome) {
              userNameCache[uid] = nome;
              return nome;
            }
          }
        }
      } catch (e) {
        console.error('Erro ao obter nome do usuário:', e);
      }
      return email || 'Desconhecido';
    }

    async function carregarDadosUsuario() {
      try {
        currentUserName = await getOwnerName(currentUser.uid, currentUser.email);
        const snap = await db.collection('uid').doc(currentUser.uid).get();
        const data = snap.data() || {};
        const emails = data.gestoresExpedicaoEmails || data.responsavelExpedicaoEmail || [];
        gestoresEmails = Array.isArray(emails) ? emails : [emails];
        const respEmail = Array.isArray(data.gestoresExpedicaoEmails)
          ? data.gestoresExpedicaoEmails[0]
          : data.responsavelExpedicaoEmail;
        if (respEmail) {
          try {
            const respSnap = await db.collection('uid').where('email', '==', respEmail).limit(1).get();
            if (!respSnap.empty) responsavelExpedicaoUid = respSnap.docs[0].id;
          } catch (err) {
            console.error('Erro ao obter UID do responsável:', err);
          }
        }
      } catch (e) {
        console.error('Erro ao carregar dados do usuário:', e);
        gestoresEmails = [];
        currentUserName = currentUser.email;
      }
    }

    async function carregarEquipeGestor() {
      const card = document.getElementById('gestorUsersCard');
      const listEl = document.getElementById('gestorUsersList');
      const selectEl = sobrasResponsavelSelect;
      if (!currentUser || !card || !listEl) return;
      try {
        const usuarios = new Map();
        const snap1 = await db.collection('uid').where('gestoresExpedicaoEmails', 'array-contains', currentUser.email).get();
        snap1.forEach(docu => {
          if (docu.id !== currentUser.uid) usuarios.set(docu.id, docu.data());
        });
        const snap2 = await db.collection('uid').where('responsavelExpedicaoEmail', '==', currentUser.email).get();
        snap2.forEach(docu => {
          if (docu.id !== currentUser.uid) usuarios.set(docu.id, docu.data());
        });
        listEl.innerHTML = '';
        if (selectEl) selectEl.innerHTML = '<option value="">Selecione responsável</option>';
        for (const [uid, data] of usuarios) {
          const nome = await getOwnerName(uid, data.email);
          const li = document.createElement('li');
          li.textContent = `${nome} (${data.email || ''})`;
          listEl.appendChild(li);
          if (selectEl) {
            const opt = document.createElement('option');
            opt.value = uid;
            opt.textContent = nome;
            selectEl.appendChild(opt);
          }
        }
      } catch (e) {
        console.error('Erro ao carregar equipe de expedição:', e);
      }
    }

    async function carregarEtiquetas() {
      const list = document.getElementById('labelsList');
      list.innerHTML = '';
      list.className = viewMode === 'cards'
        ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4'
        : 'flex flex-col gap-4';
      const filter = currentFilter;
      const snap = await db
        .collection('pdfDocs')
        .orderBy('createdAt', 'desc')
        .get();
      const seen = new Set();
      const results = [];
      for (const doc of snap.docs) {
        const data = doc.data();
        const allowed =
          data.ownerEmail === currentUser.email ||
          (data.gestoresExpedicaoEmails || []).includes(currentUser.email);
        if (!allowed || !data.url) continue;
        const key = data.storagePath || data.url;
        if (seen.has(key)) continue;
        seen.add(key);
        const status = data.status || 'nao_impresso';
        if (filter === 'all') {
          if (status === 'concluido') continue;
        } else if (status !== filter) {
          continue;
        }
        const ownerName = data.ownerName || await getOwnerName(data.ownerUid, data.ownerEmail);
        const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
        const name = (data.name || '').toLowerCase();
        const ownerEmail = (data.ownerEmail || '').toLowerCase();
        const docId = doc.id.toLowerCase();
        const dateStr = createdAt ? createdAt.toISOString().split('T')[0] : '';
        const searchMatch = !searchTerm ||
          name.includes(searchTerm) ||
          docId.includes(searchTerm) ||
          ownerEmail.includes(searchTerm) ||
          dateStr.includes(searchTerm);
        if (!searchMatch) continue;
        const startOk = !startDateFilter || (createdAt && createdAt >= new Date(startDateFilter));
        const endOk = !endDateFilter || (createdAt && createdAt <= new Date(endDateFilter + 'T23:59:59'));
        if (!startOk || !endOk) continue;
        const respMatch = !responsavelFiltro ||
          ownerName.toLowerCase().includes(responsavelFiltro) ||
          ownerEmail.includes(responsavelFiltro);
        if (!respMatch) continue;
        if (attentionOnly && !data.attention) continue;
        results.push({ doc, data, ownerName, createdAt });
      }
      results.sort((a,b) => {
        if (sortOption === 'owner') return (a.ownerName || '').localeCompare(b.ownerName || '');
        if (sortOption === 'status') return (a.data.status || '').localeCompare(b.data.status || '');
        return (b.createdAt?.getTime() || 0) - (a.createdAt?.getTime() || 0);
      });
      for (const r of results) {
        const item = viewMode === 'cards' ? createPdfCard(r.doc, r.ownerName) : createPdfListItem(r.doc, r.ownerName);
        list.appendChild(item);
      }
      if (!list.hasChildNodes()) {
        list.innerHTML = '<p class="text-gray-500">Nenhuma etiqueta encontrada.</p>';
      }
    }

    async function verificarDia() {
      const uid = currentUser.uid;
      const hoje = new Date().toISOString().split('T')[0];
      diaDocRef = db.collection('uid').doc(uid).collection('diasExpedicao').doc(hoje);
      const doc = await diaDocRef.get();
      if (doc.exists && doc.data().fim) {
        startBtn.classList.remove('hidden');
        closeBtn.classList.add('hidden');
        sobrasDiv.classList.add('hidden');
      } else if (doc.exists) {
        startBtn.classList.add('hidden');
        closeBtn.classList.remove('hidden');
        sobrasDiv.classList.remove('hidden');
      } else {
        startBtn.classList.remove('hidden');
        closeBtn.classList.add('hidden');
        sobrasDiv.classList.add('hidden');
      }
    }

    async function iniciarDia() {
      if (!currentUser) return;
      const uid = currentUser.uid;
      const hoje = new Date().toISOString().split('T')[0];
      diaDocRef = db.collection('uid').doc(uid).collection('diasExpedicao').doc(hoje);
      await diaDocRef.set({ inicio: firebase.firestore.FieldValue.serverTimestamp() });
      startBtn.classList.add('hidden');
      closeBtn.classList.remove('hidden');
      sobrasDiv.classList.remove('hidden');
      showToast('Dia iniciado');
    }

    async function fecharDia() {
      if (!currentUser || !diaDocRef) return;
      const fim = new Date();
      const sobrasQtd = parseInt(sobrasQtdInput.value) || 0;
      const sobrasMotivo = sobrasMotivoInput.value.trim();
      const updateData = { fim: firebase.firestore.FieldValue.serverTimestamp() };
      if (sobrasQtd || sobrasMotivo) {
        updateData.sobrasQuantidade = sobrasQtd;
        updateData.sobrasMotivo = sobrasMotivo;
      }
      await diaDocRef.update(updateData);
      const doc = await diaDocRef.get();
      const dados = doc.data();
      const inicio = dados.inicio && dados.inicio.toDate ? dados.inicio.toDate() : new Date();
      if (sobrasQtd || sobrasMotivo) {
        await notificarUsuariosSobras(sobrasQtd, sobrasMotivo, sobrasResponsavelSelect.value);
      }
      await gerarRelatorioDia(inicio, fim, dados);
      await gerarRelatorioDiaPorUsuario(inicio, fim, dados);
      closeBtn.classList.add('hidden');
      sobrasDiv.classList.add('hidden');
      sobrasQtdInput.value = '';
      sobrasMotivoInput.value = '';
      if (sobrasResponsavelSelect) sobrasResponsavelSelect.value = '';
      showToast('Dia encerrado');
      verificarDia();
    }

    async function enviarSobras() {
      if (!currentUser) return;
      const sobrasQtd = parseInt(sobrasQtdInput.value) || 0;
      const sobrasMotivo = sobrasMotivoInput.value.trim();
      if (!sobrasQtd && !sobrasMotivo) {
        showToast('Informe quantidade e motivo');
        return;
      }
      await notificarUsuariosSobras(sobrasQtd, sobrasMotivo, sobrasResponsavelSelect.value);
      sobrasQtdInput.value = '';
      sobrasMotivoInput.value = '';
      if (sobrasResponsavelSelect) sobrasResponsavelSelect.value = '';
      showToast('Atualização enviada');
    }

    async function notificarUsuariosSobras(qtd, motivo, responsavelUid) {
      try {
        let destinatarios = [];
        if (responsavelUid) {
          destinatarios = [responsavelUid];
        } else {
          const usuarios = [];
          const snap1 = await db.collection('uid').where('gestoresExpedicaoEmails', 'array-contains', currentUser.email).get();
          snap1.forEach(d => usuarios.push(d.id));
          const snap2 = await db.collection('uid').where('responsavelExpedicaoEmail', '==', currentUser.email).get();
          snap2.forEach(d => { if (!usuarios.includes(d.id)) usuarios.push(d.id); });
          destinatarios = usuarios;
        }
        if (!destinatarios.length) return;
        await db.collection('expedicaoMensagens').add({
          gestorUid: currentUser.uid,
          gestorEmail: currentUser.email,
          quantidade: qtd,
          motivo,
          destinatarios,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        console.error('Erro ao notificar usuários de sobras:', e);
      }
    }

    function extractStoreFromText(text) {
      const match = text.match(/(?:Remetente|Loja)[:\s]+([^\n]+)/i);
      if (match) return match[1].trim();
      const lines = text.split(/\n/);
      for (const line of lines) {
        const m = line.match(/(?:Remetente|Loja)\s*[:\-]?\s*(.+)/i);
        if (m) return m[1].trim();
      }
      return '';
    }

    function extractSkuQuantitiesFromText(text) {
      const items = [];
      const regex = /SKU\s*[:\-]?\s*([\w\.\-\/]+).*?(?:QTD|QUANTIDADE)\s*[:\-]?\s*(\d+)/gis;
      let match;
      while ((match = regex.exec(text)) !== null) {
        items.push({ sku: match[1], quantidade: parseInt(match[2], 10) || 0 });
      }
      if (items.length === 0) {
        const lines = text.split(/\n/).map(l => l.trim());
        for (let i = 0; i < lines.length; i++) {
          const skuMatch = lines[i].match(/SKU\s*[:\-]?\s*([\w\.\-\/]+)/i);
          if (skuMatch) {
            const next = lines[i + 1] || '';
            const qtdMatch = next.match(/(QTD|QUANTIDADE)\s*[:\-]?\s*(\d+)/i);
            items.push({ sku: skuMatch[1], quantidade: qtdMatch ? parseInt(qtdMatch[2], 10) || 0 : 0 });
          }
        }
      }
      return items;
    }

    async function extractDataFromPdf(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      let itens = [];
      let loja = '';
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 2 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        const { data: { text } } = await Tesseract.recognize(canvas, 'por+eng');
        if (!loja) loja = extractStoreFromText(text);
        itens.push(...extractSkuQuantitiesFromText(text));
      }
      return { loja, itens };
    }

    async function savePrintedSkuQuantities(items, loja) {
      if (!currentUser || !items || items.length === 0) return;
      const batch = db.batch();
      const userDoc = db.collection('uid').doc(currentUser.uid);
      const respDoc = responsavelExpedicaoUid ? db.collection('uid').doc(responsavelExpedicaoUid) : null;
      items.forEach(item => {
        const data = {
          sku: item.sku,
          quantidade: item.quantidade,
          loja: loja || '',
          userUid: currentUser.uid,
          userEmail: currentUser.email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        batch.set(userDoc.collection('skuimpressos').doc(), data);
        if (respDoc) batch.set(respDoc.collection('skuimpressos').doc(), data);
      });
      await batch.commit();
    }

    async function processManualLabel(file) {
      try {
        const { loja, itens } = await extractDataFromPdf(file);
        if (itens.length) {
          await savePrintedSkuQuantities(itens, loja);
        }
      } catch (e) {
        console.error('Erro ao processar OCR da etiqueta:', e);
      }
    }

    async function uploadManualLabel() {
      const file = manualPdfInput.files[0];
      if (!currentUser || !file) {
        alert('Selecione um arquivo PDF.');
        return;
      }
      try {
        const docRef = await db.collection('pdfDocs').add({
          ownerUid: currentUser.uid,
          ownerEmail: currentUser.email,
          ownerName: currentUserName,
          gestoresExpedicaoEmails: gestoresEmails,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          name: file.name,
          status: 'nao_impresso'
        });
        const fileRef = storage.ref().child(`pdfs/${currentUser.uid}/${docRef.id}.pdf`);
        await fileRef.put(file);
        const url = await fileRef.getDownloadURL();
        await docRef.update({ url: url, storagePath: fileRef.fullPath });
        await processManualLabel(file);
        manualPdfInput.value = '';
        showToast('Etiqueta adicionada');
        carregarEtiquetas();
      } catch (e) {
        console.error('Erro ao enviar etiqueta:', e);
        alert('Erro ao enviar etiqueta');
      }
    }

    async function gerarRelatorioDia(inicio, fim, diaDados) {
      const uid = currentUser.uid;
      const userDoc = db.collection('uid').doc(uid);
      const snap = await userDoc
        .collection('skuimpressos')
        .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(inicio))
        .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(fim))
        .get();
      const resumo = {};
      snap.forEach(d => {
        const data = d.data();
        const loja = data.loja || 'sem-loja';
        const sku = data.sku || 'sem-sku';
        const qtd = data.quantidade || 0;
        const key = `${loja}||${sku}`;
        resumo[key] = (resumo[key] || 0) + qtd;
      });
      const linhas = Object.entries(resumo).map(([chave, qtd]) => {
        const [loja, sku] = chave.split('||');
        return { Loja: loja, SKU: sku, Quantidade: qtd };
      });
      if (!linhas.length) {
        alert('Nenhum SKU impresso no período.');
        return;
      }
      const ws = XLSX.utils.json_to_sheet(linhas);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Resumo');
      if (diaDados && (diaDados.sobrasQuantidade || diaDados.sobrasMotivo)) {
        const wsSobras = XLSX.utils.json_to_sheet([
          { Quantidade: diaDados.sobrasQuantidade || 0, Motivo: diaDados.sobrasMotivo || '' }
        ]);
        XLSX.utils.book_append_sheet(wb, wsSobras, 'Sobras');
      }
      const diaStr = inicio.toISOString().split('T')[0];
      XLSX.writeFile(wb, `resumo_expedicao_${diaStr}.xlsx`);
    }

    async function gerarRelatorioDiaPorUsuario(inicio, fim, diaDados) {
      const snap = await db
        .collectionGroup('skuimpressos')
        .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(inicio))
        .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(fim))
        .get();
      const resumo = {};
      snap.forEach(d => {
        const data = d.data();
        const usuario = data.userEmail || 'Desconhecido';
        const loja = data.loja || 'sem-loja';
        const sku = data.sku || 'sem-sku';
        const qtd = data.quantidade || 0;
        if (!resumo[usuario]) resumo[usuario] = {};
        if (!resumo[usuario][loja]) resumo[usuario][loja] = {};
        resumo[usuario][loja][sku] = (resumo[usuario][loja][sku] || 0) + qtd;
      });
      const linhas = [];
      Object.entries(resumo).forEach(([usuario, lojas]) => {
        Object.entries(lojas).forEach(([loja, skus]) => {
          Object.entries(skus).forEach(([sku, qtd]) => {
            linhas.push({ Usuario: usuario, Loja: loja, SKU: sku, Quantidade: qtd });
          });
        });
      });
      if (!linhas.length) {
        alert('Nenhum SKU encontrado para o dia.');
        return;
      }
      const ws = XLSX.utils.json_to_sheet(linhas);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
      if (diaDados && (diaDados.sobrasQuantidade || diaDados.sobrasMotivo)) {
        const wsSobras = XLSX.utils.json_to_sheet([
          { Quantidade: diaDados.sobrasQuantidade || 0, Motivo: diaDados.sobrasMotivo || '' }
        ]);
        XLSX.utils.book_append_sheet(wb, wsSobras, 'Sobras');
      }
      const diaStr = inicio.toISOString().split('T')[0];
      XLSX.writeFile(wb, `relatorio_sku_usuarios_${diaStr}.xlsx`);
    }

    function createPdfCard(doc, ownerName) {
      const data = doc.data();
      const status = data.status || 'nao_impresso';
      const attention = data.attention || false;
      const name = data.name || 'PDF';
      const url = data.url;
      const owner = ownerName || 'Desconhecido';
      const createdAt = data.createdAt && data.createdAt.toDate
        ? data.createdAt.toDate().toLocaleString('pt-BR')
        : 'Data desconhecida';
      const statusBadge = status === 'impresso'
        ? '<span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">Impresso</span>'
        : status === 'concluido'
          ? '<span class="text-xs bg-blue-500 text-white px-2 py-0.5 rounded-full">Concluído</span>'
          : '<span class="text-xs bg-yellow-500 text-white px-2 py-0.5 rounded-full">Não impresso</span>';
      const div = document.createElement('div');
      div.className = 'pdf-card border rounded-lg p-4 bg-white shadow relative' + (attention ? ' border-red-500 border-2' : '');
      div.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <p class="font-semibold text-gray-800 text-sm">${name}</p>
            <p class="text-xs text-gray-500">${owner} - ${createdAt}</p>
          </div>
          <div class="flex items-start gap-2">
            ${statusBadge}
            <div class="relative">
              <button class="text-gray-600 hover:text-gray-800" onclick="toggleMenu(this)"><i class="fas fa-ellipsis-v"></i></button>
              <div class="hidden absolute right-0 mt-2 w-32 bg-white border rounded-md shadow-lg z-10">
                <button class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 w-full text-left" onclick="visualizar('${url}')"><i class="fas fa-eye text-indigo-600"></i><span>Ver</span></button>
                <button class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 w-full text-left" onclick="imprimir('${url}')"><i class="fas fa-print text-indigo-600"></i><span>Imprimir</span></button>
                <a class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 w-full text-left" href="${url}" download="${name}"><i class="fas fa-download text-indigo-600"></i><span>Baixar</span></a>
                <button class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 w-full text-left text-red-600" onclick="excluirEtiqueta('${doc.id}', this.closest('.pdf-card'))"><i class="fas fa-trash"></i><span>Excluir</span></button>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-2 flex items-center gap-2">
          <label class="flex items-center gap-1 text-xs">
            <input type="checkbox" class="mr-1" ${status === 'impresso' ? 'checked' : ''} onchange="toggleImpresso('${doc.id}', this, this.closest('.pdf-card'))">
            <span>Impresso</span>
          </label>
          <label class="flex items-center gap-1 text-xs">
            <input type="checkbox" class="mr-1" ${attention ? 'checked' : ''} onchange="toggleAtencao('${doc.id}', this, this.closest('.pdf-card'))">
            <span>Atenção</span>
          </label>
          <button class="ml-auto bg-green-600 text-white px-2 py-1 rounded text-xs flex items-center gap-1 hover:bg-green-700" onclick="marcarConcluido('${doc.id}', this.closest('.pdf-card'))"><i class="fas fa-check"></i><span>Concluir</span></button>
        </div>`;
      return div;
    }

    function createPdfListItem(doc, ownerName) {
      const data = doc.data();
      const status = data.status || 'nao_impresso';
      const attention = data.attention || false;
      const observacao = data.observacao || '';
      const name = data.name || 'PDF';
      const url = data.url;
      const owner = ownerName || 'Desconhecido';
      const createdAt = data.createdAt && data.createdAt.toDate
        ? data.createdAt.toDate().toLocaleString('pt-BR')
        : 'Data desconhecida';
      const statusClass = status === 'impresso'
        ? 'bg-green-100'
        : status === 'nao_impresso'
          ? 'bg-yellow-100'
          : 'bg-white';
      const div = document.createElement('div');
      div.className = `pdf-card flex flex-col md:flex-row md:items-center md:justify-between p-4 rounded-md shadow ${statusClass}` + (attention ? ' border-2 border-red-500' : '');
      div.innerHTML = `
        <div class="flex-1">
          <p class="font-semibold text-gray-800">${name}</p>
          <p class="text-sm text-gray-500">Criado por: ${owner} em ${createdAt}</p>
          <div class="mt-2 flex flex-wrap gap-2">
            <button class="text-indigo-600 hover:text-indigo-800" onclick="visualizar('${url}')" title="Visualizar"><i class="fas fa-eye"></i></button>
            <button class="text-indigo-600 hover:text-indigo-800" onclick="imprimir('${url}')" title="Imprimir"><i class="fas fa-print"></i></button>
            <a class="text-indigo-600 hover:text-indigo-800" href="${url}" download="${name}" title="Baixar"><i class="fas fa-download"></i></a>
            <button class="text-red-600 hover:text-red-800" onclick="excluirEtiqueta('${doc.id}', this.closest('.pdf-card'))" title="Excluir"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="mt-3 md:mt-0 flex flex-col gap-2 w-full md:w-1/3">
          <label class="cursor-pointer">
            <input type="checkbox" class="peer sr-only" ${status === 'impresso' ? 'checked' : ''} onchange="toggleImpresso('${doc.id}', this, this.closest('.pdf-card'))">
            <span class="px-2 py-1 rounded-full text-xs font-medium border border-gray-300 text-gray-600 peer-checked:bg-green-500 peer-checked:border-green-500 peer-checked:text-white flex items-center gap-1"><i class="fas fa-check"></i><span>Impresso</span></span>
          </label>
          <label class="cursor-pointer">
            <input type="checkbox" class="peer sr-only" ${attention ? 'checked' : ''} onchange="toggleAtencao('${doc.id}', this, this.closest('.pdf-card'))">
            <span class="px-2 py-1 rounded-full text-xs font-medium border border-gray-300 text-gray-600 peer-checked:bg-red-500 peer-checked:border-red-500 peer-checked:text-white flex items-center gap-1"><i class="fas fa-exclamation-triangle"></i><span>Atenção</span></span>
          </label>
          <textarea class="border rounded-md p-2 w-full text-sm" placeholder="Observação" onblur="salvarObservacao('${doc.id}', this.value)">${observacao}</textarea>
          <button class="w-full bg-green-600 text-white px-3 py-2 rounded-md text-sm hover:bg-green-700 transition" onclick="marcarConcluido('${doc.id}', this.closest('.pdf-card'))">Concluir</button>
        </div>`;
      return div;
    }

    const pdfModal = document.getElementById('pdfModal');
    const pdfFrame = document.getElementById('pdfFrame');
    const closeModal = document.getElementById('closeModal');

    function visualizar(url) {
      pdfFrame.src = url;
      pdfModal.classList.remove('hidden');
    }
    window.visualizar = visualizar;

    closeModal.addEventListener('click', () => {
      pdfModal.classList.add('hidden');
      pdfFrame.src = '';
    });

    pdfModal.addEventListener('click', e => {
      if (e.target === pdfModal) {
        pdfModal.classList.add('hidden');
        pdfFrame.src = '';
      }
    });

    function imprimir(url) {
      const win = window.open('', '_blank');
      win.document.write('<iframe id="printFrame" width="100%" height="100%" src="' + url + '"></iframe>');
      win.document.close();
      win.focus();
      win.onload = () => win.document.getElementById('printFrame').contentWindow.print();
    }
    window.imprimir = imprimir;

    function toggleMenu(btn) {
      const menu = btn.nextElementSibling;
      if (menu) menu.classList.toggle('hidden');
    }
    window.toggleMenu = toggleMenu;

    async function toggleImpresso(id, checkbox, card) {
      const checked = checkbox.checked;
      const confirmMsg = `Deseja ${checked ? 'marcar como impresso' : 'marcar como não impresso'}?`;
      if (!confirm(confirmMsg)) {
        checkbox.checked = !checked;
        return;
      }
      await db.collection('pdfDocs').doc(id).update({ status: checked ? 'impresso' : 'nao_impresso' });
      if (card) {
        card.classList.remove('bg-yellow-100','bg-green-100','bg-white');
        card.classList.add(checked ? 'bg-green-100' : 'bg-yellow-100');
      }
      showToast('Status atualizado');
    }
    window.toggleImpresso = toggleImpresso;

    async function marcarConcluido(id, card) {
      try {
        const docRef = db.collection('pdfDocs').doc(id);
        const snap = await docRef.get();
        const data = snap.data() || {};

        if (data.status !== 'impresso') {
          const items = (data.skus || data.skuList || []).map(s => ({ sku: s, quantidade: 1 }));
          if (items.length) await savePrintedSkuQuantities(items, data.loja || '');
          await docRef.update({ status: 'impresso' });
        }

        if (data.url) {
          const link = document.createElement('a');
          link.href = data.url;
          link.download = data.name || 'etiqueta.pdf';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        const skus = data.skus || data.skuList || [];
        for (const sku of skus) {
          await db.collection('pedidosconcluidos').add({
            sku: sku,
            pdfDocId: id,
            ownerUid: data.ownerUid || null,
            ownerEmail: data.ownerEmail || null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        if (data.storagePath) {
          try {
            await storage.ref(data.storagePath).delete();
          } catch (e) {
            console.error('Erro ao excluir do Storage:', e);
          }
        }

        await docRef.update({ status: 'concluido' });
        if (card) card.remove();
        showToast('Marcado como concluído');
      } catch (e) {
        console.error('Erro ao concluir etiqueta:', e);
        alert('Erro ao concluir etiqueta');
      }
    }
    window.marcarConcluido = marcarConcluido;

    async function excluirEtiqueta(id, card) {
      if (!confirm('Deseja excluir esta etiqueta?')) return;
      try {
        const docRef = db.collection('pdfDocs').doc(id);
        const snap = await docRef.get();
        const data = snap.data() || {};
        if (data.storagePath) {
          try {
            await storage.ref(data.storagePath).delete();
          } catch (e) {
            console.error('Erro ao excluir do Storage:', e);
          }
        }
        await docRef.delete();
        if (card) card.remove();
        showToast('Etiqueta excluída');
      } catch (e) {
        console.error('Erro ao excluir etiqueta:', e);
        alert('Erro ao excluir etiqueta');
      }
    }
    window.excluirEtiqueta = excluirEtiqueta;

    async function toggleAtencao(id, checkbox, card) {
      const checked = checkbox.checked;
      const confirmMsg = `Deseja ${checked ? 'marcar com atenção' : 'remover atenção'}?`;
      if (!confirm(confirmMsg)) {
        checkbox.checked = !checked;
        return;
      }
      await db.collection('pdfDocs').doc(id).update({ attention: checked });
      if (card) {
        if (checked) {
          card.classList.add('border-2','border-red-500');
        } else {
          card.classList.remove('border-2','border-red-500');
        }
      }
      showToast('Atualizado');
    }
    window.toggleAtencao = toggleAtencao;

    async function salvarObservacao(id, texto) {
      await db.collection('pdfDocs').doc(id).update({ observacao: texto });
      showToast('Observação salva');
    }
    window.salvarObservacao = salvarObservacao;

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow transition-opacity';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('opacity-0'), 2000);
      setTimeout(() => toast.remove(), 2500);
    }

  </script>
  <script type="module" src="login.js"></script>
  <script src="shared.js"></script>
</body>
</html>
