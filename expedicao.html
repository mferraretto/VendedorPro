<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expedição</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="sidebar-container"></div>
  <div id="navbar-container"></div>
  <div class="main-content p-4">
    <h1 class="text-2xl font-bold mb-4">Expedição</h1>
    <div class="mb-4">
      <button id="startDayBtn" class="btn btn-primary mr-2">Iniciar Dia</button>
      <button id="closeDayBtn" class="btn btn-secondary hidden">Fechar Dia</button>
    </div>
    <div id="statusFilters" class="flex flex-wrap gap-2 mb-4">
      <button class="filter-btn px-3 py-1 rounded-full bg-blue-500 text-white" data-status="all">Todas</button>
      <button class="filter-btn px-3 py-1 rounded-full bg-gray-200" data-status="nao_impresso">Não impresso</button>
      <button class="filter-btn px-3 py-1 rounded-full bg-gray-200" data-status="impresso">Impresso</button>
      <button class="filter-btn px-3 py-1 rounded-full bg-gray-200" data-status="concluido">Concluído</button>
    </div>
    <div id="labelsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>

  <div id="pdfModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white w-11/12 md:w-3/4 h-5/6 rounded shadow-lg relative">
      <button id="closeModal" class="absolute top-2 right-2 text-gray-600"><i class="fas fa-times"></i></button>
      <iframe id="pdfFrame" src="" class="w-full h-full rounded-b"></iframe>
    </div>
  </div>

 <script type="module">
    import { firebaseConfig } from './firebase-config.js';

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const storage = firebase.storage();
    let currentUser = null;
    let currentFilter = 'all';
    let diaDocRef = null;
    let isResponsavel = false;

    const startBtn = document.getElementById('startDayBtn');
    const closeBtn = document.getElementById('closeDayBtn');
    startBtn.addEventListener('click', iniciarDia);
    closeBtn.addEventListener('click', fecharDia);

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-blue-500','text-white'));
        btn.classList.add('bg-blue-500','text-white');
        currentFilter = btn.dataset.status;
        carregarEtiquetas();
      });
    });

    firebase.auth().onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        await verificarResponsavel();
        carregarEtiquetas();
        if (isResponsavel) {
          verificarDia();
        } else {
          startBtn.classList.add('hidden');
          closeBtn.classList.add('hidden');
        }
      }
    });

    async function verificarResponsavel() {
      try {
        const q1 = await db.collection('uid').where('responsavelExpedicaoEmail', '==', currentUser.email).limit(1).get();
        const q2 = await db.collection('uid').where('gestoresExpedicaoEmails', 'array-contains', currentUser.email).limit(1).get();
        isResponsavel = !q1.empty || !q2.empty;
      } catch (e) {
        console.error('Erro ao verificar responsável:', e);
        isResponsavel = false;
      }
    }

    async function carregarEtiquetas() {
      const list = document.getElementById('labelsList');
      list.innerHTML = '';
      const filter = currentFilter;
      const snap = await db
        .collection('pdfDocs')
        .orderBy('createdAt', 'desc')
        .get();
      snap.forEach(doc => {
        const data = doc.data();
        const allowed =
          data.ownerEmail === currentUser.email ||
          (data.gestoresExpedicaoEmails || []).includes(currentUser.email);
        if (!allowed) return;
        const status = data.status || 'nao_impresso';
        if (filter !== 'all' && status !== filter) return;
        const card = createPdfCard(doc);
        list.appendChild(card);
      });
      if (!list.hasChildNodes()) {
        list.innerHTML = '<p class="text-gray-500">Nenhuma etiqueta encontrada.</p>';
      }
    }

    async function verificarDia() {
      const uid = currentUser.uid;
      const hoje = new Date().toISOString().split('T')[0];
      diaDocRef = db.collection('uid').doc(uid).collection('diasExpedicao').doc(hoje);
      const doc = await diaDocRef.get();
      if (doc.exists && doc.data().fim) {
        startBtn.classList.add('hidden');
        closeBtn.classList.add('hidden');
      } else if (doc.exists) {
        startBtn.classList.add('hidden');
        closeBtn.classList.remove('hidden');
      } else {
        startBtn.classList.remove('hidden');
        closeBtn.classList.add('hidden');
      }
    }

    async function iniciarDia() {
      if (!currentUser) return;
      const uid = currentUser.uid;
      const hoje = new Date().toISOString().split('T')[0];
      diaDocRef = db.collection('uid').doc(uid).collection('diasExpedicao').doc(hoje);
      await diaDocRef.set({ inicio: firebase.firestore.FieldValue.serverTimestamp() });
      startBtn.classList.add('hidden');
      closeBtn.classList.remove('hidden');
      showToast('Dia iniciado');
    }

    async function fecharDia() {
      if (!currentUser || !diaDocRef) return;
      const fim = new Date();
      await diaDocRef.update({ fim: firebase.firestore.FieldValue.serverTimestamp() });
      const doc = await diaDocRef.get();
      const dados = doc.data();
      const inicio = dados.inicio && dados.inicio.toDate ? dados.inicio.toDate() : new Date();
      await gerarRelatorioDia(inicio, fim);
      await gerarRelatorioDiaPorUsuario(inicio, fim);
      closeBtn.classList.add('hidden');
      showToast('Dia encerrado');
      verificarDia();
    }

    async function gerarRelatorioDia(inicio, fim) {
      const uid = currentUser.uid;
      const userDoc = db.collection('uid').doc(uid);
      const snap = await userDoc
        .collection('skuimpressos')
        .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(inicio))
        .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(fim))
        .get();
      const resumo = {};
      snap.forEach(d => {
        const data = d.data();
        const sku = data.sku || 'sem-sku';
        const qtd = data.quantidade || 0;
        resumo[sku] = (resumo[sku] || 0) + qtd;
      });
      const linhas = Object.entries(resumo).map(([sku, qtd]) => ({ SKU: sku, Quantidade: qtd }));
      if (!linhas.length) {
        alert('Nenhum SKU impresso no período.');
        return;
      }
      const ws = XLSX.utils.json_to_sheet(linhas);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Resumo');
      const diaStr = inicio.toISOString().split('T')[0];
      XLSX.writeFile(wb, `resumo_expedicao_${diaStr}.xlsx`);
    }

    async function gerarRelatorioDiaPorUsuario(inicio, fim) {
      const snap = await db
        .collectionGroup('skuimpressos')
        .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(inicio))
        .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(fim))
        .get();
      const resumo = {};
      snap.forEach(d => {
        const data = d.data();
        const usuario = data.userEmail || 'Desconhecido';
        const sku = data.sku || 'sem-sku';
        const qtd = data.quantidade || 0;
        if (!resumo[usuario]) resumo[usuario] = {};
        resumo[usuario][sku] = (resumo[usuario][sku] || 0) + qtd;
      });
      const linhas = [];
      Object.entries(resumo).forEach(([usuario, skus]) => {
        Object.entries(skus).forEach(([sku, qtd]) => {
          linhas.push({ Usuario: usuario, SKU: sku, Quantidade: qtd });
        });
      });
      if (!linhas.length) {
        alert('Nenhum SKU encontrado para o dia.');
        return;
      }
      const ws = XLSX.utils.json_to_sheet(linhas);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
      const diaStr = inicio.toISOString().split('T')[0];
      XLSX.writeFile(wb, `relatorio_sku_usuarios_${diaStr}.xlsx`);
    }

    function createPdfCard(doc) {
      const data = doc.data();
      const status = data.status || 'nao_impresso';
      const attention = data.attention || false;
      const observacao = data.observacao || '';
      const name = data.name || 'PDF';
      const url = data.url;
      const owner = data.ownerEmail || 'Desconhecido';
      const createdAt = data.createdAt && data.createdAt.toDate
        ? data.createdAt.toDate().toLocaleString('pt-BR')
        : 'Data desconhecida';
      const statusClass = status === 'impresso'
        ? 'bg-green-100'
        : status === 'nao_impresso'
          ? 'bg-yellow-100'
          : 'bg-white';
      const div = document.createElement('div');
      div.className = `pdf-card p-4 rounded-lg shadow transition-colors ${statusClass}` + (attention ? ' border-2 border-red-500' : '');
      div.innerHTML = `
        <p class="font-semibold">${name}</p>
        <p class="text-sm text-gray-600">Criado por: ${owner} em ${createdAt}</p>
        <div class="mt-2 flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
          <button class="btn btn-primary flex items-center justify-center" onclick="visualizar('${url}')"><i class="fas fa-eye mr-2"></i><span>Visualizar</span></button>
          <button class="btn btn-primary flex items-center justify-center" onclick="imprimir('${url}')"><i class="fas fa-print mr-2"></i><span>Imprimir</span></button>
          <a class="btn btn-primary flex items-center justify-center" href="${url}" download="${name}"><i class="fas fa-download mr-2"></i><span>Baixar</span></a>
        </div>
        <div class="mt-2 space-y-2">
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" class="peer sr-only" ${status === 'impresso' ? 'checked' : ''} onchange="toggleImpresso('${doc.id}', this, this.closest('.pdf-card'))">
            <span class="w-5 h-5 flex items-center justify-center border-2 border-gray-300 rounded-sm peer-checked:bg-blue-500 peer-checked:border-blue-500">
              <svg class="w-3 h-3 text-white hidden peer-checked:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
              </svg>
            </span>
            <span>Impresso</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" class="peer sr-only" ${attention ? 'checked' : ''} onchange="toggleAtencao('${doc.id}', this, this.closest('.pdf-card'))">
            <span class="w-5 h-5 flex items-center justify-center border-2 border-gray-300 rounded-sm peer-checked:bg-red-500 peer-checked:border-red-500">
              <svg class="w-3 h-3 text-white hidden peer-checked:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
              </svg>
            </span>
            <span>Atenção problema</span>
          </label>
          <textarea class="border p-1 w-full" placeholder="Observação" onblur="salvarObservacao('${doc.id}', this.value)">${observacao}</textarea>
          <button class="btn btn-secondary" onclick="marcarConcluido('${doc.id}', this.closest('.pdf-card'))">Concluir</button>
        </div>`;
      return div;
    }

    const pdfModal = document.getElementById('pdfModal');
    const pdfFrame = document.getElementById('pdfFrame');
    const closeModal = document.getElementById('closeModal');

    function visualizar(url) {
      pdfFrame.src = url;
      pdfModal.classList.remove('hidden');
    }
    window.visualizar = visualizar;

    closeModal.addEventListener('click', () => {
      pdfModal.classList.add('hidden');
      pdfFrame.src = '';
    });

    pdfModal.addEventListener('click', e => {
      if (e.target === pdfModal) {
        pdfModal.classList.add('hidden');
        pdfFrame.src = '';
      }
    });

    function imprimir(url) {
      const win = window.open('', '_blank');
      win.document.write('<iframe id="printFrame" width="100%" height="100%" src="' + url + '"></iframe>');
      win.document.close();
      win.focus();
      win.onload = () => win.document.getElementById('printFrame').contentWindow.print();
    }
    window.imprimir = imprimir;

    async function toggleImpresso(id, checkbox, card) {
      const checked = checkbox.checked;
      const confirmMsg = `Deseja ${checked ? 'marcar como impresso' : 'marcar como não impresso'}?`;
      if (!confirm(confirmMsg)) {
        checkbox.checked = !checked;
        return;
      }
      await db.collection('pdfDocs').doc(id).update({ status: checked ? 'impresso' : 'nao_impresso' });
      if (card) {
        card.classList.remove('bg-yellow-100','bg-green-100','bg-white');
        card.classList.add(checked ? 'bg-green-100' : 'bg-yellow-100');
      }
      showToast('Status atualizado');
    }
    window.toggleImpresso = toggleImpresso;

    async function marcarConcluido(id, card) {
      await db.collection('pdfDocs').doc(id).update({ status: 'concluido' });
      if (card) card.remove();
      showToast('Marcado como concluído');
    }
    window.marcarConcluido = marcarConcluido;

    async function toggleAtencao(id, checkbox, card) {
      const checked = checkbox.checked;
      const confirmMsg = `Deseja ${checked ? 'marcar com atenção' : 'remover atenção'}?`;
      if (!confirm(confirmMsg)) {
        checkbox.checked = !checked;
        return;
      }
      await db.collection('pdfDocs').doc(id).update({ attention: checked });
      if (card) {
        if (checked) {
          card.classList.add('border-2','border-red-500');
        } else {
          card.classList.remove('border-2','border-red-500');
        }
      }
      showToast('Atualizado');
    }
    window.toggleAtencao = toggleAtencao;

    async function salvarObservacao(id, texto) {
      await db.collection('pdfDocs').doc(id).update({ observacao: texto });
      showToast('Observação salva');
    }
    window.salvarObservacao = salvarObservacao;

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow transition-opacity';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('opacity-0'), 2000);
      setTimeout(() => toast.remove(), 2500);
    }

    loadSidebar();
    loadNavbar();
  </script>
  <script type="module" src="login.js"></script>
  <script src="shared.js"></script>
</body>
</html>
