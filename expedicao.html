<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expedição</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script type="module" src="firebase-config.js"></script>
</head>
<body class="bg-gray-50">
  <div id="sidebar-container"></div>
  <div id="navbar-container"></div>
  <div class="main-content p-4">
    <h1 class="text-2xl font-bold mb-4">Expedição</h1>
    <div id="labelsList" class="space-y-4"></div>
  </div>
  <script>
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    let currentUser = null;
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        carregarEtiquetas();
      }
    });

    async function carregarEtiquetas() {
      const list = document.getElementById('labelsList');
      list.innerHTML = '';
      const snap = await db.collection('users').doc(currentUser.uid).collection('etiquetaenvio').orderBy('createdAt', 'desc').get();
      snap.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.className = 'p-4 bg-white rounded shadow';
        const name = data.name || 'Etiqueta';
        const base = data.pdf;
        div.innerHTML = `
          <p class="font-semibold">${name}</p>
          <div class="mt-2 space-x-2">
            <button class="btn btn-primary" onclick="visualizar('${base}')">Visualizar</button>
            <button class="btn btn-primary" onclick="imprimir('${base}')">Imprimir</button>
            <a class="btn btn-primary" href="data:application/pdf;base64,${base}" download="${name}">Baixar</a>
            <button class="btn bg-red-500 text-white" onclick="excluir('${doc.id}')">Excluir</button>
          </div>`;
        list.appendChild(div);
      });
    }

    function visualizar(base64) {
      const win = window.open('', '_blank');
      win.document.write('<iframe width="100%" height="100%" src="data:application/pdf;base64,' + base64 + '"></iframe>');
    }

    function imprimir(base64) {
      const win = window.open('', '_blank');
      win.document.write('<iframe id="printFrame" width="100%" height="100%" src="data:application/pdf;base64,' + base64 + '"></iframe>');
      win.document.close();
      win.focus();
      win.onload = () => win.document.getElementById('printFrame').contentWindow.print();
    }

    async function excluir(id) {
      if (!confirm('Deseja excluir esta etiqueta?')) return;
      await db.collection('users').doc(currentUser.uid).collection('etiquetaenvio').doc(id).delete();
      carregarEtiquetas();
    }

    loadSidebar();
    loadNavbar();
  </script>
  <script src="shared.js"></script>
</body>
</html>
