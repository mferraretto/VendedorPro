<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expedição</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-50">
  <div id="sidebar-container"></div>
  <div id="navbar-container"></div>
  <div class="main-content p-4">
    <h1 class="text-2xl font-bold mb-4">Expedição</h1>
    <div class="mb-4">
      <label for="statusFilter" class="mr-2">Filtrar por situação:</label>
      <select id="statusFilter" class="border p-1">
        <option value="all">Todas</option>
        <option value="nao_impresso">Não impresso</option>
        <option value="impresso">Impresso</option>
        <option value="concluido">Concluído</option>
      </select>
    </div>
    <div id="labelsList" class="space-y-4"></div>
  </div>
 <script type="module">
    import { firebaseConfig } from './firebase-config.js';

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const storage = firebase.storage();
    let currentUser = null;
    document.getElementById('statusFilter').addEventListener('change', carregarEtiquetas);
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        carregarEtiquetas();
      }
    });

    async function carregarEtiquetas() {
      const list = document.getElementById('labelsList');
      list.innerHTML = '';
      const filter = document.getElementById('statusFilter').value;
      const snap = await db
        .collection('pdfDocs')
        .orderBy('createdAt', 'desc')
        .get();
      snap.forEach(doc => {
        const data = doc.data();
        const allowed =
          data.ownerEmail === currentUser.email ||
          (data.gestoresExpedicaoEmails || []).includes(currentUser.email);
        if (!allowed) return;
        const status = data.status || 'nao_impresso';
        if (filter !== 'all' && status !== filter) return;
        const attention = data.attention || false;
        const observacao = data.observacao || '';
        const div = document.createElement('div');
        div.className = 'p-4 bg-white rounded shadow' + (attention ? ' border-2 border-red-500' : '');
        const name = data.name || 'PDF';
        const url = data.url;
        const owner = data.ownerEmail || 'Desconhecido';
        const createdAt = data.createdAt && data.createdAt.toDate
          ? data.createdAt.toDate().toLocaleString('pt-BR')
          : 'Data desconhecida';
        div.innerHTML = `
          <p class="font-semibold">${name}</p>
                    <p class="text-sm text-gray-600">Criado por: ${owner} em ${createdAt}</p>
          <div class="mt-2 space-x-2">
            <button class="btn btn-primary" onclick="visualizar('${url}')">Visualizar</button>
            <button class="btn btn-primary" onclick="imprimir('${url}')">Imprimir</button>
            <a class="btn btn-primary" href="${url}" download="${name}">Baixar</a>
          </div>
          <div class="mt-2 space-y-2">
            <label class="flex items-center">
              <input type="checkbox" class="mr-2" ${status === 'impresso' ? 'checked' : ''} onchange="toggleImpresso('${doc.id}', this.checked)">
              Impresso
            </label>
            <label class="flex items-center">
              <input type="checkbox" class="mr-2" ${attention ? 'checked' : ''} onchange="toggleAtencao('${doc.id}', this.checked)">
              Atenção problema
            </label>
            <textarea class="border p-1 w-full" placeholder="Observação" onblur="salvarObservacao('${doc.id}', this.value)">${observacao}</textarea>
            <button class="btn btn-secondary" onclick="marcarConcluido('${doc.id}')">Concluir</button>
          </div>`;
        list.appendChild(div);
      });
      if (!list.hasChildNodes()) {
        list.innerHTML = '<p class="text-gray-500">Nenhuma etiqueta encontrada.</p>';
      }
    }

    function visualizar(url) {
      const win = window.open('', '_blank');
      win.document.write('<iframe width="100%" height="100%" src="' + url + '"></iframe>');
    }
    window.visualizar = visualizar;

    function imprimir(url) {
      const win = window.open('', '_blank');
      win.document.write('<iframe id="printFrame" width="100%" height="100%" src="' + url + '"></iframe>');
      win.document.close();
      win.focus();
      win.onload = () => win.document.getElementById('printFrame').contentWindow.print();
    }
    window.imprimir = imprimir;

    async function toggleImpresso(id, checked) {
      await db.collection('pdfDocs').doc(id).update({ status: checked ? 'impresso' : 'nao_impresso' });
      carregarEtiquetas();
    }
    window.toggleImpresso = toggleImpresso;

    async function marcarConcluido(id) {
      await db.collection('pdfDocs').doc(id).update({ status: 'concluido' });
      carregarEtiquetas();
    }
    window.marcarConcluido = marcarConcluido;

    async function toggleAtencao(id, checked) {
      await db.collection('pdfDocs').doc(id).update({ attention: checked });
      carregarEtiquetas();
    }
    window.toggleAtencao = toggleAtencao;

    async function salvarObservacao(id, texto) {
      await db.collection('pdfDocs').doc(id).update({ observacao: texto });
    }
    window.salvarObservacao = salvarObservacao;

    loadSidebar();
    loadNavbar();
  </script>
  <script type="module" src="login.js"></script>
  <script src="shared.js"></script>
</body>
</html>
