<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Equipe - VendedorPro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-Tz4frX1Pj1kN6H0F5LZFzE8zRAwOB1p5MNDoAuCEi0aKBslZx2drXr/7EQo1gChX2NDVYqoQZnIcqoNCXlbmYw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="css/styles.css?v=20240826">
  <style>
    :root {
      --brand: #4262ff;
      --brand-dark: #2f4dde;
      --brand-soft: rgba(66, 98, 255, 0.1);
      --text: #1f2937;
      --text-soft: #6b7280;
      --border: #e5e7eb;
      --danger: #ef4444;
      --success: #059669;
      --background: #f4f6fb;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
    }

    .team-wrapper {
      padding: 24px;
    }

    .team-header h1 {
      font-size: 28px;
      font-weight: 700;
    }

    .team-header p {
      margin-top: 6px;
      color: var(--text-soft);
      max-width: 680px;
    }

    .team-tabs {
      margin: 24px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .team-tab-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: white;
      color: var(--text);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.05);
    }

    .team-tab-button i {
      color: var(--brand);
    }

    .team-tab-button:hover {
      border-color: var(--brand);
      color: var(--brand);
    }

    .team-tab-button.active {
      background: var(--brand);
      color: #fff;
      box-shadow: 0 10px 24px rgba(66, 98, 255, 0.25);
    }

    .team-tab-button.active i {
      color: #fff;
    }

    .team-section {
      display: none;
    }

    .team-section.active {
      display: block;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
    }

    .section-header {
      margin-bottom: 18px;
    }

    .section-header h2 {
      font-size: 22px;
      font-weight: 600;
    }

    .section-header p {
      margin-top: 6px;
      color: var(--text-soft);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-top: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group label {
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      transition: border-color 0.2s ease;
      background: #fff;
      min-height: 42px;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(66, 98, 255, 0.15);
    }

    .primary-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 11px 20px;
      border-radius: 10px;
      border: none;
      background: var(--brand);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .primary-button:hover {
      background: var(--brand-dark);
    }

    .primary-button:disabled {
      opacity: 0.65;
      cursor: progress;
    }

    .danger-button {
      background: var(--danger);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .danger-button:hover {
      background: #dc2626;
    }

    .danger-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .feedback {
      margin-top: 12px;
      font-size: 14px;
      min-height: 20px;
    }

    .feedback-success {
      color: var(--success);
    }

    .feedback-error {
      color: var(--danger);
    }

    .members-grid,
    .tasks-list,
    .updates-list {
      margin-top: 20px;
      display: grid;
      gap: 16px;
    }

    .members-grid {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .team-card {
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .team-card-header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
    }

    .team-card-header h3 {
      font-size: 18px;
      font-weight: 600;
      word-break: break-word;
    }

    .team-card-header span {
      font-size: 14px;
      color: var(--text-soft);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: var(--brand-soft);
      color: var(--brand);
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.12);
      color: var(--danger);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.12);
      color: #d97706;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.12);
      color: #047857;
    }

    .card-meta {
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-meta strong {
      color: var(--text);
    }

    .empty-state {
      text-align: center;
      padding: 32px;
      border-radius: 16px;
      background: white;
      color: var(--text-soft);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.1);
    }

    .team-loading {
      margin-bottom: 18px;
    }

    .hidden {
      display: none !important;
    }

    .support-link {
      color: var(--brand);
      font-weight: 500;
      text-decoration: underline;
      word-break: break-word;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    @media (max-width: 768px) {
      .team-wrapper {
        padding: 16px;
      }

      .card {
        padding: 18px;
      }

      .team-card {
        padding: 16px;
      }

      .team-tab-button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div id="sidebar-container"></div>
    <div id="navbar-container"></div>

    <main class="main-content team-wrapper">
      <div id="teamLoading" class="card team-loading">
        <p><i class="fas fa-circle-notch fa-spin"></i> Carregando informações da equipe...</p>
      </div>

      <header class="team-header">
        <h1>Gestão da Equipe</h1>
        <p>Cadastre os integrantes, organize tarefas compartilhadas e mantenha todos atualizados em um único lugar acessível a qualquer perfil.</p>
      </header>

      <nav class="team-tabs" aria-label="Navegação das seções da equipe">
        <button class="team-tab-button active" data-view="membersView" type="button">
          <i class="fas fa-envelope"></i>
          Cadastro de E-mails
        </button>
        <button class="team-tab-button" data-view="tasksView" type="button">
          <i class="fas fa-list-check"></i>
          Tarefas da Equipe
        </button>
        <button class="team-tab-button" data-view="updatesView" type="button">
          <i class="fas fa-bullhorn"></i>
          Atualizações e Alertas
        </button>
      </nav>

      <section id="membersView" class="team-section active" aria-labelledby="membersTab">
        <div class="card">
          <div class="section-header">
            <h2>Cadastro da equipe</h2>
            <p>Registre os e-mails e cargos dos integrantes. Os membros cadastrados terão acesso automático às tarefas e alertas desta equipe.</p>
          </div>
          <form id="teamMemberForm" autocomplete="off">
            <div class="form-grid">
              <div class="form-group">
                <label for="memberEmail">E-mail do integrante *</label>
                <input type="email" id="memberEmail" name="memberEmail" placeholder="nome@empresa.com" required>
              </div>
              <div class="form-group">
                <label for="memberRole">Cargo *</label>
                <input type="text" id="memberRole" name="memberRole" placeholder="Ex: Analista de Expedição" required>
              </div>
              <div class="form-group">
                <label for="memberName">Nome (opcional)</label>
                <input type="text" id="memberName" name="memberName" placeholder="Nome completo">
              </div>
            </div>
            <div class="feedback" id="membersFeedback" aria-live="polite"></div>
            <button class="primary-button" id="memberSubmitBtn" type="submit">
              <i class="fas fa-user-plus"></i>
              Adicionar integrante
            </button>
          </form>
        </div>

        <div id="teamMembersList" class="members-grid" aria-live="polite">
          <div class="empty-state">Nenhum integrante cadastrado até o momento.</div>
        </div>
      </section>

      <section id="tasksView" class="team-section" aria-labelledby="tasksTab">
        <div class="card">
          <div class="section-header">
            <h2>Registrar tarefa da equipe</h2>
            <p>Informe os detalhes da tarefa, defina prioridade e associe um responsável. Todas as pessoas cadastradas verão automaticamente essas tarefas.</p>
          </div>
          <form id="teamTaskForm" autocomplete="off">
            <div class="form-grid">
              <div class="form-group">
                <label for="taskTitle">Tarefa *</label>
                <input type="text" id="taskTitle" name="taskTitle" placeholder="Ex: Conferir estoque do dia" required>
              </div>
              <div class="form-group">
                <label for="taskDate">Data</label>
                <input type="date" id="taskDate" name="taskDate">
              </div>
              <div class="form-group">
                <label for="taskTime">Horário</label>
                <input type="time" id="taskTime" name="taskTime">
              </div>
              <div class="form-group">
                <label for="taskPriority">Prioridade</label>
                <select id="taskPriority" name="taskPriority">
                  <option value="">Selecione</option>
                  <option value="Alta">Alta</option>
                  <option value="Média">Média</option>
                  <option value="Baixa">Baixa</option>
                </select>
              </div>
              <div class="form-group">
                <label for="taskResponsible">Responsável</label>
                <select id="taskResponsible" name="taskResponsible">
                  <option value="">Selecione um responsável</option>
                </select>
              </div>
              <div class="form-group">
                <label for="taskSupport">Material de apoio</label>
                <input type="text" id="taskSupport" name="taskSupport" placeholder="Link ou observação rápida">
              </div>
            </div>
            <div class="form-group">
              <label for="taskTips">Dicas e observações</label>
              <textarea id="taskTips" name="taskTips" placeholder="Inclua instruções adicionais para ajudar na execução da tarefa"></textarea>
            </div>
            <div class="feedback" id="tasksFeedback" aria-live="polite"></div>
            <button class="primary-button" id="taskSubmitBtn" type="submit">
              <i class="fas fa-plus"></i>
              Registrar tarefa
            </button>
          </form>
        </div>

        <div id="teamTasksList" class="tasks-list" aria-live="polite">
          <div class="empty-state">Nenhuma tarefa registrada ainda.</div>
        </div>
      </section>

      <section id="updatesView" class="team-section" aria-labelledby="updatesTab">
        <div class="card">
          <div class="section-header">
            <h2>Atualizações e alertas</h2>
            <p>Compartilhe comunicados importantes, alertas e novidades para que toda a equipe fique alinhada.</p>
          </div>
          <form id="teamUpdateForm" autocomplete="off">
            <div class="form-grid">
              <div class="form-group">
                <label for="updateTitle">Título</label>
                <input type="text" id="updateTitle" name="updateTitle" placeholder="Ex: Novo procedimento de embalagem">
              </div>
            </div>
            <div class="form-group">
              <label for="updateMessage">Atualização ou alerta *</label>
              <textarea id="updateMessage" name="updateMessage" placeholder="Descreva claramente a atualização ou alerta para a equipe" required></textarea>
            </div>
            <div class="feedback" id="updatesFeedback" aria-live="polite"></div>
            <button class="primary-button" id="updateSubmitBtn" type="submit">
              <i class="fas fa-paper-plane"></i>
              Publicar atualização
            </button>
          </form>
        </div>

        <div id="teamUpdatesList" class="updates-list" aria-live="polite">
          <div class="empty-state">Nenhuma atualização registrada.</div>
        </div>
      </section>
    </main>

    <script>window.CUSTOM_SIDEBAR_PATH = '/partials/sidebar.html';</script>
    <script src="shared.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
      import { getAuth, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        where,
        doc,
        deleteDoc,
        updateDoc,
        getDocs,
        serverTimestamp,
        Timestamp
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
      import { firebaseConfig as defaultFirebaseConfig } from './firebase-config.js';

      const tabButtons = document.querySelectorAll('.team-tab-button');
      const sections = {
        membersView: document.getElementById('membersView'),
        tasksView: document.getElementById('tasksView'),
        updatesView: document.getElementById('updatesView')
      };

      tabButtons.forEach((button) => {
        button.addEventListener('click', () => {
          tabButtons.forEach((btn) => btn.classList.remove('active'));
          Object.values(sections).forEach((section) => section.classList.remove('active'));
          button.classList.add('active');
          const viewId = button.dataset.view;
          if (sections[viewId]) {
            sections[viewId].classList.add('active');
          }
        });
      });

      const memberForm = document.getElementById('teamMemberForm');
      const membersFeedback = document.getElementById('membersFeedback');
      const memberSubmitBtn = document.getElementById('memberSubmitBtn');
      const membersList = document.getElementById('teamMembersList');

      const taskForm = document.getElementById('teamTaskForm');
      const tasksFeedback = document.getElementById('tasksFeedback');
      const taskSubmitBtn = document.getElementById('taskSubmitBtn');
      const tasksList = document.getElementById('teamTasksList');
      const taskResponsibleSelect = document.getElementById('taskResponsible');

      const updatesForm = document.getElementById('teamUpdateForm');
      const updatesFeedback = document.getElementById('updatesFeedback');
      const updateSubmitBtn = document.getElementById('updateSubmitBtn');
      const updatesList = document.getElementById('teamUpdatesList');

      const teamLoading = document.getElementById('teamLoading');

      let app;
      let auth;
      let db;
      let currentUser = null;
      let currentUserEmail = '';
      let ownedMembers = [];
      let ownedMembersUnsub = null;
      let tasksUnsub = null;
      let updatesUnsub = null;
      let lastSharingSignature = '';

      const rawConfig = (() => {
        if (window.firebaseConfig) return window.firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
          try {
            return JSON.parse(__firebase_config);
          } catch (error) {
            console.error('Não foi possível interpretar __firebase_config:', error);
          }
        }
        return null;
      })();
      const firebaseConfig = rawConfig && rawConfig.projectId ? rawConfig : defaultFirebaseConfig;
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

      function showFeedback(element, message, type = 'success') {
        if (!element) return;
        element.textContent = message;
        element.classList.remove('feedback-success', 'feedback-error');
        if (message) {
          element.classList.add(type === 'error' ? 'feedback-error' : 'feedback-success');
        }
        if (message) {
          setTimeout(() => {
            if (element.textContent === message) {
              element.textContent = '';
              element.classList.remove('feedback-success', 'feedback-error');
            }
          }, 6000);
        }
      }

      function formatDateTime(task) {
        if (task.scheduledAt && typeof task.scheduledAt.toDate === 'function') {
          const dateObj = task.scheduledAt.toDate();
          const datePart = dateObj.toLocaleDateString('pt-BR');
          const timePart = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          return `${datePart} às ${timePart}`;
        }
        if (task.date || task.time) {
          const datePart = task.date ? task.date.split('-').reverse().join('/') : 'Data não definida';
          const timePart = task.time ? task.time : '';
          return timePart ? `${datePart} às ${timePart}` : datePart;
        }
        return 'Sem data definida';
      }

      function priorityBadgeClass(priority) {
        if (priority === 'Alta') return 'badge badge-danger';
        if (priority === 'Média') return 'badge badge-warning';
        if (priority === 'Baixa') return 'badge badge-success';
        return 'badge';
      }

      function getCurrentTeamEmails() {
        const emails = new Set();
        if (currentUserEmail) emails.add(currentUserEmail);
        ownedMembers.forEach((member) => {
          if (member.memberEmail) {
            emails.add(member.memberEmail.toLowerCase());
          }
        });
        return emails;
      }

      function updateResponsibleOptions() {
        const select = taskResponsibleSelect;
        if (!select) return;

        const previousValue = select.value;
        select.innerHTML = '<option value="">Selecione um responsável</option>';

        if (currentUserEmail) {
          const option = document.createElement('option');
          option.value = currentUserEmail;
          option.textContent = `${currentUser?.email || currentUserEmail} (Você)`;
          option.dataset.role = 'Gestor';
          select.appendChild(option);
        }

        ownedMembers
          .slice()
          .sort((a, b) => (a.memberEmail || '').localeCompare(b.memberEmail || ''))
          .forEach((member) => {
            const option = document.createElement('option');
            option.value = (member.memberEmail || '').toLowerCase();
            const labelName = member.memberName ? ` • ${member.memberName}` : '';
            option.textContent = `${member.memberEmail}${labelName}`;
            option.dataset.role = member.role || '';
            select.appendChild(option);
          });

        if (previousValue && [...select.options].some((opt) => opt.value === previousValue)) {
          select.value = previousValue;
        }
      }

      function renderOwnedMembers() {
        if (!membersList) return;
        membersList.innerHTML = '';

        if (ownedMembers.length === 0) {
          membersList.innerHTML = '<div class="empty-state">Nenhum integrante cadastrado até o momento.</div>';
          return;
        }

        const sortedMembers = ownedMembers.slice().sort((a, b) => (a.memberEmail || '').localeCompare(b.memberEmail || ''));

        sortedMembers.forEach((member) => {
          const card = document.createElement('article');
          card.className = 'team-card';

          const createdAtText = member.createdAt && typeof member.createdAt.toDate === 'function'
            ? member.createdAt.toDate().toLocaleString('pt-BR')
            : 'Pendente de sincronização';

          card.innerHTML = `
            <div class="team-card-header">
              <div>
                <h3>${member.memberEmail || 'E-mail não informado'}</h3>
                <span>${member.memberName || ''}</span>
              </div>
              <span class="badge">${member.role || 'Cargo não informado'}</span>
            </div>
            <div class="card-meta">
              <div><strong>Adicionado em:</strong> ${createdAtText}</div>
            </div>
            <div class="card-footer">
              <span class="card-meta"><strong>Responsável pelo cadastro:</strong> ${currentUser?.email || ''}</span>
              <button class="danger-button" data-member-id="${member.id}" type="button">
                <i class="fas fa-user-minus"></i> Remover
              </button>
            </div>
          `;

          const removeButton = card.querySelector('button[data-member-id]');
          if (removeButton) {
            removeButton.addEventListener('click', async () => {
              if (!confirm('Deseja remover este integrante da equipe? As permissões vinculadas às tarefas e alertas serão atualizadas.')) {
                return;
              }
              try {
                removeButton.disabled = true;
                await deleteDoc(doc(db, 'teamMembers', member.id));
                showFeedback(membersFeedback, 'Integrante removido com sucesso.', 'success');
                await syncOwnerSharing();
              } catch (error) {
                console.error('Erro ao remover integrante:', error);
                showFeedback(membersFeedback, 'Não foi possível remover o integrante.', 'error');
              } finally {
                removeButton.disabled = false;
              }
            });
          }

          membersList.appendChild(card);
        });
      }

      function renderTasks(tasks) {
        if (!tasksList) return;
        tasksList.innerHTML = '';

        if (tasks.length === 0) {
          tasksList.innerHTML = '<div class="empty-state">Nenhuma tarefa registrada ainda.</div>';
          return;
        }

        const sortedTasks = tasks.slice().sort((a, b) => {
          const getTime = (item) => {
            if (item.scheduledAt && typeof item.scheduledAt.toDate === 'function') {
              return item.scheduledAt.toDate().getTime();
            }
            if (item.createdAt && typeof item.createdAt.toDate === 'function') {
              return item.createdAt.toDate().getTime();
            }
            return 0;
          };
          return getTime(a) - getTime(b);
        });

        sortedTasks.forEach((task) => {
          const isOwner = task.ownerUid === (currentUser?.uid || '');
          const card = document.createElement('article');
          card.className = 'team-card';

          const createdAtText = task.createdAt && typeof task.createdAt.toDate === 'function'
            ? task.createdAt.toDate().toLocaleString('pt-BR')
            : 'Pendente de sincronização';

          const priority = task.priority || '';
          const priorityClass = priorityBadgeClass(priority);
          const priorityLabel = priority ? `<span class="${priorityClass}">${priority}</span>` : '';

          let supportHtml = '';
          if (task.supportMaterial) {
            const support = task.supportMaterial.trim();
            const isLink = /^https?:\/\//i.test(support);
            supportHtml = isLink
              ? `<a href="${support}" class="support-link" target="_blank" rel="noopener noreferrer">${support}</a>`
              : `<span>${support}</span>`;
          }

          card.innerHTML = `
            <div class="team-card-header">
              <div>
                <h3>${task.title || 'Tarefa sem título'}</h3>
                <span>${formatDateTime(task)}</span>
              </div>
              ${priorityLabel}
            </div>
            <div class="card-meta">
              <div><strong>Responsável:</strong> ${task.responsibleEmail ? task.responsibleEmail : 'Não definido'}</div>
              ${task.responsibleRole ? `<div><strong>Cargo:</strong> ${task.responsibleRole}</div>` : ''}
              <div><strong>Registrada por:</strong> ${task.ownerEmail || 'Usuário não identificado'}</div>
              <div><strong>Registrada em:</strong> ${createdAtText}</div>
            </div>
            ${task.tips ? `<div><strong>Dicas:</strong><br>${task.tips.replace(/\n/g, '<br>')}</div>` : ''}
            ${supportHtml ? `<div><strong>Material de apoio:</strong><br>${supportHtml}</div>` : ''}
            ${isOwner ? `
              <div class="card-footer">
                <span class="card-meta">Compartilhada com ${task.allowedEmails?.length || 0} integrante(s).</span>
                <button class="danger-button" data-task-id="${task.id}" type="button">
                  <i class="fas fa-trash"></i> Excluir tarefa
                </button>
              </div>
            ` : ''}
          `;

          if (isOwner) {
            const deleteBtn = card.querySelector('button[data-task-id]');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', async () => {
                if (!confirm('Deseja excluir esta tarefa?')) return;
                try {
                  deleteBtn.disabled = true;
                  await deleteDoc(doc(db, 'teamTasks', task.id));
                  showFeedback(tasksFeedback, 'Tarefa excluída com sucesso.', 'success');
                } catch (error) {
                  console.error('Erro ao excluir tarefa:', error);
                  showFeedback(tasksFeedback, 'Não foi possível excluir a tarefa.', 'error');
                } finally {
                  deleteBtn.disabled = false;
                }
              });
            }
          }

          tasksList.appendChild(card);
        });
      }

      function renderUpdates(updates) {
        if (!updatesList) return;
        updatesList.innerHTML = '';

        if (updates.length === 0) {
          updatesList.innerHTML = '<div class="empty-state">Nenhuma atualização registrada.</div>';
          return;
        }

        const sortedUpdates = updates.slice().sort((a, b) => {
          const aTime = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate().getTime() : 0;
          const bTime = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate().getTime() : 0;
          return bTime - aTime;
        });

        sortedUpdates.forEach((update) => {
          const isOwner = update.ownerUid === (currentUser?.uid || '');
          const createdAtText = update.createdAt && typeof update.createdAt.toDate === 'function'
            ? update.createdAt.toDate().toLocaleString('pt-BR')
            : 'Pendente de sincronização';

          const card = document.createElement('article');
          card.className = 'team-card';
          card.innerHTML = `
            <div class="team-card-header">
              <div>
                <h3>${update.title || 'Atualização'}</h3>
                <span>${createdAtText}</span>
              </div>
            </div>
            <div>${(update.message || '').replace(/\n/g, '<br>')}</div>
            <div class="card-meta">
              <div><strong>Publicado por:</strong> ${update.ownerEmail || 'Usuário não identificado'}</div>
              <div><strong>Visível para:</strong> ${update.allowedEmails?.length || 0} integrante(s)</div>
            </div>
            ${isOwner ? `
              <div class="card-footer">
                <span class="card-meta"></span>
                <button class="danger-button" data-update-id="${update.id}" type="button">
                  <i class="fas fa-trash"></i> Remover alerta
                </button>
              </div>
            ` : ''}
          `;

          if (isOwner) {
            const deleteBtn = card.querySelector('button[data-update-id]');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', async () => {
                if (!confirm('Deseja excluir esta atualização/alerta?')) return;
                try {
                  deleteBtn.disabled = true;
                  await deleteDoc(doc(db, 'teamUpdates', update.id));
                  showFeedback(updatesFeedback, 'Atualização removida com sucesso.', 'success');
                } catch (error) {
                  console.error('Erro ao remover atualização:', error);
                  showFeedback(updatesFeedback, 'Não foi possível remover a atualização.', 'error');
                } finally {
                  deleteBtn.disabled = false;
                }
              });
            }
          }

          updatesList.appendChild(card);
        });
      }

      function areSetsEqual(existing, target) {
        if (existing.length !== target.length) return false;
        const existingSet = new Set(existing.map((value) => value.toLowerCase()));
        return target.every((value) => existingSet.has(value));
      }

      async function syncOwnerSharing() {
        if (!currentUser) return;
        const baseEmails = [...getCurrentTeamEmails()];

        const tasksRef = collection(db, 'teamTasks');
        const tasksSnapshot = await getDocs(query(tasksRef, where('ownerUid', '==', currentUser.uid)));
        const updatesRef = collection(db, 'teamUpdates');
        const updatesSnapshot = await getDocs(query(updatesRef, where('ownerUid', '==', currentUser.uid)));

        const updatesToRun = [];

        tasksSnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const allowed = new Set(baseEmails);
          if (data.responsibleEmailLower) {
            allowed.add(data.responsibleEmailLower);
          }
          const target = [...allowed];
          const current = Array.isArray(data.allowedEmails) ? data.allowedEmails : [];
          if (!areSetsEqual(current, target)) {
            updatesToRun.push(updateDoc(docSnap.ref, { allowedEmails: target }));
          }
        });

        updatesSnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const target = [...baseEmails];
          const current = Array.isArray(data.allowedEmails) ? data.allowedEmails : [];
          if (!areSetsEqual(current, target)) {
            updatesToRun.push(updateDoc(docSnap.ref, { allowedEmails: target }));
          }
        });

        if (updatesToRun.length > 0) {
          try {
            await Promise.all(updatesToRun);
          } catch (error) {
            console.error('Erro ao sincronizar compartilhamento:', error);
          }
        }
      }

      function watchOwnedMembers() {
        if (!db || !currentUser) return;
        if (ownedMembersUnsub) ownedMembersUnsub();
        const membersRef = collection(db, 'teamMembers');
        const membersQuery = query(membersRef, where('ownerUid', '==', currentUser.uid));
        ownedMembersUnsub = onSnapshot(
          membersQuery,
          (snapshot) => {
            ownedMembers = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
            renderOwnedMembers();
            updateResponsibleOptions();
            const signature = JSON.stringify([...getCurrentTeamEmails()].sort());
            if (signature !== lastSharingSignature) {
              lastSharingSignature = signature;
              syncOwnerSharing();
            }
          },
          (error) => {
            console.error('Erro ao carregar integrantes:', error);
            showFeedback(membersFeedback, 'Erro ao carregar integrantes da equipe.', 'error');
          }
        );
      }

      function watchTasks() {
        if (!db || !currentUserEmail) return;
        if (tasksUnsub) tasksUnsub();
        const tasksRef = collection(db, 'teamTasks');
        const tasksQuery = query(tasksRef, where('allowedEmails', 'array-contains', currentUserEmail));
        tasksUnsub = onSnapshot(
          tasksQuery,
          (snapshot) => {
            const tasks = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
            renderTasks(tasks);
          },
          (error) => {
            console.error('Erro ao carregar tarefas:', error);
            showFeedback(tasksFeedback, 'Erro ao carregar as tarefas da equipe.', 'error');
          }
        );
      }

      function watchUpdates() {
        if (!db || !currentUserEmail) return;
        if (updatesUnsub) updatesUnsub();
        const updatesRef = collection(db, 'teamUpdates');
        const updatesQuery = query(updatesRef, where('allowedEmails', 'array-contains', currentUserEmail));
        updatesUnsub = onSnapshot(
          updatesQuery,
          (snapshot) => {
            const updates = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
            renderUpdates(updates);
          },
          (error) => {
            console.error('Erro ao carregar atualizações:', error);
            showFeedback(updatesFeedback, 'Erro ao carregar atualizações.', 'error');
          }
        );
      }

      memberForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!currentUser) {
          showFeedback(membersFeedback, 'Faça login para cadastrar integrantes.', 'error');
          return;
        }
        const emailInput = document.getElementById('memberEmail');
        const roleInput = document.getElementById('memberRole');
        const nameInput = document.getElementById('memberName');

        const emailValue = (emailInput.value || '').trim().toLowerCase();
        const roleValue = (roleInput.value || '').trim();
        const nameValue = (nameInput.value || '').trim();

        if (!emailValue || !roleValue) {
          showFeedback(membersFeedback, 'Preencha o e-mail e o cargo do integrante.', 'error');
          return;
        }

        if (emailValue === currentUserEmail) {
          showFeedback(membersFeedback, 'Não é necessário cadastrar o seu próprio e-mail.', 'error');
          return;
        }

        if (ownedMembers.some((member) => (member.memberEmail || '').toLowerCase() === emailValue)) {
          showFeedback(membersFeedback, 'Este e-mail já está cadastrado na equipe.', 'error');
          return;
        }

        try {
          memberSubmitBtn.disabled = true;
          await addDoc(collection(db, 'teamMembers'), {
            ownerUid: currentUser.uid,
            ownerEmail: currentUser.email || '',
            memberEmail: emailValue,
            memberName: nameValue,
            role: roleValue,
            createdAt: serverTimestamp()
          });
          memberForm.reset();
          showFeedback(membersFeedback, 'Integrante cadastrado com sucesso!', 'success');
          await syncOwnerSharing();
        } catch (error) {
          console.error('Erro ao cadastrar integrante:', error);
          showFeedback(membersFeedback, 'Não foi possível cadastrar o integrante.', 'error');
        } finally {
          memberSubmitBtn.disabled = false;
        }
      });

      taskForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!currentUser) {
          showFeedback(tasksFeedback, 'Faça login para registrar tarefas.', 'error');
          return;
        }

        const title = (document.getElementById('taskTitle').value || '').trim();
        const date = (document.getElementById('taskDate').value || '').trim();
        const time = (document.getElementById('taskTime').value || '').trim();
        const priority = (document.getElementById('taskPriority').value || '').trim();
        const tips = (document.getElementById('taskTips').value || '').trim();
        const supportMaterial = (document.getElementById('taskSupport').value || '').trim();
        const responsibleSelect = taskResponsibleSelect;
        const responsibleEmail = responsibleSelect?.value ? responsibleSelect.value.toLowerCase() : '';
        const responsibleRole = responsibleSelect?.selectedOptions?.[0]?.dataset?.role || '';

        if (!title) {
          showFeedback(tasksFeedback, 'Informe uma tarefa para registrar.', 'error');
          return;
        }

        let scheduledAt = null;
        if (date) {
          const isoDate = time ? `${date}T${time}` : `${date}T00:00`;
          const parsed = new Date(isoDate);
          if (!isNaN(parsed.getTime())) {
            scheduledAt = Timestamp.fromDate(parsed);
          }
        }

        const allowedEmails = new Set(getCurrentTeamEmails());
        if (responsibleEmail) {
          allowedEmails.add(responsibleEmail);
        }

        try {
          taskSubmitBtn.disabled = true;
          await addDoc(collection(db, 'teamTasks'), {
            ownerUid: currentUser.uid,
            ownerEmail: currentUser.email || '',
            title,
            date,
            time,
            priority,
            tips,
            supportMaterial,
            responsibleEmail: responsibleEmail || '',
            responsibleEmailLower: responsibleEmail || '',
            responsibleRole: responsibleRole || '',
            scheduledAt,
            createdAt: serverTimestamp(),
            allowedEmails: Array.from(allowedEmails)
          });
          taskForm.reset();
          updateResponsibleOptions();
          showFeedback(tasksFeedback, 'Tarefa registrada com sucesso!', 'success');
        } catch (error) {
          console.error('Erro ao registrar tarefa:', error);
          showFeedback(tasksFeedback, 'Não foi possível registrar a tarefa.', 'error');
        } finally {
          taskSubmitBtn.disabled = false;
        }
      });

      updatesForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!currentUser) {
          showFeedback(updatesFeedback, 'Faça login para publicar alertas.', 'error');
          return;
        }

        const title = (document.getElementById('updateTitle').value || '').trim();
        const message = (document.getElementById('updateMessage').value || '').trim();

        if (!message) {
          showFeedback(updatesFeedback, 'Descreva a atualização ou alerta antes de publicar.', 'error');
          return;
        }

        const allowedEmails = Array.from(getCurrentTeamEmails());

        try {
          updateSubmitBtn.disabled = true;
          await addDoc(collection(db, 'teamUpdates'), {
            ownerUid: currentUser.uid,
            ownerEmail: currentUser.email || '',
            title,
            message,
            createdAt: serverTimestamp(),
            allowedEmails
          });
          updatesForm.reset();
          showFeedback(updatesFeedback, 'Atualização publicada com sucesso!', 'success');
        } catch (error) {
          console.error('Erro ao publicar atualização:', error);
          showFeedback(updatesFeedback, 'Não foi possível publicar a atualização.', 'error');
        } finally {
          updateSubmitBtn.disabled = false;
        }
      });

      async function initializeFirebase() {
        if (!firebaseConfig || !firebaseConfig.projectId) {
          teamLoading.innerHTML = '<strong>Configuração do Firebase não encontrada.</strong>';
          return;
        }

        try {
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          }

          onAuthStateChanged(auth, (user) => {
            if (!user) {
              window.location.href = 'index.html?login=1';
              return;
            }
            currentUser = user;
            currentUserEmail = (user.email || '').toLowerCase();
            teamLoading?.classList.add('hidden');
            watchOwnedMembers();
            watchTasks();
            watchUpdates();
            updateResponsibleOptions();
          });
        } catch (error) {
          console.error('Erro ao inicializar Firebase:', error);
          teamLoading.innerHTML = '<strong>Não foi possível inicializar os serviços da equipe.</strong>';
        }
      }

      initializeFirebase();
    </script>
  </div>
</body>
</html>
