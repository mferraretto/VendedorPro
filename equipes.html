<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Central da Equipe</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css?v=20240826" />
    <style>
      :root {
        color-scheme: light dark;
      }

      body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--color-background, #f5f7fb);
        color: var(--color-text, #1f2937);
      }

      .page-wrapper {
        min-height: 100vh;
        display: flex;
      }

      .main-content {
        flex: 1;
        padding: 32px 24px 48px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .page-header {
        margin-bottom: 24px;
      }

      .page-header h1 {
        font-size: clamp(1.8rem, 2vw + 1rem, 2.5rem);
        font-weight: 700;
        margin-bottom: 8px;
      }

      .page-header p {
        color: var(--text-light, #4b5563);
        max-width: 780px;
      }

      .tab-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 24px;
      }

      .tab-nav button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--border-color, #d1d5db);
        background: var(--tab-bg, #fff);
        color: inherit;
        padding: 10px 18px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      }

      .tab-nav button i {
        color: var(--primary, #4262ff);
      }

      .tab-nav button.active {
        background: var(--primary, #4262ff);
        color: #fff;
        border-color: transparent;
      }

      .tab-nav button.active i {
        color: inherit;
      }

      .tab-view {
        display: none;
        gap: 24px;
        flex-direction: column;
      }

      .tab-view.active {
        display: flex;
      }

      .card {
        background: var(--card-bg, #ffffff);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 18px 32px -24px rgba(15, 23, 42, 0.45);
        border: 1px solid color-mix(in srgb, var(--primary, #4262ff) 10%, transparent);
      }

      .text-sm {
        font-size: 0.95rem;
      }

      .card h2,
      .card h3 {
        font-weight: 700;
        margin-bottom: 12px;
      }

      form {
        display: grid;
        gap: 16px;
      }

      label {
        font-weight: 600;
        display: flex;
        gap: 6px;
        align-items: center;
      }

      label span.required {
        color: #dc2626;
        font-weight: 700;
      }

      input[type='text'],
      input[type='email'],
      input[type='date'],
      input[type='time'],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border-color, #d1d5db);
        background: var(--input-bg, #fff);
        color: inherit;
        transition: border 0.2s ease, box-shadow 0.2s ease;
        font-size: 0.98rem;
      }

      textarea {
        min-height: 96px;
        resize: vertical;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary, #4262ff);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary, #4262ff) 25%, transparent);
      }

      .actions-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: flex-end;
      }

      button[type='submit'],
      .secondary-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }

      button[type='submit'] {
        background: linear-gradient(135deg, var(--primary, #4262ff), #6b8bff);
        color: #fff;
      }

      button[type='submit']:hover:not([disabled]) {
        transform: translateY(-1px);
        box-shadow: 0 10px 24px -18px rgba(66, 98, 255, 0.8);
      }

      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .secondary-button {
        background: color-mix(in srgb, var(--primary, #4262ff) 10%, transparent);
        color: var(--primary, #4262ff);
        border: 1px solid color-mix(in srgb, var(--primary, #4262ff) 40%, transparent);
      }

      .status-message {
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 500;
        display: none;
      }

      .status-message.show {
        display: block;
      }

      .status-success {
        background: color-mix(in srgb, #10b981 12%, transparent);
        color: #047857;
        border: 1px solid color-mix(in srgb, #10b981 50%, transparent);
      }

      .status-error {
        background: color-mix(in srgb, #ef4444 12%, transparent);
        color: #b91c1c;
        border: 1px solid color-mix(in srgb, #ef4444 50%, transparent);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border-radius: 14px;
      }

      table thead {
        background: color-mix(in srgb, var(--primary, #4262ff) 8%, transparent);
        text-align: left;
      }

      table th,
      table td {
        padding: 12px 14px;
        border-bottom: 1px solid color-mix(in srgb, var(--primary, #4262ff) 12%, transparent);
      }

      table tbody tr:last-child td {
        border-bottom: none;
      }

      .empty-state {
        padding: 24px;
        text-align: center;
        border-radius: 14px;
        border: 1px dashed color-mix(in srgb, var(--primary, #4262ff) 35%, transparent);
        background: color-mix(in srgb, var(--primary, #4262ff) 4%, transparent);
        font-weight: 500;
        color: var(--text-light, #4b5563);
      }

      .stack {
        display: grid;
        gap: 16px;
      }

      .task-card,
      .update-card {
        border: 1px solid color-mix(in srgb, var(--primary, #4262ff) 16%, transparent);
        border-radius: 16px;
        padding: 18px;
        background: color-mix(in srgb, var(--card-bg, #ffffff) 92%, transparent);
        display: grid;
        gap: 12px;
      }

      .task-card header,
      .update-card header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
        background: color-mix(in srgb, var(--primary, #4262ff) 12%, transparent);
        color: var(--primary, #4262ff);
      }

      .badge.high {
        background: color-mix(in srgb, #ef4444 16%, transparent);
        color: #b91c1c;
      }

      .badge.medium {
        background: color-mix(in srgb, #f59e0b 16%, transparent);
        color: #b45309;
      }

      .badge.low {
        background: color-mix(in srgb, #10b981 16%, transparent);
        color: #047857;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: color-mix(in srgb, var(--primary, #4262ff) 6%, transparent);
        border-radius: 999px;
        font-size: 0.75rem;
      }

      .card-footer {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        color: var(--text-light, #4b5563);
        font-size: 0.9rem;
      }

      .card-footer button {
        background: transparent;
        color: inherit;
        border: none;
        cursor: pointer;
        font-weight: 600;
        padding: 0;
      }

      .card-footer button:hover {
        color: #ef4444;
      }

      @media (max-width: 960px) {
        .main-content {
          padding: 24px 16px 40px;
        }

        .card {
          padding: 20px;
        }
      }

      @media (max-width: 640px) {
        .tab-nav button {
          flex: 1 1 100%;
        }

        table thead {
          display: none;
        }

        table tr {
          display: grid;
          gap: 12px;
          padding: 16px;
          border: 1px solid color-mix(in srgb, var(--primary, #4262ff) 15%, transparent);
          border-radius: 14px;
          margin-bottom: 16px;
        }

        table td {
          border: none;
          padding: 0;
        }

        table td::before {
          content: attr(data-label);
          display: block;
          font-weight: 600;
          margin-bottom: 4px;
          color: var(--text-light, #4b5563);
        }
      }
    </style>
  </head>
  <body>
    <div class="page-wrapper">
      <div id="sidebar-container"></div>
      <div class="main-content">
        <div id="navbar-container"></div>

        <div class="page-header">
          <h1>Central da Equipe</h1>
          <p>
            Organize sua equipe, compartilhe tarefas e mantenha todos informados com atualizações e alertas em um só lugar.
          </p>
        </div>

        <nav class="tab-nav" aria-label="Subpáginas da equipe">
          <button type="button" class="active" data-tab="members">
            <i class="fas fa-user-group" aria-hidden="true"></i>
            Cadastro da equipe
          </button>
          <button type="button" data-tab="tasks">
            <i class="fas fa-list-check" aria-hidden="true"></i>
            Tarefas da equipe
          </button>
          <button type="button" data-tab="updates">
            <i class="fas fa-bell" aria-hidden="true"></i>
            Atualizações e alertas
          </button>
        </nav>

        <section id="members" class="tab-view active" aria-labelledby="Cadastro da equipe">
          <div class="card">
            <h2>Registrar integrante</h2>
            <p class="text-sm" style="color: var(--text-light, #4b5563); margin-bottom: 12px;">
              Cadastre os e-mails e cargos da sua equipe para liberar o acesso automático às tarefas e alertas.
            </p>
            <div id="memberStatus" class="status-message" role="status" aria-live="polite"></div>
            <form id="memberForm">
              <div>
                <label for="memberName">
                  Nome completo
                </label>
                <input id="memberName" name="memberName" type="text" placeholder="Ex.: Ana Mendes" autocomplete="name" />
              </div>
              <div>
                <label for="memberEmail">
                  E-mail da equipe <span class="required" aria-hidden="true">*</span>
                </label>
                <input
                  id="memberEmail"
                  name="memberEmail"
                  type="email"
                  placeholder="nome@suaempresa.com"
                  autocomplete="email"
                  required
                />
              </div>
              <div>
                <label for="memberRole">
                  Cargo ou função <span class="required" aria-hidden="true">*</span>
                </label>
                <input
                  id="memberRole"
                  name="memberRole"
                  type="text"
                  placeholder="Ex.: Analista de Atendimento"
                  required
                />
              </div>
              <div class="actions-row">
                <button type="submit" id="memberSubmitBtn">
                  <i class="fas fa-user-plus" aria-hidden="true"></i>
                  Adicionar integrante
                </button>
              </div>
            </form>
          </div>

          <div class="card">
            <h2>Minha equipe</h2>
            <div class="stack" id="myMembersContainer">
              <div class="empty-state">Cadastre integrantes para montar a sua equipe.</div>
            </div>
          </div>

          <div class="card" id="sharedTeamsCard" hidden>
            <h2>Equipes em que participo</h2>
            <p class="text-sm" style="color: var(--text-light, #4b5563);">
              Estes são os times que adicionaram seu e-mail. Você tem acesso às tarefas e alertas publicados por eles.
            </p>
            <div class="stack" id="sharedTeamsContainer"></div>
          </div>
        </section>

        <section id="tasks" class="tab-view" aria-labelledby="Tarefas da equipe">
          <div class="card">
            <h2>Registrar tarefa</h2>
            <p class="text-sm" style="color: var(--text-light, #4b5563); margin-bottom: 12px;">
              Defina tarefas com data, horário, prioridade e materiais de apoio. Os integrantes cadastrados verão tudo automaticamente.
            </p>
            <div id="taskStatus" class="status-message" role="status" aria-live="polite"></div>
            <form id="taskForm">
              <div>
                <label for="taskTitle">
                  Tarefa <span class="required" aria-hidden="true">*</span>
                </label>
                <input id="taskTitle" name="taskTitle" type="text" placeholder="Ex.: Realizar inventário diário" required />
              </div>
              <div class="stack" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div>
                  <label for="taskDate">
                    Data <span class="required" aria-hidden="true">*</span>
                  </label>
                  <input id="taskDate" name="taskDate" type="date" required />
                </div>
                <div>
                  <label for="taskTime">
                    Horário <span class="required" aria-hidden="true">*</span>
                  </label>
                  <input id="taskTime" name="taskTime" type="time" required />
                </div>
                <div>
                  <label for="taskPriority">
                    Prioridade <span class="required" aria-hidden="true">*</span>
                  </label>
                  <select id="taskPriority" name="taskPriority" required>
                    <option value="alta">Alta</option>
                    <option value="media">Média</option>
                    <option value="baixa">Baixa</option>
                  </select>
                </div>
              </div>
              <div>
                <label for="taskTips">Dicas e orientações</label>
                <textarea id="taskTips" name="taskTips" placeholder="Compartilhe detalhes, lembretes ou checklists importantes."></textarea>
              </div>
              <div>
                <label for="taskSupport">Material de apoio</label>
                <textarea
                  id="taskSupport"
                  name="taskSupport"
                  placeholder="Links, anotações ou referências úteis."
                ></textarea>
              </div>
              <div>
                <label for="taskResponsible">
                  Usuário responsável <span class="required" aria-hidden="true">*</span>
                </label>
                <select id="taskResponsible" name="taskResponsible" required>
                  <option value="" disabled selected>Cadastre a equipe para selecionar um responsável</option>
                </select>
              </div>
              <div class="actions-row">
                <button type="submit" id="taskSubmitBtn">
                  <i class="fas fa-plus" aria-hidden="true"></i>
                  Salvar tarefa
                </button>
              </div>
            </form>
          </div>

          <div class="card">
            <h2>Tarefas compartilhadas</h2>
            <div id="tasksContainer" class="stack">
              <div class="empty-state">As tarefas cadastradas aqui aparecerão para toda a equipe.</div>
            </div>
          </div>
        </section>

        <section id="updates" class="tab-view" aria-labelledby="Atualizações e alertas">
          <div class="card">
            <h2>Publicar atualização ou alerta</h2>
            <p class="text-sm" style="color: var(--text-light, #4b5563); margin-bottom: 12px;">
              Use esta área para comunicar mudanças importantes, avisos urgentes ou novidades da equipe.
            </p>
            <div id="updateStatus" class="status-message" role="status" aria-live="polite"></div>
            <form id="updateForm">
              <div>
                <label for="updateTitle">Título</label>
                <input id="updateTitle" name="updateTitle" type="text" placeholder="Ex.: Mudanças no processo de expedição" />
              </div>
              <div>
                <label for="updateMessage">
                  Mensagem <span class="required" aria-hidden="true">*</span>
                </label>
                <textarea
                  id="updateMessage"
                  name="updateMessage"
                  placeholder="Descreva a atualização ou alerta."
                  required
                ></textarea>
              </div>
              <div class="actions-row">
                <button type="submit" id="updateSubmitBtn">
                  <i class="fas fa-paper-plane" aria-hidden="true"></i>
                  Compartilhar comunicado
                </button>
              </div>
            </form>
          </div>

          <div class="card">
            <h2>Atualizações recentes</h2>
            <div id="updatesContainer" class="stack">
              <div class="empty-state">Nenhuma atualização registrada até o momento.</div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>window.CUSTOM_SIDEBAR_PATH = '/partials/sidebar.html';</script>
    <script src="shared.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script type="module">
      import {
        initializeApp,
        getApps,
        getApp
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
      import {
        getAuth,
        signInWithCustomToken,
        onAuthStateChanged
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
      import {
        getFirestore,
        collection,
        collectionGroup,
        addDoc,
        deleteDoc,
        doc,
        getDocs,
        onSnapshot,
        orderBy,
        query,
        serverTimestamp,
        where
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

      const appId = typeof __app_id !== 'undefined' ? __app_id : 'equipes';
      const firebaseConfig = window.firebaseConfig ||
        (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null) ||
        (window.defaultFirebaseConfig || null);
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

      const tabButtons = document.querySelectorAll('.tab-nav button');
      const tabViews = document.querySelectorAll('.tab-view');
      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.tab;
          tabButtons.forEach((b) => b.classList.toggle('active', b === btn));
          tabViews.forEach((view) => view.classList.toggle('active', view.id === target));
        });
      });

      const memberForm = document.getElementById('memberForm');
      const memberStatus = document.getElementById('memberStatus');
      const memberSubmitBtn = document.getElementById('memberSubmitBtn');
      const myMembersContainer = document.getElementById('myMembersContainer');
      const sharedTeamsCard = document.getElementById('sharedTeamsCard');
      const sharedTeamsContainer = document.getElementById('sharedTeamsContainer');

      const taskForm = document.getElementById('taskForm');
      const taskStatus = document.getElementById('taskStatus');
      const taskSubmitBtn = document.getElementById('taskSubmitBtn');
      const taskResponsibleSelect = document.getElementById('taskResponsible');
      const tasksContainer = document.getElementById('tasksContainer');

      const updateForm = document.getElementById('updateForm');
      const updateStatus = document.getElementById('updateStatus');
      const updateSubmitBtn = document.getElementById('updateSubmitBtn');
      const updatesContainer = document.getElementById('updatesContainer');

      let app;
      let db;
      let auth;
      let currentUser = null;
      let currentEmail = '';
      let trackedOwners = new Set();

      const ownerInfo = new Map();
      const membersByOwner = new Map();
      const tasksByOwner = new Map();
      const updatesByOwner = new Map();

      const memberUnsubs = new Map();
      const taskUnsubs = new Map();
      const updateUnsubs = new Map();

      function showStatus(element, message, type = 'success') {
        if (!element) return;
        element.textContent = message || '';
        element.classList.remove('status-success', 'status-error', 'show');
        if (!message) return;
        element.classList.add(type === 'error' ? 'status-error' : 'status-success', 'show');
      }

      function setButtonLoading(button, loading) {
        if (!button) return;
        button.disabled = loading;
      }

      function formatDate(date) {
        if (!date) return 'Sem data definida';
        return new Intl.DateTimeFormat('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        }).format(date);
      }

      function formatTime(timeString) {
        if (!timeString) return '';
        try {
          const [hour, minute] = timeString.split(':');
          return `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
        } catch (e) {
          return timeString;
        }
      }

      function resolveOwnerLabel(ownerUid) {
        const meta = ownerInfo.get(ownerUid) || {};
        if (ownerUid === currentUser?.uid) {
          return 'Minha equipe';
        }
        if (meta.label) return meta.label;
        if (meta.email) return `Equipe de ${meta.email}`;
        return 'Equipe compartilhada';
      }

      function resolveMemberName(ownerUid, email) {
        if (!email) return 'Não atribuído';
        const normalized = email.toLowerCase();
        const members = membersByOwner.get(ownerUid) || [];
        const match = members.find((member) => (member.emailLower || '').toLowerCase() === normalized);
        if (match) {
          return match.name || match.email || email;
        }
        if (ownerUid === currentUser?.uid && currentUser?.email && currentUser.email.toLowerCase() === normalized) {
          return 'Você';
        }
        return email;
      }

      function renderMyMembers() {
        const myMembers = membersByOwner.get(currentUser?.uid) || [];
        if (!myMembers.length) {
          myMembersContainer.innerHTML = '<div class="empty-state">Cadastre integrantes para montar a sua equipe.</div>';
          return;
        }

        const rows = myMembers
          .sort((a, b) => (a.name || a.email || '').localeCompare(b.name || b.email || ''))
          .map((member) => {
            const email = member.email || '—';
            const role = member.role || '—';
            const name = member.name || member.email || '—';
            return `
              <div class="task-card" data-member-id="${member.id}">
                <header>
                  <div>
                    <strong>${name}</strong>
                    <div style="color: var(--text-light, #4b5563); font-size: 0.9rem;">${email}</div>
                  </div>
                  <span class="badge"><i class="fas fa-briefcase"></i>${role}</span>
                </header>
                <div class="card-footer">
                  <span>Adicionado em ${member.createdAt ? formatDate(member.createdAt) : '—'}</span>
                  <button type="button" data-action="delete-member" data-id="${member.id}">
                    <i class="fas fa-trash" aria-hidden="true"></i> Remover
                  </button>
                </div>
              </div>
            `;
          })
          .join('');

        myMembersContainer.innerHTML = rows;
      }

      function renderSharedTeams() {
        const owners = Array.from(trackedOwners).filter((ownerUid) => ownerUid !== currentUser?.uid);
        if (!owners.length) {
          sharedTeamsCard.hidden = true;
          sharedTeamsContainer.innerHTML = '';
          return;
        }

        sharedTeamsCard.hidden = false;
        sharedTeamsContainer.innerHTML = owners
          .map((ownerUid) => {
            const members = membersByOwner.get(ownerUid) || [];
            const meta = ownerInfo.get(ownerUid) || {};
            const memberList = members
              .map((member) => {
                const role = member.role || '—';
                const email = member.email || '—';
                const name = member.name || email;
                return `<li><strong>${name}</strong> — ${role} (${email})</li>`;
              })
              .join('');

            return `
              <div class="task-card">
                <header>
                  <div>
                    <strong>${resolveOwnerLabel(ownerUid)}</strong>
                    ${meta.email ? `<div class="tag"><i class="fas fa-envelope"></i>${meta.email}</div>` : ''}
                  </div>
                </header>
                <div>
                  ${memberList ? `<ul class="stack" style="padding-left: 18px;">${memberList}</ul>` : '<div class="empty-state">Nenhum integrante listado.</div>'}
                </div>
              </div>
            `;
          })
          .join('');
      }

      function priorityBadge(priority) {
        const normalized = (priority || '').toLowerCase();
        if (normalized === 'alta') return '<span class="badge high"><i class="fas fa-circle-exclamation"></i>Alta</span>';
        if (normalized === 'media') return '<span class="badge medium"><i class="fas fa-exclamation"></i>Média</span>';
        return '<span class="badge low"><i class="fas fa-check"></i>Baixa</span>';
      }

      function renderTasks() {
        const owners = Array.from(trackedOwners);
        if (!owners.length) {
          tasksContainer.innerHTML = '<div class="empty-state">As tarefas cadastradas aqui aparecerão para toda a equipe.</div>';
          return;
        }

        const sections = owners
          .map((ownerUid) => {
            const tasks = (tasksByOwner.get(ownerUid) || []).slice().sort((a, b) => {
              const aDate = a.dueDate ? new Date(`${a.dueDate}T${a.dueTime || '00:00'}`) : null;
              const bDate = b.dueDate ? new Date(`${b.dueDate}T${b.dueTime || '00:00'}`) : null;
              if (aDate && bDate) return aDate - bDate;
              if (aDate) return -1;
              if (bDate) return 1;
              return (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0);
            });

            const cards = tasks
              .map((task) => {
                const dueDate = task.dueDate ? new Date(`${task.dueDate}T00:00:00`) : null;
                const material = task.supportMaterial ? `<div><strong>Material:</strong> ${task.supportMaterial.replace(/\n/g, '<br>')}</div>` : '';
                const tips = task.tips ? `<div><strong>Dicas:</strong> ${task.tips.replace(/\n/g, '<br>')}</div>` : '';
                const responsible = resolveMemberName(ownerUid, task.responsibleEmail);

                return `
                  <article class="task-card" data-task-id="${task.id}" data-owner="${ownerUid}">
                    <header>
                      <div>
                        <h3 style="margin: 0 0 4px;">${task.title || 'Tarefa sem título'}</h3>
                        <div class="tag"><i class="fas fa-user"></i>${responsible}</div>
                      </div>
                      ${priorityBadge(task.priority)}
                    </header>
                    <div class="stack">
                      <div><strong>Data:</strong> ${task.dueDate ? formatDate(dueDate) : 'Sem data'}</div>
                      <div><strong>Horário:</strong> ${formatTime(task.dueTime)}</div>
                      ${tips}
                      ${material}
                    </div>
                    <div class="card-footer">
                      <span>Registrado por ${task.createdBy || 'Equipe'}${task.createdAt ? ` em ${formatDate(task.createdAt)}` : ''}</span>
                      ${ownerUid === currentUser?.uid ? `<button type="button" data-action="delete-task" data-id="${task.id}">Excluir</button>` : ''}
                    </div>
                  </article>
                `;
              })
              .join('');

            return `
              <section class="stack">
                <h3>${resolveOwnerLabel(ownerUid)}</h3>
                ${cards || '<div class="empty-state">Nenhuma tarefa cadastrada para esta equipe.</div>'}
              </section>
            `;
          })
          .join('');

        tasksContainer.innerHTML = sections || '<div class="empty-state">As tarefas cadastradas aqui aparecerão para toda a equipe.</div>';
      }

      function renderUpdates() {
        const owners = Array.from(trackedOwners);
        if (!owners.length) {
          updatesContainer.innerHTML = '<div class="empty-state">Nenhuma atualização registrada até o momento.</div>';
          return;
        }

        const sections = owners
          .map((ownerUid) => {
            const updates = (updatesByOwner.get(ownerUid) || []).slice().sort((a, b) => {
              const aDate = a.createdAt?.getTime?.() || 0;
              const bDate = b.createdAt?.getTime?.() || 0;
              return bDate - aDate;
            });

            const cards = updates
              .map((update) => {
                const createdAt = update.createdAt ? formatDate(update.createdAt) : '—';
                return `
                  <article class="update-card" data-update-id="${update.id}" data-owner="${ownerUid}">
                    <header>
                      <div>
                        <h3 style="margin: 0 0 4px;">${update.title || 'Atualização'}</h3>
                        <div class="tag"><i class="fas fa-user"></i>${update.createdBy || 'Equipe'}</div>
                      </div>
                    </header>
                    <div>${(update.message || '').replace(/\n
/g, '<br>')}</div>
                    <div class="card-footer">
                      <span>Publicado em ${createdAt}</span>
                      ${ownerUid === currentUser?.uid ? `<button type="button" data-action="delete-update" data-id="${update.id}">Excluir</button>` : ''}
                    </div>
                  </article>
                `;
              })
              .join('');

            return `
              <section class="stack">
                <h3>${resolveOwnerLabel(ownerUid)}</h3>
                ${cards || '<div class="empty-state">Nenhum comunicado foi compartilhado ainda.</div>'}
              </section>
            `;
          })
          .join('');

        updatesContainer.innerHTML = sections || '<div class="empty-state">Nenhuma atualização registrada até o momento.</div>';
      }

      function updateResponsibleOptions() {
        if (!taskResponsibleSelect) return;
        const myMembers = membersByOwner.get(currentUser?.uid) || [];
        const currentUserEmail = currentUser?.email || '';
        const options = [
          '<option value="">Selecione um responsável</option>'
        ];

        const normalizedEmails = new Set();
        myMembers.forEach((member) => {
          if (!member.email) return;
          const normalized = member.email.toLowerCase();
          if (normalizedEmails.has(normalized)) return;
          normalizedEmails.add(normalized);
          const label = `${member.name || member.email} — ${member.role || 'Sem cargo'}`;
          options.push(`<option value="${member.email}">${label}</option>`);
        });

        if (currentUserEmail) {
          const normalized = currentUserEmail.toLowerCase();
          if (!normalizedEmails.has(normalized)) {
            options.push(`<option value="${currentUserEmail}">${currentUserEmail} (Você)</option>`);
          }
        }

        taskResponsibleSelect.innerHTML = options.join('');
      }

      function extractOwnerUidFromPath(path) {
        const segments = path.split('/');
        const index = segments.indexOf('users');
        if (index >= 0 && segments.length > index + 1) {
          return segments[index + 1];
        }
        return null;
      }

      function ensureOwnerMeta(ownerUid, meta = {}) {
        const currentMeta = ownerInfo.get(ownerUid) || {};
        ownerInfo.set(ownerUid, { ...currentMeta, ...meta });
      }

      function subscribeToOwnerCollections(ownerUid) {
        if (!db) return;
        if (!memberUnsubs.has(ownerUid)) {
          const membersRef = collection(db, 'artifacts', appId, 'users', ownerUid, 'members');
          const membersQuery = query(membersRef, orderBy('createdAt', 'desc'));
          const unsub = onSnapshot(membersQuery, (snapshot) => {
            const members = snapshot.docs.map((docSnap) => {
              const data = docSnap.data();
              const createdAt = data.createdAt?.toDate?.() || null;
              if (data.ownerUid && data.ownerEmail) {
                ensureOwnerMeta(data.ownerUid, { email: data.ownerEmail });
              }
              return {
                id: docSnap.id,
                name: data.name || '',
                email: data.email || '',
                emailLower: (data.emailLower || data.email || '').toLowerCase(),
                role: data.role || '',
                createdAt,
              };
            });
            membersByOwner.set(ownerUid, members);
            if (ownerUid === currentUser?.uid) {
              updateResponsibleOptions();
            }
            renderMyMembers();
            renderSharedTeams();
            renderTasks();
          }, (error) => {
            console.error('Erro ao acompanhar membros:', error);
          });
          memberUnsubs.set(ownerUid, unsub);
        }

        if (!taskUnsubs.has(ownerUid)) {
          const tasksRef = collection(db, 'artifacts', appId, 'users', ownerUid, 'tasks');
          const tasksQuery = query(tasksRef, orderBy('createdAt', 'desc'));
          const unsub = onSnapshot(tasksQuery, (snapshot) => {
            const tasks = snapshot.docs.map((docSnap) => {
              const data = docSnap.data();
              const createdAt = data.createdAt?.toDate?.() || null;
              if (data.ownerUid && data.ownerEmail) {
                ensureOwnerMeta(data.ownerUid, { email: data.ownerEmail });
              }
              return {
                id: docSnap.id,
                title: data.title || '',
                dueDate: data.dueDate || '',
                dueTime: data.dueTime || '',
                priority: data.priority || 'baixa',
                tips: data.tips || '',
                supportMaterial: data.supportMaterial || '',
                responsibleEmail: data.responsibleEmail || '',
                createdBy: data.createdBy || '',
                createdAt,
              };
            });
            tasksByOwner.set(ownerUid, tasks);
            renderTasks();
          }, (error) => {
            console.error('Erro ao acompanhar tarefas:', error);
          });
          taskUnsubs.set(ownerUid, unsub);
        }

        if (!updateUnsubs.has(ownerUid)) {
          const updatesRef = collection(db, 'artifacts', appId, 'users', ownerUid, 'updates');
          const updatesQuery = query(updatesRef, orderBy('createdAt', 'desc'));
          const unsub = onSnapshot(updatesQuery, (snapshot) => {
            const updates = snapshot.docs.map((docSnap) => {
              const data = docSnap.data();
              const createdAt = data.createdAt?.toDate?.() || null;
              if (data.ownerUid && data.ownerEmail) {
                ensureOwnerMeta(data.ownerUid, { email: data.ownerEmail });
              }
              return {
                id: docSnap.id,
                title: data.title || '',
                message: data.message || '',
                createdBy: data.createdBy || '',
                createdAt,
              };
            });
            updatesByOwner.set(ownerUid, updates);
            renderUpdates();
          }, (error) => {
            console.error('Erro ao acompanhar atualizações:', error);
          });
          updateUnsubs.set(ownerUid, unsub);
        }
      }

      function unsubscribeFromOwner(ownerUid) {
        const unsubMembers = memberUnsubs.get(ownerUid);
        if (unsubMembers) {
          unsubMembers();
          memberUnsubs.delete(ownerUid);
        }
        const unsubTasks = taskUnsubs.get(ownerUid);
        if (unsubTasks) {
          unsubTasks();
          taskUnsubs.delete(ownerUid);
        }
        const unsubUpdates = updateUnsubs.get(ownerUid);
        if (unsubUpdates) {
          unsubUpdates();
          updateUnsubs.delete(ownerUid);
        }
        membersByOwner.delete(ownerUid);
        tasksByOwner.delete(ownerUid);
        updatesByOwner.delete(ownerUid);
      }

      function applyOwnerSet(newOwnersSet) {
        const newOwners = new Set(newOwnersSet);
        newOwners.forEach((ownerUid) => {
          if (!trackedOwners.has(ownerUid)) {
            subscribeToOwnerCollections(ownerUid);
          }
        });
        trackedOwners.forEach((ownerUid) => {
          if (!newOwners.has(ownerUid)) {
            unsubscribeFromOwner(ownerUid);
          }
        });
        trackedOwners = newOwners;
        renderMyMembers();
        renderSharedTeams();
        renderTasks();
        renderUpdates();
      }

      async function refreshSharedMemberships() {
        if (!db || !currentEmail) return;
        try {
          const membersQuery = query(
            collectionGroup(db, 'members'),
            where('emailLower', '==', currentEmail)
          );
          const snapshot = await getDocs(membersQuery);
          const owners = new Set([currentUser.uid]);
          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const ownerUid = data.ownerUid || extractOwnerUidFromPath(docSnap.ref.path);
            if (!ownerUid) return;
            owners.add(ownerUid);
            ensureOwnerMeta(ownerUid, {
              email: data.ownerEmail || undefined,
              label: data.ownerName ? `Equipe de ${data.ownerName}` : undefined,
            });
          });
          applyOwnerSet(owners);
        } catch (error) {
          console.error('Erro ao buscar equipes compartilhadas:', error);
          showStatus(memberStatus, 'Não foi possível carregar equipes compartilhadas.', 'error');
        }
      }

      function initializeAuth() {
        if (!firebaseConfig || !firebaseConfig.projectId) {
          showStatus(memberStatus, 'Configuração do Firebase ausente. Contate o suporte.', 'error');
          return;
        }

        try {
          if (!getApps().length) {
            app = initializeApp(firebaseConfig);
          } else {
            app = getApp();
          }
          db = getFirestore(app);
          auth = getAuth(app);

          if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch((error) => {
              console.error('Erro ao autenticar com token personalizado:', error);
            });
          }

          onAuthStateChanged(auth, (user) => {
            if (!user) {
              window.location.href = 'index.html?login=1';
              return;
            }

            currentUser = user;
            currentEmail = (user.email || '').toLowerCase();
            ensureOwnerMeta(user.uid, {
              email: user.email || undefined,
              label: 'Minha equipe'
            });
            applyOwnerSet(new Set([user.uid]));
            refreshSharedMemberships();
          });
        } catch (error) {
          console.error('Erro ao inicializar Firebase:', error);
          showStatus(memberStatus, 'Não foi possível conectar ao Firebase.', 'error');
        }
      }

      memberForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!db || !currentUser) return;
        const formData = new FormData(memberForm);
        const name = (formData.get('memberName') || '').toString().trim();
        const email = (formData.get('memberEmail') || '').toString().trim();
        const role = (formData.get('memberRole') || '').toString().trim();

        if (!email || !role) {
          showStatus(memberStatus, 'Informe o e-mail e o cargo do integrante.', 'error');
          return;
        }

        const normalizedEmail = email.toLowerCase();
        const existing = (membersByOwner.get(currentUser.uid) || []).some(
          (member) => (member.emailLower || '').toLowerCase() === normalizedEmail
        );
        if (existing) {
          showStatus(memberStatus, 'Este e-mail já está cadastrado na equipe.', 'error');
          return;
        }

        setButtonLoading(memberSubmitBtn, true);
        try {
          await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'members'), {
            name,
            email,
            emailLower: normalizedEmail,
            role,
            ownerUid: currentUser.uid,
            ownerEmail: currentUser.email || null,
            ownerName: currentUser.displayName || null,
            createdAt: serverTimestamp(),
          });
          memberForm.reset();
          showStatus(memberStatus, 'Integrante cadastrado com sucesso!');
          updateResponsibleOptions();
        } catch (error) {
          console.error('Erro ao adicionar integrante:', error);
          showStatus(memberStatus, 'Não foi possível cadastrar o integrante.', 'error');
        } finally {
          setButtonLoading(memberSubmitBtn, false);
        }
      });

      myMembersContainer?.addEventListener('click', async (event) => {
        const button = event.target.closest('[data-action="delete-member"]');
        if (!button || !db || !currentUser) return;
        const memberId = button.dataset.id;
        if (!memberId) return;
        if (!confirm('Tem certeza de que deseja remover este integrante?')) return;
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'members', memberId));
          showStatus(memberStatus, 'Integrante removido.');
        } catch (error) {
          console.error('Erro ao remover integrante:', error);
          showStatus(memberStatus, 'Não foi possível remover o integrante.', 'error');
        }
      });

      taskForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!db || !currentUser) return;
        const formData = new FormData(taskForm);
        const title = (formData.get('taskTitle') || '').toString().trim();
        const dueDate = (formData.get('taskDate') || '').toString();
        const dueTime = (formData.get('taskTime') || '').toString();
        const priority = (formData.get('taskPriority') || '').toString();
        const tips = (formData.get('taskTips') || '').toString();
        const support = (formData.get('taskSupport') || '').toString();
        const responsible = (formData.get('taskResponsible') || '').toString();

        if (!title || !dueDate || !dueTime || !priority || !responsible) {
          showStatus(taskStatus, 'Preencha os campos obrigatórios da tarefa.', 'error');
          return;
        }

        setButtonLoading(taskSubmitBtn, true);
        try {
          await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks'), {
            title,
            dueDate,
            dueTime,
            priority,
            tips,
            supportMaterial: support,
            responsibleEmail: responsible,
            ownerUid: currentUser.uid,
            ownerEmail: currentUser.email || null,
            createdBy: currentUser.email || currentUser.uid,
            createdAt: serverTimestamp(),
          });
          taskForm.reset();
          updateResponsibleOptions();
          showStatus(taskStatus, 'Tarefa registrada com sucesso!');
        } catch (error) {
          console.error('Erro ao salvar tarefa:', error);
          showStatus(taskStatus, 'Não foi possível salvar a tarefa.', 'error');
        } finally {
          setButtonLoading(taskSubmitBtn, false);
        }
      });

      tasksContainer?.addEventListener('click', async (event) => {
        const button = event.target.closest('[data-action="delete-task"]');
        if (!button || !db || !currentUser) return;
        const taskId = button.dataset.id;
        if (!taskId) return;
        if (!confirm('Deseja excluir esta tarefa?')) return;
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', taskId));
          showStatus(taskStatus, 'Tarefa excluída.');
        } catch (error) {
          console.error('Erro ao excluir tarefa:', error);
          showStatus(taskStatus, 'Não foi possível excluir a tarefa.', 'error');
        }
      });

      updateForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!db || !currentUser) return;
        const formData = new FormData(updateForm);
        const title = (formData.get('updateTitle') || '').toString().trim();
        const message = (formData.get('updateMessage') || '').toString().trim();
        if (!message) {
          showStatus(updateStatus, 'Escreva a mensagem da atualização.', 'error');
          return;
        }

        setButtonLoading(updateSubmitBtn, true);
        try {
          await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'updates'), {
            title,
            message,
            ownerUid: currentUser.uid,
            ownerEmail: currentUser.email || null,
            createdBy: currentUser.email || currentUser.uid,
            createdAt: serverTimestamp(),
          });
          updateForm.reset();
          showStatus(updateStatus, 'Atualização publicada com sucesso!');
        } catch (error) {
          console.error('Erro ao salvar atualização:', error);
          showStatus(updateStatus, 'Não foi possível publicar a atualização.', 'error');
        } finally {
          setButtonLoading(updateSubmitBtn, false);
        }
      });

      updatesContainer?.addEventListener('click', async (event) => {
        const button = event.target.closest('[data-action="delete-update"]');
        if (!button || !db || !currentUser) return;
        const updateId = button.dataset.id;
        if (!updateId) return;
        if (!confirm('Deseja remover esta atualização?')) return;
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'updates', updateId));
          showStatus(updateStatus, 'Atualização removida.');
        } catch (error) {
          console.error('Erro ao remover atualização:', error);
          showStatus(updateStatus, 'Não foi possível remover a atualização.', 'error');
        }
      });

      window.addEventListener('focus', () => {
        if (currentUser) {
          refreshSharedMemberships();
        }
      });

      initializeAuth();
    </script>
  </body>
</html>
