<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Etiqueta Shopee - Corte 15/2/2</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css?v=20240826" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="expedicao-notifier.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    .shopee-labels {
      position: relative;
      background: linear-gradient(180deg, #1e3a8a 0%, #2563eb 45%, #0ea5e9 100%);
      border-radius: 32px;
      padding: 40px 32px 44px;
      color: #fff;
      box-shadow: 0 35px 65px rgba(37, 99, 235, 0.35);
      overflow: hidden;
    }
    .shopee-labels::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.25), transparent 60%),
                  radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.4), transparent 65%);
      pointer-events: none;
    }
    .shopee-labels > * {
      position: relative;
      z-index: 1;
    }
    .labels-banner {
      text-align: center;
      font-size: clamp(26px, 3.4vw, 40px);
      font-weight: 800;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 28px;
      text-shadow: 0 12px 25px rgba(15, 23, 42, 0.35);
    }
    .labels-body {
      display: flex;
      flex-direction: column;
      gap: 26px;
    }
    .labels-drop {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 38px 24px;
      border-radius: 26px;
      border: 3px dashed rgba(37, 99, 235, 0.45);
      background: rgba(255, 255, 255, 0.96);
      color: #1e3a8a;
      font-weight: 600;
      font-size: 1rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.08);
    }
    .labels-drop:hover {
      border-color: #38bdf8;
      transform: translateY(-2px);
      box-shadow: 0 24px 48px rgba(14, 165, 233, 0.35);
    }
    .labels-drop-icon {
      font-size: 2.75rem;
      color: #2563eb;
    }
    .labels-drop-note {
      font-size: 0.85rem;
      color: #2563eb;
      font-weight: 600;
    }
    .shopee-labels input[type="file"] {
      display: none;
    }
    .labels-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }
    .labels-start {
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 0 56px;
      height: 60px;
      border-radius: 9999px;
      font-size: 1.25rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: linear-gradient(135deg, #34d399 0%, #22d3ee 100%);
      color: #0f172a;
      cursor: pointer;
      box-shadow: 0 28px 45px rgba(16, 185, 129, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }
    .labels-start:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
      filter: grayscale(10%);
    }
    .labels-start:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 32px 54px rgba(13, 148, 136, 0.4);
    }
    .labels-start:not(:disabled):active {
      transform: translateY(1px);
    }
    .labels-status {
      font-size: 0.85rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(226, 232, 240, 0.85);
      min-height: 1.6rem;
    }
    .labels-options {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 18px;
      flex-wrap: wrap;
    }
    .labels-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 220px;
    }
    .labels-field label {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(226, 232, 240, 0.9);
    }
    .labels-input {
      background: rgba(255, 255, 255, 0.98);
      border: none;
      border-radius: 16px;
      padding: 12px 16px;
      color: #0f172a;
      font-size: 0.95rem;
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.12);
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .labels-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(125, 211, 252, 0.65);
      transform: translateY(-1px);
    }
    .labels-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-weight: 600;
      color: rgba(226, 232, 240, 0.92);
    }
    .labels-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: #22d3ee;
    }
    .labels-checkbox span {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.8rem;
      letter-spacing: 0.04em;
    }
    .labels-hint {
      font-size: 0.9rem;
      line-height: 1.5;
      color: rgba(226, 232, 240, 0.88);
    }
    .labels-hint-center {
      text-align: center;
    }
    .labels-sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }
    .labels-card {
      background: rgba(15, 23, 42, 0.28);
      border-radius: 24px;
      padding: 24px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .labels-card-title {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    .labels-card-content {
      font-size: 0.95rem;
      color: rgba(226, 232, 240, 0.95);
      min-height: 40px;
    }
    .labels-log {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 18px;
      padding: 16px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      max-height: 240px;
      overflow-y: auto;
    }
    .labels-log pre {
      margin: 0;
      color: #e2e8f0;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }
    .labels-emails {
      background: rgba(15, 23, 42, 0.2);
      border-radius: 24px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }
    .labels-emails label {
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 700;
      color: rgba(226, 232, 240, 0.85);
    }
    .labels-emails input {
      background: rgba(255, 255, 255, 0.98);
      border: none;
      border-radius: 16px;
      padding: 12px 16px;
      color: #0f172a;
      font-size: 0.95rem;
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.12);
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .labels-emails input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(125, 211, 252, 0.65);
      transform: translateY(-1px);
    }
    .progress-bar-bg {
      background: linear-gradient(90deg, #cfd9df 0%, #e2ebf0 100%);
      border-radius: 9999px;
      height: 1.5rem;
      overflow: hidden;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
    }
    .progress-bar-fill {
      background: linear-gradient(90deg, #06B6D4 0%, #3B82F6 100%);
      height: 100%;
      border-radius: 9999px 0 0 9999px;
      transition: width 0.3s cubic-bezier(.4,0,.2,1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 0.875rem;
      background-size: 200% 100%;
      animation: progress-animation 2s linear infinite;
    }
    .progress-bar-fill.completed {
      background: linear-gradient(90deg, #16A34A 0%, #22C55E 100%);
      animation: none;
    }
    .progress-bar-fill.failed {
      background: linear-gradient(90deg, #DC2626 0%, #EF4444 100%);
      animation: none;
    }
    @keyframes progress-animation {
      0% { background-position: 0% 0; }
      100% { background-position: -200% 0; }
    }
    #timerText {
      font-size: 0.875rem;
      color: #1f2937;
      font-weight: 500;
    }
    #status {
      min-height: 1.6rem;
    }
    @media (max-width: 768px) {
      .shopee-labels {
        padding: 32px 24px 36px;
      }
      .labels-drop {
        padding: 30px 18px;
      }
      .labels-start {
        width: 100%;
      }
      .labels-options {
        justify-content: stretch;
      }
    }
    @media (max-width: 480px) {
      .labels-start {
        font-size: 1.1rem;
        padding: 0 32px;
        height: 54px;
      }
      .labels-checkbox {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
  <div class="app-container">
    <div id="sidebar-container"></div>
    <div id="navbar-container"></div>
    <div class="main-content">
      <div class="px-4 py-6">
        <div class="max-w-4xl mx-auto">
          <div class="shopee-labels">
            <div class="labels-banner">Etiquetas Shopee</div>
            <div class="labels-body">
              <label class="labels-drop" for="file">
                <input id="file" type="file" accept="application/pdf" />
                <span class="labels-drop-icon"><i class="fa-solid fa-cloud-arrow-up"></i></span>
                <span>Arrastar e soltar ou clicar para fazer upload</span>
                <span class="labels-drop-note">PDF A4 com checklist Shopee</span>
              </label>
              <div class="labels-actions">
                <button id="go" type="button" class="labels-start">Iniciar</button>
                <span id="status" class="labels-status"></span>
              </div>
              <div class="labels-options">
                <div class="labels-field">
                  <label for="storeName">Loja</label>
                  <input id="storeName" type="text" class="labels-input" placeholder="Ex.: Loja Principal" />
                </div>
                <label class="labels-checkbox">
                  <input id="debug" type="checkbox" />
                  <span>Gerar PDF DEBUG</span>
                </label>
              </div>
              <p class="labels-hint labels-hint-center">Colunas (cm): <strong>[2.2, 1.9, 1.9, 1.9, 1.9]</strong>. Zoom padrão: <strong>120%</strong> (ajustável em <code>zoomFactor</code>).</p>
              <div class="labels-sections">
                <div class="labels-card">
                  <h3 class="labels-card-title">Resultados</h3>
                  <div id="out" class="labels-card-content">Links para download aparecerão aqui.</div>
                </div>
                <div class="labels-card">
                  <h3 class="labels-card-title">Log</h3>
                  <div class="labels-log">
                    <pre id="log"></pre>
                  </div>
                </div>
              </div>
              <div class="labels-emails">
                <label for="gestoresEmails">E-mails do gestor de expedição</label>
                <input id="gestoresEmails" type="text" placeholder="separados por vírgula" />
                <p class="labels-hint">Os PDFs serão compartilhados com os e-mails listados. Se houver mais de um, você poderá escolher durante o envio.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="processingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40 px-4">
    <div id="processingModalCard" class="w-full max-w-lg rounded-xl shadow-xl p-6 bg-white border-t-4 border-blue-500 space-y-5 transition-colors duration-300">
      <div class="flex items-start gap-3">
        <i id="processingIcon" class="fa-solid fa-gear fa-spin text-blue-500 text-2xl mt-1"></i>
        <div>
          <h2 id="processingTitle" class="text-xl font-semibold text-gray-800">Processando etiquetas...</h2>
          <p id="processingSubtitle" class="text-sm text-gray-600">Por favor, não feche a página até concluirmos o processamento.</p>
        </div>
      </div>
      <div>
        <div class="progress-bar-bg" id="progressBar" style="display:none;">
          <div class="progress-bar-fill" id="progressFill" style="width:0%;">
            <span id="progressText" class="w-full text-center"></span>
          </div>
        </div>
        <div id="timerText" class="text-center text-sm text-gray-700 mt-3"></div>
      </div>
      <div class="text-xs text-yellow-700 bg-yellow-100 border border-yellow-200 rounded-md px-3 py-2 flex items-start gap-2">
        <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
        <span>Não feche a página enquanto as etiquetas são processadas e enviadas.</span>
      </div>
      <button id="processingClose" type="button" class="w-full hidden py-2.5 rounded-lg font-medium text-white bg-green-600 hover:bg-green-700 transition" aria-hidden="true">Fechar</button>
    </div>
  </div>

  <div id="gestorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white w-full max-w-md p-4 rounded-xl shadow-lg space-y-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-800">Enviar arquivo para qual gestor?</h2>
        <p class="text-sm text-gray-500">Escolha o e-mail que receberá a etiqueta processada.</p>
      </div>
      <select id="gestorSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
      <div class="flex justify-end gap-2">
        <button id="gestorCancel" type="button" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
        <button id="gestorConfirm" type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.firestore();
    const storage = firebase.storage();

    const fileInput = document.getElementById('file');
    const processBtn = document.getElementById('go');
    const debugCheckbox = document.getElementById('debug');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const outEl = document.getElementById('out');
    const gestoresInput = document.getElementById('gestoresEmails');
    const storeNameInput = document.getElementById('storeName');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const timerText = document.getElementById('timerText');
    const processingModal = document.getElementById('processingModal');
    const processingModalCard = document.getElementById('processingModalCard');
    const processingTitle = document.getElementById('processingTitle');
    const processingSubtitle = document.getElementById('processingSubtitle');
    const processingIcon = document.getElementById('processingIcon');
    const processingClose = document.getElementById('processingClose');

    const log = (text) => {
      logEl.textContent += text + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    };

    const setStatus = (text) => {
      statusEl.textContent = text || '';
    };

    let currentUser = null;
    let responsavelExpedicaoUid = null;
    let horariosEtiquetas = [];
    let isProcessing = false;

    const gestorModal = document.getElementById('gestorModal');
    const gestorSelect = document.getElementById('gestorSelect');
    const gestorConfirm = document.getElementById('gestorConfirm');
    const gestorCancel = document.getElementById('gestorCancel');

    processingModalCard.dataset.status = 'idle';

    function setProcessingModalTheme(state) {
      processingModalCard.classList.remove('bg-white', 'border-blue-500', 'bg-green-50', 'border-green-500', 'bg-red-50', 'border-red-500');
      processingTitle.classList.remove('text-gray-800', 'text-green-700', 'text-red-700');
      processingSubtitle.classList.remove('text-gray-600', 'text-green-700', 'text-red-700');
      timerText.classList.remove('text-gray-700', 'text-green-700', 'text-red-700');

      if (state === 'success') {
        processingModalCard.classList.add('bg-green-50', 'border-green-500');
        processingTitle.classList.add('text-green-700');
        processingSubtitle.classList.add('text-green-700');
        timerText.classList.add('text-green-700');
      } else if (state === 'error') {
        processingModalCard.classList.add('bg-red-50', 'border-red-500');
        processingTitle.classList.add('text-red-700');
        processingSubtitle.classList.add('text-red-700');
        timerText.classList.add('text-red-700');
      } else {
        processingModalCard.classList.add('bg-white', 'border-blue-500');
        processingTitle.classList.add('text-gray-800');
        processingSubtitle.classList.add('text-gray-600');
        timerText.classList.add('text-gray-700');
      }
    }

    function openProcessingModal() {
      setProcessingModalTheme('processing');
      processingModal.classList.remove('hidden');
      processingModal.classList.add('flex');
      document.body.classList.add('overflow-hidden');
      processingModalCard.dataset.status = 'processing';
      processingIcon.className = 'fa-solid fa-gear fa-spin text-blue-500 text-2xl mt-1';
      processingTitle.textContent = 'Processando etiquetas...';
      processingSubtitle.textContent = 'Por favor, não feche a página até concluirmos o processamento.';
      progressBar.style.display = 'block';
      progressFill.style.width = '0%';
      progressFill.classList.remove('completed', 'failed');
      progressText.textContent = '';
      timerText.textContent = '';
      processingClose.classList.add('hidden');
      processingClose.setAttribute('aria-hidden', 'true');
      processingClose.disabled = true;
    }

    function completeProcessingModal(totalSeconds) {
      setProcessingModalTheme('success');
      processingModalCard.dataset.status = 'completed';
      processingIcon.className = 'fa-solid fa-circle-check text-green-500 text-2xl mt-1';
      processingTitle.textContent = 'Tudo pronto!';
      processingSubtitle.textContent = 'Arquivo final salvo com sucesso. Agora você já pode fechar esta janela.';
      progressFill.classList.add('completed');
      progressFill.classList.remove('failed');
      progressFill.style.width = '100%';
      progressText.textContent = 'Processamento finalizado (100%)';
      if (Number.isFinite(totalSeconds)) {
        timerText.textContent = `Tempo total: ${formatTime(Math.max(0, Math.floor(totalSeconds)))}`;
      }
      processingClose.classList.remove('hidden');
      processingClose.removeAttribute('aria-hidden');
      processingClose.disabled = false;
    }

    function failProcessingModal(message) {
      setProcessingModalTheme('error');
      processingModalCard.dataset.status = 'failed';
      processingIcon.className = 'fa-solid fa-circle-exclamation text-red-500 text-2xl mt-1';
      processingTitle.textContent = 'Algo deu errado';
      processingSubtitle.textContent = message || 'Não foi possível concluir o processamento. Tente novamente.';
      progressFill.classList.add('failed');
      progressFill.classList.remove('completed');
      processingClose.classList.remove('hidden');
      processingClose.removeAttribute('aria-hidden');
      processingClose.disabled = false;
    }

    function hideProcessingModal() {
      processingModal.classList.add('hidden');
      processingModal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
      progressBar.style.display = 'none';
      processingModalCard.dataset.status = 'idle';
    }

    if (processingClose) {
      processingClose.addEventListener('click', () => {
        if (processingModalCard.dataset.status !== 'processing') {
          hideProcessingModal();
        }
      });
    }

    function toggleProcessingState(active) {
      isProcessing = active;
      processBtn.disabled = active || !currentUser;
    }

    function updateAuthUI() {
      processBtn.disabled = isProcessing || !currentUser;
      processBtn.classList.toggle('opacity-60', processBtn.disabled);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function formatShortDate(date = new Date()) {
      const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      const day = String(date.getDate()).padStart(2, '0');
      const month = months[date.getMonth()] || '';
      const year = String(date.getFullYear()).slice(-2);
      return `${day}${month}${year}`;
    }

    function sanitizeFileNameSegment(text) {
      return String(text)
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9_-]+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '')
        .toLowerCase();
    }

    function updateProgress(current, total, startTime, progressFillEl, progressTextEl, timerTextEl) {
      const progress = total > 0 ? Math.round((current / total) * 100) : 0;
      progressFillEl.style.width = `${Math.min(100, Math.max(0, progress))}%`;
      if (current > 0) {
        progressTextEl.textContent = `Processando página ${current} de ${total} (${progress}%)`;
        const elapsed = (Date.now() - startTime) / 1000;
        const avg = elapsed / current;
        const remaining = Math.max(0, Math.round(avg * (total - current)));
        timerTextEl.textContent = `Tempo restante: ${formatTime(remaining)}`;
      } else {
        progressTextEl.textContent = total > 0 ? `Preparando (${total} páginas)...` : 'Preparando...';
        timerTextEl.textContent = '';
      }
    }

    function escolherGestorEmail(emails) {
      return new Promise((resolve) => {
        if (!emails || !emails.length) {
          resolve([]);
          return;
        }
        if (emails.length === 1) {
          resolve([emails[0]]);
          return;
        }

        gestorSelect.innerHTML = '';
        emails.forEach((email) => {
          const opt = document.createElement('option');
          opt.value = email;
          opt.textContent = email;
          gestorSelect.appendChild(opt);
        });

        function closeModal(value) {
          gestorModal.classList.add('hidden');
          gestorConfirm.removeEventListener('click', onConfirm);
          gestorCancel.removeEventListener('click', onCancel);
          gestorModal.removeEventListener('click', onBackdrop);
          resolve(value ? [value] : [emails[0]]);
        }

        function onConfirm() {
          closeModal(gestorSelect.value || emails[0]);
        }

        function onCancel() {
          closeModal(emails[0]);
        }

        function onBackdrop(event) {
          if (event.target === gestorModal) {
            closeModal(emails[0]);
          }
        }

        gestorConfirm.addEventListener('click', onConfirm);
        gestorCancel.addEventListener('click', onCancel);
        gestorModal.addEventListener('click', onBackdrop);
        gestorModal.classList.remove('hidden');
      });
    }

    async function carregarHorarios() {
      if (!responsavelExpedicaoUid) return;
      try {
        const doc = await db.collection('uid').doc(responsavelExpedicaoUid).get();
        const data = doc.data() || {};
        horariosEtiquetas = Array.isArray(data.horariosEtiquetas) ? data.horariosEtiquetas : [];
      } catch (error) {
        console.error('Erro ao carregar horários de etiquetas:', error);
      }
    }

    function foraDoHorario() {
      if (!horariosEtiquetas.length) return false;
      const now = new Date();
      return !horariosEtiquetas.some((intervalo) => {
        if (!intervalo?.inicio || !intervalo?.fim) return false;
        const [ih, im] = intervalo.inicio.split(':').map(Number);
        const [fh, fm] = intervalo.fim.split(':').map(Number);
        const start = new Date(now);
        start.setHours(ih || 0, im || 0, 0, 0);
        const end = new Date(now);
        end.setHours(fh || 0, fm || 0, 0, 0);
        return now >= start && now <= end;
      });
    }

    async function getNextShopeeLabelNumber(total) {
      if (!currentUser) return 1;
      const value = Number(total);
      if (!Number.isFinite(value) || value <= 0) return 1;
      const totalSanitizado = Math.max(1, Math.floor(value));
      const ref = db.collection('uid').doc(currentUser.uid).collection('config').doc('contadores');
      try {
        return await db.runTransaction(async (tx) => {
          const snap = await tx.get(ref);
          const atual = snap.exists ? Number(snap.data().shopeeLastNumber || 0) : 0;
          const inicio = atual + 1;
          const proximo = atual + totalSanitizado;
          tx.set(ref, { shopeeLastNumber: proximo }, { merge: true });
          return inicio;
        });
      } catch (error) {
        console.error('Erro ao atualizar o contador de etiquetas Shopee:', error);
        return 1;
      }
    }

    async function uploadPdfToFirebase(blob, fileName, meta = {}) {
      if (!currentUser) {
        throw new Error('Usuário não autenticado.');
      }
      try {
        const gestoresRaw = (gestoresInput.value || '').split(',');
        const gestoresEmails = gestoresRaw.map((email) => email.trim()).filter(Boolean);
        const selecionado = await escolherGestorEmail(gestoresEmails);
        const foraHorarioAtual = foraDoHorario();
        const contadorInicialMeta = Number.isFinite(meta.contadorInicial)
          ? Math.floor(meta.contadorInicial)
          : null;
        const contadorFinalMeta = Number.isFinite(meta.contadorFinal)
          ? Math.floor(meta.contadorFinal)
          : null;
        const quantidadeMeta = Number.isFinite(meta.quantidade)
          ? Number(meta.quantidade)
          : Number.isFinite(meta.totalPaginas)
            ? Number(meta.totalPaginas)
            : null;
        const lojaMeta = typeof meta.loja === 'string' ? meta.loja.trim() : '';
        const dataCurtaMeta = typeof meta.dataProcessamento === 'string' ? meta.dataProcessamento.trim() : '';
        const docPayload = {
          ownerUid: currentUser.uid,
          ownerEmail: currentUser.email,
          gestoresExpedicaoEmails: selecionado,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          name: fileName,
          foraHorario: foraHorarioAtual,
        };
        if (lojaMeta) {
          docPayload.loja = lojaMeta;
        }
        if (dataCurtaMeta) {
          docPayload.dataProcessamento = dataCurtaMeta;
        }
        if (Number.isFinite(meta.totalPaginas)) {
          docPayload.totalPaginas = Number(meta.totalPaginas);
        }
        if (Number.isFinite(meta.totalPaginasOrigem)) {
          docPayload.totalPaginasOrigem = Number(meta.totalPaginasOrigem);
        }
        if (quantidadeMeta !== null) {
          docPayload.quantidade = quantidadeMeta;
        }
        if (contadorInicialMeta !== null) {
          docPayload.contadorInicial = contadorInicialMeta;
        }
        if (contadorFinalMeta !== null) {
          docPayload.contadorFinal = contadorFinalMeta;
        }

        const docRef = await db.collection('pdfDocs').add(docPayload);
        const fileRef = storage.ref().child(`pdfs/${currentUser.uid}/${docRef.id}.pdf`);
        await fileRef.put(blob);
        const url = await fileRef.getDownloadURL();
        await docRef.update({ url, storagePath: fileRef.fullPath });

        const resumo = {
          name: fileName,
          url,
          path: fileRef.fullPath,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        };
        if (lojaMeta) {
          resumo.loja = lojaMeta;
        }
        if (dataCurtaMeta) {
          resumo.dataProcessamento = dataCurtaMeta;
        }
        if (Number.isFinite(meta.totalPaginas)) {
          resumo.totalPaginas = Number(meta.totalPaginas);
        }
        if (Number.isFinite(meta.totalPaginasOrigem)) {
          resumo.totalPaginasOrigem = Number(meta.totalPaginasOrigem);
        }
        if (quantidadeMeta !== null) {
          resumo.quantidade = quantidadeMeta;
        }
        if (contadorInicialMeta !== null) {
          resumo.contadorInicial = contadorInicialMeta;
        }
        if (contadorFinalMeta !== null) {
          resumo.contadorFinal = contadorFinalMeta;
        }
        await db.collection('users').doc(currentUser.uid).collection('etiquetaenvio').add(resumo);

        if (
          window.ExpedicaoNotifier &&
          typeof window.ExpedicaoNotifier.notifyNovaEtiqueta === 'function'
        ) {
          const additionalData = {};
          if (contadorInicialMeta !== null) additionalData.contadorInicial = contadorInicialMeta;
          if (contadorFinalMeta !== null) additionalData.contadorFinal = contadorFinalMeta;
          if (lojaMeta) additionalData.loja = lojaMeta;
          if (dataCurtaMeta) additionalData.dataProcessamento = dataCurtaMeta;
          const notifyPayload = {
            db,
            firebase,
            currentUser,
            destinatarioEmails: selecionado,
            destinatarioUids: responsavelExpedicaoUid ? [responsavelExpedicaoUid] : [],
            arquivoNome: fileName,
            totalPaginas: Number.isFinite(meta.totalPaginas) ? Number(meta.totalPaginas) : null,
            foraHorario: foraHorarioAtual,
            origem: 'Etiquetas Shopee (Corte 15/2/2)',
            pdfDocId: docRef.id,
          };
          if (lojaMeta) {
            notifyPayload.loja = lojaMeta;
          }
          if (dataCurtaMeta) {
            notifyPayload.dataProcessamento = dataCurtaMeta;
          }
          if (Object.keys(additionalData).length) {
            notifyPayload.additionalData = additionalData;
          }
          await window.ExpedicaoNotifier.notifyNovaEtiqueta(notifyPayload);
        }

        return { url, storagePath: fileRef.fullPath, docId: docRef.id };
      } catch (error) {
        console.error('Erro ao enviar PDF para o Firebase:', error);
        throw error;
      }
    }

    async function carregarDadosUsuario(user) {
      try {
        const doc = await db.collection('uid').doc(user.uid).get();
        const data = doc.data() || {};
        const emails = data.gestoresExpedicaoEmails || data.responsavelExpedicaoEmail || '';
        if (Array.isArray(emails)) {
          gestoresInput.value = emails.join(', ');
        } else if (typeof emails === 'string') {
          gestoresInput.value = emails;
        }

        const respEmail = Array.isArray(data.gestoresExpedicaoEmails)
          ? data.gestoresExpedicaoEmails[0]
          : data.responsavelExpedicaoEmail;
        if (respEmail) {
          const snap = await db.collection('uid').where('email', '==', respEmail).limit(1).get();
          if (!snap.empty) {
            responsavelExpedicaoUid = snap.docs[0].id;
            await carregarHorarios();
          }
        }
      } catch (error) {
        console.error('Erro ao carregar dados do usuário:', error);
      }
    }

    firebase.auth().onAuthStateChanged(async (user) => {
      currentUser = user;
      if (!user) {
        setStatus('Faça login para processar as etiquetas.');
      } else {
        setStatus('');
        await carregarDadosUsuario(user);
      }
      updateAuthUI();
    });

    processBtn.addEventListener('click', async () => {
      if (isProcessing) return;
      if (!currentUser) {
        alert('Faça login para processar e salvar PDFs.');
        setStatus('Usuário não autenticado.');
        return;
      }
      const file = fileInput.files?.[0];
      if (!file) {
        alert('Selecione um PDF.');
        return;
      }

      const storeNameValue = (storeNameInput.value || '').replace(/\s+/g, ' ').trim();
      if (!storeNameValue) {
        alert('Informe o nome da loja das etiquetas.');
        storeNameInput.focus();
        return;
      }
      const shortDate = formatShortDate(new Date());
      const storeFileSegment = sanitizeFileNameSegment(storeNameValue) || 'loja';

      logEl.textContent = '';
      outEl.innerHTML = 'Processando...';
      setStatus('Lendo PDF…');
      toggleProcessingState(true);
      openProcessingModal();
      const startTime = Date.now();

      try {
        const wantDebug = debugCheckbox.checked;
        const srcBytes = new Uint8Array(await file.arrayBuffer());
        const srcDoc = await PDFLib.PDFDocument.load(srcBytes, { updateMetadata: false });
        const outDoc = await PDFLib.PDFDocument.create();
        const dbgDoc = wantDebug ? await PDFLib.PDFDocument.create() : null;
        const totalPages = srcDoc.getPageCount();
        const expectedOutPages = totalPages * 2;
        const labelFont = await outDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        log(`Loja selecionada: ${storeNameValue}`);
        let contadorInicial = null;
        let proximoNumeroEtiqueta = 1;
        let contadorInicializado = false;
        if (expectedOutPages > 0) {
          const inicial = await getNextShopeeLabelNumber(expectedOutPages);
          const inicialSanitizado = Number.isFinite(inicial)
            ? Math.max(1, Math.floor(inicial))
            : 1;
          contadorInicial = inicialSanitizado;
          proximoNumeroEtiqueta = inicialSanitizado;
          contadorInicializado = true;
        }

        log(`Páginas originais: ${totalPages}`);
        updateProgress(0, totalPages, startTime, progressFill, progressText, timerText);

        const CM_TO_PT = 28.3464566929;
        const cm = (v) => v * CM_TO_PT;

        const CM_TOP = 15;
        const CM_DISCARD = 2.3;
        const CM_TAKE = 1.7;
        const COL_WIDTHS = [2.0, 1.9, 1.9, 1.9, 1.9];
        const PICK = [3, 5];
        const zoomFactor = 2.6;

        let totalOutPages = 0;

        for (let i = 0; i < totalPages; i++) {
          const page = srcDoc.getPage(i);
          const { width: W, height: H } = page.getSize();
          const halfW = W / 2;

          const topH = cm(CM_TOP);
          const discardH = cm(CM_DISCARD);
          const takeH = cm(CM_TAKE);

          const checklistTop = H - topH;
          const bandTop = checklistTop - discardH;
          const bandBottom = bandTop - takeH;

          if (bandBottom < 0) {
            log(`Pg ${i + 1}: banda do checklist ficou fora da página.`);
            updateProgress(i + 1, totalPages, startTime, progressFill, progressText, timerText);
            continue;
          }

          for (const side of [0, 1]) {
            const x0 = side === 0 ? 0 : halfW;
            const x1 = x0 + halfW;

            const topRegion = {
              left: x0,
              right: x1,
              bottom: Math.max(H - topH, 0),
              top: H,
            };

            const bandRegion = {
              left: x0,
              right: x1,
              bottom: Math.max(bandBottom, 0),
              top: Math.min(bandTop, H),
            };

            const widthsPt = COL_WIDTHS.map(cm);
            const totalColsW = widthsPt.reduce((a, b) => a + b, 0);
            const startX = x0 + (halfW - totalColsW) / 2;

            let cursor = startX;
            const colBoxes = [];
            for (let c = 0; c < COL_WIDTHS.length; c++) {
              const w = widthsPt[c];
              colBoxes.push({
                idx: c + 1,
                left: cursor,
                right: cursor + w,
                bottom: bandRegion.bottom,
                top: bandRegion.top,
                width: w,
              });
              cursor += w;
            }

            const [embTop] = await outDoc.embedPages([page], [topRegion]);

            const chosen = [];
            for (const k of PICK) {
              const box = colBoxes[k - 1];
              const [emb] = await outDoc.embedPages([page], [box]);
              chosen.push({ emb, box });
            }

            const bottomTrimCm = -0.4;
            const outW = halfW;
            const outH = (topH + takeH * zoomFactor) - cm(bottomTrimCm);
            const outPage = outDoc.addPage([outW, outH]);
            totalOutPages += 1;
            const numeroEtiquetaAtual = proximoNumeroEtiqueta;
            proximoNumeroEtiqueta += 1;

            outPage.drawPage(embTop, {
              x: 0,
              y: takeH * zoomFactor,
              width: outW,
              height: topH,
            });

            const pairW = chosen.reduce((s, { box }) => s + box.width, 0);
            const pairWZoom = pairW * zoomFactor;
            const cx = (outW - pairWZoom) / 1.5;

            let dx = 0;
            for (const { emb, box } of chosen) {
              const w = box.width;
              outPage.drawPage(emb, {
                x: cx + dx * zoomFactor,
                y: 0,
                width: w * zoomFactor,
                height: takeH * zoomFactor,
              });
              dx += w;
            }

            const infoLines = [`Etiqueta Nº: ${numeroEtiquetaAtual}`];
            if (storeNameValue) {
              infoLines.push(`Loja: ${storeNameValue}`);
            }
            const infoMargin = 12;
            const infoPaddingX = 8;
            const infoPaddingY = 6;
            let infoFontSize = 12;
            const maxBoxWidth = Math.max(infoMargin * 2, outW - infoMargin * 2);
            let widestLine = Math.max(
              ...infoLines.map((line) => labelFont.widthOfTextAtSize(line, infoFontSize))
            );
            if (widestLine + infoPaddingX * 2 > maxBoxWidth) {
              const scale = (maxBoxWidth - infoPaddingX * 2) / Math.max(widestLine, 1);
              if (scale > 0) {
                infoFontSize = Math.max(8, Math.floor(infoFontSize * scale));
                widestLine = Math.max(
                  ...infoLines.map((line) => labelFont.widthOfTextAtSize(line, infoFontSize))
                );
              }
            }
            const infoBoxWidth = Math.min(maxBoxWidth, widestLine + infoPaddingX * 2);
            const lineHeight = infoFontSize + 4;
            const infoBoxHeight = infoPaddingY * 2 + lineHeight * infoLines.length;
            const infoBoxDefaultX = outW - infoBoxWidth - infoMargin;
            const infoBoxX = infoBoxDefaultX >= infoMargin ? infoBoxDefaultX : infoMargin;
            const infoBoxY = infoMargin;
            outPage.drawRectangle({
              x: infoBoxX,
              y: infoBoxY,
              width: infoBoxWidth,
              height: infoBoxHeight,
              color: PDFLib.rgb(1, 1, 1),
              opacity: 0.9,
              borderColor: PDFLib.rgb(0, 0, 0),
              borderWidth: 0.5,
            });
            let textY = infoBoxY + infoBoxHeight - infoPaddingY - infoFontSize;
            for (const line of infoLines) {
              outPage.drawText(line, {
                x: infoBoxX + infoPaddingX,
                y: textY,
                size: infoFontSize,
                font: labelFont,
                color: PDFLib.rgb(0, 0, 0),
              });
              textY -= lineHeight;
            }

            if (dbgDoc) {
              const dbg = dbgDoc.addPage([W, H]);
              const draw = (r, c) =>
                dbg.drawRectangle({
                  x: r.left,
                  y: r.bottom,
                  width: r.right - r.left,
                  height: r.top - r.bottom,
                  borderWidth: 1,
                  borderColor: PDFLib.rgb(...c),
                });
              draw({ left: x0, bottom: 0, right: x1, top: H }, [0.25, 0.25, 0.25]);
              draw(topRegion, [0.05, 0.85, 0.85]);
              draw(bandRegion, [0.95, 0.8, 0.1]);
              for (const k of PICK) draw(colBoxes[k - 1], [0.9, 0.2, 0.2]);
            }

            log(`OK ▶ Pg ${i + 1} ${side === 0 ? 'ESQ' : 'DIR'} ▶ etiqueta + col(3,5) com zoom.`);
          }
          updateProgress(i + 1, totalPages, startTime, progressFill, progressText, timerText);
        }

        if (outDoc.getPageCount() === 0) {
          throw new Error('Nenhuma página válida foi gerada.');
        }

        setStatus('Salvando PDF…');
        const outBytes = await outDoc.save();
        const outBlob = new Blob([outBytes], { type: 'application/pdf' });
        const finalFileName = `${storeFileSegment}-${shortDate}.pdf`;
        log(`Arquivo final: ${finalFileName}`);

        const contadorFinal = contadorInicializado ? (proximoNumeroEtiqueta - 1) : null;
        const uploadInfo = await uploadPdfToFirebase(outBlob, finalFileName, {
          totalPaginas: totalOutPages,
          totalPaginasOrigem: srcDoc.getPageCount(),
          contadorInicial: contadorInicializado ? contadorInicial : null,
          contadorFinal,
          loja: storeNameValue,
          dataProcessamento: shortDate,
        });

        const outUrl = URL.createObjectURL(outBlob);
        let html = `
          <div class="labels-ok">✅ PDF final gerado e salvo no Firebase.</div>
          <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
            <a class="labels-link" href="${outUrl}" download="${finalFileName}">Baixar PDF final</a>
            <a class="labels-link" href="${uploadInfo.url}" target="_blank" rel="noopener">Abrir no Firebase</a>
          </div>
        `;

        if (dbgDoc) {
          const dbgBytes = await dbgDoc.save();
          const dbgBlob = new Blob([dbgBytes], { type: 'application/pdf' });
          const dbgUrl = URL.createObjectURL(dbgBlob);
          html += `<div class="labels-hint" style="margin-top:10px">DEBUG: <a class="labels-link" href="${dbgUrl}" download="debug_recortes.pdf">Baixar PDF com áreas de recorte</a></div>`;
        }

        outEl.innerHTML = html;
        const storeInfo = document.createElement('div');
        storeInfo.className = 'labels-hint';
        storeInfo.style.marginTop = '6px';
        storeInfo.textContent = `Loja: ${storeNameValue} • Data: ${shortDate}`;
        outEl.appendChild(storeInfo);
        if (contadorInicializado) {
          log(`Numeração aplicada: ${contadorInicial} até ${contadorFinal}`);
        }
        setStatus('Concluído.');
        const finalTime = Math.round((Date.now() - startTime) / 1000);
        completeProcessingModal(finalTime);
      } catch (error) {
        console.error(error);
        setStatus('Erro.');
        outEl.innerHTML = '';
        log(`ERRO: ${error?.message || error}`);
        alert('Erro ao processar o PDF.');
        failProcessingModal('Não foi possível concluir o processamento. Tente novamente.');
      } finally {
        toggleProcessingState(false);
      }
    });
  </script>
  <script src="shared.js"></script>
</body>
</html>
