<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Etiqueta Shopee - Corte 15/2/2</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css?v=20240826" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="expedicao-notifier.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    body {
      background: linear-gradient(180deg, #f8fafc 0%, #eef2ff 30%, #ffffff 100%);
      font-family: 'Inter', sans-serif;
    }
    .shopee-labels {
      --labels-bg: linear-gradient(160deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 58, 138, 0.9) 100%);
      --labels-card: rgba(17, 24, 39, 0.75);
      --labels-muted: #94a3b8;
      --labels-pad: 18px;
      --labels-radius: 18px;
      background: var(--labels-bg);
      color: #e5e7eb;
      border-radius: 24px;
      border: 1px solid #1f2937;
      box-shadow: 0 30px 50px rgba(15, 23, 42, 0.45);
      overflow: hidden;
      position: relative;
    }
    .shopee-labels::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at -10% -10%, rgba(56, 189, 248, 0.35), transparent 55%),
        radial-gradient(circle at 120% 0%, rgba(99, 102, 241, 0.25), transparent 50%);
      pointer-events: none;
      opacity: 0.8;
    }
    .shopee-labels > * {
      position: relative;
      z-index: 1;
    }
    .shopee-labels .labels-header {
      padding: 32px 28px 8px;
      text-align: left;
    }
    .shopee-labels .labels-title {
      margin: 0 0 10px;
      font-size: clamp(24px, 2.4vw, 32px);
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .shopee-labels .labels-sub {
      margin: 0;
      color: #cbd5f5;
      font-size: 0.95rem;
      line-height: 1.5;
      max-width: 62ch;
    }
    .shopee-labels .labels-wrap {
      display: grid;
      gap: 24px;
      padding: 0 28px 32px;
    }
    .shopee-labels .labels-card {
      background: var(--labels-card);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: var(--labels-radius);
      padding: var(--labels-pad);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(6px);
    }
    .shopee-labels .labels-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
    }
    .shopee-labels .labels-upload {
      display: inline-flex;
      gap: 12px;
      align-items: center;
      padding: 14px 18px;
      border-radius: 14px;
      background: rgba(30, 41, 59, 0.7);
      border: 1px dashed rgba(148, 163, 184, 0.45);
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease;
      min-width: 230px;
    }
    .shopee-labels .labels-upload:hover {
      border-color: #67e8f9;
      transform: translateY(-2px);
    }
    .shopee-labels input[type="file"] {
      display: none;
    }
    .shopee-labels .labels-action {
      all: unset;
      display: inline-flex;
      gap: 10px;
      align-items: center;
      background: linear-gradient(135deg, #06b6d4 0%, #2563eb 100%);
      color: #f8fafc;
      font-weight: 700;
      padding: 12px 20px;
      border-radius: 14px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .shopee-labels .labels-action:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      transform: none !important;
      box-shadow: none !important;
    }
    .shopee-labels .labels-action:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(37, 99, 235, 0.28);
    }
    .shopee-labels .labels-action:not(:disabled):active {
      transform: translateY(1px);
    }
    .shopee-labels .labels-mono {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 12.5px;
      color: #cbd5e1;
    }
    .shopee-labels .labels-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: rgba(148, 163, 184, 0.12);
      color: #f1f5f9;
      min-height: 28px;
    }
    .shopee-labels .labels-status:empty {
      display: none;
    }
    .shopee-labels .labels-hint {
      color: var(--labels-muted);
      font-size: 13px;
      line-height: 1.4;
    }
    .shopee-labels .labels-ok {
      color: #22c55e;
      font-weight: 700;
    }
    .shopee-labels .labels-link {
      color: #67e8f9;
      text-decoration: underline;
      font-weight: 600;
    }
    .shopee-labels .labels-chk {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      border: 1px solid #374151;
      border-radius: 10px;
      background: #1f2937;
    }
    .shopee-labels .labels-log {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(148, 163, 184, 0.12);
      max-height: 240px;
      overflow-y: auto;
    }
    .shopee-labels .labels-split {
      display: grid;
      gap: 20px;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      align-items: stretch;
    }
    .shopee-labels .labels-side {
      display: grid;
      gap: 18px;
    }
    .shopee-labels .labels-step-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-top: 24px;
    }
    .shopee-labels .labels-step {
      display: flex;
      gap: 14px;
      padding: 16px 18px;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 16px;
      backdrop-filter: blur(4px);
    }
    .shopee-labels .labels-step-number {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.9), rgba(37, 99, 235, 0.9));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #0f172a;
      font-size: 1rem;
    }
    .shopee-labels .labels-step-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 4px;
    }
    .shopee-labels .labels-step-desc {
      font-size: 0.85rem;
      color: rgba(203, 213, 225, 0.85);
      line-height: 1.45;
    }
    .info-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.05);
    }
    .info-card-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #1e293b;
    }
    .info-card-title i {
      color: #2563eb;
    }
    .info-card p {
      margin-top: 6px;
      font-size: 0.9rem;
      color: #475569;
      line-height: 1.5;
    }
    .progress-bar-bg {
      background: linear-gradient(90deg, #cfd9df 0%, #e2ebf0 100%);
      border-radius: 9999px;
      height: 1.5rem;
      overflow: hidden;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
    }
    .progress-bar-fill {
      background: linear-gradient(90deg, #06B6D4 0%, #3B82F6 100%);
      height: 100%;
      border-radius: 9999px 0 0 9999px;
      transition: width 0.3s cubic-bezier(.4,0,.2,1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 0.875rem;
      background-size: 200% 100%;
      animation: progress-animation 2s linear infinite;
    }
    .progress-bar-fill.completed {
      background: linear-gradient(90deg, #16A34A 0%, #22C55E 100%);
      animation: none;
    }
    .progress-bar-fill.failed {
      background: linear-gradient(90deg, #DC2626 0%, #EF4444 100%);
      animation: none;
    }
    @keyframes progress-animation {
      0% { background-position: 0% 0; }
      100% { background-position: -200% 0; }
    }
    #timerText {
      font-size: 0.875rem;
      color: #374151;
      font-weight: 500;
    }
    #status {
      min-height: 0;
    }
    @media (max-width: 768px) {
      .shopee-labels .labels-header {
        padding: 24px 18px 8px;
      }
      .shopee-labels .labels-wrap {
        padding: 0 18px 24px;
      }
      .shopee-labels .labels-split {
        grid-template-columns: 1fr;
      }
      .shopee-labels .labels-row {
        align-items: stretch;
      }
      .shopee-labels .labels-status {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body class="text-gray-800 min-h-screen">
  <div class="app-container">
    <div id="sidebar-container"></div>
    <div id="navbar-container"></div>
    <div class="main-content">
      <div class="px-4 py-6">
        <div class="max-w-5xl mx-auto space-y-6">
          <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6 md:p-8 space-y-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
              <div class="flex items-start gap-4">
                <div class="h-14 w-14 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center text-2xl shadow-inner">
                  <i class="fa-solid fa-scissors"></i>
                </div>
                <div class="space-y-2">
                  <div class="inline-flex items-center gap-2 rounded-full bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700 uppercase tracking-wide">
                    <i class="fa-solid fa-bolt"></i>
                    Fluxo automatizado
                  </div>
                  <h1 class="text-3xl font-semibold text-gray-900 leading-tight">Etiqueta Shopee - Corte 15/2/2</h1>
                  <p class="text-sm text-gray-500 max-w-2xl">Processa PDFs A4, recorta etiqueta superior e as colunas 3 e 5 do checklist com zoom otimizado. O arquivo final é salvo automaticamente no Firebase para facilitar o compartilhamento com sua equipe.</p>
                </div>
              </div>
              <div class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm text-slate-600 max-w-xs">
                <p class="font-medium text-slate-800 flex items-center gap-2">
                  <i class="fa-solid fa-circle-info text-blue-500"></i>
                  Pré-requisitos
                </p>
                <p class="mt-2 leading-relaxed">Utilize PDFs A4 exportados diretamente da Shopee para garantir cortes precisos e leitura do checklist.</p>
              </div>
            </div>
            <div>
              <label for="gestoresEmails" class="block text-sm font-semibold text-gray-700">E-mails do gestor de expedição</label>
              <div class="mt-2 flex flex-col gap-2 md:flex-row md:items-center">
                <input id="gestoresEmails" type="text" placeholder="ex.: helter@empresa.com, carassowaber@gmail.com" class="w-full md:flex-1 rounded-xl border border-gray-300 px-4 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                <span class="text-xs text-gray-500 md:ml-2">Separe múltiplos endereços com vírgula</span>
              </div>
              <p class="text-xs text-gray-500 mt-2">Os PDFs serão compartilhados com os e-mails listados. Se houver mais de um endereço, você escolherá o destinatário durante o envio.</p>
            </div>
            <div class="grid gap-4 md:grid-cols-3">
              <div class="info-card">
                <span class="info-card-title"><i class="fa-solid fa-layer-group"></i> Layout final</span>
                <p>Etiqueta superior e checklist reposicionados automaticamente em uma folha A4 única para impressão direta.</p>
              </div>
              <div class="info-card">
                <span class="info-card-title"><i class="fa-solid fa-cloud-arrow-up"></i> Upload seguro</span>
                <p>Arquivos enviados são armazenados na nuvem com autenticação do usuário logado.</p>
              </div>
              <div class="info-card">
                <span class="info-card-title"><i class="fa-solid fa-share-nodes"></i> Compartilhamento ágil</span>
                <p>Defina e-mails padrão e reduza tempo de distribuição das etiquetas para a equipe de expedição.</p>
              </div>
            </div>
          </div>

          <div class="shopee-labels">
            <div class="labels-header">
              <h2 class="labels-title">✂️ Etiqueta em cima + colunas 3 e 5 do checklist (com zoom)</h2>
              <p class="labels-sub">Dividimos a folha A4 ao meio, recortamos os 15 cm superiores (etiqueta) e extraímos as colunas 3 e 5 do checklist com zoom de 120% para uma leitura nítida. Tudo é reposicionado automaticamente na mesma página.</p>
            </div>
            <div class="labels-wrap">
              <div class="labels-step-grid">
                <div class="labels-step">
                  <span class="labels-step-number">1</span>
                  <div>
                    <div class="labels-step-title">Faça o upload do PDF A4</div>
                    <p class="labels-step-desc">Garanta que o arquivo contém a etiqueta superior e checklist completos exportados da Shopee.</p>
                  </div>
                </div>
                <div class="labels-step">
                  <span class="labels-step-number">2</span>
                  <div>
                    <div class="labels-step-title">Revise as opções</div>
                    <p class="labels-step-desc">Ative o PDF de debug se precisar validar cortes ou ajustar os parâmetros de zoom no código.</p>
                  </div>
                </div>
                <div class="labels-step">
                  <span class="labels-step-number">3</span>
                  <div>
                    <div class="labels-step-title">Compartilhe com a equipe</div>
                    <p class="labels-step-desc">Envie o arquivo processado para o gestor responsável diretamente da plataforma.</p>
                  </div>
                </div>
              </div>

              <div class="labels-split">
                <div class="labels-card space-y-4">
                  <div class="labels-row">
                    <label class="labels-upload">
                      <i class="fa-solid fa-file-arrow-up text-sky-300 text-lg"></i>
                      <div>
                        <div class="font-semibold text-sm text-slate-100">Escolher PDF A4</div>
                        <div class="labels-hint">Clique para selecionar ou arraste o arquivo para esta área</div>
                      </div>
                      <input id="file" type="file" accept="application/pdf" />
                    </label>
                    <button id="go" type="button" class="labels-action">
                      <i class="fa-solid fa-wand-magic-sparkles text-base"></i>
                      <span>Processar</span>
                    </button>
                    <label class="labels-chk">
                      <input id="debug" type="checkbox" />
                      <span class="labels-mono">Gerar PDF DEBUG</span>
                    </label>
                  </div>
                  <div class="flex flex-wrap gap-3 items-center">
                    <span id="status" class="labels-status labels-mono"></span>
                    <span class="labels-hint">Colunas (cm): <b>[2.2, 1.9, 1.9, 1.9, 1.9]</b> · Zoom padrão: <b>120%</b> (<code>zoomFactor</code>).</span>
                  </div>
                </div>
                <div class="labels-side">
                  <div class="labels-card">
                    <div class="flex items-center justify-between mb-2">
                      <strong>Saída</strong>
                      <i class="fa-solid fa-download text-sky-300"></i>
                    </div>
                    <div id="out" class="labels-hint" style="margin-top:4px">Links para download aparecerão aqui.</div>
                  </div>
                  <div class="labels-card">
                    <div class="flex items-center justify-between mb-2">
                      <strong>Log</strong>
                      <i class="fa-solid fa-terminal text-slate-300"></i>
                    </div>
                    <div class="labels-log">
                      <pre id="log" class="labels-mono" style="white-space:pre-wrap;margin:0"></pre>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="processingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40 px-4">
    <div id="processingModalCard" class="w-full max-w-lg rounded-xl shadow-xl p-6 bg-white border-t-4 border-blue-500 space-y-5 transition-colors duration-300">
      <div class="flex items-start gap-3">
        <i id="processingIcon" class="fa-solid fa-gear fa-spin text-blue-500 text-2xl mt-1"></i>
        <div>
          <h2 id="processingTitle" class="text-xl font-semibold text-gray-800">Processando etiquetas...</h2>
          <p id="processingSubtitle" class="text-sm text-gray-600">Por favor, não feche a página até concluirmos o processamento.</p>
        </div>
      </div>
      <div>
        <div class="progress-bar-bg" id="progressBar" style="display:none;">
          <div class="progress-bar-fill" id="progressFill" style="width:0%;">
            <span id="progressText" class="w-full text-center"></span>
          </div>
        </div>
        <div id="timerText" class="text-center text-sm text-gray-700 mt-3"></div>
      </div>
      <div class="text-xs text-yellow-700 bg-yellow-100 border border-yellow-200 rounded-md px-3 py-2 flex items-start gap-2">
        <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
        <span>Não feche a página enquanto as etiquetas são processadas e enviadas.</span>
      </div>
      <button id="processingClose" type="button" class="w-full hidden py-2.5 rounded-lg font-medium text-white bg-green-600 hover:bg-green-700 transition" aria-hidden="true">Fechar</button>
    </div>
  </div>

  <div id="gestorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white w-full max-w-md p-4 rounded-xl shadow-lg space-y-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-800">Enviar arquivo para qual gestor?</h2>
        <p class="text-sm text-gray-500">Escolha o e-mail que receberá a etiqueta processada.</p>
      </div>
      <select id="gestorSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
      <div class="flex justify-end gap-2">
        <button id="gestorCancel" type="button" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
        <button id="gestorConfirm" type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.firestore();
    const storage = firebase.storage();

    const fileInput = document.getElementById('file');
    const processBtn = document.getElementById('go');
    const debugCheckbox = document.getElementById('debug');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const outEl = document.getElementById('out');
    const gestoresInput = document.getElementById('gestoresEmails');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const timerText = document.getElementById('timerText');
    const processingModal = document.getElementById('processingModal');
    const processingModalCard = document.getElementById('processingModalCard');
    const processingTitle = document.getElementById('processingTitle');
    const processingSubtitle = document.getElementById('processingSubtitle');
    const processingIcon = document.getElementById('processingIcon');
    const processingClose = document.getElementById('processingClose');

    const log = (text) => {
      logEl.textContent += text + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    };

    const setStatus = (text) => {
      statusEl.textContent = text || '';
    };

    let currentUser = null;
    let responsavelExpedicaoUid = null;
    let horariosEtiquetas = [];
    let isProcessing = false;

    const gestorModal = document.getElementById('gestorModal');
    const gestorSelect = document.getElementById('gestorSelect');
    const gestorConfirm = document.getElementById('gestorConfirm');
    const gestorCancel = document.getElementById('gestorCancel');

    processingModalCard.dataset.status = 'idle';

    function setProcessingModalTheme(state) {
      processingModalCard.classList.remove('bg-white', 'border-blue-500', 'bg-green-50', 'border-green-500', 'bg-red-50', 'border-red-500');
      processingTitle.classList.remove('text-gray-800', 'text-green-700', 'text-red-700');
      processingSubtitle.classList.remove('text-gray-600', 'text-green-700', 'text-red-700');
      timerText.classList.remove('text-gray-700', 'text-green-700', 'text-red-700');

      if (state === 'success') {
        processingModalCard.classList.add('bg-green-50', 'border-green-500');
        processingTitle.classList.add('text-green-700');
        processingSubtitle.classList.add('text-green-700');
        timerText.classList.add('text-green-700');
      } else if (state === 'error') {
        processingModalCard.classList.add('bg-red-50', 'border-red-500');
        processingTitle.classList.add('text-red-700');
        processingSubtitle.classList.add('text-red-700');
        timerText.classList.add('text-red-700');
      } else {
        processingModalCard.classList.add('bg-white', 'border-blue-500');
        processingTitle.classList.add('text-gray-800');
        processingSubtitle.classList.add('text-gray-600');
        timerText.classList.add('text-gray-700');
      }
    }

    function openProcessingModal() {
      setProcessingModalTheme('processing');
      processingModal.classList.remove('hidden');
      processingModal.classList.add('flex');
      document.body.classList.add('overflow-hidden');
      processingModalCard.dataset.status = 'processing';
      processingIcon.className = 'fa-solid fa-gear fa-spin text-blue-500 text-2xl mt-1';
      processingTitle.textContent = 'Processando etiquetas...';
      processingSubtitle.textContent = 'Por favor, não feche a página até concluirmos o processamento.';
      progressBar.style.display = 'block';
      progressFill.style.width = '0%';
      progressFill.classList.remove('completed', 'failed');
      progressText.textContent = '';
      timerText.textContent = '';
      processingClose.classList.add('hidden');
      processingClose.setAttribute('aria-hidden', 'true');
      processingClose.disabled = true;
    }

    function completeProcessingModal(totalSeconds) {
      setProcessingModalTheme('success');
      processingModalCard.dataset.status = 'completed';
      processingIcon.className = 'fa-solid fa-circle-check text-green-500 text-2xl mt-1';
      processingTitle.textContent = 'Tudo pronto!';
      processingSubtitle.textContent = 'Arquivo final salvo com sucesso. Agora você já pode fechar esta janela.';
      progressFill.classList.add('completed');
      progressFill.classList.remove('failed');
      progressFill.style.width = '100%';
      progressText.textContent = 'Processamento finalizado (100%)';
      if (Number.isFinite(totalSeconds)) {
        timerText.textContent = `Tempo total: ${formatTime(Math.max(0, Math.floor(totalSeconds)))}`;
      }
      processingClose.classList.remove('hidden');
      processingClose.removeAttribute('aria-hidden');
      processingClose.disabled = false;
    }

    function failProcessingModal(message) {
      setProcessingModalTheme('error');
      processingModalCard.dataset.status = 'failed';
      processingIcon.className = 'fa-solid fa-circle-exclamation text-red-500 text-2xl mt-1';
      processingTitle.textContent = 'Algo deu errado';
      processingSubtitle.textContent = message || 'Não foi possível concluir o processamento. Tente novamente.';
      progressFill.classList.add('failed');
      progressFill.classList.remove('completed');
      processingClose.classList.remove('hidden');
      processingClose.removeAttribute('aria-hidden');
      processingClose.disabled = false;
    }

    function hideProcessingModal() {
      processingModal.classList.add('hidden');
      processingModal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
      progressBar.style.display = 'none';
      processingModalCard.dataset.status = 'idle';
    }

    if (processingClose) {
      processingClose.addEventListener('click', () => {
        if (processingModalCard.dataset.status !== 'processing') {
          hideProcessingModal();
        }
      });
    }

    function toggleProcessingState(active) {
      isProcessing = active;
      processBtn.disabled = active || !currentUser;
    }

    function updateAuthUI() {
      processBtn.disabled = isProcessing || !currentUser;
      processBtn.classList.toggle('opacity-60', processBtn.disabled);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function updateProgress(current, total, startTime, progressFillEl, progressTextEl, timerTextEl) {
      const progress = total > 0 ? Math.round((current / total) * 100) : 0;
      progressFillEl.style.width = `${Math.min(100, Math.max(0, progress))}%`;
      if (current > 0) {
        progressTextEl.textContent = `Processando página ${current} de ${total} (${progress}%)`;
        const elapsed = (Date.now() - startTime) / 1000;
        const avg = elapsed / current;
        const remaining = Math.max(0, Math.round(avg * (total - current)));
        timerTextEl.textContent = `Tempo restante: ${formatTime(remaining)}`;
      } else {
        progressTextEl.textContent = total > 0 ? `Preparando (${total} páginas)...` : 'Preparando...';
        timerTextEl.textContent = '';
      }
    }

    function escolherGestorEmail(emails) {
      return new Promise((resolve) => {
        if (!emails || !emails.length) {
          resolve([]);
          return;
        }
        if (emails.length === 1) {
          resolve([emails[0]]);
          return;
        }

        gestorSelect.innerHTML = '';
        emails.forEach((email) => {
          const opt = document.createElement('option');
          opt.value = email;
          opt.textContent = email;
          gestorSelect.appendChild(opt);
        });

        function closeModal(value) {
          gestorModal.classList.add('hidden');
          gestorConfirm.removeEventListener('click', onConfirm);
          gestorCancel.removeEventListener('click', onCancel);
          gestorModal.removeEventListener('click', onBackdrop);
          resolve(value ? [value] : [emails[0]]);
        }

        function onConfirm() {
          closeModal(gestorSelect.value || emails[0]);
        }

        function onCancel() {
          closeModal(emails[0]);
        }

        function onBackdrop(event) {
          if (event.target === gestorModal) {
            closeModal(emails[0]);
          }
        }

        gestorConfirm.addEventListener('click', onConfirm);
        gestorCancel.addEventListener('click', onCancel);
        gestorModal.addEventListener('click', onBackdrop);
        gestorModal.classList.remove('hidden');
      });
    }

    async function carregarHorarios() {
      if (!responsavelExpedicaoUid) return;
      try {
        const doc = await db.collection('uid').doc(responsavelExpedicaoUid).get();
        const data = doc.data() || {};
        horariosEtiquetas = Array.isArray(data.horariosEtiquetas) ? data.horariosEtiquetas : [];
      } catch (error) {
        console.error('Erro ao carregar horários de etiquetas:', error);
      }
    }

    function foraDoHorario() {
      if (!horariosEtiquetas.length) return false;
      const now = new Date();
      return !horariosEtiquetas.some((intervalo) => {
        if (!intervalo?.inicio || !intervalo?.fim) return false;
        const [ih, im] = intervalo.inicio.split(':').map(Number);
        const [fh, fm] = intervalo.fim.split(':').map(Number);
        const start = new Date(now);
        start.setHours(ih || 0, im || 0, 0, 0);
        const end = new Date(now);
        end.setHours(fh || 0, fm || 0, 0, 0);
        return now >= start && now <= end;
      });
    }

    async function uploadPdfToFirebase(blob, fileName, meta = {}) {
      if (!currentUser) {
        throw new Error('Usuário não autenticado.');
      }
      try {
        const gestoresRaw = (gestoresInput.value || '').split(',');
        const gestoresEmails = gestoresRaw.map((email) => email.trim()).filter(Boolean);
        const selecionado = await escolherGestorEmail(gestoresEmails);
        const foraHorarioAtual = foraDoHorario();
        const docPayload = {
          ownerUid: currentUser.uid,
          ownerEmail: currentUser.email,
          gestoresExpedicaoEmails: selecionado,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          name: fileName,
          foraHorario: foraHorarioAtual,
        };
        if (Number.isFinite(meta.totalPaginas)) {
          docPayload.totalPaginas = Number(meta.totalPaginas);
        }
        if (Number.isFinite(meta.totalPaginasOrigem)) {
          docPayload.totalPaginasOrigem = Number(meta.totalPaginasOrigem);
        }

        const docRef = await db.collection('pdfDocs').add(docPayload);
        const fileRef = storage.ref().child(`pdfs/${currentUser.uid}/${docRef.id}.pdf`);
        await fileRef.put(blob);
        const url = await fileRef.getDownloadURL();
        await docRef.update({ url, storagePath: fileRef.fullPath });

        const resumo = {
          name: fileName,
          url,
          path: fileRef.fullPath,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        };
        if (Number.isFinite(meta.totalPaginas)) {
          resumo.totalPaginas = Number(meta.totalPaginas);
        }
        if (Number.isFinite(meta.totalPaginasOrigem)) {
          resumo.totalPaginasOrigem = Number(meta.totalPaginasOrigem);
        }
        await db.collection('users').doc(currentUser.uid).collection('etiquetaenvio').add(resumo);

        if (
          window.ExpedicaoNotifier &&
          typeof window.ExpedicaoNotifier.notifyNovaEtiqueta === 'function'
        ) {
          await window.ExpedicaoNotifier.notifyNovaEtiqueta({
            db,
            firebase,
            currentUser,
            destinatarioEmails: selecionado,
            destinatarioUids: responsavelExpedicaoUid ? [responsavelExpedicaoUid] : [],
            arquivoNome: fileName,
            totalPaginas: Number.isFinite(meta.totalPaginas) ? Number(meta.totalPaginas) : null,
            foraHorario: foraHorarioAtual,
            origem: 'Etiquetas Shopee (Corte 15/2/2)',
            pdfDocId: docRef.id,
          });
        }

        return { url, storagePath: fileRef.fullPath, docId: docRef.id };
      } catch (error) {
        console.error('Erro ao enviar PDF para o Firebase:', error);
        throw error;
      }
    }

    async function carregarDadosUsuario(user) {
      try {
        const doc = await db.collection('uid').doc(user.uid).get();
        const data = doc.data() || {};
        const emails = data.gestoresExpedicaoEmails || data.responsavelExpedicaoEmail || '';
        if (Array.isArray(emails)) {
          gestoresInput.value = emails.join(', ');
        } else if (typeof emails === 'string') {
          gestoresInput.value = emails;
        }

        const respEmail = Array.isArray(data.gestoresExpedicaoEmails)
          ? data.gestoresExpedicaoEmails[0]
          : data.responsavelExpedicaoEmail;
        if (respEmail) {
          const snap = await db.collection('uid').where('email', '==', respEmail).limit(1).get();
          if (!snap.empty) {
            responsavelExpedicaoUid = snap.docs[0].id;
            await carregarHorarios();
          }
        }
      } catch (error) {
        console.error('Erro ao carregar dados do usuário:', error);
      }
    }

    firebase.auth().onAuthStateChanged(async (user) => {
      currentUser = user;
      if (!user) {
        setStatus('Faça login para processar as etiquetas.');
      } else {
        setStatus('');
        await carregarDadosUsuario(user);
      }
      updateAuthUI();
    });

    processBtn.addEventListener('click', async () => {
      if (isProcessing) return;
      if (!currentUser) {
        alert('Faça login para processar e salvar PDFs.');
        setStatus('Usuário não autenticado.');
        return;
      }
      const file = fileInput.files?.[0];
      if (!file) {
        alert('Selecione um PDF.');
        return;
      }

      logEl.textContent = '';
      outEl.innerHTML = 'Processando...';
      setStatus('Lendo PDF…');
      toggleProcessingState(true);
      openProcessingModal();
      const startTime = Date.now();

      try {
        const wantDebug = debugCheckbox.checked;
        const srcBytes = new Uint8Array(await file.arrayBuffer());
        const srcDoc = await PDFLib.PDFDocument.load(srcBytes, { updateMetadata: false });
        const outDoc = await PDFLib.PDFDocument.create();
        const dbgDoc = wantDebug ? await PDFLib.PDFDocument.create() : null;
        const totalPages = srcDoc.getPageCount();

        log(`Páginas originais: ${totalPages}`);
        updateProgress(0, totalPages, startTime, progressFill, progressText, timerText);

        const CM_TO_PT = 28.3464566929;
        const cm = (v) => v * CM_TO_PT;

        const CM_TOP = 15;
        const CM_DISCARD = 2.3;
        const CM_TAKE = 1.7;
        const COL_WIDTHS = [2.0, 1.9, 1.9, 1.9, 1.9];
        const PICK = [3, 5];
        const zoomFactor = 2.6;

        let totalOutPages = 0;

        for (let i = 0; i < totalPages; i++) {
          const page = srcDoc.getPage(i);
          const { width: W, height: H } = page.getSize();
          const halfW = W / 2;

          const topH = cm(CM_TOP);
          const discardH = cm(CM_DISCARD);
          const takeH = cm(CM_TAKE);

          const checklistTop = H - topH;
          const bandTop = checklistTop - discardH;
          const bandBottom = bandTop - takeH;

          if (bandBottom < 0) {
            log(`Pg ${i + 1}: banda do checklist ficou fora da página.`);
            updateProgress(i + 1, totalPages, startTime, progressFill, progressText, timerText);
            continue;
          }

          for (const side of [0, 1]) {
            const x0 = side === 0 ? 0 : halfW;
            const x1 = x0 + halfW;

            const topRegion = {
              left: x0,
              right: x1,
              bottom: Math.max(H - topH, 0),
              top: H,
            };

            const bandRegion = {
              left: x0,
              right: x1,
              bottom: Math.max(bandBottom, 0),
              top: Math.min(bandTop, H),
            };

            const widthsPt = COL_WIDTHS.map(cm);
            const totalColsW = widthsPt.reduce((a, b) => a + b, 0);
            const startX = x0 + (halfW - totalColsW) / 2;

            let cursor = startX;
            const colBoxes = [];
            for (let c = 0; c < COL_WIDTHS.length; c++) {
              const w = widthsPt[c];
              colBoxes.push({
                idx: c + 1,
                left: cursor,
                right: cursor + w,
                bottom: bandRegion.bottom,
                top: bandRegion.top,
                width: w,
              });
              cursor += w;
            }

            const [embTop] = await outDoc.embedPages([page], [topRegion]);

            const chosen = [];
            for (const k of PICK) {
              const box = colBoxes[k - 1];
              const [emb] = await outDoc.embedPages([page], [box]);
              chosen.push({ emb, box });
            }

            const bottomTrimCm = -0.4;
            const outW = halfW;
            const outH = (topH + takeH * zoomFactor) - cm(bottomTrimCm);
            const outPage = outDoc.addPage([outW, outH]);
            totalOutPages += 1;

            outPage.drawPage(embTop, {
              x: 0,
              y: takeH * zoomFactor,
              width: outW,
              height: topH,
            });

            const pairW = chosen.reduce((s, { box }) => s + box.width, 0);
            const pairWZoom = pairW * zoomFactor;
            const cx = (outW - pairWZoom) / 1.5;

            let dx = 0;
            for (const { emb, box } of chosen) {
              const w = box.width;
              outPage.drawPage(emb, {
                x: cx + dx * zoomFactor,
                y: 0,
                width: w * zoomFactor,
                height: takeH * zoomFactor,
              });
              dx += w;
            }

            if (dbgDoc) {
              const dbg = dbgDoc.addPage([W, H]);
              const draw = (r, c) =>
                dbg.drawRectangle({
                  x: r.left,
                  y: r.bottom,
                  width: r.right - r.left,
                  height: r.top - r.bottom,
                  borderWidth: 1,
                  borderColor: PDFLib.rgb(...c),
                });
              draw({ left: x0, bottom: 0, right: x1, top: H }, [0.25, 0.25, 0.25]);
              draw(topRegion, [0.05, 0.85, 0.85]);
              draw(bandRegion, [0.95, 0.8, 0.1]);
              for (const k of PICK) draw(colBoxes[k - 1], [0.9, 0.2, 0.2]);
            }

            log(`OK ▶ Pg ${i + 1} ${side === 0 ? 'ESQ' : 'DIR'} ▶ etiqueta + col(3,5) com zoom.`);
          }
          updateProgress(i + 1, totalPages, startTime, progressFill, progressText, timerText);
        }

        if (outDoc.getPageCount() === 0) {
          throw new Error('Nenhuma página válida foi gerada.');
        }

        setStatus('Salvando PDF…');
        const outBytes = await outDoc.save();
        const outBlob = new Blob([outBytes], { type: 'application/pdf' });
        const baseName = file.name.replace(/\.pdf$/i, '') || 'etiquetas';
        const finalFileName = `${baseName}-cols3-5-zoom.pdf`;

        const uploadInfo = await uploadPdfToFirebase(outBlob, finalFileName, {
          totalPaginas: totalOutPages,
          totalPaginasOrigem: srcDoc.getPageCount(),
        });

        const outUrl = URL.createObjectURL(outBlob);
        let html = `
          <div class="labels-ok">✅ PDF final gerado e salvo no Firebase.</div>
          <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
            <a class="labels-link" href="${outUrl}" download="${finalFileName}">Baixar PDF final</a>
            <a class="labels-link" href="${uploadInfo.url}" target="_blank" rel="noopener">Abrir no Firebase</a>
          </div>
        `;

        if (dbgDoc) {
          const dbgBytes = await dbgDoc.save();
          const dbgBlob = new Blob([dbgBytes], { type: 'application/pdf' });
          const dbgUrl = URL.createObjectURL(dbgBlob);
          html += `<div class="labels-hint" style="margin-top:10px">DEBUG: <a class="labels-link" href="${dbgUrl}" download="debug_recortes.pdf">Baixar PDF com áreas de recorte</a></div>`;
        }

        outEl.innerHTML = html;
        setStatus('Concluído.');
        const finalTime = Math.round((Date.now() - startTime) / 1000);
        completeProcessingModal(finalTime);
      } catch (error) {
        console.error(error);
        setStatus('Erro.');
        outEl.innerHTML = '';
        log(`ERRO: ${error?.message || error}`);
        alert('Erro ao processar o PDF.');
        failProcessingModal('Não foi possível concluir o processamento. Tente novamente.');
      } finally {
        toggleProcessingState(false);
      }
    });
  </script>
  <script src="shared.js"></script>
</body>
</html>
