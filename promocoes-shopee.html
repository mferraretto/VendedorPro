<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promo√ß√µes Shopee</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script type="module" src="firebase-config.js"></script>
</head>
<body class="bg-gray-100">
  <div class="app-container">
    <div id="sidebar-container"></div>
    <div id="navbar-container"></div>
    <div class="main-content p-6">
      <h1 class="text-2xl font-bold mb-6"><i class="fas fa-tags mr-2"></i> Promo√ß√µes Shopee</h1>
      <div class="card mb-6">
        <div class="flex flex-wrap gap-4 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium mb-2">Importar Planilha de Promo√ß√µes Shopee:</label>
            <input type="file" id="promoFileInput" accept=".xlsx,.xls" class="border p-2 rounded-lg w-full">
          </div>
         <button onclick="importPromocoesFile()" class="btn-primary">
  <i class="fas fa-upload mr-2"></i> Importar
</button>

        </div>
      </div>


      <div id="promoImportedProducts" style="display:none;" class="mt-6">
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>ID Produto</th>
                <th>Parent SKU</th>
                <th>SKU</th>
                <th>Pre√ßo Original</th>
                <th>Pre√ßo Desconto</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="promoProductsTableBody"></tbody>
          </table>
        </div>
        <p id="promoChangesCount" class="mt-2 font-bold"></p>
      </div>
      <!-- Bot√µes de a√ß√£o -->
<div class="flex flex-wrap gap-3 mt-4" id="acaoPromocoes" style="display:none;">
  <button onclick="applyPromoPriceUpdate('promo')" class="btn-danger">
    <i class="fas fa-tag mr-2"></i> Aplicar Sem Lucro (0%)
  </button>
  <button onclick="applyPromoPriceUpdate('medium')" class="btn-secondary">
    <i class="fas fa-chart-line mr-2"></i> Aplicar Lucro 5%
  </button>
  <button onclick="applyPromoPriceUpdate('ideal')" class="btn-success">
    <i class="fas fa-star mr-2"></i> Aplicar Lucro 10%
  </button>

  <button onclick="exportPromoFile()" class="btn btn-success">
    <i class="fas fa-file-excel mr-2"></i> Exportar Excel
  </button>
  <button onclick="window.print()" class="btn btn-danger">
    <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
  </button>
</div>
    </div>
  </div>
 <script>
  let db;
  document.addEventListener('DOMContentLoaded', () => {
    firebase.initializeApp(window.firebaseConfig);
    db = firebase.firestore();
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html?login=1';
      } else {
        carregarProdutosSistema();
      }
    });
  });

  const sistema = {
    produtos: [],
    promoShopeeData: [],
    originalPromoShopeeData: []
  };

  // 1) Carrega SKUs do Firestore
  async function carregarProdutosSistema() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    const snap = await db
      .collection('uid').doc(user.uid)
      .collection('produtos').get();
    sistema.produtos = snap.docs
      .map(d => d.data())
      .filter(d => d.sku);
    console.log(`‚úÖ ${sistema.produtos.length} produtos carregados.`);
  }

  // 2) Importa e armazena dados da planilha
  async function importPromocoesFile() {
    const input = document.getElementById('promoFileInput');
    if (!input.files.length) {
      alert('Selecione um arquivo primeiro');
      return;
    }

    const data = new Uint8Array(await input.files[0].arrayBuffer());
    const wb   = XLSX.read(data, { type: 'array' });
    const rows = XLSX.utils.sheet_to_json(
      wb.Sheets[wb.SheetNames[0]],
      { header: 1 }
    );
    if (rows.length < 2) {
      alert('Planilha vazia ou formato inv√°lido');
      return;
    }

    const [headers, ...dataRows] = rows;
    sistema.promoShopeeData = dataRows.map(r => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = r[i]);
      return obj;
    });
    sistema.originalPromoShopeeData = sistema.promoShopeeData.map(o => ({ ...o }));

    document.getElementById('promoImportedProducts').style.display = 'block';
    displayPromoProducts();
    await checkProducts();
  }

  // 3) Renderiza a tabela com destaque de modifica√ß√µes
  function displayPromoProducts() {
    const body = document.getElementById('promoProductsTableBody');
    body.innerHTML = '';
    let modifiedCount = 0;

    sistema.promoShopeeData.forEach((prod, idx) => {
      const orig = sistema.originalPromoShopeeData[idx];
      const isMod = String(prod['Pre√ßo de desconto']) !== String(orig['Pre√ßo de desconto']);
      if (isMod) modifiedCount++;

      const statusText = prod.encontrado ? 'Encontrado' : 'N√£o encontrado';
      const tr = document.createElement('tr');
      tr.classList.add(prod.encontrado ? 'bg-green-100' : 'bg-red-100');
      if (isMod) tr.classList.add('border-2','border-green-600');

      tr.innerHTML = `
        <td>${prod['ID do produto']||''}</td>
        <td>${prod['N¬∫ de Ref. Parent SKU. (Opcional)']||''}</td>
        <td>${prod['N¬∫ de Ref. SKU. (Opcional)']||''}</td>
        <td>${prod['Pre√ßo original (opcional)']||''}</td>
        <td class="font-bold">${prod['Pre√ßo de desconto']||''}</td>
        <td class="status">${statusText}</td>
      `;
      body.appendChild(tr);
    });

    document.getElementById('promoChangesCount').textContent = `${modifiedCount} SKUs modificados`;
  }

  // 4) Verifica cada SKU no Firestore e atualiza status
  async function checkProducts() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const snap = await db
      .collection('uid').doc(user.uid)
      .collection('produtos').get();
    const systemSkus = new Set(snap.docs.map(d => String(d.data().sku||'').trim()));

    document
      .querySelectorAll('#promoProductsTableBody tr')
      .forEach((tr, idx) => {
        const prod = sistema.promoShopeeData[idx];
        const sku  = String(
          prod['N¬∫ de Ref. SKU. (Opcional)'] ||
          prod['N¬∫ de Ref. Parent SKU. (Opcional)'] ||
          ''
        ).trim();
        const found = systemSkus.has(sku);
        prod.encontrado = found;
        tr.classList.toggle('bg-green-100', found);
        tr.classList.toggle('bg-red-100', !found);
        tr.querySelector('.status').textContent = found ? 'Encontrado' : 'N√£o encontrado';
      });

    console.log(`üîç Verifica√ß√£o finalizada: ${sistema.promoShopeeData.length} SKUs verificados.`);
  }

  // 5) Aplica atualiza√ß√£o de pre√ßo conforme tipo de margem
  async function applyPromoPriceUpdate(type) {
    if (!sistema.promoShopeeData.length) {
      showToast('Importe a planilha primeiro!', 'warning');
      return;
    }
    const user = firebase.auth().currentUser;
    if (!user) {
      showToast('Usu√°rio n√£o autenticado!', 'error');
      return;
    }

    const snap = await db
      .collection('uid').doc(user.uid)
      .collection('produtos').get();
    const systemProducts = snap.docs.map(d => d.data());

    let updated = 0, notFound = 0, noSku = 0, missing = [];
    sistema.promoShopeeData.forEach(prod => {
      const sku = String(prod['N¬∫ de Ref. SKU. (Opcional)'] || '').trim() ||
                  String(prod['N¬∫ de Ref. Parent SKU. (Opcional)']||'').trim();
      if (!sku) { noSku++; prod.status = 'Sem SKU'; return; }

      const sys = systemProducts.find(p => String(p.sku).trim() === sku);
      if (!sys) { notFound++; prod.status = 'N√£o encontrado'; missing.push(sku); return; }

      let price;
      if (type==='promo')  price = sys.precoMinimo;
      if (type==='medium') price = sys.precoMedio;
      if (type==='ideal')  price = sys.precoIdeal;

      if (String(prod['Pre√ßo de desconto']) !== String(parseFloat(price).toFixed(2))) {
        updated++;
        prod['Pre√ßo de desconto'] = parseFloat(price).toFixed(2);
        prod.status = 'Atualizado';
      }
    });

    displayPromoProducts();
    showToast(`‚úÖ ${updated} atualizados ‚Ä¢ ‚ùå ${notFound} n√£o encontrados ‚Ä¢ ‚ö†Ô∏è ${noSku} sem SKU`, 'success');
    if (missing.length) {
      const list = missing.map(s => `<li>${s}</li>`).join('');
      document.getElementById('toastContainer').innerHTML += `
        <div class="toast toast-warning">
          <strong>${missing.length} SKUs n√£o encontrados:</strong>
          <ul class="pl-4 list-disc max-h-40 overflow-auto">${list}</ul>
        </div>`;
    }
  }

  // 6) Exporta XLSX com as altera√ß√µes
  function exportPromoFile() {
    if (!sistema.promoShopeeData.length) {
      showToast('Nenhum dado para exportar!', 'warning');
      return;
    }
    const headers = Object.keys(sistema.originalPromoShopeeData[0]);
    const data = [headers];
    sistema.originalPromoShopeeData.forEach((orig, i) => {
      const upd = sistema.promoShopeeData[i];
      const row = headers.map(h => (h==='Pre√ßo de desconto' && upd[h]!==undefined) ? upd[h] : orig[h]);
      data.push(row);
    });
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Promo√ß√µes');
    XLSX.writeFile(wb, `promocoes_shopee_${new Date().toISOString().slice(0,10)}.xlsx`);
    showToast('Exportado com sucesso!', 'success');
  }

  // Fun√ß√£o gen√©rica de toast
  function showToast(msg, tipo='success') {
    const cor = tipo==='success'? 'bg-green-500'
              : tipo==='warning'? 'bg-yellow-500'
              : tipo==='error'?   'bg-red-500'
              : 'bg-blue-500';
    const t = document.createElement('div');
    t.className = `${cor} text-white px-4 py-2 rounded shadow flex justify-between items-center`;
    t.innerHTML = `<span>${msg}</span><button onclick="this.parentElement.remove()">√ó</button>`;
    document.getElementById('toastContainer').appendChild(t);
    setTimeout(()=>t.remove(),4000);
  }
</script>

  <script src="shared.js"></script>
</body>
</html>
