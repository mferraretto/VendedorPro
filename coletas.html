<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coletas</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css?v=20240826" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="sidebar-container"></div>
  <div id="navbar-container"></div>
  <div class="main-content p-4">
    <h1 class="text-2xl font-bold mb-4">Coletas</h1>
    <div class="card mb-4 space-y-4">
      <div id="actionBar" class="flex flex-wrap items-center gap-2">
        <label for="reciboColetaPdf" class="btn flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 cursor-pointer">
          <i class="fas fa-file-import"></i><span>Importar Recibo de Coleta (PDF)</span>
        </label>
        <input type="file" id="reciboColetaPdf" accept="application/pdf" class="hidden" />
      </div>
      <div id="listaPedidos" class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr><th class="p-2 border">Pedido</th><th class="p-2 border">SPX</th><th class="p-2 border">Horário de Coleta</th></tr>
          </thead>
          <tbody id="pedidosDiaBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let currentUser = null;
    const inputPdf = document.getElementById('reciboColetaPdf');

    firebase.auth().onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = 'index.html?login=1';
        return;
      }
      currentUser = user;
      carregarPedidosDia();
    });

    inputPdf.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) importarReciboColetaPDF(file);
      e.target.value = '';
    });

    // Lê texto de todas as páginas do PDF
    async function readPdfText(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        text += strings.join(' ') + '\n';
      }
      return text.replace(/\u00A0/g, ' ').replace(/[ ]{2,}/g, ' ');
    }

    // Extrai metadados do recibo
    function extractReciboMeta(text) {
      const meta = {};
      const task = text.match(/ID\s*Tarefa[:\s]+(\S+)/i);
      if (task) meta.taskId = task[1];
      const fin = text.match(/Finaliza(?:ção|cao)[:\s]+(\d{2}-\d{2}-\d{4}\s+\d{2}:\d{2})/i);
      if (fin) meta.finalizacao = fin[1];
      const inicio = text.match(/In(?:í|i)cio\s+da\s+rota[:\s]+(\d{2}-\d{2}-\d{4}\s+\d{2}:\d{2})/i);
      if (inicio) meta.inicioRota = inicio[1];
      const chegada = text.match(/Chegada[:\s]+(\d{2}-\d{2}-\d{4}\s+\d{2}:\d{2})/i);
      if (chegada) meta.chegada = chegada[1];
      return meta;
    }

    // Isola a seção de pedidos coletados
    function sliceColetadosSection(text) {
  // aceita com/sem “:”, e variações de espaço/maiúsculas
  const startRe = /Pedidos\s+coletados\s+com\s+sucesso\s*:?\s*\d*/i;
  const endRe   = /Pedidos\s+com\s+ocorr[êe]ncia/i;

  const mStart = text.match(startRe);
  if (!mStart) return '';

  const startIdx = mStart.index;
  const rest = text.slice(startIdx);
  const mEnd = rest.match(endRe);
  const endIdx = mEnd ? mEnd.index : rest.length;

  return rest.slice(0, endIdx);
}


    // Extrai os pedidos coletados
    function extractColetadosOrders(sectionText) {
  const orders = [];
  // casa blocos do tipo:  "1 25090928EBBYH4 BR2534097941036 10-09-2025 12:08"
  // sem depender de \n e tolerando letra final no tracking
  const re = /(?:^|\s)\d+\s+([A-Z0-9]{10,20})\s+([A-Z0-9]+)\s+(\d{2}-\d{2}-\d{4}\s+\d{2}:\d{2})(?=\s|$)/g;

  let m;
  while ((m = re.exec(sectionText)) !== null) {
    const [, numeroPedido, spx, horarioColeta] = m;
    orders.push({ numeroPedido, spx, horarioColeta });
  }

  // fallback (algumas extrações “grudam” colunas)
  if (!orders.length) {
    const re2 = /(?:^|\s)\d+\s+([A-Z0-9]{10,20})\s+([A-Z0-9]+)\s+(\d{2}-\d{2}-\d{4})\s*(\d{2}:\d{2})(?=\s|$)/g;
    let m2;
    while ((m2 = re2.exec(sectionText)) !== null) {
      const [, numeroPedido, spx, d, h] = m2;
      orders.push({ numeroPedido, spx, horarioColeta: `${d} ${h}` });
    }
  }
  return orders;
}

    // Salva pedidos no Firestore evitando duplicidades
    async function savePedidosColetados(orders, meta) {
      if (!currentUser || !orders.length) return 0;
      const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Sao_Paulo' });
      const baseRef = db.collection('uid').doc(currentUser.uid).collection('coletas').doc(todayStr);
      const pedidosCol = baseRef.collection('pedidos');

      // Verifica quais pedidos já existem para não registrá-los novamente
      const existing = await Promise.all(
        orders.map(o => pedidosCol.doc(o.numeroPedido).get())
      );
      const novos = orders.filter((_, idx) => !existing[idx].exists);

      const batch = db.batch();
      batch.set(baseRef, { ...meta, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      novos.forEach(o => {
        const docRef = pedidosCol.doc(o.numeroPedido);
        batch.set(docRef, { ...o, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      });
      await batch.commit();
      if (novos.length) await marcarPedidosTinyColetados(novos);
      return novos.length;
    }

    // Marca pedidos correspondentes em pedidostiny como coletados
    async function marcarPedidosTinyColetados(orders) {
      if (!currentUser) return;
      const tinyCol = db.collection('usuarios').doc(currentUser.uid).collection('pedidostiny');
      for (const o of orders) {
        try {
          // procura pelo pedido usando a chave interna "idPedido"
          let qSnap = await tinyCol.where('idPedido', '==', o.numeroPedido).limit(1).get();
          // fallback para alguns registros que utilizam "numeroPedido"
          if (qSnap.empty) {
            qSnap = await tinyCol.where('numeroPedido', '==', o.numeroPedido).limit(1).get();
          }
          if (!qSnap.empty) {
            const foundRef = tinyCol.doc(qSnap.docs[0].id);
            const updateData = { coletado: true };
            if (o.horarioColeta) updateData.horarioColeta = o.horarioColeta;
            await foundRef.set(updateData, { merge: true });
            continue;
          }
          // por fim, tenta atualizar um documento cujo ID seja o número do pedido
          const docRef = tinyCol.doc(o.numeroPedido);
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            const updateData = { coletado: true };
            if (o.horarioColeta) updateData.horarioColeta = o.horarioColeta;
            await docRef.set(updateData, { merge: true });
          }
        } catch (err) {
          console.error('Erro ao marcar pedido coletado no Tiny:', o.numeroPedido, err);
        }
      }
    }

    // Fluxo completo de importação
    async function importarReciboColetaPDF(file) {
      try {
        const text = await readPdfText(file);
        const meta = extractReciboMeta(text);
        const section = sliceColetadosSection(text);
        if (!section) {
          alert("Seção 'Pedidos coletados com sucesso' não encontrada.");
          return;
        }
        const orders = extractColetadosOrders(section);
        if (!orders.length) {
          alert('Tabela de pedidos coletados está vazia.');
          return;
        }
        const novos = await savePedidosColetados(orders, meta);
        alert(`Importado com sucesso: ${novos} pedidos coletados.`);
        carregarPedidosDia();
        if (typeof calcularTotalPedidosDia === 'function') {
          calcularTotalPedidosDia();
        }
      } catch (e) {
        console.error('Erro ao importar recibo:', e);
        alert('Erro ao importar Recibo de Coleta.');
      }
    }
    window.importarReciboColetaPDF = importarReciboColetaPDF;

    // Carrega pedidos do dia atual
    async function carregarPedidosDia() {
      if (!currentUser) return;
      const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Sao_Paulo' });
      const tbody = document.getElementById('pedidosDiaBody');
      tbody.innerHTML = '';
      try {
        const snap = await db.collection('uid').doc(currentUser.uid).collection('coletas').doc(todayStr).collection('pedidos').get();
        if (snap.empty) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="3" class="p-2 text-center text-gray-500">Nenhum pedido enviado hoje.</td>';
          tbody.appendChild(tr);
          return;
        }
        snap.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="p-2 border">${doc.id}</td><td class="p-2 border">${d.spx || ''}</td><td class="p-2 border">${d.horarioColeta || ''}</td>`;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error('Erro ao carregar pedidos do dia:', e);
      }
    }
    window.carregarPedidosDia = carregarPedidosDia;
  </script>
  <script type="module" src="login.js"></script>
  <script src="shared.js"></script>
</body>
</html>
