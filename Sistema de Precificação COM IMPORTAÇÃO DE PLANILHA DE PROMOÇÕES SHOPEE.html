<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MENTORIA FERRARETTO | Sistema de Precificação</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Montserrat:wght@700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #F45C00;
      --primary-hover: #e15400;
      --brand: #1C2B36;
      --success: #4CAF50;
      --error: #F44336;
      --bg: #F5F7FA;
      --card: #FFFFFF;
      --text: #333333;
      --text-light: #6B7280;
      --border: #E5E7EB;
    }

    .dark-mode {
      --bg: #1E293B;
      --card: #2D3748;
      --text: #F3F4F6;
      --text-light: #94A3B8;
      --border: #475569;
    }

    * {
      transition: background-color 0.3s, border-color 0.3s;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    h1, h2, h3, h4, h5 {
      font-family: 'Montserrat', sans-serif;
    }

    button, .btn {
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--brand);
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: all 0.3s;
    }

    .sidebar-logo {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar-menu {
      padding: 15px 0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .menu-item:hover {
      background: rgba(255,255,255,0.05);
      color: white;
    }

    .menu-item.active {
      background: rgba(255,255,255,0.1);
      color: white;
      border-left: 3px solid var(--primary);
    }

    .menu-icon {
      width: 24px;
      text-align: center;
      margin-right: 12px;
      font-size: 18px;
    }

    /* Navbar */
    .navbar {
      height: 70px;
      background: var(--card);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: fixed;
      top: 0;
      left: 260px;
      right: 0;
      z-index: 99;
      display: flex;
      align-items: center;
      padding: 0 25px;
      justify-content: space-between;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-dropdown {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      position: relative;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--brand);
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 600;
      font-size: 15px;
    }

    .user-role {
      font-size: 12px;
      color: var(--text-light);
    }

    /* Main Content */
    .main-content {
      margin-top: 70px;
      margin-left: 260px;
      padding: 25px;
      min-height: calc(100vh - 70px);
    }

    /* Cards */
    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      padding: 20px;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }

    .dashboard-card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    /* Buttons */
    .btn-primary {
      background-color: var(--primary);
      color: white;
      border-radius: 9999px;
      padding: 8px 20px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
    }

    .btn-outline {
      border: 1px solid var(--border);
      border-radius: 9999px;
      padding: 8px 20px;
      font-weight: 500;
      transition: all 0.2s;
      background: transparent;
      color: var(--text);
    }

    .btn-outline:hover {
      background: var(--bg);
    }

    .btn-success {
      background-color: var(--success);
      color: white;
      border-radius: 9999px;
      padding: 8px 20px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-success:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn-danger {
      background-color: var(--error);
      color: white;
      border-radius: 9999px;
      padding: 8px 20px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-danger:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    .tabs button {
      padding: 10px 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      border-radius: 6px;
      font-weight: 500;
      color: var(--text-light);
      position: relative;
    }

    .tabs button:hover {
      background: rgba(0,0,0,0.05);
    }

    .tabs button.active {
      color: var(--primary);
      background: rgba(244,92,0,0.1);
    }

    .tabs button.active:after {
      content: '';
      position: absolute;
      bottom: -11px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary);
      border-radius: 3px 3px 0 0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Forms */
    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text);
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(244,92,0,0.2);
    }

    /* Tables */
    .table-container {
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: var(--card);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      background: var(--bg);
      text-align: left;
      padding: 12px 15px;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-light);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
    }

    .table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    .table tr:nth-child(even) {
      background: rgba(0,0,0,0.02);
    }

    .dark-mode .table tr:nth-child(even) {
      background: rgba(255,255,255,0.03);
    }

    /* Scenario Cards */
    .scenario-card {
      background: var(--card);
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      border-left: 4px solid;
    }

    .scenario-ideal {
      border-left-color: var(--success);
      background-color: rgba(76, 175, 80, 0.05);
    }

    .scenario-medium {
      border-left-color: #FFC107;
      background-color: rgba(255, 193, 7, 0.05);
    }

    .scenario-promo {
      border-left-color: var(--error);
      background-color: rgba(244, 67, 54, 0.05);
    }

    .scenario-title {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .scenario-value {
      font-size: 1.2rem;
      font-weight: 700;
    }

    /* Platform Tags */
    .platform-tag {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .platform-ml {
      background: #ffe0e0;
      color: #c62828;
    }

    .platform-shopee {
      background: #e3f2fd;
      color: #1565c0;
    }

    .platform-magalu {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .platform-shein {
      background: #f3e5f5;
      color: #6a1b9a;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: var(--card);
      margin: 5% auto;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .btn-close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: var(--text-light);
    }

    .btn-close:hover {
      color: var(--text);
    }

    /* Product Card */
    .product-card {
      background: var(--card);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      padding: 20px;
      transition: all 0.3s;
      border: 1px solid var(--border);
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.12);
      border-color: var(--primary);
    }

    .product-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--success);
    }

    /* Toast Messages */
    .toast {
      position: fixed;
      bottom: 25px;
      right: 25px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
    }

    .toast-success {
      background: var(--success);
    }

    .toast-error {
      background: var(--error);
    }

    .toast-warning {
      background: #FFC107;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, var(--border) 25%, rgba(0,0,0,0.05) 50%, var(--border) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: var(--brand);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }

    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--brand) transparent transparent transparent;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .dark-mode-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--primary);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    /* Responsive */
    @media (max-width: 992px) {
      .sidebar {
        width: 70px;
      }
      .sidebar .menu-text {
        display: none;
      }
      .navbar {
        left: 70px;
      }
      .main-content {
        margin-left: 70px;
      }
    }

    @media (max-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: 1fr;
      }
      .modal-content {
        width: 95%;
        margin: 10px auto;
      }
      .navbar {
        left: 0;
      }
      .main-content {
        margin-left: 0;
      }
      .sidebar {
        transform: translateX(-100%);
        z-index: 101;
      }
      .sidebar.active {
        transform: translateX(0);
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-logo">
      <h1 class="text-white text-xl font-bold flex items-center gap-2">
        <i class="fas fa-calculator"></i>
        <span>MENTORIA FERRARETTO</span>
      </h1>
    </div>
    
    <div class="sidebar-menu">
      <a href="#" class="menu-item active">
        <div class="menu-icon">🧮</div>
        <span class="menu-text">Sistema de Precificação Shopee</span>
      </a>
      <a href="#" class="menu-item">
        <div class="menu-icon">📣</div>
        <span class="menu-text">Gerenciamento de Anúncios</span>
      </a>
      <a href="#" class="menu-item">
        <div class="menu-icon">📦</div>
        <span class="menu-text">Controle de Sobras Shopee</span>
      </a>
      <a href="#" class="menu-item">
        <div class="menu-icon">🛠️</div>
        <span class="menu-text">Custeio de Produção</span>
      </a>
      <a href="#" class="menu-item">
        <div class="menu-icon">👥</div>
        <span class="menu-text">Gerenciamento de Usuários</span>
      </a>
    </div>
    
    <div class="px-5 py-4 mt-auto">
      <div class="flex items-center justify-between">
        <span class="text-gray-400 text-sm">Modo Escuro</span>
        <label class="dark-mode-toggle">
          <input type="checkbox" id="darkModeToggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
  </div>
  
  <!-- Navbar -->
  <div class="navbar">
    <div>
      <button class="md:hidden" id="sidebarToggle">
        <i class="fas fa-bars text-xl"></i>
      </button>
    </div>
    
    <div class="navbar-right">
      <div class="relative">
        <button class="p-2 rounded-full hover:bg-gray-100 relative">
          <i class="fas fa-bell text-gray-600"></i>
          <span class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">3</span>
        </button>
      </div>
      
      <div class="user-dropdown" id="userDropdown">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-info">
          <div class="user-name" id="currentUser">admin@empresa.com</div>
          <div class="user-role">Administrador</div>
        </div>
        <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
        
        <!-- Dropdown menu -->
        <div class="absolute top-full right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 hidden" id="dropdownMenu">
          <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100">
            <i class="fas fa-user mr-2"></i> Perfil
          </a>
          <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100">
            <i class="fas fa-cog mr-2"></i> Configurações
          </a>
          <div class="border-t my-1"></div>
          <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100 text-red-500" id="logoutBtn">
            <i class="fas fa-sign-out-alt mr-2"></i> Sair
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Sistema de Precificação</h1>
      <div>
        <button class="btn-outline">
          <i class="fas fa-sync-alt mr-2"></i> Atualizar Dados
        </button>
      </div>
    </div>
    
    <!-- Abas principais -->
    <div class="tabs">
      <button class="tab-button active" data-tab="precificacao">
        <i class="fas fa-calculator mr-2"></i> Precificação
      </button>
      <button class="tab-button" data-tab="produtos">
        <i class="fas fa-box mr-2"></i> Produtos
      </button>
      <button class="tab-button" data-tab="historico" id="historyTab">
        <i class="fas fa-history mr-2"></i> Histórico
      </button>
      <button class="tab-button" data-tab="configuracoes" id="configTab">
        <i class="fas fa-cog mr-2"></i> Configurações
      </button>
    </div>

    <!-- Conteúdo das abas -->

    <div id="precificacao" class="tab-content active">
      <div class="card mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="input-group">
            <label for="produto">Nome do Produto</label>
            <input id="produto" placeholder="Ex: Tênis Esportivo" class="p-3">
          </div>
          <div class="input-group">
            <label for="sku">Código SKU</label>
            <input id="sku" placeholder="Ex: TN-ESPORT-001" class="p-3">
          </div>
          <div class="input-group">
            <label for="custo">Custo do Produto (R$)</label>
            <input id="custo" placeholder="Ex: 89,90" type="number" step="0.01" class="p-3">
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <!-- Mercado Livre -->
        <div class="card">
          <h2 class="text-xl font-bold mb-4 text-red-600"><i class="fas fa-store mr-2"></i> Mercado Livre</h2>
          <div id="mlCampos">
            <div class="input-group">
              <label>Taxas da Plataforma (%)</label>
              <div class="flex gap-2">
                <select id="ml_taxa_select" class="flex-1 p-2">
                  <option value="16">16%</option>
                  <option value="21">21%</option>
                </select>
                <input type="number" step="0.01" placeholder="Outro" id="ml_taxa_custom" class="flex-1 p-2">
              </div>
            </div>
            
            <div class="input-group">
              <label>Custo Fixo Plataforma (R$)</label>
              <div class="flex gap-2">
                <select id="ml_fixo_select" class="flex-1 p-2">
                  <option value="6">R$ 6,00</option>
                </select>
                <input type="number" step="0.01" placeholder="Outro" id="ml_fixo_custom" class="flex-1 p-2">
              </div>
            </div>
            
            <input placeholder="Frete (R$)" data-campo="Frete (R$)" class="p-2">
            <input placeholder="Taxa de Transação (%)" data-campo="Taxa de Transação (%)" class="p-2">
            <input placeholder="Taxa de Transferência (%)" data-campo="Taxa de Transferência (%)" class="p-2">
            <input placeholder="Taxa de Antecipação (%)" data-campo="Taxa de Antecipação (%)" class="p-2">
            <input placeholder="Custos Variáveis (R$)" data-campo="Custos Variáveis (R$)" class="p-2">
            <input placeholder="Imposto (%)" data-campo="Imposto (%)" class="p-2">
            <input placeholder="Comissão do Vendedor (%)" data-campo="Comissão do Vendedor (%)" class="p-2">
            
            <div class="input-group mt-4">
              <label>Preço Mínimo (R$)</label>
              <input id="preco_ml" disabled class="p-3 bg-gray-100 font-bold text-lg">
            </div>
            
             <div class="scenario-card scenario-promo">
              <div class="scenario-title">Sem Lucro (0%)</div>
              <div class="scenario-value" id="preco_ml_promo">R$ 0,00</div>
            </div>
            
            <div class="scenario-card scenario-medium">
              <div class="scenario-title">Lucro 5%</div>
              <div class="scenario-value" id="preco_ml_medio">R$ 0,00</div>
            </div>
            
            <div class="scenario-card scenario-ideal">
              <div class="scenario-title">Lucro 10%</div>
              <div class="scenario-value" id="preco_ml_ideal">R$ 0,00</div>
            </div>
          </div>
          <button class="btn-primary w-full mt-4" onclick="calcular('ml')">
            <i class="fas fa-save mr-2"></i> Calcular e Salvar
          </button>
        </div>

        <!-- Shopee -->
        <div class="card">
          <h2 class="text-xl font-bold mb-4 text-blue-600"><i class="fas fa-store mr-2"></i> Shopee</h2>
          <div id="shopeeCampos">
            <div class="input-group">
              <label>Taxas da Plataforma (%)</label>
              <div class="flex gap-2">
                <select id="shopee_taxa_select" class="flex-1 p-2">
                  <option value="14">14%</option>
                  <option value="20">20%</option>
                </select>
                <input type="number" step="0.01" placeholder="Outro" id="shopee_taxa_custom" class="flex-1 p-2">
              </div>
            </div>
            
            <div class="input-group">
              <label>Custo Fixo Plataforma (R$)</label>
              <div class="flex gap-2">
                <select id="shopee_fixo_select" class="flex-1 p-2">
                  <option value="4">R$ 4,00</option>
                </select>
                <input type="number" step="0.01" placeholder="Outro" id="shopee_fixo_custom" class="flex-1 p-2">
              </div>
            </div>
            
            <input placeholder="Frete (R$)" data-campo="Frete (R$)" class="p-2">
            <input placeholder="Taxa de Transação (%)" data-campo="Taxa de Transação (%)" class="p-2">
            <input placeholder="Taxa de Transferência (%)" data-campo="Taxa de Transferência (%)" class="p-2">
            <input placeholder="Taxa de Antecipação (%)" data-campo="Taxa de Antecipação (%)" class="p-2">
            <input placeholder="Custos Variáveis (R$)" data-campo="Custos Variáveis (R$)" class="p-2">
            <input placeholder="Imposto (%)" data-campo="Imposto (%)" class="p-2">
            <input placeholder="Comissão do Vendedor (%)" data-campo="Comissão do Vendedor (%)" class="p-2">
            
            <div class="input-group mt-4">
              <label>Preço Mínimo (R$)</label>
              <input id="preco_shopee" disabled class="p-3 bg-gray-100 font-bold text-lg">
            </div>
            
             <div class="scenario-card scenario-promo">
              <div class="scenario-title">Sem Lucro (0%)</div>
              <div class="scenario-value" id="preco_shopee_promo">R$ 0,00</div>
            </div>
            
            <div class="scenario-card scenario-medium">
              <div class="scenario-title">Lucro 5%</div>
              <div class="scenario-value" id="preco_shopee_medio">R$ 0,00</div>
            </div>
            
           <div class="scenario-card scenario-ideal">
              <div class="scenario-title">Lucro 10%</div>
              <div class="scenario-value" id="preco_shopee_ideal">R$ 0,00</div>
            </div>
          </div>
          <button class="btn-primary w-full mt-4" onclick="calcular('shopee')">
            <i class="fas fa-save mr-2"></i> Calcular e Salvar
          </button>
        </div>

        <!-- Magalu -->
        <div class="card">
          <h2 class="text-xl font-bold mb-4 text-green-600"><i class="fas fa-store mr-2"></i> Magalu</h2>
          <div id="magaluCampos">
            <div class="input-group">
              <label>Taxas da Plataforma (%)</label>
              <div class="flex gap-2">
                <select id="magalu_taxa_select" class="flex-1 p-2">
                  <option value="10">10%</option>
                  <option value="16">16%</option>
                  <option value="20">20%</option>
                </select>
                <input type="number" step="0.01" placeholder="Outro" id="magalu_taxa_custom" class="flex-1 p-2">
              </div>
            </div>
            
            <div class="input-group">
              <label>Custo Fixo Plataforma (R$)</label>
              <div class="flex gap-2">
                <select id="magalu_fixo_select" class="flex-1 p-2">
                  <option value="3">R$ 3,00</option>
                </select>
                <input type="number" step="0.01" placeholder="Outro" id="magalu_fixo_custom" class="flex-1 p-2">
              </div>
            </div>
            
            <input placeholder="Frete (R$)" data-campo="Frete (R$)" class="p-2">
            <input placeholder="Taxa de Transação (%)" data-campo="Taxa de Transação (%)" class="p-2">
            <input placeholder="Taxa de Transferência (%)" data-campo="Taxa de Transferência (%)" class="p-2">
            <input placeholder="Taxa de Antecipação (%)" data-campo="Taxa de Antecipação (%)" class="p-2">
            <input placeholder="Custos Variáveis (R$)" data-campo="Custos Variáveis (R$)" class="p-2">
            <input placeholder="Imposto (%)" data-campo="Imposto (%)" class="p-2">
            <input placeholder="Comissão do Vendedor (%)" data-campo="Comissão do Vendedor (%)" class="p-2">
            
            <div class="input-group mt-4">
              <label>Preço Mínimo (R$)</label>
              <input id="preco_magalu" disabled class="p-3 bg-gray-100 font-bold text-lg">
            </div>
            
           <div class="scenario-card scenario-promo">
              <div class="scenario-title">Sem Lucro (0%)</div>
              <div class="scenario-value" id="preco_magalu_promo">R$ 0,00</div>
            </div>
            
            <div class="scenario-card scenario-medium">
<div class="scenario-title">Lucro 5%</div>
              <div class="scenario-value" id="preco_magalu_medio">R$ 0,00</div>
            </div>
            
            <div class="scenario-card scenario-ideal">
              <div class="scenario-title">Lucro 10%</div>
              <div class="scenario-value" id="preco_magalu_ideal">R$ 0,00</div>
            </div>
          </div>
          <button class="btn-primary w-full mt-4" onclick="calcular('magalu')">
            <i class="fas fa-save mr-2"></i> Calcular e Salvar
          </button>
        </div>

        <!-- SHEIN -->
        <div class="card">
          <h2 class="text-xl font-bold mb-4 text-purple-600"><i class="fas fa-store mr-2"></i> SHEIN</h2>
          <div id="sheinCampos">
            <div class="input-group">
              <label>Taxas da Plataforma (%)</label>
              <div class="flex gap-2">
                <select id="shein_taxa_select" class="flex-1 p-2">
                  <option value="16">16%</option>
                </select>
                <input type="number" step="0.01" placeholder="Outro" id="shein_taxa_custom" class="flex-1 p-2">
              </div>
            </div>
            
            <div class="input-group">
              <label>Custo Fixo Plataforma (R$)</label>
              <div class="flex gap-2">
                <select id="shein_fixo_select" class="flex-1 p-2">
                  <option value="0">R$ 0,00</option>
                </select>
                <input type="number" step="0.01" placeholder="Outro" id="shein_fixo_custom" class="flex-1 p-2">
              </div>
            </div>
            
            <input placeholder="Frete (R$)" data-campo="Frete (R$)" class="p-2">
            <input placeholder="Taxa de Transação (%)" data-campo="Taxa de Transação (%)" class="p-2">
            <input placeholder="Taxa de Transferência (%)" data-campo="Taxa de Transferência (%)" class="p-2">
            <input placeholder="Taxa de Antecipação (%)" data-campo="Taxa de Antecipação (%)" class="p-2">
            <input placeholder="Custos Variáveis (R$)" data-campo="Custos Variáveis (R$)" class="p-2">
            <input placeholder="Imposto (%)" data-campo="Imposto (%)" class="p-2">
            <input placeholder="Comissão do Vendedor (%)" data-campo="Comissão do Vendedor (%)" class="p-2">
            
            <div class="input-group mt-4">
              <label>Preço Mínimo (R$)</label>
              <input id="preco_shein" disabled class="p-3 bg-gray-100 font-bold text-lg">
            </div>
            
            <div class="scenario-card scenario-promo">
              <div class="scenario-title">Sem Lucro (0%)</div>
              <div class="scenario-value" id="preco_shein_promo">R$ 0,00</div>
            </div>
            
            <div class="scenario-card scenario-medium">
             <div class="scenario-title">Lucro 5%</div>
              <div class="scenario-value" id="preco_shein_medio">R$ 0,00</div>
            </div>
            
           <div class="scenario-card scenario-ideal">
              <div class="scenario-title">Lucro 10%</div>
              <div class="scenario-value" id="preco_shein_ideal">R$ 0,00</div>
            </div>
          </div>
          <button class="btn-primary w-full mt-4" onclick="calcular('shein')">
            <i class="fas fa-save mr-2"></i> Calcular e Salvar
          </button>
        </div>
      </div>
    </div>

    <div id="produtos" class="tab-content p-4">
      <div class="card mb-6">
        <h2 class="text-2xl font-bold mb-6"><i class="fas fa-boxes mr-2"></i> Produtos Salvos</h2>
        
        <div class="bg-gray-50 p-5 rounded-xl mb-6">
          <h3 class="text-xl font-bold mb-4"><i class="fas fa-file-import mr-2"></i> Importar/Exportar Promoções Shopee</h3>
          
          <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-1">
              <label class="block text-sm font-medium mb-2">Importar Planilha Shopee:</label>
              <input type="file" id="shopeeFileInput" accept=".xlsx,.xls" class="border p-2 rounded-lg w-full">
            </div>
            <button onclick="importShopeeFile()" class="btn-primary">
              <i class="fas fa-upload mr-2"></i> Importar
            </button>
          </div>
          
          <div id="importedShopeeProducts" class="mt-4" style="display: none;">
            <h4 class="font-semibold mb-2">Produtos importados:</h4>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID Produto</th>
                    <th>Nome</th>
                    <th>Parent SKU</th>
                    <th>ID Variação</th>
                    <th>Variação</th>
                    <th>SKU</th>
                    <th>Preço Original</th>
                    <th>Preço Desconto</th>
                  </tr>
                </thead>
                <tbody id="importedProductsTableBody"></tbody>
              </table>
            </div>
            
            <div class="flex flex-wrap gap-3 mt-4">
              <button onclick="applyPriceUpdate('promo')" class="btn-danger">
                <i class="fas fa-tag mr-2"></i> Aplicar Sem Lucro (0%)
              </button>
              <button onclick="applyPriceUpdate('medium')" class="btn-warning">
                <i class="fas fa-chart-line mr-2"></i> Aplicar Lucro 5%
              </button>
              <button onclick="applyPriceUpdate('ideal')" class="btn-success">
                <i class="fas fa-star mr-2"></i> Aplicar Lucro 10%
              </button>
              <button onclick="exportShopeeFile()" class="btn-primary ml-auto">
                <i class="fas fa-file-export mr-2"></i> Exportar Planilha
              </button>
            </div>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-4 mb-6">
          <button onclick="exportarExcel()" class="btn-success">
            <i class="fas fa-file-excel mr-2"></i> Exportar Excel
          </button>
          <button onclick="exportarPDF()" class="btn-danger">
            <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
          </button>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Filtrar por Plataforma:</label>
          <select id="filtroPlataforma" class="border p-3 w-full md:w-1/3">
            <option value="Todas">Todas as Plataformas</option>
            <option value="SHOPEE">Shopee</option>
            <option value="MAGALU">Magalu</option>
            <option value="ML">Mercado Livre</option>
            <option value="SHEIN">SHEIN</option>
          </select>
        </div>
        
        <div id="listaProdutos" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      </div>
    </div>

    <div id="historico" class="tab-content p-4">
      <div class="card">
        <h2 class="text-2xl font-bold mb-6"><i class="fas fa-history mr-2"></i> Histórico de Alterações</h2>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Filtrar por:</label>
          <div class="flex flex-wrap gap-4">
            <select id="filterHistoryType" class="border p-2">
              <option value="all">Todos os tipos</option>
              <option value="login">Logins</option>
              <option value="price_update">Atualizações de preço</option>
              <option value="product_edit">Edições de produto</option>
              <option value="backup">Backups</option>
            </select>
            <select id="filterHistoryUser" class="border p-2">
              <option value="all">Todos os usuários</option>
              <!-- Preenchido dinamicamente -->
            </select>
            <input type="date" id="filterHistoryDate" class="border p-2">
          </div>
        </div>
        
        <div id="historyList" class="space-y-4">
          <!-- Preenchido dinamicamente -->
        </div>
      </div>
    </div>

    <div id="configuracoes" class="tab-content p-4">
      <div class="card">
        <h2 class="text-2xl font-bold mb-6"><i class="fas fa-cog mr-2"></i> Configurações do Sistema</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-gray-50 p-5 rounded-xl">
            <h3 class="font-semibold text-lg mb-4 pb-2 border-b">Configurações de API</h3>
            
            <div class="space-y-4">
              <div>
                <h4 class="font-medium mb-2">Mercado Livre</h4>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium mb-1">Client ID</label>
                    <input type="text" id="mlClientId" class="w-full p-2 border rounded" value="">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">Client Secret</label>
                    <input type="password" id="mlClientSecret" class="w-full p-2 border rounded" value="">
                  </div>
                  <button onclick="testMlConnection()" class="btn-outline">
                    Testar Conexão
                  </button>
                </div>
              </div>
              
              <div>
                <h4 class="font-medium mb-2">Shopee</h4>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium mb-1">API Key</label>
                    <input type="text" id="shopeeApiKey" class="w-full p-2 border rounded" value="">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">Partner ID</label>
                    <input type="text" id="shopeePartnerId" class="w-full p-2 border rounded" value="">
                  </div>
                  <button onclick="testShopeeConnection()" class="btn-outline">
                    Testar Conexão
                  </button>
                </div>
              </div>
            </div>
            
            <div class="mt-6">
              <button onclick="saveApiConfig()" class="btn-primary">
                Salvar Configurações
              </button>
            </div>
          </div>
          
          <div class="bg-gray-50 p-5 rounded-xl">
            <h3 class="font-semibold text-lg mb-4 pb-2 border-b">Configurações de Backup</h3>
            
            <div class="space-y-4">
              <div class="flex items-center">
                <input type="checkbox" id="autoBackup" class="mr-2" checked>
                <label for="autoBackup">Backup automático diário</label>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1">Frequência de Backup</label>
                <select id="backupFrequency" class="border p-2 w-full">
                  <option value="daily">Diário</option>
                  <option value="weekly">Semanal</option>
                  <option value="monthly">Mensal</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1">Último Backup</label>
                <div class="bg-gray-100 p-3 rounded-lg">
                  <div id="lastBackupInfo" class="text-sm">Nenhum backup realizado ainda</div>
                </div>
              </div>
              
              <div class="flex gap-3">
                <button onclick="createBackup()" class="btn-primary">
                  Criar Backup Agora
                </button>
                <button onclick="restoreBackup()" class="btn-outline">
                  Restaurar Backup
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-6 bg-gray-50 p-5 rounded-xl">
          <h3 class="font-semibold text-lg mb-4 pb-2 border-b">Gerenciamento de Usuários</h3>
          
          <div class="overflow-x-auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>E-mail</th>
                  <th>Perfil</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- Preenchido dinamicamente -->
              </tbody>
            </table>
          </div>
          
          <button onclick="openAddUserModal()" class="btn-primary mt-4">
            <i class="fas fa-plus mr-2"></i> Adicionar Usuário
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modais -->
  <div id="loginModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <span class="btn-close" onclick="closeModal('loginModal')">&times;</span>
      <h3 class="text-xl font-bold mb-4">Acesso ao Sistema</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">E-mail</label>
          <input type="email" id="loginEmail" class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Senha</label>
          <input type="password" id="loginPassword" class="w-full p-2 border rounded">
        </div>
        <button onclick="login()" class="w-full btn-primary">
          <i class="fas fa-sign-in-alt mr-2"></i> Entrar
        </button>
        <div class="text-center">
          <a href="#recover" onclick="openRecoverModal()" class="text-sm text-blue-600">Esqueci minha senha</a>
        </div>
      </div>
    </div>
  </div>

  <div id="recoverModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <span class="btn-close" onclick="closeModal('recoverModal')">&times;</span>
      <h3 class="text-xl font-bold mb-4">Recuperar Senha</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">E-mail cadastrado</label>
          <input type="email" id="recoverEmail" class="w-full p-2 border rounded">
        </div>
        <button onclick="sendRecovery()" class="w-full btn-primary">
          Enviar Link de Recuperação
        </button>
      </div>
    </div>
  </div>

  <div id="addUserModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <span class="btn-close" onclick="closeModal('addUserModal')">&times;</span>
      <h3 class="text-xl font-bold mb-4">Adicionar Novo Usuário</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Nome Completo</label>
          <input type="text" id="newUserName" class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">E-mail</label>
          <input type="email" id="newUserEmail" class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Senha</label>
          <input type="password" id="newUserPassword" class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Perfil</label>
          <select id="newUserProfile" class="w-full p-2 border rounded">
            <option value="admin">Administrador</option>
            <option value="operador">Operador</option>
            <option value="visualizador">Visualizador</option>
          </select>
        </div>
        <button onclick="addNewUser()" class="w-full btn-primary">
          <i class="fas fa-save mr-2"></i> Salvar Usuário
        </button>
      </div>
    </div>
  </div>

  <div id="detalhesModal" class="modal">
    <div class="modal-content">
      <span class="btn-close" onclick="fecharModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC78l9b2DTNj64y_0fbRKofNupO6NHDmeo",
      authDomain: "matheus-35023.firebaseapp.com",
      projectId: "matheus-35023",
      storageBucket: "matheus-35023.appspot.com",
      messagingSenderId: "1011113149395",
      appId: "1:1011113149395:web:c1f449e0e974ca8ecb2526"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Configuração inicial
    const { jsPDF } = window.jspdf;
    const plataformas = ["ml", "shopee", "magalu", "shein"];
    const camposExtras = [
      "Frete (R$)", "Taxa de Transação (%)", "Taxa de Transferência (%)",
      "Taxa de Antecipação (%)", "Custos Variáveis (R$)", "Imposto (%)", "Comissão do Vendedor (%)"
    ];

    // Dados do sistema
    let sistema = {
      produtos: [],
      historico: [],
      usuarios: [],
      config: {
        backupAuto: true,
        backupFrequency: "daily",
        apiConfig: {
          ml: { clientId: "", clientSecret: "", connected: false },
          shopee: { apiKey: "", partnerId: "", connected: false }
        }
      },
      importedShopeeData: null,
      originalShopeeData: null,
      produtoEditando: null
    };

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
      setupCharts();
      setupEventListeners();
      checkLogin();
      const params = new URLSearchParams(window.location.search);
      if (params.get('login') === '1') {
        openModal('loginModal');
      }
      
      // Configurar dark mode toggle
      document.getElementById('darkModeToggle').addEventListener('change', function() {
        document.body.classList.toggle('dark-mode');
      });
      
      // Configurar dropdown de usuário
      document.getElementById('userDropdown').addEventListener('click', function() {
        document.getElementById('dropdownMenu').classList.toggle('hidden');
      });
      
      // Configurar sidebar toggle mobile
      document.getElementById('sidebarToggle').addEventListener('click', function() {
        document.querySelector('.sidebar').classList.toggle('active');
      });
    });

    // Funções principais do sistema
    async function loadSystem() {
       const user = auth.currentUser;
      if (!user) return;

      let isAdmin = false;
      try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (userDoc.exists) {
          isAdmin = userDoc.data().perfil === 'admin';
        }
      } catch (error) {
        console.error("Erro ao verificar perfil do usuário:", error);
      }
      // Carrega configurações do Firestore
      try {
        const configDoc = await db.collection("config").doc("systemConfig").get();
        if (configDoc.exists) {
          sistema.config = configDoc.data();
          updateUI();
        }
      } catch (error) {
        console.error("Erro ao carregar configurações:", error);
      }
      
      // Carrega usuários somente se admin
      try {
         if (isAdmin) {
          const usersSnapshot = await db.collection("users").get();
          sistema.usuarios = [];
          usersSnapshot.forEach(doc => {
            sistema.usuarios.push({ id: doc.id, ...doc.data() });
          });
          loadUsers();
        }
      } catch (error) {
        console.error("Erro ao carregar usuários:", error);
      }
      
      // Carrega histórico
      try {
 let historyQuery = db.collection("history").orderBy("timestamp", "desc").limit(100);
        if (!isAdmin) {
          historyQuery = db.collection("history").where("userId", "==", user.uid).orderBy("timestamp", "desc").limit(100);
        }
        const historySnapshot = await historyQuery.get();
        sistema.historico = [];
        historySnapshot.forEach(doc => {
          sistema.historico.push({ id: doc.id, ...doc.data() });
        });
        loadHistory();
        updateRecentUpdates();
      } catch (error) {
        console.error("Erro ao carregar histórico:", error);
      }
      
      // Carrega produtos
      try {
   let productsQuery = db.collection("products").orderBy("createdAt", "desc");
        if (!isAdmin) {
          productsQuery = db.collection("products").where("userId", "==", user.uid).orderBy("createdAt", "desc");
        }
        const productsSnapshot = await productsQuery.get();
        sistema.produtos = [];
        productsSnapshot.forEach(doc => {
          sistema.produtos.push({ id: doc.id, ...doc.data() });
        });
        atualizarLista();
        updateKPIs();
      } catch (error) {
        console.error("Erro ao carregar produtos:", error);
      }
    }

    async function saveSystem() {
      try {
        // Salvar configurações
        await db.collection("config").doc("systemConfig").set(sistema.config);
      } catch (error) {
        console.error("Erro ao salvar configurações:", error);
      }
    }

    function setupCharts() {
      // Gráfico de margens
      const marginCtx = document.getElementById('marginChart').getContext('2d');
      new Chart(marginCtx, {
        type: 'bar',
        data: {
          labels: ['Mercado Livre', 'Shopee', 'Magalu', 'SHEIN'],
          datasets: [{
            label: 'Margem Média (%)',
            data: [22, 18, 15, 20],
            backgroundColor: [
              '#FF6384',
              '#36A2EB',
              '#FFCE56',
              '#4BC0C0'
            ]
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      // Gráfico de produtos mais rentáveis
      const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
      new Chart(topProductsCtx, {
        type: 'doughnut',
        data: {
          labels: ['Tênis Esportivo', 'Camiseta Premium', 'Calça Jeans', 'Bolsa Feminina', 'Relógio'],
          datasets: [{
            data: [35, 25, 20, 15, 5],
            backgroundColor: [
              '#FF6384',
              '#36A2EB',
              '#FFCE56',
              '#4BC0C0',
              '#9966FF'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });

      // Gráfico de histórico de preços
      const priceCtx = document.getElementById('priceHistoryChart').getContext('2d');
      new Chart(priceCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
          datasets: [
            {
              label: 'Preço Mínimo',
              data: [89, 92, 95, 94, 96, 98],
              borderColor: '#F44336',
              fill: false,
              tension: 0.4
            },
            {
              label: 'Preço Ideal',
              data: [120, 122, 125, 124, 126, 128],
              borderColor: '#4CAF50',
              fill: false,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true
        }
      });
    }

    // Funções de autenticação
    function checkLogin() {
      auth.onAuthStateChanged(user => {
        if (user) {
          // Usuário logado
          showUserArea(user);
        } else {
          // Usuário não logado
          hideUserArea();
        }
      });
    }

    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          showUserArea(user);
          closeModal('loginModal');
          addHistoryEntry('login', `Usuário ${user.email} fez login`);
          showToast('Login realizado com sucesso!', 'success');
        })
        .catch((error) => {
          alert('Credenciais inválidas! ' + error.message);
          showToast('Erro ao fazer login!', 'error');
        });
    }

    function logout() {
      const user = auth.currentUser;
      if (user) {
        addHistoryEntry('logout', `Usuário ${user.email} fez logout`);
        showToast('Logout realizado com sucesso!', 'success');
      }
      auth.signOut()
        .then(() => {
          hideUserArea();
        })
        .catch((error) => {
          console.error("Erro ao fazer logout: ", error);
          showToast('Erro ao fazer logout!', 'error');
        });
    }

    function showUserArea(user) {
      document.getElementById('currentUser').textContent = user.email;
      
      // Atualizar avatar com iniciais
      const nameParts = user.email.split('@')[0].split('.');
      const initials = nameParts.map(part => part[0]).join('').toUpperCase();
      document.querySelector('.user-avatar').textContent = initials;
      
      // Verifica permissões
      checkPermissions(user);
       // Carrega dados do sistema para o usuário logado
      loadSystem();
    }

    function hideUserArea() {
      document.getElementById('currentUser').textContent = '';
      
      // Remove todas as restrições de permissão
      document.getElementById('configTab').classList.remove('hidden');
      document.getElementById('historyTab').classList.remove('hidden');
      // Limpa dados carregados
      sistema.produtos = [];
      sistema.historico = [];
      atualizarLista();
      loadHistory();
      updateKPIs();
    }

    function checkPermissions(user) {
      // Verificação simplificada de permissões
      // Implementação real dependeria de dados do Firestore
      if (user.email !== "admin@empresa.com") {
        document.getElementById('configTab').classList.add('hidden');
      }
    }

    // Funções de histórico
    async function addHistoryEntry(action, description) {
      const user = auth.currentUser;
      if (!user) return;
      
      const entry = {
        action,
        description,
        user: user.email,
                userId: user.uid,
        timestamp: new Date().toISOString()
      };
      
      try {
        await db.collection("history").add(entry);
        sistema.historico.unshift({ ...entry, id: "temp" });
        updateRecentUpdates();
        loadHistory();
      } catch (error) {
        console.error("Erro ao adicionar histórico:", error);
      }
    }

    async function loadHistory() {
      const historyContainer = document.getElementById('historyList');
      const filterType = document.getElementById('filterHistoryType').value;
      const filterUser = document.getElementById('filterHistoryUser').value;
      const filterDate = document.getElementById('filterHistoryDate').value;
      
      historyContainer.innerHTML = '';
      
      // Filtra o histórico
      let filteredHistory = sistema.historico;
      
      if (filterType !== 'all') {
        filteredHistory = filteredHistory.filter(entry => entry.action === filterType);
      }
      
      if (filterUser !== 'all') {
        filteredHistory = filteredHistory.filter(entry => entry.user === filterUser);
      }
      
      if (filterDate) {
        const filterDateObj = new Date(filterDate);
        filteredHistory = filteredHistory.filter(entry => {
          const entryDate = new Date(entry.timestamp);
          return entryDate.toDateString() === filterDateObj.toDateString();
        });
      }
      
      // Exibe no máximo 50 itens
      const recent = filteredHistory.slice(0, 50);
      
      if (recent.length === 0) {
        historyContainer.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum registro encontrado</div>';
        return;
      }
      
      recent.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div class="flex justify-between">
            <div class="font-medium">${entry.description}</div>
            <div class="text-sm text-gray-500">${new Date(entry.timestamp).toLocaleString()}</div>
          </div>
          <div class="text-sm text-gray-600">Usuário: ${entry.user}</div>
        `;
        historyContainer.appendChild(div);
      });
    }

    function updateRecentUpdates() {
      const updatesContainer = document.getElementById('recentUpdates');
      updatesContainer.innerHTML = '';
      
      const recent = sistema.historico.slice(0, 3);
      recent.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'text-sm';
        div.innerHTML = `
          <div>${entry.description}</div>
          <div class="text-xs text-gray-500">${new Date(entry.timestamp).toLocaleTimeString()}</div>
        `;
        updatesContainer.appendChild(div);
      });
    }

    // Funções de API
    function checkApiConnections() {
      // Verifica conexões com APIs e atualiza UI
      sistema.config.apiConfig.ml.connected = sistema.config.apiConfig.ml.clientId !== "";
      sistema.config.apiConfig.shopee.connected = sistema.config.apiConfig.shopee.apiKey !== "";
      
      updateApiStatusUI();
      updateKPIs();
    }

    function updateApiStatusUI() {
      // Atualiza indicadores de status na UI
      document.querySelectorAll('.api-status').forEach(el => {
        const platform = el.parentElement.textContent.includes('Mercado') ? 'ml' : 
                       el.parentElement.textContent.includes('Shopee') ? 'shopee' : 'magalu';
        
        el.classList.toggle('api-connected', sistema.config.apiConfig[platform]?.connected);
        el.classList.toggle('api-disconnected', !sistema.config.apiConfig[platform]?.connected);
      });
    }

    async function testMlConnection() {
      try {
        // Simulação de teste de conexão
        await new Promise(resolve => setTimeout(resolve, 1000));
        showToast('Conexão com Mercado Livre testada com sucesso!', 'success');
        sistema.config.apiConfig.ml.connected = true;
        updateApiStatusUI();
        addHistoryEntry('api_config', 'Teste de conexão com Mercado Livre realizado');
      } catch (error) {
        showToast('Falha na conexão com Mercado Livre!', 'error');
      }
    }

    async function testShopeeConnection() {
      try {
        // Simulação de teste de conexão
        await new Promise(resolve => setTimeout(resolve, 1000));
        showToast('Conexão com Shopee testada com sucesso!', 'success');
        sistema.config.apiConfig.shopee.connected = true;
        updateApiStatusUI();
        addHistoryEntry('api_config', 'Teste de conexão com Shopee realizado');
      } catch (error) {
        showToast('Falha na conexão com Shopee!', 'error');
      }
    }

    async function saveApiConfig() {
      sistema.config.apiConfig.ml = {
        clientId: document.getElementById('mlClientId').value,
        clientSecret: document.getElementById('mlClientSecret').value,
        connected: sistema.config.apiConfig.ml.connected
      };
      
      sistema.config.apiConfig.shopee = {
        apiKey: document.getElementById('shopeeApiKey').value,
        partnerId: document.getElementById('shopeePartnerId').value,
        connected: sistema.config.apiConfig.shopee.connected
      };
      
      try {
        await saveSystem();
        updateApiStatusUI();
        showToast('Configurações salvas com sucesso!', 'success');
        addHistoryEntry('api_config', 'Configurações de API atualizadas');
      } catch (error) {
        console.error("Erro ao salvar configurações:", error);
        showToast('Erro ao salvar configurações!', 'error');
      }
    }

    // Funções de backup
    async function createBackup() {
      try {
        const data = {
          produtos: sistema.produtos,
          historico: sistema.historico,
          usuarios: sistema.usuarios,
          config: sistema.config,
          timestamp: new Date().toISOString()
        };
        
        // Salvar backup no Firestore
        await db.collection("backups").add(data);
        
        // Atualiza UI
        document.getElementById('lastBackupInfo').textContent = `Último backup: ${new Date().toLocaleString('pt-BR')}`;
        addHistoryEntry('backup', 'Backup do sistema realizado');
        showToast('Backup criado com sucesso!', 'success');
      } catch (error) {
        console.error("Erro ao criar backup:", error);
        showToast('Erro ao criar backup!', 'error');
      }
    }

    async function restoreBackup() {
      try {
        const backupsSnapshot = await db.collection("backups").orderBy("timestamp", "desc").limit(1).get();
        if (backupsSnapshot.empty) {
          showToast('Nenhum backup encontrado!', 'warning');
          return;
        }
        
        const backupData = backupsSnapshot.docs[0].data();
        
        if (confirm('Tem certeza que deseja restaurar o backup? Todos os dados atuais serão substituídos.')) {
          // Restaurar dados do backup
          sistema.produtos = backupData.produtos || [];
          sistema.historico = backupData.historico || [];
          sistema.usuarios = backupData.usuarios || [];
          sistema.config = backupData.config || {
            backupAuto: true,
            apiConfig: {
              ml: { clientId: "", clientSecret: "", connected: false },
              shopee: { apiKey: "", partnerId: "", connected: false }
            }
          };
          
          // Salvar configurações restauradas
          await saveSystem();
          
          // Recarregar dados
          loadSystem();
          
          addHistoryEntry('backup', 'Sistema restaurado a partir de backup');
          showToast('Backup restaurado com sucesso!', 'success');
        }
      } catch (error) {
        console.error("Erro ao restaurar backup:", error);
        showToast('Erro ao restaurar backup!', 'error');
      }
    }

    // Funções de usuários
    async function loadUsers() {
      const usersTable = document.getElementById('usersTableBody');
      usersTable.innerHTML = '';
      
      // Atualiza filtro de usuários no histórico
      const userFilter = document.getElementById('filterHistoryUser');
      userFilter.innerHTML = '<option value="all">Todos os usuários</option>';
      
      sistema.usuarios.forEach(user => {
        // Adiciona à tabela
        const row = document.createElement('tr');
        row.className = 'border-b';
        row.innerHTML = `
          <td class="p-3">${user.nome || user.email}</td>
          <td class="p-3">${user.email}</td>
          <td class="p-3">
            <span class="${user.perfil === 'admin' ? 'admin-badge' : user.perfil === 'operador' ? 'operator-badge' : 'viewer-badge'} profile-badge">
              ${user.perfil}
            </span>
          </td>
          <td class="p-3">
            <button onclick="editUser('${user.id}')" class="btn-action btn-edit mr-2">
              <i class="fas fa-edit"></i>
            </button>
            ${user.email !== 'admin@empresa.com' ? `
            <button onclick="deleteUser('${user.id}')" class="btn-action btn-delete">
              <i class="fas fa-trash"></i>
            </button>
            ` : ''}
          </td>
        `;
        usersTable.appendChild(row);
        
        // Adiciona ao filtro
        const option = document.createElement('option');
        option.value = user.email;
        option.textContent = user.email;
        userFilter.appendChild(option);
      });
    }

    function openAddUserModal() {
      document.getElementById('newUserName').value = '';
      document.getElementById('newUserEmail').value = '';
      document.getElementById('newUserPassword').value = '';
      document.getElementById('newUserProfile').value = 'operador';
      openModal('addUserModal');
    }

    async function addNewUser() {
      const nome = document.getElementById('newUserName').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const senha = document.getElementById('newUserPassword').value;
      const perfil = document.getElementById('newUserProfile').value;
      
      if (!nome || !email || !senha) {
        showToast('Preencha todos os campos!', 'warning');
        return;
      }
      
      if (sistema.usuarios.some(u => u.email === email)) {
        showToast('Já existe um usuário com este e-mail!', 'warning');
        return;
      }
      
      const permissoes = perfil === 'admin' ? ['todos'] : 
                        perfil === 'operador' ? ['editar', 'exportar'] : 
                        ['visualizar'];
      
      try {
        // Criar usuário no Firebase Authentication
        const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
        
        // Salvar informações adicionais no Firestore
        const userData = {
          email,
          nome,
          perfil,
          permissoes
        };
        
        await db.collection("users").doc(userCredential.user.uid).set(userData);
        
        // Atualizar lista de usuários
        sistema.usuarios.push({ id: userCredential.user.uid, ...userData });
        loadUsers();
        closeModal('addUserModal');
        addHistoryEntry('user_add', `Usuário ${email} adicionado`);
        showToast('Usuário adicionado com sucesso!', 'success');
      } catch (error) {
        console.error("Erro ao adicionar usuário:", error);
        showToast('Erro ao adicionar usuário!', 'error');
      }
    }

    async function editUser(userId) {
      const user = sistema.usuarios.find(u => u.id === userId);
      if (!user) return;
      
      document.getElementById('newUserName').value = user.nome || '';
      document.getElementById('newUserEmail').value = user.email;
      document.getElementById('newUserEmail').readOnly = true;
      document.getElementById('newUserPassword').value = '';
      document.getElementById('newUserProfile').value = user.perfil || 'operador';
      
      // Mudar o texto do botão para "Atualizar"
      const btn = document.querySelector('#addUserModal button');
      btn.innerHTML = '<i class="fas fa-save mr-2"></i> Atualizar Usuário';
      btn.onclick = function() { updateUser(userId); };
      
      openModal('addUserModal');
    }

    async function updateUser(userId) {
      const nome = document.getElementById('newUserName').value.trim();
      const senha = document.getElementById('newUserPassword').value;
      const perfil = document.getElementById('newUserProfile').value;
      
      const userIndex = sistema.usuarios.findIndex(u => u.id === userId);
      if (userIndex === -1) return;
      
      sistema.usuarios[userIndex].nome = nome;
      sistema.usuarios[userIndex].perfil = perfil;
      
      sistema.usuarios[userIndex].permissoes = perfil === 'admin' ? ['todos'] : 
                                              perfil === 'operador' ? ['editar', 'exportar'] : 
                                              ['visualizar'];
      
      try {
        // Atualizar informações no Firestore
        await db.collection("users").doc(userId).update({
          nome: nome,
          perfil: perfil,
          permissoes: sistema.usuarios[userIndex].permissoes
        });
        
        // Se foi informada uma nova senha, atualizar no Authentication
        if (senha) {
          const user = auth.currentUser;
          if (user && user.uid === userId) {
            await user.updatePassword(senha);
          }
        }
        
        loadUsers();
        closeModal('addUserModal');
        addHistoryEntry('user_edit', `Usuário ${sistema.usuarios[userIndex].email} atualizado`);
        showToast('Usuário atualizado com sucesso!', 'success');
      } catch (error) {
        console.error("Erro ao atualizar usuário:", error);
        showToast('Erro ao atualizar usuário!', 'error');
      }
    }

    async function deleteUser(userId) {
      const user = sistema.usuarios.find(u => u.id === userId);
      if (!user) return;
      
      if (user.email === 'admin@empresa.com') {
        showToast('Não é possível remover o usuário administrador principal!', 'warning');
        return;
      }
      
      if (!confirm(`Tem certeza que deseja remover o usuário ${user.email}?`)) {
        return;
      }
      
      try {
        // Remover do Authentication
        await auth.currentUser.delete();
        
        // Remover do Firestore
        await db.collection("users").doc(userId).delete();
        
        // Atualizar lista local
        sistema.usuarios = sistema.usuarios.filter(u => u.id !== userId);
        loadUsers();
        addHistoryEntry('user_delete', `Usuário ${user.email} removido`);
        showToast('Usuário removido com sucesso!', 'success');
      } catch (error) {
        console.error("Erro ao remover usuário:", error);
        showToast('Erro ao remover usuário!', 'error');
      }
    }

    // Funções de precificação
    function calcular(plataforma) {
      const custo = parseFloat(document.getElementById("custo").value) || 0;
      const produto = document.getElementById("produto").value.trim();
      const sku = document.getElementById("sku").value.trim();
      
      if (!produto || custo <= 0) {
        showToast("Preencha o nome do produto e um custo válido!", "warning");
        return;
      }

      let totalPercentual = 0;
      let totalFixo = 0;
      const taxasDetalhadas = {};

      // Taxa da Plataforma
      const taxaSelect = document.getElementById(`${plataforma}_taxa_select`);
      const taxaInput = document.getElementById(`${plataforma}_taxa_custom`);
      const taxa = taxaInput.value.trim() !== '' ? 
                   parseFloat(taxaInput.value) : 
                   parseFloat(taxaSelect.value) || 0;
      totalPercentual += taxa;
      taxasDetalhadas['Taxas da Plataforma (%)'] = taxa;

      // Custo Fixo
      const fixoSelect = document.getElementById(`${plataforma}_fixo_select`);
      const fixoInput = document.getElementById(`${plataforma}_fixo_custom`);
      const fixo = fixoInput.value.trim() !== '' ? 
                   parseFloat(fixoInput.value) : 
                   parseFloat(fixoSelect.value) || 0;
      totalFixo += fixo;
      taxasDetalhadas['Custo Fixo Plataforma (R$)'] = fixo;

      // Demais campos
      const container = document.getElementById(`${plataforma}Campos`);
      const inputs = container.querySelectorAll('input[data-campo]');
      inputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        const campo = input.getAttribute('data-campo');
        const isPercentual = input.placeholder.includes('%');
        if (isPercentual) {
          totalPercentual += valor;
        } else {
          totalFixo += valor;
        }
        taxasDetalhadas[campo] = valor;
      });

      // Verificação de valores
      if (totalPercentual >= 100) {
        showToast("As taxas percentuais não podem somar 100% ou mais!", "warning");
        return;
      }

      // Calcular preço mínimo (sem lucro)
      const precoMinimo = ((custo + totalFixo) / (1 - totalPercentual / 100)).toFixed(2);
      document.getElementById(`preco_${plataforma}`).value = precoMinimo;
      
      // Calcular cenários de lucro
       const precoPromo = precoMinimo; // 0% de lucro
      const precoMedio = (precoMinimo * 1.05).toFixed(2); // 5% de lucro
      const precoIdeal = (precoMinimo * 1.10).toFixed(2); // 10% de lucro
      
      document.getElementById(`preco_${plataforma}_ideal`).textContent = `R$ ${precoIdeal}`;
      document.getElementById(`preco_${plataforma}_medio`).textContent = `R$ ${precoMedio}`;
      document.getElementById(`preco_${plataforma}_promo`).textContent = `R$ ${precoPromo}`;

      // Se está editando, atualiza o produto existente
      if (sistema.produtoEditando) {
        atualizarProduto(produto, sku, plataforma.toUpperCase(), precoMinimo, precoIdeal, precoMedio, precoPromo, custo, taxasDetalhadas);
        sistema.produtoEditando = null;
      } else {
        salvarProduto(produto, sku, plataforma.toUpperCase(), precoMinimo, precoIdeal, precoMedio, precoPromo, custo, taxasDetalhadas);
      }
    }

    async function salvarProduto(produto, sku, plataforma, precoMinimo, precoIdeal, precoMedio, precoPromo, custo, taxas) {
      const user = auth.currentUser;
      if (!user) {
        showToast("Usuário não autenticado!", "error");
        return;
      }

      const novoProduto = {
        produto,
        sku,
        plataforma, 
        precoMinimo,
        precoIdeal,
        precoMedio,
        precoPromo,
        custo,
        taxas,
        userId: user.uid,
        createdAt: new Date().toISOString()
      };

      try {
        await db.collection("products").add(novoProduto);
        
        // Atualizar lista local
        sistema.produtos.unshift({ ...novoProduto, id: "temp" });
        atualizarLista();
        
        // Mostrar feedback visual
        showToast("Produto salvo com sucesso!", "success");
        
        // Registrar no histórico
        addHistoryEntry('product_add', `Produto "${produto}" cadastrado para ${plataforma}`);
      } catch (error) {
        console.error("Erro ao salvar produto:", error);
        showToast("Erro ao salvar produto!", "error");
      }
    }

    async function atualizarProduto(produto, sku, plataforma, precoMinimo, precoIdeal, precoMedio, precoPromo, custo, taxas) {
      const user = auth.currentUser;
      if (!user) {
        showToast("Usuário não autenticado!", "error");
        return;
      }

      try {
        await db.collection("products").doc(sistema.produtoEditando.id).update({
          produto,
          sku,
          plataforma,
          precoMinimo,
          precoIdeal,
          precoMedio,
          precoPromo,
          custo,
          taxas
        });
        
        // Atualizar lista local
        const index = sistema.produtos.findIndex(item => item.id === sistema.produtoEditando.id);
        if (index !== -1) {
          sistema.produtos[index] = {
            ...sistema.produtos[index],
            produto,
            sku,
            plataforma,
            precoMinimo,
            precoIdeal,
            precoMedio,
            precoPromo,
            custo,
            taxas
          };
          atualizarLista();
          
          // Mostrar feedback visual
          showToast("Produto atualizado com sucesso!", "success");
          
          // Registrar no histórico
          addHistoryEntry('product_edit', `Produto "${produto}" atualizado`);
        }
      } catch (error) {
        console.error("Erro ao atualizar produto:", error);
        showToast("Erro ao atualizar produto!", "error");
      }
    }

    function atualizarLista() {
      const filtro = document.getElementById("filtroPlataforma").value;
      const container = document.getElementById("listaProdutos");
      
      container.innerHTML = "";
      
      const listaFiltrada = filtro === "Todas" ? 
          sistema.produtos : 
          sistema.produtos.filter(item => item.plataforma === filtro);
      
      if (listaFiltrada.length === 0) {
        container.innerHTML = `
          <div class="col-span-2 text-center py-10">
            <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-medium text-gray-500">Nenhum produto encontrado</h3>
            <p class="text-gray-400">Adicione produtos na aba de Precificação</p>
          </div>
        `;
        return;
      }
      
      listaFiltrada.forEach(item => {
        const div = document.createElement("div");
        div.className = "product-card";
        
        // Determinar classe de cor para a plataforma
        let platformClass = "";
        let platformName = "";
        switch(item.plataforma) {
          case "ML":
            platformClass = "platform-ml";
            platformName = "Mercado Livre";
            break;
          case "SHOPEE":
            platformClass = "platform-shopee";
            platformName = "Shopee";
            break;
          case "MAGALU":
            platformClass = "platform-magalu";
            platformName = "Magalu";
            break;
          case "SHEIN":
            platformClass = "platform-shein";
            platformName = "SHEIN";
            break;
        }
        
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-bold text-lg">${item.produto}</h3>
              ${item.sku ? `<div class="text-sm text-gray-500">SKU: ${item.sku}</div>` : ''}
              <div class="mt-1">
                <span class="${platformClass} platform-tag">${platformName}</span>
              </div>
            </div>
            <div class="text-right">
              <div class="text-gray-500 text-sm">Preço mínimo</div>
              <div class="product-price">R$ ${parseFloat(item.precoMinimo).toFixed(2)}</div>
            </div>
          </div>
          
          <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between">
            <div class="text-sm text-gray-500">
              <i class="far fa-calendar-alt"></i> ${new Date(item.createdAt).toLocaleDateString('pt-BR')}
            </div>
            <div class="flex space-x-2">
              <button onclick="verDetalhes('${item.id}')" class="btn-action btn-view">
                <i class="fas fa-eye"></i> Ver
              </button>
              <button onclick="editarProduto('${item.id}')" class="btn-action btn-edit">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button onclick="excluirProduto('${item.id}')" class="btn-action btn-delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      
      // Atualiza KPIs
      updateKPIs();
    }

    async function verDetalhes(id) {
      const produto = sistema.produtos.find(item => item.id === id);
      
      if (!produto) return;
      
      let html = `
        <h3 class="text-2xl font-bold mb-2">${produto.produto}</h3>
        ${produto.sku ? `<div class="text-gray-600 mb-2">SKU: ${produto.sku}</div>` : ''}
        <div class="flex items-center mb-6">
          <span class="${getPlatformClass(produto.plataforma)} platform-tag mr-3">${getPlatformName(produto.plataforma)}</span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="scenario-card scenario-promo">
            <div class="scenario-title">Sem Lucro (0%)</div>
            <div class="scenario-value">R$ ${produto.precoPromo}</div>
          </div>
          
          <div class="scenario-card scenario-medium">
              <div class="scenario-title">Lucro 5%</div>
            <div class="scenario-value">R$ ${produto.precoMedio}</div>
          </div>
          
          <div class="scenario-card scenario-ideal">
            <div class="scenario-title">Lucro 10%</div>
            <div class="scenario-value">R$ ${produto.precoIdeal}</div>
          </div>
          
          <div class="bg-gray-100 p-4 rounded-lg">
            <div class="font-semibold">Preço Mínimo</div>
            <div class="text-xl font-bold text-green-600">R$ ${produto.precoMinimo}</div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-gray-50 p-5 rounded-xl">
            <h4 class="font-semibold text-lg mb-4 pb-2 border-b">Informações Básicas</h4>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Custo do produto:</span>
                <span class="font-medium">R$ ${produto.custo}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Data de cadastro:</span>
                <span class="font-medium">${new Date(produto.createdAt).toLocaleDateString('pt-BR')}</span>
              </div>
            </div>
          </div>
          
          <div class="bg-gray-50 p-5 rounded-xl">
            <h4 class="font-semibold text-lg mb-4 pb-2 border-b">Detalhes das Taxas</h4>
            <div class="space-y-3">
      `;
      
      for (const [campo, valor] of Object.entries(produto.taxas)) {
        const unidade = campo.includes('%') ? '%' : 'R$';
        html += `
          <div class="flex justify-between">
            <span class="text-gray-600">${campo}:</span>
            <span class="font-medium">${valor} ${unidade}</span>
          </div>
        `;
      }
      
      html += `
            </div>
          </div>
        </div>
        
        <div class="mt-8 text-right">
          <button onclick="fecharModal()" class="btn-outline">
            Fechar
          </button>
        </div>
      `;
      
      document.getElementById("modalContent").innerHTML = html;
      document.getElementById("detalhesModal").style.display = "block";
    }

    function getPlatformClass(plataforma) {
      switch(plataforma) {
        case "ML": return "platform-ml";
        case "SHOPEE": return "platform-shopee";
        case "MAGALU": return "platform-magalu";
        case "SHEIN": return "platform-shein";
        default: return "";
      }
    }

    function getPlatformName(plataforma) {
      switch(plataforma) {
        case "ML": return "Mercado Livre";
        case "SHOPEE": return "Shopee";
        case "MAGALU": return "Magalu";
        case "SHEIN": return "SHEIN";
        default: return plataforma;
      }
    }

    function editarProduto(id) {
      const produto = sistema.produtos.find(item => item.id === id);
      
      if (!produto) return;
      
      // Preencher campos básicos
      document.getElementById("produto").value = produto.produto;
      document.getElementById("sku").value = produto.sku || '';
      document.getElementById("custo").value = produto.custo;
      
      // Preencher campos específicos da plataforma
      const plataforma = produto.plataforma.toLowerCase();
      
      // Taxa
      document.getElementById(`${plataforma}_taxa_custom`).value = produto.taxas['Taxas da Plataforma (%)'];
      document.getElementById(`${plataforma}_taxa_select`).selectedIndex = -1;
      
      // Fixo
      document.getElementById(`${plataforma}_fixo_custom`).value = produto.taxas['Custo Fixo Plataforma (R$)'];
      document.getElementById(`${plataforma}_fixo_select`).selectedIndex = -1;
      
      // Preencher outros campos
      const container = document.getElementById(`${plataforma}Campos`);
      const inputs = container.querySelectorAll('input[data-campo]');
      inputs.forEach(input => {
        const campo = input.getAttribute('data-campo');
        input.value = produto.taxas[campo] || '';
      });
      
      // Ativar aba de precificação
      document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      document.querySelector(`.tab-button[data-tab="precificacao"]`).classList.add("active");
      document.getElementById('precificacao').classList.add("active");
      
      // Salvar referência do produto que está sendo editado
      sistema.produtoEditando = produto;
      
      // Rolar para o topo
      window.scrollTo(0, 0);
    }

    async function excluirProduto(id) {
      if (!confirm('Tem certeza que deseja excluir este produto permanentemente?')) {
        return;
      }
      
      try {
        await db.collection("products").doc(id).delete();
        
        // Atualizar lista local
        sistema.produtos = sistema.produtos.filter(item => item.id !== id);
        atualizarLista();
        
        // Mostrar feedback visual
        showToast("Produto excluído com sucesso!", "success");
        
        // Registrar no histórico
        addHistoryEntry('product_delete', `Produto excluído`);
      } catch (error) {
        console.error("Erro ao excluir produto:", error);
        showToast("Erro ao excluir produto!", "error");
      }
    }

    function fecharModal() {
      document.getElementById("detalhesModal").style.display = "none";
    }

    function exportarExcel() {
      if (sistema.produtos.length === 0) {
        showToast("Nenhum produto para exportar!", "warning");
        return;
      }
      
      // Definir cabeçalhos
      const headers = [
        "Produto", 
        "SKU",
        "Plataforma", 
        "Custo (R$)", 
        "Preço Mínimo (R$)", 
        "Preço Ideal (R$)",
        "Preço Médio (R$)",
        "Preço Promo (R$)",
        "Data",
        "Taxas da Plataforma (%)",
        "Custo Fixo Plataforma (R$)",
        "Frete (R$)",
        "Taxa de Transação (%)",
        "Taxa de Transferência (%)",
        "Taxa de Antecipação (%)",
        "Custos Variáveis (R$)",
        "Imposto (%)",
        "Comissão do Vendedor (%)"
      ];
      
      // Criar conteúdo CSV
      let csvContent = headers.join(";") + "\n";
      
      // Adicionar dados
      sistema.produtos.forEach(item => {
        const row = [
          `"${item.produto}"`,
          `"${item.sku || ''}"`,
          getPlatformName(item.plataforma),
          item.custo,
          item.precoMinimo,
          item.precoIdeal,
          item.precoMedio,
          item.precoPromo,
          `"${new Date(item.createdAt).toLocaleDateString('pt-BR')}"`,
          item.taxas['Taxas da Plataforma (%)'] || '0',
          item.taxas['Custo Fixo Plataforma (R$)'] || '0',
          item.taxas['Frete (R$)'] || '0',
          item.taxas['Taxa de Transação (%)'] || '0',
          item.taxas['Taxa de Transferência (%)'] || '0',
          item.taxas['Taxa de Antecipação (%)'] || '0',
          item.taxas['Custos Variáveis (R$)'] || '0',
          item.taxas['Imposto (%)'] || '0',
          item.taxas['Comissão do Vendedor (%)'] || '0'
        ];
        
        csvContent += row.join(";") + "\n";
      });
      
      // Criar e baixar arquivo
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "precificacao_produtos.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      addHistoryEntry('export', 'Exportação para Excel realizada');
      showToast('Exportação para Excel realizada com sucesso!', 'success');
    }

    function exportarPDF() {
      if (sistema.produtos.length === 0) {
        showToast("Nenhum produto para exportar!", "warning");
        return;
      }
      
      // Criar novo documento PDF
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });
      
      // Título do documento
      doc.setFontSize(18);
      doc.text("Relatório de Precificação de Produtos", 105, 15, { align: 'center' });
      doc.setFontSize(12);
      doc.setTextColor(100);
      doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
      
      // Preparar dados da tabela
      const headers = [
        "Produto", 
        "SKU",
        "Plataforma", 
        "Custo (R$)", 
        "Preço Mínimo (R$)", 
        "Preço Ideal (R$)",
        "Preço Médio (R$)",
        "Preço Promo (R$)",
        "Data"
      ];
      
      const data = sistema.produtos.map(item => [
        item.produto,
        item.sku || '-',
        getPlatformName(item.plataforma),
        parseFloat(item.custo).toFixed(2),
        parseFloat(item.precoMinimo).toFixed(2),
        parseFloat(item.precoIdeal).toFixed(2),
        parseFloat(item.precoMedio).toFixed(2),
        parseFloat(item.precoPromo).toFixed(2),
        new Date(item.createdAt).toLocaleDateString('pt-BR')
      ]);
      
      // Criar tabela
      doc.autoTable({
        head: [headers],
        body: data,
        startY: 30,
        theme: 'grid',
        styles: { 
          fontSize: 8,
          cellPadding: 2,
          valign: 'middle'
        },
        headStyles: {
          fillColor: [76, 175, 80],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240]
        },
        margin: { top: 30 }
      });
      
      // Salvar PDF
      doc.save(`precificacao_produtos_${new Date().toISOString().slice(0, 10)}.pdf`);
      
      addHistoryEntry('export', 'Exportação para PDF realizada');
      showToast('Exportação para PDF realizada com sucesso!', 'success');
    }

 
    function importShopeeFile() {
      const fileInput = document.getElementById('shopeeFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Selecione um arquivo primeiro!', 'warning');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Assume que os dados estão na primeira planilha
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        
        // Converter para JSON
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        if (jsonData.length < 2) {
          showToast('Planilha vazia ou formato inválido!', 'warning');
          return;
        }
        
        // Extrair cabeçalhos
        const headers = jsonData[0];
        
        // Processar linhas de dados
        const products = [];
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (row.length === 0) continue;
          
          const product = {};
          for (let j = 0; j < headers.length; j++) {
            product[headers[j]] = row[j];
          }
          products.push(product);
        }
        
        // Armazenar dados importados
        sistema.importedShopeeData = products;
        sistema.originalShopeeData = JSON.parse(JSON.stringify(products)); // Cópia profunda para backup
        
        // Exibir dados na tabela
        displayImportedProducts(products);
        
        // Mostrar seção de produtos importados
        document.getElementById('importedShopeeProducts').style.display = 'block';
        
        addHistoryEntry('import', `${products.length} produtos importados da Shopee`);
        showToast(`${products.length} produtos importados com sucesso!`, 'success');
      };
      
      reader.readAsArrayBuffer(file);
    }

    function displayImportedProducts(products) {
      const tableBody = document.getElementById('importedProductsTableBody');
      tableBody.innerHTML = '';
      
      products.forEach(product => {
        const row = document.createElement('tr');
        
        // Mapear campos importantes para exibição
        row.innerHTML = `
          <td>${product['ID do produto'] || ''}</td>
          <td>${product['Nome do Produto. (Opcional)'] || ''}</td>
          <td>${product['Nº de Ref. Parent SKU. (Opcional)'] || ''}</td>
          <td>${product['ID de variação'] || ''}</td>
          <td>${product['Variação de nome. (Opcional)'] || ''}</td>
          <td>${product['Nº de Ref. SKU. (Opcional)'] || ''}</td>
          <td>${product['Preço original (opcional)'] || ''}</td>
          <td class="font-bold">${product['Preço de desconto'] || ''}</td>
        `;
        
        tableBody.appendChild(row);
      });
    }

    function applyPriceUpdate(type) {
      if (!sistema.importedShopeeData) {
        showToast('Importe os dados da Shopee primeiro!', 'warning');
        return;
      }
      
      // Obter todos os produtos do sistema
      const systemProducts = sistema.produtos;
      let productsWithNoSku = 0;
      let productsNotFound = 0;
      let productsUpdated = 0;
      
      // Percorrer produtos importados
      for (const importedProduct of sistema.importedShopeeData) {
        // Determinar o SKU a ser buscado (primeiro tenta SKU, depois Parent SKU)
        const sku = importedProduct['Nº de Ref. SKU. (Opcional)'] ? 
                   String(importedProduct['Nº de Ref. SKU. (Opcional)']).trim() : null;
        
        const parentSku = importedProduct['Nº de Ref. Parent SKU. (Opcional)'] ? 
                         String(importedProduct['Nº de Ref. Parent SKU. (Opcional)']).trim() : null;
        
        const searchSku = sku || parentSku;
        
        if (!searchSku) {
          console.log('Produto sem SKU identificável:', importedProduct['Nome do Produto. (Opcional)'] || 'Sem nome');
          productsWithNoSku++;
          continue;
        }
        
        // Buscar produto correspondente no sistema (comparação exata de strings)
        const systemProduct = systemProducts.find(p => {
          const systemSku = p.sku ? String(p.sku).trim() : '';
          return systemSku === searchSku;
        });
        
        if (!systemProduct) {
          console.log('Produto não encontrado no sistema:', searchSku, importedProduct['Nome do Produto. (Opcional)'] || 'Sem nome');
          productsNotFound++;
          continue;
        }
        
        // Aplicar preço conforme o tipo selecionado, formatando com 2 casas decimais
        let priceToApply = 0;
        switch(type) {
          case 'promo':
            priceToApply = parseFloat(systemProduct.precoPromo).toFixed(2);
            break;
          case 'medium':
            priceToApply = parseFloat(systemProduct.precoMedio).toFixed(2);
            break;
          case 'ideal':
            priceToApply = parseFloat(systemProduct.precoIdeal).toFixed(2);
            break;
        }
        
        importedProduct['Preço de desconto'] = priceToApply;
        productsUpdated++;
      }
      
      // Atualizar exibição
      displayImportedProducts(sistema.importedShopeeData);
      
      // Feedback visual detalhado
      showToast(`Atualizados ${productsUpdated} preços! Não encontrados: ${productsNotFound}, Sem SKU: ${productsWithNoSku}`, 'success');
      
      // Registrar no histórico
      addHistoryEntry('price_update', `${productsUpdated} preços atualizados na planilha Shopee`);
    }

    function exportShopeeFile() {
      if (!sistema.importedShopeeData) {
        showToast('Nenhum dado para exportar!', 'warning');
        return;
      }
      
      // Recriar estrutura original com cabeçalhos
      const headers = Object.keys(sistema.originalShopeeData[0]);
      const dataToExport = [headers];
      
      // Adicionar dados modificados mantendo a estrutura original
      sistema.importedShopeeData.forEach(product => {
        const row = headers.map(header => product[header]);
        dataToExport.push(row);
      });
      
      // Criar planilha
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Promoções");
      
      // Exportar
      XLSX.writeFile(wb, `promocoes_shopee_${new Date().toISOString().slice(0, 10)}.xlsx`);
      
      addHistoryEntry('export', 'Planilha Shopee exportada');
      showToast('Planilha Shopee exportada com sucesso!', 'success');
    }

    // Funções auxiliares
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
    }

    function openRecoverModal() {
      closeModal('loginModal');
      openModal('recoverModal');
    }

    function sendRecovery() {
      const email = document.getElementById('recoverEmail').value;
      if (!email.includes('@')) {
        showToast('E-mail inválido!', 'warning');
        return;
      }
      
      // Simulação de envio
      showToast(`Link de recuperação enviado para ${email}`, 'success');
      closeModal('recoverModal');
      addHistoryEntry('recovery', `Solicitação de recuperação de senha para ${email}`);
    }

    function setupEventListeners() {
      // Login/logout
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // Tabs
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
        });
      });
      
      // Filtros
      document.getElementById('filterHistoryType').addEventListener('change', loadHistory);
      document.getElementById('filterHistoryUser').addEventListener('change', loadHistory);
      document.getElementById('filterHistoryDate').addEventListener('change', loadHistory);
      document.getElementById('filtroPlataforma').addEventListener('change', atualizarLista);
      
      // Configurações
      document.getElementById('autoBackup').addEventListener('change', function() {
        sistema.config.backupAuto = this.checked;
        saveSystem();
      });
      
      document.getElementById('backupFrequency').addEventListener('change', function() {
        sistema.config.backupFrequency = this.value;
        saveSystem();
      });
    }

    function updateUI() {
      // Atualiza checkbox de backup automático
      document.getElementById('autoBackup').checked = sistema.config.backupAuto;
      document.getElementById('backupFrequency').value = sistema.config.backupFrequency || 'daily';
      
      // Atualiza status de conexão
      updateApiStatusUI();
      
      // Atualiza histórico recente
      updateRecentUpdates();
    }

    function updateKPIs() {
      const totalProducts = sistema.produtos.length;
      
      // Calcula margem média
      let avgMargin = 0;
      if (sistema.produtos.length > 0) {
        const totalMargin = sistema.produtos.reduce((sum, produto) => {
          const custo = parseFloat(produto.custo);
          const precoMinimo = parseFloat(produto.precoMinimo);
          return sum + ((precoMinimo - custo) / precoMinimo * 100);
        }, 0);
        avgMargin = (totalMargin / sistema.produtos.length).toFixed(2);
      }
      
      // Conta conexões ativas
      const activeConnections = Object.values(sistema.config.apiConfig)
        .filter(api => api.connected).length;
      
      document.getElementById('totalProducts').textContent = totalProducts;
      document.getElementById('avgMargin').textContent = `${avgMargin}%`;
      document.getElementById('activeConnections').textContent = `${activeConnections}/3`;
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }
    
    function showToast(message, type) {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-exclamation-triangle'}"></i>
        ${message}
      `;
      
      toastContainer.appendChild(toast);
      
      // Remover toast após animação
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Verificações periódicas
    setInterval(() => {
      checkApiConnections();
      updateKPIs();
      
      // Backup automático
      if (sistema.config.backupAuto) {
        const now = new Date();
        const lastBackup = localStorage.getItem("lastBackupTime");
        const lastBackupTime = lastBackup ? new Date(lastBackup) : null;
        
        let needsBackup = false;
        if (!lastBackupTime) {
          needsBackup = true;
        } else {
          const diffHours = (now - lastBackupTime) / (1000 * 60 * 60);
          
          if (sistema.config.backupFrequency === 'daily' && diffHours >= 24) {
            needsBackup = true;
          } else if (sistema.config.backupFrequency === 'weekly' && diffHours >= 168) {
            needsBackup = true;
          } else if (sistema.config.backupFrequency === 'monthly' && diffHours >= 720) {
            needsBackup = true;
          }
        }
        
        if (needsBackup) {
          createBackup();
          localStorage.setItem("lastBackupTime", now.toISOString());
        }
      }
    }, 300000); // 5 minutos
  </script>
</body>
</html>
