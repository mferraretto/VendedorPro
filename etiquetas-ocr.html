
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Etiquetas Shopee com OCR</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div id="sidebar-container"></div>
  <div id="navbar-container"></div>
  <div class="main-content p-4 space-y-4">
   <h2>ðŸ“¦ Editor Visual de Etiquetas Shopee</h2>
  <input type="file" id="pdfInput" accept="application/pdf" />
  <button onclick="processar()">ðŸ“¥ Processar e Gerar PDF</button>
  <div class="status" id="status"></div>
  <canvas id="pdfCanvas"></canvas>
 </div>
  
   <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

    async function processar() {
      const status = document.getElementById("status");
      const pdfFile = document.getElementById("pdfInput").files[0];
      if (!pdfFile) return alert("Envie o arquivo PDF.");

      status.textContent = "ðŸ“¸ Lendo PDF...";
      const arrayBuffer = await pdfFile.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const novoPdf = await PDFLib.PDFDocument.create();
      const canvas = document.getElementById("pdfCanvas");
      const ctx = canvas.getContext("2d");

      for (let i = 0; i < pdf.numPages; i++) {
        const page = await pdf.getPage(i + 1);
        const scale = 3;
        const viewport = page.getViewport({ scale });

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: ctx, viewport }).promise;

        const largura = canvas.width;
        const altura = canvas.height;

        const colWidth = largura / 2;
        const rowHeight = altura / 2;

        const pares = [
          { etiqueta: { x: 0, y: 0 }, checklist: { x: 0, y: rowHeight / 1 } }, // coluna esquerda
          { etiqueta: { x: colWidth, y: 0 }, checklist: { x: colWidth, y: rowHeight / 1 } }  // coluna direita
        ];

        for (const par of pares) {
          // CORTA ETIQUETA (linha de cima)
const etCanvas = document.createElement("canvas");
etCanvas.width = colWidth;
etCanvas.height = rowHeight; // âœ… agora pega metade da pÃ¡gina (altura da linha de etiqueta)
const etCtx = etCanvas.getContext("2d");
etCtx.drawImage(canvas, par.etiqueta.x, par.etiqueta.y, colWidth, rowHeight, 0, 0, colWidth, rowHeight);


          // CORTA CHECKLIST (linha de baixo)
          const chkCanvas = document.createElement("canvas");
          chkCanvas.width = colWidth;
          chkCanvas.height = rowHeight / 2;
          const chkCtx = chkCanvas.getContext("2d");
          chkCtx.drawImage(canvas, par.checklist.x, par.checklist.y, colWidth, rowHeight / 2, 0, 0, colWidth, rowHeight / 2);

          // OCR do checklist (linha inferior)
          const { data: { text } } = await Tesseract.recognize(chkCanvas, "eng");
console.log("ðŸ“„ Texto OCR completo do checklist:\n", text);

          // ExtraÃ§Ã£o de dados
let pedido = null;

          const matchPedido = text.match(/([0-9A-Z]{12,})/);
          if (matchPedido) pedido = matchPedido[1].trim();

// Pega a primeira linha que comeÃ§a com 1 (ex: "1 Nome do Produto Qtd")
const linhas = text.split('\n').map(l => l.trim()).filter(Boolean);

let linhaProduto = "Produto nÃ£o identificado";
for (let i = 0; i < linhas.length; i++) {
  if (/^1\s+/.test(linhas[i])) {
    // Pega a linha inteira a partir do caractere 1 (Ã­ndice 1)
    linhaProduto = linhas[i].substring(1).trim();
    break;
  }
}
// IdentificaÃ§Ã£o do SKU com base em padrÃµes
let sku = "SKU nÃ£o identificado";
const palavras = linhaProduto.split(/\s+/);
const possiveisSkus = palavras.filter(p =>
  /^[A-Z]{1,}[0-9]{0,2}$/.test(p) ||    // T6, B6, A12
  /^[A-Z]{4,}$/.test(p)                // BOLEIRAS, SUPORTE
);
let ultimaQtd = palavras[palavras.length - 1];
if (!/^\d+$/.test(ultimaQtd)) ultimaQtd = ""; // Se nÃ£o for nÃºmero, ignora

if (possiveisSkus.length > 0) {
  sku = `${possiveisSkus[0]} ${ultimaQtd}`.trim();
}
// RodapÃ© final simplificado
// Define o conteÃºdo do rodapÃ©
const rodape = `Pedido: ${pedido}\n${linhaProduto}\nSKU: ${sku}`;

// Define tamanho base da fonte e ajusta se necessÃ¡rio
let fontSize = 12;
const textoLimpo = rodape.replace(/\n/g, " "); // conta sem as quebras
if (textoLimpo.length > 60) fontSize = 10;
if (textoLimpo.length > 90) fontSize = 8;

// Desenha a imagem da etiqueta
const imgBytes = await fetch(etCanvas.toDataURL("image/png")).then(res => res.arrayBuffer());
const imgEmbed = await novoPdf.embedPng(imgBytes);

const larguraPagina = 283.46;
const alturaPagina = 425.2;
const larguraEtiqueta = 255;
const alturaEtiqueta = 359;
const margemX = (larguraPagina - larguraEtiqueta) / 2;
const margemY = alturaPagina - alturaEtiqueta - 15;

const pag = novoPdf.addPage([larguraPagina, alturaPagina]);
pag.drawImage(imgEmbed, {
  x: margemX,
  y: margemY,
  width: larguraEtiqueta,
  height: alturaEtiqueta,
});

// Desenha o rodapÃ© com tamanho ajustado
pag.drawText(rodape, {
  x: 30,
  y: 35,
  size: fontSize,
  lineHeight: fontSize + 2,
  color: PDFLib.rgb(0, 0, 0),
});

console.log("âœ… RodapÃ© inserido:", rodape);


      const pdfFinal = await novoPdf.save();
      const blob = new Blob([pdfFinal], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "etiquetas_editadas.pdf";
      a.click();
      status.textContent = "âœ… PDF gerado com sucesso!";
    }
  

  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
</script>

  <script src="shared.js"></script>
</body>
</html>
