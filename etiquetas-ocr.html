<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etiquetas Shopee com OCR</title>
    <!-- Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Font Inter para tipografia -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados */
        body { font-family: 'Inter', sans-serif; }
        .main-content { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        .glass-card { background: rgba(255, 255, 255, 0.85); box-shadow: 0 4px 32px rgba(72, 187, 255, 0.07); backdrop-filter: blur(8px); border: 1px solid rgba(200, 230, 255, 0.18); }
        .progress-bar-bg { background: linear-gradient(90deg, #e2ebf0 0%, #cfd9df 100%); box-shadow: 0 2px 16px rgba(0,0,0,0.08); }
        .progress-bar-fill { background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%); transition: width 0.3s cubic-bezier(.4,0,.2,1); }
        .btn-main { background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%); transition: background 0.2s, transform 0.2s; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.08); }
        .btn-main:hover { background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%); transform: translateY(-2px) scale(1.03); }
        .modal { display: none; } /* Oculta a modal por padrão */
    </style>
    <!-- Bibliotecas essenciais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Define as variáveis globais do Firebase
        let db, auth, storage;
        let userId = null;
        let isAuthReady = false;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Inicializa o Firebase e autentica o usuário.
         */
        async function initFirebaseAndAuth() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Data persistence will not be available.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                    } else {
                        userId = null;
                        console.log("Usuário não autenticado.");
                    }
                    isAuthReady = true;
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro ao inicializar o Firebase ou autenticar:", error);
                showModal("Erro", "Não foi possível conectar ao banco de dados. O salvamento de arquivos está desativado.");
            }
        }
        
        // Exponha as funções globais necessárias
        window.initFirebaseAndAuth = initFirebaseAndAuth;
        window.getDb = () => db;
        window.getAuth = () => auth;
        window.getUserId = () => userId;
        window.isAuthReady = () => isAuthReady;
        window.serverTimestamp = serverTimestamp;
        window.getAppId = () => appId;
        window.getStorage = () => storage;
    </script>
</head>
<body class="bg-gradient-to-tr from-cyan-100 via-blue-50 to-cyan-200 text-gray-800 min-h-screen">
    <div class="main-content p-4 w-full">
        <div class="glass-card w-full max-w-2xl mx-auto rounded-xl p-8 md:p-12 shadow-xl">
            <!-- Cabeçalho -->
            <div class="flex items-center gap-4 mb-6">
                <span class="text-4xl text-blue-700"><i class="fa-solid fa-barcode"></i></span>
                <h2 class="text-3xl font-bold text-blue-700 tracking-tight">Editor de Etiquetas Shopee</h2>
            </div>
            
            <!-- Campo de upload de PDF -->
            <div class="mb-6">
                <label for="pdfInput" class="block text-lg font-medium mb-2 text-gray-700">
                    <i class="fa-solid fa-file-pdf text-red-500"></i> Envie seu arquivo PDF:
                </label>
                <input type="file" id="pdfInput" accept="application/pdf" class="block w-full text-sm text-gray-700 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none focus:border-blue-400 p-3" />
            </div>
            
            <!-- Botões de ação -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button class="btn-main w-full" onclick="processar()">
                    <i class="fa-solid fa-magic-wand-sparkles mr-2"></i> Processar e Gerar PDF
                </button>
                <button class="btn-main w-full bg-blue-500" onclick="doOcrOnCanvas()">
                    <i class="fa-solid fa-spell-check mr-2"></i> Extrair Texto da Etiqueta
                </button>
            </div>

            <!-- Barra de progresso -->
            <div id="progressBar" class="mt-6 progress-bar-bg rounded-full h-4 relative overflow-hidden" style="display:none;">
                <div id="progressFill" class="progress-bar-fill h-full text-white text-xs font-semibold flex items-center justify-center transition-all duration-300 ease-in-out" style="width:0%;">
                    <span id="progressText"></span>
                </div>
            </div>
            
            <!-- Área de status e resultados -->
            <div class="mt-6 flex flex-col gap-4">
                <div class="text-blue-700 font-medium min-h-[24px]" id="status"></div>
                <!-- Área para exibir o resultado do OCR -->
                <div id="ocrResult" class="hidden bg-gray-100 p-4 rounded-lg shadow-inner">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Texto Extraído (OCR)</h3>
                    <pre class="whitespace-pre-wrap text-sm text-gray-600 font-mono"></pre>
                </div>
            </div>

            <!-- Canvas para visualização da etiqueta processada -->
            <canvas id="pdfCanvas" class="mt-8 mx-auto border rounded-lg shadow-lg" style="display:none; max-width:100%;"></canvas>
            
            <!-- Rodapé -->
            <div class="flex justify-center mt-8">
                <span class="text-xs text-gray-500">
                    Desenvolvido com <i class="fa-solid fa-heart text-red-500"></i> &nbsp;·&nbsp;
                    <a href="https://github.com/matheusferraretto" target="_blank" class="text-blue-500 hover:underline">Matheus Ferraretto</a> &nbsp;·&nbsp;
                    <i class="fa-solid fa-robot"></i>
                </span>
            </div>
        </div>
    </div>
    
    <!-- Modal de Mensagens -->
    <div id="messageModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm transform transition-all duration-300 scale-95">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="modalMessage" class="text-gray-600"></p>
            <div class="mt-6 flex justify-end">
                <button onclick="hideModal()" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Script principal da aplicação -->
    <script type="text/javascript">
        // Variáveis globais para o estado da aplicação
        let lastProcessedCanvas = null;

        // Funções para a modal
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        /**
         * Função principal para processar o arquivo PDF.
         * Renderiza cada página em um canvas, e depois gera um novo PDF.
         */
        async function processar() {
            const progressBar = document.getElementById("progressBar");
            const progressFill = document.getElementById("progressFill");
            const progressText = document.getElementById("progressText");
            const status = document.getElementById("status");
            const pdfFile = document.getElementById("pdfInput").files[0];

            if (!pdfFile) {
                return showModal("Atenção", "Por favor, selecione um arquivo PDF primeiro.");
            }

            progressBar.style.display = "block";
            progressFill.style.width = "0%";
            status.textContent = "Iniciando processamento do PDF...";

            try {
                // Carrega o PDF original
                const arrayBuffer = await pdfFile.arrayBuffer();
                const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const novoPdf = await PDFLib.PDFDocument.create();
                const canvas = document.getElementById("pdfCanvas");
                const ctx = canvas.getContext("2d");

                canvas.style.display = "block";
                status.textContent = "Processando páginas...";

                for (let i = 0; i < pdfDoc.numPages; i++) {
                    const pageNumber = i + 1;
                    const progress = Math.round((pageNumber / pdfDoc.numPages) * 100);
                    progressFill.style.width = progress + "%";
                    progressText.textContent = `Página ${pageNumber} de ${pdfDoc.numPages}`;

                    const page = await pdfDoc.getPage(pageNumber);
                    const scale = 4; // Escala reduzida para melhorar o desempenho
                    const viewport = page.getViewport({ scale });

                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({ canvasContext: ctx, viewport }).promise;
                    
                    // Converte a página renderizada para uma imagem e a insere no novo PDF
                    const imgData = canvas.toDataURL("image/png");
                    const imgBytes = await fetch(imgData).then(res => res.arrayBuffer());
                    const imgEmbed = await novoPdf.embedPng(imgBytes);

                    const { width, height } = imgEmbed.scale(0.5);
                    const newPage = novoPdf.addPage();
                    newPage.drawImage(imgEmbed, { x: 50, y: 50, width, height });
                }

                progressFill.style.width = "100%";
                progressText.textContent = "100% Concluído!";
                status.textContent = "PDF gerado. Salvando e baixando...";

                const pdfFinal = await novoPdf.save();
                const blob = new Blob([pdfFinal], { type: "application/pdf" });

                // Salva no Cloud Storage se o usuário estiver autenticado e o Firebase estiver pronto
                const userId = window.getUserId();
                const appId = window.getAppId();
                if (userId && window.isAuthReady() && window.getDb() && window.getStorage()) {
                    try {
                        const db = window.getDb();
                        const storage = window.getStorage();
                        const fileName = `etiquetas_editadas_${Date.now()}.pdf`;
                        const storagePath = `artifacts/${appId}/users/${userId}/etiquetas_processadas/${fileName}`;
                        const storageRef = ref(storage, storagePath);
                        
                        // Upload do arquivo para o Cloud Storage
                        await uploadBytes(storageRef, blob);
                        const downloadURL = await getDownloadURL(storageRef);

                        // Salva os metadados no Firestore
                        const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/etiquetaenvio`), {
                            name: fileName,
                            url: downloadURL,
                            createdAt: window.serverTimestamp()
                        });
                        console.log("Documento de metadados salvo com ID:", docRef.id);
                        console.log("Arquivo de PDF salvo em:", downloadURL);

                    } catch (e) {
                        console.error("Erro ao salvar no Firebase Storage ou Firestore:", e);
                        showModal("Erro", "O arquivo foi gerado, mas não pudemos salvá-lo no banco de dados. Tente fazer o download manualmente.");
                    }
                } else {
                    console.warn("Usuário não autenticado ou Firebase não está pronto. O arquivo não será salvo no Cloud Storage ou Firestore.");
                }

                // Faz o download do arquivo
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "etiquetas_editadas.pdf";
                a.click();
                URL.revokeObjectURL(url);

                status.textContent = "✅ PDF gerado e baixado com sucesso!";
                
                // Salva o último canvas processado para o OCR
                lastProcessedCanvas = canvas;

            } catch (error) {
                console.error("Erro durante o processamento do PDF:", error);
                status.textContent = "❌ Ocorreu um erro ao processar o PDF.";
                showModal("Erro", `Não foi possível processar o PDF. Detalhes: ${error.message}`);
            } finally {
                setTimeout(() => {
                    progressBar.style.display = "none";
                }, 2000);
            }
        }

        /**
         * Realiza o Reconhecimento Óptico de Caracteres (OCR) no último canvas processado.
         */
        async function doOcrOnCanvas() {
            if (!lastProcessedCanvas) {
                return showModal("Atenção", "Por favor, processe um PDF primeiro para extrair o texto.");
            }

            const ocrResultDiv = document.getElementById('ocrResult');
            const ocrResultPre = ocrResultDiv.querySelector('pre');
            const status = document.getElementById("status");

            ocrResultDiv.classList.add('hidden');
            ocrResultPre.textContent = '';
            status.textContent = "Iniciando reconhecimento de texto...";

            try {
                // Inicializa o Tesseract.js com uma barra de progresso
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            status.textContent = `Reconhecendo texto... ${progress}%`;
                        } else {
                            status.textContent = `Status OCR: ${m.status}`;
                        }
                    }
                });

                // Carrega a língua portuguesa
                await worker.loadLanguage('por');
                await worker.initialize('por');
                
                // Executa o OCR no canvas
                const { data: { text } } = await worker.recognize(lastProcessedCanvas);
                
                ocrResultDiv.classList.remove('hidden');
                ocrResultPre.textContent = text;
                status.textContent = "✅ Reconhecimento de texto concluído!";
                await worker.terminate();

            } catch (error) {
                console.error("Erro no OCR:", error);
                status.textContent = "❌ Ocorreu um erro ao extrair o texto.";
                showModal("Erro no OCR", `Não foi possível extrair o texto da imagem. Detalhes: ${error.message}`);
            }
        }

        // Inicializa o Firebase ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.initFirebaseAndAuth === 'function') {
                window.initFirebaseAndAuth();
            } else {
                console.error("Firebase init function not available. Check script import.");
            }
        });
    </script>
</body>
</html>
