<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Etiquetas Shopee com OCR</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Barra de progresso customizada */
    .progress-bar-bg {
      background: linear-gradient(90deg, #cfd9df 0%, #e2ebf0 100%);
      border-radius: 9999px;
      height: 1.5rem;
      overflow: hidden;
      box-shadow: 0 2px 16px rgba(0,0,0,0.08);
    }
    .progress-bar-fill {
      background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%);
      height: 100%;
      border-radius: 9999px 0 0 9999px;
      transition: width 0.3s cubic-bezier(.4,0,.2,1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 500;
      font-size: 1rem;
    }
    /* Card Glassmorphism */
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 4px 32px rgba(72, 187, 255, 0.07);
      border-radius: 1rem;
      padding: 2.5rem 2rem 2rem 2rem;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(200, 230, 255, 0.18);
      max-width: 520px;
      margin: 1.5rem auto;
    }
    .main-content {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .btn-main {
      background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%);
      color: #fff;
      font-weight: 500;
      border-radius: 0.75rem;
      padding: 0.75rem 2.5rem;
      margin-top: 1rem;
      font-size: 1.1rem;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.08);
      border: none;
      outline: none;
      transition: background 0.2s, transform 0.2s;
    }
    .btn-main:hover {
      background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
      transform: translateY(-2px) scale(1.03);
    }
    #status {
      min-height: 2rem;
    }
    @media (max-width: 600px) {
      .glass-card {
        padding: 1.5rem 0.6rem 1.5rem 0.6rem;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-cyan-100 via-blue-50 to-cyan-200 text-gray-800 min-h-screen">
  <div id="sidebar-container"></div>
  <div id="navbar-container"></div>
  <div class="main-content p-4 w-full">
    <div class="glass-card shadow-xl">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl"><i class="fa-solid fa-barcode"></i></span>
        <h2 class="text-2xl font-bold text-blue-700 tracking-tight">Editor Visual de Etiquetas Shopee</h2>
      </div>
      <div class="mb-4">
        <label for="pdfInput" class="block text-lg font-medium mb-2 text-gray-700">
          <i class="fa-solid fa-file-pdf text-red-500"></i> Envie seu arquivo PDF:
        </label>
        <input type="file" id="pdfInput" accept="application/pdf" class="block w-full text-sm text-gray-700 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none focus:border-blue-400 p-2" />
      </div>
      <button class="btn-main w-full" onclick="processar()">
        <i class="fa-solid fa-magic-wand-sparkles mr-2"></i>
        Processar e Gerar PDF
      </button>
      <div class="mt-6">
        <div class="progress-bar-bg" id="progressBar" style="display:none;">
          <div class="progress-bar-fill" id="progressFill" style="width:0%;">
            <span id="progressText" class="w-full text-center"></span>
          </div>
        </div>
      </div>
      <div class="status mt-4 text-blue-700 font-medium" id="status"></div>
      <canvas id="pdfCanvas" class="mt-8 mx-auto border rounded-lg shadow" style="display:none;max-width:100%;box-shadow:0 2px 16px rgba(0,0,0,0.04);"></canvas>
      <div class="flex justify-center mt-8">
        <span class="text-xs text-gray-500">Desenvolvido por Matheus Ferraretto &nbsp;·&nbsp; <i class="fa-solid fa-robot"></i></span>
      </div>
    </div>
  </div>
    <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

function showMessage(text) {
  const messageBox = document.getElementById("messageBox");
  const messageText = document.getElementById("messageText");
  messageText.textContent = text;
  messageBox.style.display = "block";
}

async function processar() {
  const progressBar = document.getElementById("progressBar");
  const progressFill = document.getElementById("progressFill");
  const progressText = document.getElementById("progressText");
  progressBar.style.display = "block";
  progressFill.style.width = "0%";
  progressText.textContent = "";

  const status = document.getElementById("status");
  const pdfFile = document.getElementById("pdfInput").files[0];
  if (!pdfFile) {
    progressBar.style.display = "none";
    return showMessage("Envie o arquivo PDF.");
  }

  status.textContent = "📸 Lendo PDF...";
  const arrayBuffer = await pdfFile.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const novoPdf = await PDFLib.PDFDocument.create();
  const canvas = document.getElementById("pdfCanvas");
  const ctx = canvas.getContext("2d");
  canvas.style.display = "block";

  for (let i = 0; i < pdf.numPages; i++) {
    const progress = Math.round((i / pdf.numPages) * 100);
    progressFill.style.width = progress + "%";
    progressText.textContent = `Processando página ${i + 1} de ${pdf.numPages}...`;

    const page = await pdf.getPage(i + 1);
    const scale = 2;
    const viewport = page.getViewport({ scale });

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: ctx, viewport }).promise;

    const largura = canvas.width;
    const altura = canvas.height;

    const colWidth = largura / 2;
    const rowHeight = altura / 1.75;

    const pares = [
      { etiqueta: { x: 0, y: 0 }, checklist: { x: 0, y: rowHeight } },
      { etiqueta: { x: colWidth, y: 0 }, checklist: { x: colWidth, y: rowHeight } }
    ];

    for (const par of pares) {
      // Ajuste das proporções para garantir que a parte do checklist seja totalmente capturada.
      // Desta vez, vamos dar mais espaço para o checklist para garantir que nada seja cortado.
      const proporcaoEtiqueta = 0.88; 
      const proporcaoChecklist = 0.12; 

      const alturaEtiquetaPrincipal = rowHeight * proporcaoEtiqueta;
      const alturaChecklist = rowHeight * proporcaoChecklist;
      
      const deslocamentoEtiquetaY = 0;
      
      // CORTA A ETIQUETA PRINCIPAL
      const etCanvas = document.createElement("canvas");
      etCanvas.width = colWidth;
      etCanvas.height = alturaEtiquetaPrincipal - deslocamentoEtiquetaY;
      const etCtx = etCanvas.getContext("2d");
      etCtx.drawImage(canvas, par.etiqueta.x, par.etiqueta.y + deslocamentoEtiquetaY, colWidth, alturaEtiquetaPrincipal - deslocamentoEtiquetaY, 0, 0, colWidth, alturaEtiquetaPrincipal - deslocamentoEtiquetaY);
      
      // CORTA A PARTE DO CHECKLIST
      const chkCanvas = document.createElement("canvas");
      
      // Definimos um deslocamento mínimo para evitar a linha de separação, mas não cortar o texto.
      const deslocamentoY = 6; 
      const novaAlturaChecklist = alturaChecklist - deslocamentoY;
      
      chkCanvas.width = colWidth;
      chkCanvas.height = novaAlturaChecklist;
      const chkCtx = chkCanvas.getContext("2d");
      
      // Captura o checklist a partir do ponto inicial da seção.
      chkCtx.drawImage(canvas, par.checklist.x, par.checklist.y + deslocamentoY, colWidth, novaAlturaChecklist, 0, 0, colWidth, novaAlturaChecklist);
      
      // COMBINA AS DUAS PARTES EM UM ÚNICO CANVAS
      const etiquetaCompletaCanvas = document.createElement("canvas");
      etiquetaCompletaCanvas.width = colWidth;
      
      const ajusteVerticalChecklist = 4; 
      etiquetaCompletaCanvas.height = (alturaEtiquetaPrincipal - deslocamentoEtiquetaY) + novaAlturaChecklist + ajusteVerticalChecklist;
      
      const completoCtx = etiquetaCompletaCanvas.getContext("2d");
      completoCtx.drawImage(etCanvas, 0, 0);
const escalaChecklist = 2; // 🔍 ZOOM 1.9x

const larguraZoom = colWidth * escalaChecklist;
const alturaZoom = novaAlturaChecklist * escalaChecklist;

// Ajustar a posição X para centralizar após o zoom (caso queira)
const offsetX = (colWidth - larguraZoom) / 1.3;
const offsetY = (alturaEtiquetaPrincipal - deslocamentoEtiquetaY) + ajusteVerticalChecklist;

// Aplica o zoom
completoCtx.drawImage(
  chkCanvas,
  0, 0, colWidth, novaAlturaChecklist, // Fonte (tamanho original)
  offsetX, offsetY, larguraZoom, alturaZoom // Destino (com zoom)
);

      // Inserção no novo PDF
      const imgBytes = await fetch(etiquetaCompletaCanvas.toDataURL("image/png")).then(res => res.arrayBuffer());
      const imgEmbed = await novoPdf.embedPng(imgBytes);

      // Usando dimensões de página padrão para uma etiqueta
      const larguraPagina = 283.46;
      const alturaPagina = 455.2;
      
      // Adicionamos um fator de escala para diminuir a etiqueta de forma proporcional.
      const scaleFactor = 0.90;
      const larguraEtiquetaFinal = 277 * scaleFactor; 
      const alturaEtiquetaFinal = 449 * scaleFactor;
      
      const margemX = (larguraPagina - larguraEtiquetaFinal) / 2;
      const margemY = (alturaPagina - alturaEtiquetaFinal) / 2;

      // Ajustado a posição vertical para subir a etiqueta e dar espaço para o checklist.
      const ajusteVertical = 10; 
      const yPos = margemY + ajusteVertical;

      // Adiciona uma página para cada etiqueta
      const pag = novoPdf.addPage([larguraPagina, alturaPagina]);

      pag.drawImage(imgEmbed, {
        x: margemX,
        y: yPos,
        width: larguraEtiquetaFinal,
        height: alturaEtiquetaFinal,
      });
    }
  }

  progressFill.style.width = "100%";
  progressText.textContent = "✅ Concluído!";
  setTimeout(() => {
    progressBar.style.display = "none";
  }, 2000);

  const pdfFinal = await novoPdf.save();
  const blob = new Blob([pdfFinal], { type: "application/pdf" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "etiquetas_editadas.pdf";
  a.click();

  status.textContent = "✅ PDF gerado com sucesso!";
}
  </script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  </script>
  <script src="shared.js"></script>
</body>
</html>
