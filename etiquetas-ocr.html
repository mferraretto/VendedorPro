
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Etiquetas Shopee com OCR</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div id="sidebar-container"></div>
  <div id="navbar-container"></div>
  <div class="main-content p-4 space-y-4">
   <h2>ðŸ“¦ Editor Visual de Etiquetas Shopee</h2>
  <input type="file" id="pdfInput" accept="application/pdf" />
  <button onclick="processar()">ðŸ“¥ Processar e Gerar PDF</button>
  <div class="status" id="status"></div>
  <canvas id="pdfCanvas"></canvas>
 </div>
  
    <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

    async function processar() {
document.getElementById("progressBar").style.display = "block";

      const status = document.getElementById("status");
      const pdfFile = document.getElementById("pdfInput").files[0];
      if (!pdfFile) return alert("Envie o arquivo PDF.");

      status.textContent = "ðŸ“¸ Lendo PDF...";
      const arrayBuffer = await pdfFile.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const novoPdf = await PDFLib.PDFDocument.create();
      const canvas = document.getElementById("pdfCanvas");
      const ctx = canvas.getContext("2d");
document.getElementById("progressBar").style.display = "block";

      for (let i = 0; i < pdf.numPages; i++) {
 const progress = Math.round((i / pdf.numPages) * 100);
  document.getElementById("progressFill").style.width = progress + "%";
  document.getElementById("progressText").textContent = `Processando pÃ¡gina ${i + 1} de ${pdf.numPages}...`;
      
  const page = await pdf.getPage(i + 1);
        const scale = 3;
        const viewport = page.getViewport({ scale });

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: ctx, viewport }).promise;

        const largura = canvas.width;
        const altura = canvas.height;

        const colWidth = largura / 2;
        const rowHeight = altura / 2;

        const pares = [
          { etiqueta: { x: 0, y: 0 }, checklist: { x: 0, y: rowHeight / 1 } }, // coluna esquerda
          { etiqueta: { x: colWidth, y: 0 }, checklist: { x: colWidth, y: rowHeight / 1 } }  // coluna direita
        ];

        for (const par of pares) {
          // CORTA ETIQUETA (linha de cima)
const etCanvas = document.createElement("canvas");
etCanvas.width = colWidth;
etCanvas.height = rowHeight; // âœ… agora pega metade da pÃ¡gina (altura da linha de etiqueta)
const etCtx = etCanvas.getContext("2d");
etCtx.drawImage(canvas, par.etiqueta.x, par.etiqueta.y, colWidth, rowHeight, 0, 0, colWidth, rowHeight);


          // CORTA CHECKLIST (linha de baixo)
          const chkCanvas = document.createElement("canvas");
          chkCanvas.width = colWidth;
          chkCanvas.height = rowHeight / 2;
          const chkCtx = chkCanvas.getContext("2d");
          chkCtx.drawImage(canvas, par.checklist.x, par.checklist.y, colWidth, rowHeight / 2, 0, 0, colWidth, rowHeight / 2);

          // OCR do checklist (linha inferior)
const { data: { text } } = await Tesseract.recognize(chkCanvas, "eng");
console.log("ðŸ“„ Texto OCR completo do checklist:\n", text);

// ExtraÃ§Ã£o do ID do pedido
let pedido = null;
const matchPedido = text.match(/([0-9A-Z]{12,})/);
if (matchPedido) pedido = matchPedido[1].trim();

// ExtraÃ§Ã£o dos dados estruturados do checklist
function extrairDadosChecklist(textoOCR) {
   const linhas = textoOCR.split('\n').map(l => l.trim()).filter(Boolean);
  let cabecalhoEncontrado = false;
  let dadosLinha = null;
  let descricaoExtra = [];

  for (let i = 0; i < linhas.length; i++) {
    const linha = linhas[i];

    if (linha.startsWith("# Produto SKU")) {
      cabecalhoEncontrado = true;
      continue;
    }

    if (!cabecalhoEncontrado) continue;

    if (!dadosLinha && /^\d+ /.test(linha)) {
      const partes = linha.split(/\s+/);
      const numero = partes[0];
      const quantidade = partes[partes.length - 1];

      // Detecta o Ã­ndice do SKU (ex: T6, B6, A12, BOLEIRAS etc.)
      const indexSKU = partes.findIndex(p =>
        /^[A-Z]{1,3}[0-9]{0,2}$/.test(p) || /^[A-Z]{4,}$/.test(p)
      );

      let produto = partes.slice(1, indexSKU).join(' ');
      const sku = partes[indexSKU];
      const variacao = partes.slice(indexSKU + 1, partes.length - 1).join(' ');

      dadosLinha = { numero, produto, sku, variacao, quantidade };
    } else if (dadosLinha) {
      descricaoExtra.push(linha);
    }
  }

  if (dadosLinha && descricaoExtra.length > 0) {
    dadosLinha.produto += ' ' + descricaoExtra.join(' ');
  }

  return dadosLinha;
}

const dados = extrairDadosChecklist(text);

// RodapÃ© final com todos os dados
const rodape = `SKU: ${dados?.sku || 'SKU nÃ£o identificado'}
VariaÃ§Ã£o: ${dados?.variacao || 'N/A'}
Qtd: ${dados?.quantidade || 'N/A'}`;

          // InserÃ§Ã£o no novo PDF
          const imgBytes = await fetch(etCanvas.toDataURL("image/png")).then(res => res.arrayBuffer());
          const imgEmbed = await novoPdf.embedPng(imgBytes);

          const larguraPagina = 283.46;
          const alturaPagina = 425.2;
          const larguraEtiqueta = 255;
          const alturaEtiqueta = 359;
          const margemX = (larguraPagina - larguraEtiqueta) / 2;
          const margemY = alturaPagina - alturaEtiqueta - 15;

          const pag = novoPdf.addPage([larguraPagina, alturaPagina]);
          pag.drawImage(imgEmbed, {
            x: margemX,
            y: margemY,
            width: larguraEtiqueta,
            height: alturaEtiqueta,
          });

          pag.drawText(rodape, {
  x: 15,
  y: 45,
  size: 12,
  lineHeight: 11,
  color: PDFLib.rgb(0, 0, 0),
});
          console.log("âœ… RodapÃ© inserido:", rodape);
        }
      }

      const pdfFinal = await novoPdf.save();
      const blob = new Blob([pdfFinal], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "etiquetas_editadas.pdf";
      a.click();
document.getElementById("progressFill").style.width = "100%";
document.getElementById("progressText").textContent = "âœ… ConcluÃ­do!";
setTimeout(() => {
  document.getElementById("progressBar").style.display = "none";
}, 2000);

      status.textContent = "âœ… PDF gerado com sucesso!";
    }
  </script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
</script>

  <script src="shared.js"></script>
</body>
</html>
